import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as n,d as a,a as l,e as p,o}from"./app-Bv3jHGDE.js";const e={},c=l("p",null,"Java 虚拟机",-1),r=p(`<figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806488.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>Java Class</p><p>ClassLoader</p><h1 id="一、java内存结构" tabindex="-1"><a class="header-anchor" href="#一、java内存结构"><span>一、Java内存结构</span></a></h1><h2 id="_1-程序计数器" tabindex="-1"><a class="header-anchor" href="#_1-程序计数器"><span>1.程序计数器</span></a></h2><h4 id="_1-1定义" tabindex="-1"><a class="header-anchor" href="#_1-1定义"><span>1.1定义</span></a></h4><p>Program Counter Register 程序计数器（寄存器） 作用：是记录下一条 jvm 指令的执行地址行号。 特点：</p><ul><li>是线程私有的</li><li>不会存在内存溢出</li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#B48EAD;">0</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> getstatic #</span><span style="color:#B48EAD;">20</span><span style="color:#616E88;"> // PrintStream out = System.out;</span></span>
<span class="line"><span style="color:#B48EAD;">3</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_1 </span><span style="color:#616E88;">// --</span></span>
<span class="line"><span style="color:#B48EAD;">4</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_1 </span><span style="color:#616E88;">// out.println(1);</span></span>
<span class="line"><span style="color:#B48EAD;">5</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iconst_1 </span><span style="color:#616E88;">// --</span></span>
<span class="line"><span style="color:#B48EAD;">6</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokevirtual #</span><span style="color:#B48EAD;">26</span><span style="color:#616E88;"> // --</span></span>
<span class="line"><span style="color:#B48EAD;">9</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_1 </span><span style="color:#616E88;">// out.println(2);</span></span>
<span class="line"><span style="color:#B48EAD;">10</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iconst_2 </span><span style="color:#616E88;">// --</span></span>
<span class="line"><span style="color:#B48EAD;">11</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokevirtual #</span><span style="color:#B48EAD;">26</span><span style="color:#616E88;"> // --</span></span>
<span class="line"><span style="color:#B48EAD;">14</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_1 </span><span style="color:#616E88;">// out.println(3);</span></span>
<span class="line"><span style="color:#B48EAD;">15</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iconst_3 </span><span style="color:#616E88;">// --</span></span>
<span class="line"><span style="color:#B48EAD;">16</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokevirtual #</span><span style="color:#B48EAD;">26</span><span style="color:#616E88;"> // --</span></span>
<span class="line"><span style="color:#B48EAD;">19</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_1 </span><span style="color:#616E88;">// out.println(4);</span></span>
<span class="line"><span style="color:#B48EAD;">20</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iconst_4 </span><span style="color:#616E88;">// --</span></span>
<span class="line"><span style="color:#B48EAD;">21</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokevirtual #</span><span style="color:#B48EAD;">26</span><span style="color:#616E88;"> // --</span></span>
<span class="line"><span style="color:#B48EAD;">24</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_1 </span><span style="color:#616E88;">// out.println(5);</span></span>
<span class="line"><span style="color:#B48EAD;">25</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iconst_5 </span><span style="color:#616E88;">// --</span></span>
<span class="line"><span style="color:#B48EAD;">26</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokevirtual #</span><span style="color:#B48EAD;">26</span><span style="color:#616E88;"> // --</span></span>
<span class="line"><span style="color:#B48EAD;">29</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> return</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>解释器会解释指令为机器码交给 cpu 执行，程序计数器会记录下一条指令的地址行号，这样下一次解释器会从程序计数器拿到指令然后进行解释执行。</li><li>多线程的环境下，如果两个线程发生了上下文切换，那么程序计数器会记录线程下一行指令的地址行号，以便于接着往下执行。</li></ul><h2 id="_2-虚拟机栈" tabindex="-1"><a class="header-anchor" href="#_2-虚拟机栈"><span>2.虚拟机栈</span></a></h2><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806323.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h4 id="_2-1-定义" tabindex="-1"><a class="header-anchor" href="#_2-1-定义"><span>2.1 定义</span></a></h4><ul><li>每个线程运行需要的内存空间，称为虚拟机栈</li><li>每个栈由多个栈帧（Frame）组成，对应着每次调用方法时所占用的内存</li><li>每个线程只能有一个活动栈帧，对应着当前正在执行的方法</li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> main1</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">        method1</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> method1</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">        method2</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> int</span><span style="color:#88C0D0;"> method2</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> a</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> b</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#D8DEE9;"> c</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> a </span><span style="color:#81A1C1;">+</span><span style="color:#D8DEE9FF;"> b</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#D8DEE9FF;"> c</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806481.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>问题辨析：</p><ol><li>垃圾回收是否涉及栈内存？ 不会。栈内存是方法调用产生的，方法调用结束后会弹出栈。</li><li>栈内存分配越大越好吗？ 不是。因为物理内存是一定的，栈内存越大，可以支持更多的递归调用，但是可执行的线程数就会越少。</li><li>方法呢的局部变量是否线程安全 <ol><li>如果方法内部的变量没有逃离方法的作用范围，它是线程安全的</li><li>如果是局部变量引用了对象，并逃离了方法的范围，那就要考虑线程安全问题。</li></ol></li></ol><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> main1</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#616E88;">    //下面各个方法会不会造成线程安全问题？</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    //不会</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> m1</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        StringBuilder</span><span style="color:#D8DEE9;"> sb</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> StringBuilder</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        sb</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">append</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        sb</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">append</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        sb</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">append</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">3</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">sb</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    //会，可能会有其他线程使用这个对象</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> m2</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">StringBuilder</span><span style="color:#D8DEE9;"> sb</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        sb</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">append</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        sb</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">append</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        sb</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">append</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">3</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">sb</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    //会，其他线程可能会拿到这个线程的引用</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#8FBCBB;"> StringBuilder</span><span style="color:#88C0D0;"> m3</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        StringBuilder</span><span style="color:#D8DEE9;"> sb</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> StringBuilder</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        sb</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">append</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        sb</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">append</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        sb</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">append</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">3</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#D8DEE9FF;"> sb</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-栈内存溢出" tabindex="-1"><a class="header-anchor" href="#_2-2-栈内存溢出"><span>2.2 栈内存溢出</span></a></h4><p><strong><code>Java.lang.stackOverflowError</code></strong> 栈内存溢出</p><p><strong>导致栈<strong><strong>内存</strong></strong>溢出的情况</strong>：</p><ul><li><strong>栈帧****过多</strong>导致栈内存溢出</li><li><strong>栈帧****过大</strong>导致栈内存溢出</li></ul><p>栈帧过大、过多、或者第三方类库操作，都有可能造成栈内存溢出 java.lang.stackOverflowError ，使用 -Xss256k 指定栈内存大小！</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806492.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>设置<strong><strong>虚拟机</strong></strong>栈<strong><strong>内存</strong></strong>大小</strong>：</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806444.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h4 id="_2-3-线程运行诊断" tabindex="-1"><a class="header-anchor" href="#_2-3-线程运行诊断"><span>2.3 线程运行诊断</span></a></h4><p>案例：CPU占用过高</p><p>Linux环境下运行某些程序的时候，可能导致CPU的占用过高，这时需要定位占用CPU过高的线程</p><ul><li>用<code>top</code>定位哪个进程对cpu的占用过高</li><li><code>ps H -eo pid,tid,%cpu | grep 进程id</code> ，刚才通过top查到的进程号，用ps命令进一步定位是哪个线程引起的cpu占用过高</li><li><code>jstack 进程id</code>，通过查看进程中的线程的nid，刚才通过ps命令看到的tid来<strong>对比定位</strong>，注意jstack查找出的线程id是<strong>16进制的</strong>，<strong>需要转换</strong></li></ul><h2 id="_3-本地方法栈" tabindex="-1"><a class="header-anchor" href="#_3-本地方法栈"><span>3.本地方法栈</span></a></h2><p>一些带有<strong>native关键字</strong>的方法就是需要JAVA去调用本地的C或者C++方法，因为JAVA有时候没法直接和操作系统底层交互，所以需要用到本地方法。</p><h2 id="_4-堆" tabindex="-1"><a class="header-anchor" href="#_4-堆"><span>4.堆</span></a></h2><h4 id="_4-1-定义" tabindex="-1"><a class="header-anchor" href="#_4-1-定义"><span>4.1 定义</span></a></h4><p>通过<strong>new关键字创建的对象</strong>都会使用堆内存</p><h4 id="_4-2特点" tabindex="-1"><a class="header-anchor" href="#_4-2特点"><span>4.2特点</span></a></h4><ul><li>它是<strong>线程共享</strong>的，堆中对象都需要考虑线程安全的问题</li><li>有垃圾回收机制</li></ul><h4 id="_4-3堆内存溢出" tabindex="-1"><a class="header-anchor" href="#_4-3堆内存溢出"><span>4.3堆内存溢出</span></a></h4><p><code>java.lang.OutofMemoryError ：java heap space</code> 堆内存溢出</p><p>案例：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">/**</span></span>
<span class="line"><span style="color:#616E88;"> * 演示堆内存溢出 java.lang.OutOfMemoryError: Java heap space</span></span>
<span class="line"><span style="color:#616E88;"> * -Xmx8m ，最大堆空间的jvm虚拟机参数，默认是4g</span></span>
<span class="line"><span style="color:#616E88;"> */</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> main1</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">        try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">            ArrayList</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> list</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> ArrayList</span><span style="color:#ECEFF4;">&lt;&gt;()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">// new 一个list 存入堆中</span></span>
<span class="line"><span style="color:#8FBCBB;">            String</span><span style="color:#D8DEE9;"> a</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">hello</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">            while</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">                list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">a</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">// 不断地向list 中添加 a</span></span>
<span class="line"><span style="color:#D8DEE9FF;">                a </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> a </span><span style="color:#81A1C1;">+</span><span style="color:#D8DEE9FF;"> a</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">                i</span><span style="color:#81A1C1;">++;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">Throwable</span><span style="color:#D8DEE9;"> e</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span><span style="color:#616E88;">// list 使用结束，被jc 垃圾回收</span></span>
<span class="line"><span style="color:#D8DEE9;">            e</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">printStackTrace</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9;">java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">OutOfMemoryError</span><span style="color:#81A1C1;">:</span><span style="color:#8FBCBB;"> Java</span><span style="color:#D8DEE9FF;"> heap space</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        at </span><span style="color:#D8DEE9;">java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">util</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Arrays</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">copyOf</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">Arrays</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">java</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;">3332</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        at </span><span style="color:#D8DEE9;">java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">AbstractStringBuilder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">ensureCapacityInternal</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">AbstractStringBuilder</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">java</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;">124</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        at </span><span style="color:#D8DEE9;">java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">AbstractStringBuilder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">append</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">AbstractStringBuilder</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">java</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;">448</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        at </span><span style="color:#D8DEE9;">java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">StringBuilder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">append</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">StringBuilder</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">java</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;">136</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        at </span><span style="color:#D8DEE9;">com</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">itcast</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">itheima</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">xpp</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">main1</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">main</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">main1</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">java</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;">14</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#B48EAD;">22</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4堆内存诊断" tabindex="-1"><a class="header-anchor" href="#_4-4堆内存诊断"><span>4.4堆内存诊断</span></a></h4><ol><li><strong>jps</strong> <strong>工具</strong></li></ol><p>查看当前系统中有哪些 java 进程</p><ol><li><strong>jmap 工具</strong></li></ol><p>查看堆内存占用情况 <code>jmap - heap 进程id</code></p><ol><li><strong>jconsole 工具</strong></li></ol><p>图形界面的，多功能的监测工具，可以连续监测</p><ol><li>jvisualvm 工具</li></ol><h2 id="_5-方法区" tabindex="-1"><a class="header-anchor" href="#_5-方法区"><span>5.方法区</span></a></h2><h4 id="_5-1-定义" tabindex="-1"><a class="header-anchor" href="#_5-1-定义"><span>5.1 定义</span></a></h4><p>Java 虚拟机有一个在所有 Java 虚拟机线程之间共享的方法区域。方法区域类似于用于传统语言的编译代码的存储区域，或者类似于操作系统进程中的“文本”段。它存储每个类的结构，例如运行时常量池、字段和方法数据，以及方法和构造函数的代码，包括特殊方法，用于类和实例初始化以及接口初始化方法区域是在虚拟机启动时创建的。尽管方法区域在逻辑上是堆的一部分，但简单的实现可能不会选择垃圾收集或压缩它。此规范不强制指定方法区的位置或用于管理已编译代码的策略。方法区域可以具有固定的大小，或者可以根据计算的需要进行扩展，并且如果不需要更大的方法区域，则可以收缩。方法区域的内存不需要是连续的！</p><h4 id="_5-2-组成" tabindex="-1"><a class="header-anchor" href="#_5-2-组成"><span>5.2 组成</span></a></h4><ul><li><strong>永久代</strong>用的<strong>堆内存</strong></li><li><strong>元空间</strong>用的<strong>本地****内存</strong></li></ul><p>Hotspot 虚拟机 jdk1.6 1.7 1.8 内存结构图</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806556.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h4 id="_5-3-方法区内存溢出" tabindex="-1"><a class="header-anchor" href="#_5-3-方法区内存溢出"><span>5.3 方法区内存溢出</span></a></h4><ul><li>1.8以前会导致<strong>永久代</strong>内存溢出<code>java.lang.OutOfMemoryError: PermGen space</code></li><li>1.8以后会导致<strong>元空间</strong>内存溢出<code>java.lang.OutOfMemoryError: Metaspace</code></li><li>1.8 之前会导致永久代内存溢出 <ul><li>使用 -XX:MaxPermSize=8m 指定永久代内存大小</li></ul></li><li>1.8 之后会导致元空间内存溢出 <ul><li>使用 -XX:MaxMetaspaceSize=8m 指定元空间大小</li></ul></li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">/**</span></span>
<span class="line"><span style="color:#616E88;"> * 演示元空间内存溢出:java.lang.OutOfMemoryError: Metaspace</span></span>
<span class="line"><span style="color:#616E88;"> * -XX:MaxMetaspaceSize=8m</span></span>
<span class="line"><span style="color:#616E88;"> */</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> main1</span><span style="color:#81A1C1;"> extends</span><span style="color:#8FBCBB;font-weight:bold;"> ClassLoader</span><span style="color:#ECEFF4;"> {</span><span style="color:#616E88;">//可以用来加载类的二进制字节码</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#D8DEE9;"> j</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">            main1 test </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> main1</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">            for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 10000</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;">j</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">                //ClassWriter 作用是生产类的二进制字节码</span></span>
<span class="line"><span style="color:#8FBCBB;">                ClassWriter</span><span style="color:#D8DEE9;"> cw</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ClassWriter</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">                //版本号，public，类名</span></span>
<span class="line"><span style="color:#D8DEE9;">                cw</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">visit</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">Opcodes</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">V1_8</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> Opcodes</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">ACC_PUBLIC</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Class</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> null</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">java/lang/Object</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> null</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">                //返回 byte[]</span></span>
<span class="line"><span style="color:#81A1C1;">                byte</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> code</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> cw</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toByteArray</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">                //执行类的加载</span></span>
<span class="line"><span style="color:#D8DEE9;">                test</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">defineClass</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Class</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> code</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> code</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">length</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;"> finally</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">j</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#8FBCBB;">Exception</span><span style="color:#D8DEE9FF;"> in thread </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">main</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9;"> java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">OutOfMemoryError</span><span style="color:#81A1C1;">:</span><span style="color:#8FBCBB;"> Metaspace</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        at </span><span style="color:#D8DEE9;">java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">ClassLoader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">defineClass1</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">Native</span><span style="color:#D8DEE9FF;"> Method</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        at </span><span style="color:#D8DEE9;">java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">ClassLoader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">defineClass</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">ClassLoader</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">java</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;">763</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        at </span><span style="color:#D8DEE9;">java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">ClassLoader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">defineClass</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">ClassLoader</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">java</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;">642</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        at </span><span style="color:#D8DEE9;">com</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">itcast</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">itheima</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">xpp</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">main1</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">main</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">main1</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">java</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;">26</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#B48EAD;">4865</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8FBCBB;">Process</span><span style="color:#D8DEE9FF;"> finished with exit code </span><span style="color:#B48EAD;">1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-4-通过反编译来查看类的信息" tabindex="-1"><a class="header-anchor" href="#_5-4-通过反编译来查看类的信息"><span>5.4 通过反编译来查看类的信息</span></a></h4><ul><li>获得对应类的.class文件，<code>javac xxx.java</code><ul><li><p>在JDK对应的bin目录下运行cmd，<strong>也可以在IDEA控制台输入</strong></p></li><li><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806505.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure></li><li><p>输入 <strong>javac</strong> <strong>对应类的绝对路径</strong></p></li><li><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">F</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;">\\JAVA\\</span><span style="color:#D8DEE9;">JDK8</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">0</span><span style="color:#D8DEE9FF;">\\bin</span><span style="color:#81A1C1;">&gt;</span><span style="color:#D8DEE9FF;">javac F</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;">\\Thread_study\\src\\com\\nyima\\JVM\\day01\\</span><span style="color:#D8DEE9;">Main</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">java</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>输入完成后，对应的目录下就会出现类的.class文件</p></li></ul></li><li>在控制台输入 <code>javap -v 类的绝对路径</code></li></ul><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" data-title="plain" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>javap -v F:\\Thread_study\\src\\com\\nyima\\JVM\\day01\\Main.class</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>然后能在控制台看到反编译以后类的信息了 <ul><li><p>类的基本信息</p></li><li><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806336.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure></li><li><p>常量池</p></li><li><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806606.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure></li><li><p>虚拟机中执行编译的方法（框内的是真正编译执行的内容，<strong>#号的内容需要在<strong><strong>常量池</strong></strong>中查找</strong>）</p></li><li><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806528.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure></li></ul></li></ul><h4 id="_5-5-运行时常量池" tabindex="-1"><a class="header-anchor" href="#_5-5-运行时常量池"><span>5.5 运行时常量池</span></a></h4><ul><li><strong>常量池</strong>：就是一张表，虚拟机指令根据这张常量表找到要执行的类名、方法名、参数类型、字面量等信息</li><li><strong>运行时常量池</strong>：常量池是 *.class 文件中的，当该类被加载，它的常量池信息就会放入运行时常量池，并把里面的符号地址变为真实地址</li></ul><h4 id="_5-6-常量池与串池stringtable的关系" tabindex="-1"><a class="header-anchor" href="#_5-6-常量池与串池stringtable的关系"><span>5.6 常量池与串池StringTable的关系</span></a></h4><p><strong>StringTable 特性</strong></p><ul><li>常量池中的字符串仅是符号，只有<strong>在被用到时才会转化为对象</strong></li><li>利用串池的机制，来避免重复创建字符串对象</li><li>字符串<strong>变量</strong>拼接的原理是<strong>StringBuilder</strong></li><li>字符串<strong>常量</strong>拼接的原理是<strong>编译器优化</strong></li><li>可以使用<strong>intern方法</strong>，主动将串池中还没有的字符串对象放入串池中 <ul><li>1.8 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池，会把串池中的对象返回</li><li>1.6 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有会把此对象复制一份，放入串池，会把串池中的对象返回</li></ul></li></ul><p><strong>栗子1</strong>：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> StringTableStudy</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">                String</span><span style="color:#D8DEE9;"> a</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">a</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#8FBCBB;">                String</span><span style="color:#D8DEE9;"> b</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">b</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">                String</span><span style="color:#D8DEE9;"> ab</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">ab</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>常量池中的信息，都会被加载到运行时常量池中，但这是a b ab 仅是常量池中的符号，<strong>还没有成为java字符串</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#B48EAD;">0</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ldc           #</span><span style="color:#B48EAD;">2</span><span style="color:#616E88;">                  // String a</span></span>
<span class="line"><span style="color:#B48EAD;">2</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_1</span></span>
<span class="line"><span style="color:#B48EAD;">3</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ldc           #</span><span style="color:#B48EAD;">3</span><span style="color:#616E88;">                  // String b</span></span>
<span class="line"><span style="color:#B48EAD;">5</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_2</span></span>
<span class="line"><span style="color:#B48EAD;">6</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ldc           #</span><span style="color:#B48EAD;">4</span><span style="color:#616E88;">                  // String ab</span></span>
<span class="line"><span style="color:#B48EAD;">8</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_3</span></span>
<span class="line"><span style="color:#B48EAD;">9</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> return</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当执行到 ldc #2 时，会把符号 a 变为 “a” 字符串对象，<strong>并放入串池中</strong>（hashtable结构 不可扩容）</p><p>当执行到 ldc #3 时，会把符号 b 变为 “b” 字符串对象，并放入串池中</p><p>当执行到 ldc #4 时，会把符号 ab 变为 “ab” 字符串对象，并放入串池中</p><p>最终<strong>StringTable [“a”, “b”, “<strong><strong>ab</strong></strong>”]</strong></p><p><strong>注意</strong>：字符串对象的创建都是<strong>懒惰的</strong>，只有当运行到那一行字符串且在串池中不存在的时候（如 ldc #2）时，该字符串才会被创建并放入串池中。</p><p><strong>栗子2</strong>：使用拼接<strong>字符串****变量对象</strong>创建字符串的过程</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> HelloWorld</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> s1</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">a</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> s2</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">b</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> s3</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">ab</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> s4</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;">s1</span><span style="color:#81A1C1;">+</span><span style="color:#D8DEE9FF;">s2</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//new StringBuilder().append(&quot;a&quot;).append(&quot;2&quot;).toString()  new String(&quot;ab&quot;)</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">s3</span><span style="color:#81A1C1;">==</span><span style="color:#D8DEE9FF;">s4</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//false</span></span>
<span class="line"><span style="color:#616E88;">//结果为false,因为s3是存在于串池之中，s4是由StringBuffer的toString方法所返回的一个对象，存在于堆内存之中</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>反编译后的结果</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">         Code</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      stack</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> locals</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">5</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> args_size</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span></span>
<span class="line"><span style="color:#B48EAD;">         0</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ldc           #</span><span style="color:#B48EAD;">2</span><span style="color:#616E88;">                  // String a</span></span>
<span class="line"><span style="color:#B48EAD;">         2</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_1</span></span>
<span class="line"><span style="color:#B48EAD;">         3</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ldc           #</span><span style="color:#B48EAD;">3</span><span style="color:#616E88;">                  // String b</span></span>
<span class="line"><span style="color:#B48EAD;">         5</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_2</span></span>
<span class="line"><span style="color:#B48EAD;">         6</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ldc           #</span><span style="color:#B48EAD;">4</span><span style="color:#616E88;">                  // String ab</span></span>
<span class="line"><span style="color:#B48EAD;">         8</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_3</span></span>
<span class="line"><span style="color:#B48EAD;">         9</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> new</span><span style="color:#D8DEE9FF;">           #5                  </span><span style="color:#616E88;">// class java/lang/StringBuilder</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        12</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> dup</span></span>
<span class="line"><span style="color:#B48EAD;">        13</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokespecial #</span><span style="color:#B48EAD;">6</span><span style="color:#616E88;">                  // Method java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:()V</span></span>
<span class="line"><span style="color:#B48EAD;">        16</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_1</span></span>
<span class="line"><span style="color:#B48EAD;">        17</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokevirtual #</span><span style="color:#B48EAD;">7</span><span style="color:#616E88;">                  // Method java/lang/StringBuilder.append:(Ljava/lang/String</span></span>
<span class="line"><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">)Ljava</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">StringBuilder</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#B48EAD;">        20</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_2</span></span>
<span class="line"><span style="color:#B48EAD;">        21</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokevirtual #</span><span style="color:#B48EAD;">7</span><span style="color:#616E88;">                  // Method java/lang/StringBuilder.append:(Ljava/lang/String</span></span>
<span class="line"><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">)Ljava</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">StringBuilder</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#B48EAD;">        24</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokevirtual #</span><span style="color:#B48EAD;">8</span><span style="color:#616E88;">                  // Method java/lang/StringBuilder.toString:()Ljava/lang/Str</span></span>
<span class="line"><span style="color:#D8DEE9FF;">ing</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#B48EAD;">        27</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore        </span><span style="color:#B48EAD;">4</span></span>
<span class="line"><span style="color:#B48EAD;">        29</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> return</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>通过拼接的方式来创建字符串的<strong>过程</strong>是：<code>StringBuilder().append(“a”).append(“b”).toString()</code></li><li>最后的toString方法的返回值是一个<strong>新的字符串</strong>，但字符串的<strong>值</strong>和拼接的字符串一致，但是两个不同的字符串，<strong>一个存在于串池之中，一个存在于<strong><strong>堆内存</strong></strong>之中</strong></li></ul><p><strong>栗子3</strong>：使用<strong>拼接字符串常量对象</strong>的方法创建字符串</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> HelloWorld</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> s1</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">a</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> s2</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">b</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> s3</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">ab</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> s4</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;">s1</span><span style="color:#81A1C1;">+</span><span style="color:#D8DEE9FF;">s2</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//new StringBuilder().a|ppend(&quot;a&quot;).append(&quot;2&quot;).toString()  new String(&quot;ab&quot;)</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> s5</span><span style="color:#81A1C1;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">a</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">+</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">b</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">s5</span><span style="color:#81A1C1;">==</span><span style="color:#D8DEE9FF;">s3</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//true</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>反编译后的结果</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">           Code</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      stack</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> locals</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">6</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> args_size</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span></span>
<span class="line"><span style="color:#B48EAD;">         0</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ldc           #</span><span style="color:#B48EAD;">2</span><span style="color:#616E88;">                  // String a</span></span>
<span class="line"><span style="color:#B48EAD;">         2</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_1</span></span>
<span class="line"><span style="color:#B48EAD;">         3</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ldc           #</span><span style="color:#B48EAD;">3</span><span style="color:#616E88;">                  // String b</span></span>
<span class="line"><span style="color:#B48EAD;">         5</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_2</span></span>
<span class="line"><span style="color:#B48EAD;">         6</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ldc           #</span><span style="color:#B48EAD;">4</span><span style="color:#616E88;">                  // String ab</span></span>
<span class="line"><span style="color:#B48EAD;">         8</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_3</span></span>
<span class="line"><span style="color:#B48EAD;">         9</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> new</span><span style="color:#D8DEE9FF;">           #5                  </span><span style="color:#616E88;">// class java/lang/StringBuilder</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        12</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> dup</span></span>
<span class="line"><span style="color:#B48EAD;">        13</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokespecial #</span><span style="color:#B48EAD;">6</span><span style="color:#616E88;">                  // Method java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:()V</span></span>
<span class="line"><span style="color:#B48EAD;">        16</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_1</span></span>
<span class="line"><span style="color:#B48EAD;">        17</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokevirtual #</span><span style="color:#B48EAD;">7</span><span style="color:#616E88;">                  // Method java/lang/StringBuilder.append:(Ljava/lang/String</span></span>
<span class="line"><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">)Ljava</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">StringBuilder</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#B48EAD;">        20</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_2</span></span>
<span class="line"><span style="color:#B48EAD;">        21</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokevirtual #</span><span style="color:#B48EAD;">7</span><span style="color:#616E88;">                  // Method java/lang/StringBuilder.append:(Ljava/lang/String</span></span>
<span class="line"><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">)Ljava</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">StringBuilder</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#B48EAD;">        24</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokevirtual #</span><span style="color:#B48EAD;">8</span><span style="color:#616E88;">                  // Method java/lang/StringBuilder.toString:()Ljava/lang/Str</span></span>
<span class="line"><span style="color:#D8DEE9FF;">ing</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#B48EAD;">        27</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore        </span><span style="color:#B48EAD;">4</span></span>
<span class="line"><span style="color:#616E88;">        //ab3初始化时直接从串池中获取字符串</span></span>
<span class="line"><span style="color:#B48EAD;">        29</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ldc           #</span><span style="color:#B48EAD;">4</span><span style="color:#616E88;">                  // String ab</span></span>
<span class="line"><span style="color:#B48EAD;">        31</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore        </span><span style="color:#B48EAD;">5</span></span>
<span class="line"><span style="color:#B48EAD;">        33</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> return</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>使用<strong>拼接字符串常量</strong>的方法来创建新的字符串时，因为<strong>内容是常量，<strong><strong>javac</strong></strong>在编译期会进行优化，结果已在编译期确定为ab</strong>，而创建ab的时候已经在串池中放入了“ab”，所以s5直接从串池中获取值，所以进行的操作和 s3= “ab” 一致。</li><li>使用<strong>拼接字符串变量</strong>的方法来创建新的字符串时，因为内容是变量，只能<strong>在运行期确定它的值，所以需要使用<strong><strong>StringBuilder</strong></strong>来创建</strong></li></ul><p><strong>intern方法 1.8</strong>：</p><p>调用字符串对象的intern方法，会将该字符串对象尝试放入到串池中</p><ul><li>如果串池中没有该字符串对象，则放入成功</li><li>如果有该字符串对象，则放入失败</li></ul><p>无论放入是否成功，都会返回<strong>串池中</strong>的字符串对象</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> HelloWorld</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> x</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">ab</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> s</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> String</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">a</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> +</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> String</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">b</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> s2</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> s</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">intern</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池，这两种情况都会把串池中的对象返回</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">s2 </span><span style="color:#81A1C1;">==</span><span style="color:#D8DEE9FF;"> x</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//true</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">s </span><span style="color:#81A1C1;">==</span><span style="color:#D8DEE9FF;"> x</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//false</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="面试题-string-str1-new-string-abc-和string-str2-abc-和-区别" tabindex="-1"><a class="header-anchor" href="#面试题-string-str1-new-string-abc-和string-str2-abc-和-区别"><span><strong>面试题：String str1 = new String(&quot;abc&quot;)和String str2 = &quot;abc&quot; 和 区别？</strong></span></a></h5><p>答：编译器在编译期间会把abc作为常量放在常量池中，这两个语句都会去字符串常量池中检查是否已经存在 “abc”，区别在于new会在堆中创建一个新的对象，String str2 = &quot;abc&quot; 返回字符串常量池的引用。</p><h5 id="面试题-string-s-new-string-a-new-string-b" tabindex="-1"><a class="header-anchor" href="#面试题-string-s-new-string-a-new-string-b"><span><strong>面试题：String s = new String(&quot;a&quot;) + new String(&quot;b&quot;);</strong></span></a></h5><p><strong>String s3 = &quot;ab&quot;;</strong> <strong>String s4=s1+s2; //new</strong> <strong>StringBuilder</strong>**().a|ppend(&quot;a&quot;).append(&quot;2&quot;).toString() new String(&quot;ab&quot;)** <strong>String s5=&quot;a&quot;+&quot;b&quot;;</strong></p><p>这类题记住编译器在编译期间会把字符字面量作为常量放在常量池中，如果操作的是对象和变量是不会放入常量池中的。</p><p><strong>intern方法 1.6</strong>：</p><p>调用字符串对象的intern方法，会将该字符串对象尝试放入到串池中</p><ul><li>如果串池中没有该字符串对象，会将该字符串对象复制一份，再放入到串池中</li><li>如果有该字符串对象，则放入失败</li></ul><p>无论放入是否成功，都会返回<strong>串池中</strong>的字符串对象</p><p><strong>面试题（1.8）</strong>：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> com</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">itcast</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">itheima</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">xpp</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> main</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> s1</span><span style="color:#81A1C1;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">a</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> s2</span><span style="color:#81A1C1;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">b</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> s3</span><span style="color:#81A1C1;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">a</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">+</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">b</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> s4</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;">s1</span><span style="color:#81A1C1;">+</span><span style="color:#D8DEE9FF;">s2</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> s5</span><span style="color:#81A1C1;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ab</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> s6</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9;">s4</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">intern</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">s3</span><span style="color:#81A1C1;">==</span><span style="color:#D8DEE9FF;">s4</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//false</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">s3</span><span style="color:#81A1C1;">==</span><span style="color:#D8DEE9FF;">s5</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//true</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">s3</span><span style="color:#81A1C1;">==</span><span style="color:#D8DEE9FF;">s6</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> x2</span><span style="color:#81A1C1;">=new</span><span style="color:#88C0D0;"> String</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">c</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">+new</span><span style="color:#88C0D0;"> String</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">d</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> x1</span><span style="color:#81A1C1;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">cd</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        x2</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">intern</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">x1</span><span style="color:#81A1C1;">==</span><span style="color:#D8DEE9FF;">x2</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//false</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> x4</span><span style="color:#81A1C1;">=new</span><span style="color:#88C0D0;"> String</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">e</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">+new</span><span style="color:#88C0D0;"> String</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">f</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        x4</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">intern</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> x3</span><span style="color:#81A1C1;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ef</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">x3</span><span style="color:#81A1C1;">==</span><span style="color:#D8DEE9FF;">x4</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-7-stringtable-位置" tabindex="-1"><a class="header-anchor" href="#_5-7-stringtable-位置"><span>5.7 StringTable 位置</span></a></h4><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806611.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><ul><li>JDK1.6 时，StringTable是属于<strong>常量池</strong>的一部分。</li><li>JDK1.8 以后，StringTable是放在<strong>堆</strong>中的。</li></ul><h4 id="_5-8-stringtable-垃圾回收" tabindex="-1"><a class="header-anchor" href="#_5-8-stringtable-垃圾回收"><span>5.8 StringTable 垃圾回收</span></a></h4><p>StringTable在内存紧张时，会发生垃圾回收</p><p>-Xmx10m 指定堆内存大小 -XX:+PrintStringTableStatistics 打印字符串常量池信息 -XX:+PrintGCDetails -verbose:gc 打印 gc 的次数，耗费时间等信息</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">/**</span></span>
<span class="line"><span style="color:#616E88;"> * 演示 StringTable 垃圾回收</span></span>
<span class="line"><span style="color:#616E88;"> * -Xmx10m -XX:+PrintStringTableStatistics -XX:+PrintGCDetails -verbose:gc</span></span>
<span class="line"><span style="color:#616E88;"> */</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Code_05_StringTableTest</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            for</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> j</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> j </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 10000</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> j</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span><span style="color:#616E88;"> // j = 100, j = 10000</span></span>
<span class="line"><span style="color:#D8DEE9;">                String</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">valueOf</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">j</span><span style="color:#ECEFF4;">).</span><span style="color:#88C0D0;">intern</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">                i</span><span style="color:#81A1C1;">++;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;">catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">Exception</span><span style="color:#D8DEE9;"> e</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">            e</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">printStackTrace</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;">finally</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-9-stringtable-性能调优" tabindex="-1"><a class="header-anchor" href="#_5-9-stringtable-性能调优"><span>5.9 StringTable 性能调优</span></a></h4><ul><li>因为StringTable是由HashTable实现的，所以可以适当增加HashTable桶的个数，来减少字符串放入串池所需要的时间</li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;">StringTableSize</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;">桶个数（最少设置为 </span><span style="color:#B48EAD;">1009</span><span style="color:#D8DEE9FF;"> 以上）</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>考虑是否需要将字符串对象入池 可以通过 intern 方法减少重复入池</li></ul><h2 id="_6-直接内存" tabindex="-1"><a class="header-anchor" href="#_6-直接内存"><span>6.直接内存</span></a></h2><h4 id="_6-1-定义" tabindex="-1"><a class="header-anchor" href="#_6-1-定义"><span>6.1 定义</span></a></h4><ul><li>属于操作系统，常见于NIO操作时，用于数据缓冲区</li><li>分配回收成本较高，但读写性能高</li><li>不受JVM内存回收管理</li></ul><h4 id="_6-2-使用直接内存的好处" tabindex="-1"><a class="header-anchor" href="#_6-2-使用直接内存的好处"><span>6.2 使用直接内存的好处</span></a></h4><p>文件读写流程：</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806759.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>因为 java 不能直接操作文件管理，需要切换到内核态，使用本地方法进行操作，然后读取磁盘文件，会在系统内存中创建一个缓冲区，将数据读到系统缓冲区， 然后在将系统缓冲区数据，复制到 java 堆内存中。缺点是数据存储了两份，在系统内存中有一份，java 堆中有一份，造成了不必要的复制。</p><p><strong>使用了 DirectBuffer 文件读取流程</strong></p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806509.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>直接内存是操作系统和 Java 代码都可以访问的一块区域，无需将代码从系统内存复制到 Java 堆内存，从而提高了效率。</p><h4 id="直接内存也会导致内存溢出" tabindex="-1"><a class="header-anchor" href="#直接内存也会导致内存溢出"><span><strong>直接<strong><strong>内存</strong></strong>也会导致内存溢出</strong></span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Main</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    static</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> _100MB</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 100</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> IOException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        List</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">ByteBuffer</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> list</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> ArrayList</span><span style="color:#ECEFF4;">&lt;&gt;()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            while</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">true</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">                ByteBuffer</span><span style="color:#D8DEE9;"> byteBuffer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> ByteBuffer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">allocateDirect</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">_100MB</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">                list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">byteBuffer</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">                i</span><span style="color:#81A1C1;">++;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;"> finally</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#616E88;">//输出：</span></span>
<span class="line"><span style="color:#B48EAD;">2</span></span>
<span class="line"><span style="color:#8FBCBB;">Exception</span><span style="color:#D8DEE9FF;"> in thread </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">main</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9;"> java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">OutOfMemoryError</span><span style="color:#81A1C1;">:</span><span style="color:#8FBCBB;"> Direct</span><span style="color:#D8DEE9FF;"> buffer memory</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        at </span><span style="color:#D8DEE9;">java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">nio</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Bits</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">reserveMemory</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">Bits</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">java</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;">694</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        at </span><span style="color:#D8DEE9;">java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">nio</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">DirectByteBuffer</span><span style="color:#ECEFF4;">.</span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9FF;">init</span><span style="color:#81A1C1;">&gt;</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">DirectByteBuffer</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">java</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;">123</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        at </span><span style="color:#D8DEE9;">java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">nio</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">ByteBuffer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">allocateDirect</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">ByteBuffer</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">java</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;">311</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        at </span><span style="color:#D8DEE9;">main</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Main</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">main</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">Main</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">java</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;">19</span><span style="color:#ECEFF4;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>直接<strong><strong>内存</strong></strong>释放原理</strong>：</p><p>直接内存的回收不是通过JVM的垃圾回收来释放的，而是通过<code>unsafe.freeMemory</code>来手动释放</p><p>通过申请直接内存，但JVM并不能回收直接内存中的内容，它是如何实现回收的呢？</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">//通过ByteBuffer申请1M的直接内存ByteBuffer byteBuffer = ByteBuffer.allocateDirect(_1M);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>allocateDirect的实现</strong>：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> static</span><span style="color:#8FBCBB;"> ByteBuffer</span><span style="color:#88C0D0;"> allocateDirect</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9FF;"> capacity</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span><span style="color:#81A1C1;">return</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> DirectByteBuffer</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">capacity</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>DirectByteBuffer类</strong>：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#88C0D0;">DirectByteBuffer</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9FF;"> cap</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span><span style="color:#616E88;">   // package-private</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    super</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">-</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> cap</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> cap</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    boolean</span><span style="color:#D8DEE9;"> pa</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> VM</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">isDirectMemoryPageAligned</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    int</span><span style="color:#D8DEE9;"> ps</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Bits</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">pageSize</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    long</span><span style="color:#D8DEE9;"> size</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Math</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">max</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1L</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">long</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;">cap </span><span style="color:#81A1C1;">+</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">pa </span><span style="color:#81A1C1;">?</span><span style="color:#D8DEE9FF;"> ps </span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    Bits</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">reserveMemory</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">size</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> cap</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    long</span><span style="color:#D8DEE9;"> base</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        base </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9;"> unsafe</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">allocateMemory</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">size</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> //申请内存</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">OutOfMemoryError</span><span style="color:#D8DEE9;"> x</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        Bits</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">unreserveMemory</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">size</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> cap</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        throw</span><span style="color:#D8DEE9FF;"> x</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#D8DEE9;">    unsafe</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setMemory</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">base</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> size</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">)</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">pa </span><span style="color:#81A1C1;">&amp;&amp;</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">base </span><span style="color:#81A1C1;">%</span><span style="color:#D8DEE9FF;"> ps </span><span style="color:#81A1C1;">!=</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">        // Round up to page boundary</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        address </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> base </span><span style="color:#81A1C1;">+</span><span style="color:#D8DEE9FF;"> ps </span><span style="color:#81A1C1;">-</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">base </span><span style="color:#81A1C1;">&amp;</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">ps </span><span style="color:#81A1C1;">-</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        address </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> base</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    cleaner </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9;"> Cleaner</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">create</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">this</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Deallocator</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">base</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> size</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> cap</span><span style="color:#ECEFF4;">))</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> //通过虚引用，来实现直接内存的释放，this为虚引用的实际对象</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    att </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> null;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里调用了一个Cleaner的create方法，且后台线程还会对虚引用的对象监测，如果虚引用的实际对象（这里是DirectByteBuffer）被回收以后，就会调用Cleaner的clean方法，来清除直接内存中占用的内存</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> clean</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#88C0D0;">remove</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">this</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">thunk</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">run</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> //调用run方法</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">final</span><span style="color:#8FBCBB;"> Throwable</span><span style="color:#D8DEE9;"> var2</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">            AccessController</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">doPrivileged</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#8FBCBB;"> PrivilegedAction</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">Void</span><span style="color:#ECEFF4;">&gt;()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">                public</span><span style="color:#8FBCBB;"> Void</span><span style="color:#88C0D0;"> run</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">                    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">err</span><span style="color:#81A1C1;"> !=</span><span style="color:#81A1C1;"> null</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">                        (</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> Error</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Cleaner terminated abnormally</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#88C0D0;"> var2</span><span style="color:#ECEFF4;">)).</span><span style="color:#88C0D0;">printStackTrace</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">                    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">                    System</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">exit</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">                    return</span><span style="color:#81A1C1;"> null;</span></span>
<span class="line"><span style="color:#ECEFF4;">                }</span></span>
<span class="line"><span style="color:#ECEFF4;">            })</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>run方法</strong>：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> run</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">address </span><span style="color:#81A1C1;">==</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">        // Paranoia</span></span>
<span class="line"><span style="color:#81A1C1;">        return;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#D8DEE9;">    unsafe</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">freeMemory</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">address</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> //释放直接内存中占用的内存</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    address </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    Bits</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">unreserveMemory</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">size</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> capacity</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>直接<strong><strong>内存</strong></strong>的回收机制总结</strong>：</p><ul><li>使用了 <code>Unsafe</code> 对象完成直接内存的分配回收，并且回收需要主动调用 <code>freeMemory</code> 方法</li><li><code>ByteBuffer</code> 的实现类内部，使用了 <code>Cleaner</code> （虚引用）来监测 ByteBuffer 对象，一旦 ByteBuffer 对象被垃圾回收，那么就会由 <code>ReferenceHandler</code> 线程通过 Cleaner 的 clean 方法调 用 freeMemory 来释放直接内存</li></ul><h4 id="_6-3-直接内存回收原理" tabindex="-1"><a class="header-anchor" href="#_6-3-直接内存回收原理"><span>6.3 直接内存回收原理</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Code_06_DirectMemoryTest</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> _1GB</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> IOException</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> NoSuchFieldException</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> IllegalAccessException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">//        method();</span></span>
<span class="line"><span style="color:#88C0D0;">        method1</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // 演示 直接内存 是被 unsafe 创建与回收</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> method1</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> IOException</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> NoSuchFieldException</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> IllegalAccessException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8FBCBB;">        Field</span><span style="color:#D8DEE9;"> field</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Unsafe</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getDeclaredField</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">theUnsafe</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        field</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setAccessible</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">true</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        Unsafe</span><span style="color:#D8DEE9;"> unsafe</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">Unsafe</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9;">field</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">Unsafe</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">        long</span><span style="color:#D8DEE9;"> base</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> unsafe</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">allocateMemory</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">_1GB</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        unsafe</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setMemory</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">base</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;">_1GB</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">)</span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">in</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">        unsafe</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">freeMemory</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">base</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">in</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // 演示 直接内存被 释放</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> method</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> IOException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        ByteBuffer</span><span style="color:#D8DEE9;"> byteBuffer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> ByteBuffer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">allocateDirect</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">_1GB</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">分配完毕</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">in</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">开始释放</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        byteBuffer </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> null;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">gc</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // 手动 gc</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">in</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#616E88;">/**</span></span>
<span class="line"><span style="color:#616E88;">     * -XX:+DisableExplicitGC 显示的</span></span>
<span class="line"><span style="color:#616E88;">     */</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> method</span><span style="color:#ECEFF4;">()</span><span style="color:#D8DEE9FF;"> throws IOException </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#8FBCBB;">        ByteBuffer</span><span style="color:#D8DEE9;"> byteBuffer</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> ByteBuffer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">allocateDirect</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">_1GB</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">分配完毕</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">in</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">开始释放</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        byteBuffer </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> null;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">gc</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // 手动 gc 失效</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">in</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>一般用 jvm 调优时，会加上下面的参数：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:+</span><span style="color:#D8DEE9FF;">DisableExplicitGC  </span><span style="color:#616E88;">// 静止显示的 GC</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>意思就是禁止我们手动的 GC，比如手动 System.gc() 无效，它是一种 full gc，会回收新生代、老年代，会造成程序执行的时间比较长。所以我们就通过 unsafe 对象调用 freeMemory 的方式释放内存。</p><h1 id="二、垃圾回收" tabindex="-1"><a class="header-anchor" href="#二、垃圾回收"><span>二、垃圾回收</span></a></h1><h2 id="_1-如何判断对象可以回收" tabindex="-1"><a class="header-anchor" href="#_1-如何判断对象可以回收"><span>1.如何判断对象可以回收</span></a></h2><h4 id="_1-1-引用计数法" tabindex="-1"><a class="header-anchor" href="#_1-1-引用计数法"><span>1.1 引用计数法</span></a></h4><ul><li>当一个对象被其他变量引用，该对象计数加一，当某个变量不在引用该对象，其计数减一</li><li>当一个对象引用没有被其他变量引用时，即计数变为0时，该对象就可以被回收</li></ul><h5 id="缺点-循环引用时-两个对象的计数都为1-导致两个对象都无法被释放" tabindex="-1"><a class="header-anchor" href="#缺点-循环引用时-两个对象的计数都为1-导致两个对象都无法被释放"><span><strong>缺点</strong>：循环引用时，两个对象的计数都为1，导致两个对象都无法被释放</span></a></h5><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806290.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h4 id="_1-2-可达性分析算法" tabindex="-1"><a class="header-anchor" href="#_1-2-可达性分析算法"><span>1.2 可达性分析算法</span></a></h4><ul><li>JVM中的垃圾回收器通过<strong>可达性分析</strong>来探索所有存活的对象</li><li>扫描堆中的对象，看能否沿着<strong>GC</strong> <strong>Root</strong>对象为起点的引用链找到该对象，如果<strong>找不到</strong>，则表示<strong>可以回收</strong></li></ul><h5 id="可以作为gc-root的对象" tabindex="-1"><a class="header-anchor" href="#可以作为gc-root的对象"><span>可以作为<strong>GC</strong> <strong>Root</strong>的对象</span></a></h5><ul><li>虚拟机栈（栈帧中的本地变量表）中引用的对象。</li><li>方法区中类静态属性引用的对象</li><li>方法区中常量引用的对象</li><li>本地方法栈中JNI（即一般说的Native方法）引用的对象</li><li>所有被同步锁（synchronized关键字）持有的对象。</li></ul><h5 id="使用memory-analyzer-mat-分析。" tabindex="-1"><a class="header-anchor" href="#使用memory-analyzer-mat-分析。"><span>使用Memory Analyzer (MAT)分析。</span></a></h5><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9FF;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> throws IOException </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8FBCBB;">        ArrayList</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">Object</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> list</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> ArrayList</span><span style="color:#ECEFF4;">&lt;&gt;()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">a</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">b</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">in</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">        list </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> null;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">in</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">end</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于以上代码，可以使用如下命令将堆内存信息转储成一个文件，然后使用 Eclipse Memory Analyzer 工具进行分析。 第一步： 使用 jps 命令，查看程序的进程</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806559.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>第二步：</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806527.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>使用 jmap -dump:format=b,live,file=1.bin 16104 命令转储文件 dump：转储文件 format=b：二进制文件 file：文件名 16104：进程的id 第三步：打开 Eclipse Memory Analyzer 对 1.bin 文件进行分析。</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806840.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>分析的 gc root，找到了 ArrayList 对象，然后将 list 置为null，再次转储，那么 list 对象就会被回收。</p><h4 id="_1-3-五种引用" tabindex="-1"><a class="header-anchor" href="#_1-3-五种引用"><span>1.3 五种引用</span></a></h4><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806056.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><ol><li><h5 id="强引用" tabindex="-1"><a class="header-anchor" href="#强引用"><span><strong>强引用</strong></span></a></h5><ul><li>只有所有 GC Roots 对象都不通过【强引用】引用该对象，该对象才能被垃圾回收</li></ul></li><li><h5 id="软引用" tabindex="-1"><a class="header-anchor" href="#软引用"><span><strong>软引用</strong></span></a></h5><ul><li>仅有【软引用】引用该对象时，在垃圾回收后，<strong>内存****仍不足</strong>时会再次出发垃圾回收，回收软引用对象</li><li>可以配合【引用队列】来释放软引用自身</li></ul></li><li><h5 id="弱引用" tabindex="-1"><a class="header-anchor" href="#弱引用"><span><strong>弱引用</strong></span></a></h5><ul><li>仅有【弱引用】引用该对象时，在垃圾回收时，<strong>无论<strong><strong>内存</strong></strong>是否充足</strong>，都会回收弱引用对象</li><li>可以配合【引用队列】来释放弱引用自身</li></ul></li><li><h5 id="虚引用" tabindex="-1"><a class="header-anchor" href="#虚引用"><span><strong>虚引用</strong></span></a></h5><ul><li>必须配合【引用队列】使用，主要配合 <code>ByteBuffer</code> 使用，被引用对象回收时，会将【虚引用】入队， 由 <code>Reference Handler</code> 线程调用虚引用相关方法释放【直接内存】</li><li>如上图，B对象不再引用<code>ByteBuffer</code>对象，<code>ByteBuffer</code>就会被回收。但是直接内存中的内存还未被回收。这时需要将虚引用对象<code>Cleaner</code>放入引用队列中，然后调用它的<code>clean</code>方法来释放直接内存</li></ul></li><li><h5 id="终结器引用" tabindex="-1"><a class="header-anchor" href="#终结器引用"><span><strong>终结器引用</strong></span></a></h5><ul><li>无需手动编码，但其内部配合【引用队列】使用，在垃圾回收时，【终结器引用】入队（被引用对象暂时没有被回收），再由 <code>Finalizer</code> 线程通过【终结器引用】找到被引用对象并调用它的 <code>finalize</code> 方法，第二次 GC 时才能回收被引用对象</li><li>如上图，B对象不再引用A4对象。这时终结器对象就会被放入引用队列中，引用队列会根据它，找到它所引用的对象。然后调用被引用对象的<code>finalize</code>方法。调用以后，该对象就可以被垃圾回收了</li></ul></li></ol><h5 id="软引用使用" tabindex="-1"><a class="header-anchor" href="#软引用使用"><span><strong>软引用使用</strong></span></a></h5><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Demo1</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">                final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> _4M</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 4</span><span style="color:#81A1C1;">*</span><span style="color:#B48EAD;">1024</span><span style="color:#81A1C1;">*</span><span style="color:#B48EAD;">1024</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">                //使用软引用对象 list和SoftReference是强引用，而SoftReference和byte数组则是软引用</span></span>
<span class="line"><span style="color:#8FBCBB;">                List</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">SoftReference</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;&gt;</span><span style="color:#D8DEE9;"> list</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> ArrayList</span><span style="color:#ECEFF4;">&lt;&gt;()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">                SoftReference</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;</span><span style="color:#D8DEE9;"> ref</span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> SoftReference</span><span style="color:#ECEFF4;">&lt;&gt;(</span><span style="color:#81A1C1;">new</span><span style="color:#81A1C1;"> byte</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">_4M</span><span style="color:#ECEFF4;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#616E88;">/**</span></span>
<span class="line"><span style="color:#616E88;"> * 演示 软引用</span></span>
<span class="line"><span style="color:#616E88;"> * -Xmx20m -XX:+PrintGCDetails -verbose:gc</span></span>
<span class="line"><span style="color:#616E88;"> */</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Code_08_SoftReferenceTest</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> _4MB</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 4</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> IOException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">        method2</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // 设置 -Xmx20m , 演示堆内存不足,</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> method1</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> IOException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        ArrayList</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;</span><span style="color:#D8DEE9;"> list</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> ArrayList</span><span style="color:#ECEFF4;">&lt;&gt;()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 5</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">            list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#81A1C1;"> byte</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">_4MB</span><span style="color:#ECEFF4;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">in</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // 演示 软引用</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> method2</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> IOException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        ArrayList</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">SoftReference</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;&gt;</span><span style="color:#D8DEE9;"> list</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> ArrayList</span><span style="color:#ECEFF4;">&lt;&gt;()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 5</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">            SoftReference</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;</span><span style="color:#D8DEE9;"> ref</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> SoftReference</span><span style="color:#ECEFF4;">&lt;&gt;(</span><span style="color:#81A1C1;">new</span><span style="color:#81A1C1;"> byte</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">_4MB</span><span style="color:#ECEFF4;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">ref</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">            list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">ref</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">size</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">循环结束：</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9;"> list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">size</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">SoftReference</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;</span><span style="color:#D8DEE9;"> ref</span><span style="color:#81A1C1;"> :</span><span style="color:#D8DEE9FF;"> list</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">ref</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>method1 方法解析： 首先会设置一个堆内存的大小为 20m，然后运行 mehtod1 方法，会抛异常，堆内存不足，因为 mehtod1 中的 list 都是强引用。</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806314.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>method2 方法解析： 在 list 集合中存放了 软引用对象，当内存不足时，会触发 full gc，将软引用的对象回收。细节如图：</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806561.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>上面的代码中，当软引用引用的对象被回收了，但是软引用还存在，所以，一般软引用需要搭配一个引用队列一起使用。</p><p>修改 method2 如下：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// 演示 软引用 搭配引用队列</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> method3</span><span style="color:#ECEFF4;">()</span><span style="color:#D8DEE9FF;"> throws IOException </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">        //使用软引用对象 list和SoftReference是强引用，而SoftReference和byte数组则是软引用</span></span>
<span class="line"><span style="color:#8FBCBB;">        ArrayList</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">SoftReference</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;&gt;</span><span style="color:#D8DEE9;"> list</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> ArrayList</span><span style="color:#ECEFF4;">&lt;&gt;()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        ///使用引用队列，用于移除引用为空的软引用对象</span></span>
<span class="line"><span style="color:#8FBCBB;">        ReferenceQueue</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;</span><span style="color:#D8DEE9;"> queue</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> ReferenceQueue</span><span style="color:#ECEFF4;">&lt;&gt;()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 5</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">            // 关联了引用队列，当软引用所关联的 byte[] 被回收时，软引用自己会加入到 queue 中去</span></span>
<span class="line"><span style="color:#8FBCBB;">            SoftReference</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;</span><span style="color:#D8DEE9;"> ref</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> SoftReference</span><span style="color:#ECEFF4;">&lt;&gt;(</span><span style="color:#81A1C1;">new</span><span style="color:#81A1C1;"> byte</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">_4MB</span><span style="color:#ECEFF4;">],</span><span style="color:#D8DEE9FF;"> queue</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">ref</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">            list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">ref</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">size</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        // 从队列中获取无用的 软引用对象，并移除</span></span>
<span class="line"><span style="color:#8FBCBB;">        Reference</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">?</span><span style="color:#81A1C1;"> extends</span><span style="color:#81A1C1;"> byte</span><span style="color:#ECEFF4;">[]&gt;</span><span style="color:#D8DEE9;"> poll</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> queue</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">poll</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        //遍历引用队列，如果有元素，则移除</span></span>
<span class="line"><span style="color:#81A1C1;">        while</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">poll </span><span style="color:#81A1C1;">!=</span><span style="color:#81A1C1;"> null</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">            list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">remove</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">poll</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">            poll </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9;"> queue</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">poll</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">=====================</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">SoftReference</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;</span><span style="color:#D8DEE9;"> ref</span><span style="color:#81A1C1;"> :</span><span style="color:#D8DEE9FF;"> list</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">ref</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806479.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h5 id="弱引用-使用" tabindex="-1"><a class="header-anchor" href="#弱引用-使用"><span><strong>弱引用****使用</strong></span></a></h5><p>弱引用的使用和软引用类似，只是将 <code>SoftReference</code> 换为了 <code>WeakReference</code></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Code_09_WeakReferenceTest</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">//        method1();</span></span>
<span class="line"><span style="color:#88C0D0;">        method2</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> _4MB</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 4</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;">1024</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // 演示 弱引用</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> method1</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        List</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">WeakReference</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;&gt;</span><span style="color:#D8DEE9;"> list</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> ArrayList</span><span style="color:#ECEFF4;">&lt;&gt;()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">            WeakReference</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;</span><span style="color:#D8DEE9;"> weakReference</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> WeakReference</span><span style="color:#ECEFF4;">&lt;&gt;(</span><span style="color:#81A1C1;">new</span><span style="color:#81A1C1;"> byte</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">_4MB</span><span style="color:#ECEFF4;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">            list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">weakReference</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">            for</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">WeakReference</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;</span><span style="color:#D8DEE9;"> wake</span><span style="color:#81A1C1;"> :</span><span style="color:#D8DEE9FF;"> list</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">                System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">print</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">wake</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> +</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">,</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // 演示 弱引用搭配 引用队列</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> method2</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        List</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">WeakReference</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;&gt;</span><span style="color:#D8DEE9;"> list</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> ArrayList</span><span style="color:#ECEFF4;">&lt;&gt;()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        ReferenceQueue</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;</span><span style="color:#D8DEE9;"> queue</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> ReferenceQueue</span><span style="color:#ECEFF4;">&lt;&gt;()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 9</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">            WeakReference</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;</span><span style="color:#D8DEE9;"> weakReference</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> WeakReference</span><span style="color:#ECEFF4;">&lt;&gt;(</span><span style="color:#81A1C1;">new</span><span style="color:#81A1C1;"> byte</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">_4MB</span><span style="color:#ECEFF4;">],</span><span style="color:#D8DEE9FF;"> queue</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">            list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">weakReference</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">            for</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">WeakReference</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;</span><span style="color:#D8DEE9;"> wake</span><span style="color:#81A1C1;"> :</span><span style="color:#D8DEE9FF;"> list</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">                System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">print</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">wake</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> +</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">,</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">===========================================</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        Reference</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">?</span><span style="color:#81A1C1;"> extends</span><span style="color:#81A1C1;"> byte</span><span style="color:#ECEFF4;">[]&gt;</span><span style="color:#D8DEE9;"> poll</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> queue</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">poll</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        while</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">poll </span><span style="color:#81A1C1;">!=</span><span style="color:#81A1C1;"> null</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">            list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">remove</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">poll</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">            poll </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9;"> queue</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">poll</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">WeakReference</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;</span><span style="color:#D8DEE9;"> wake</span><span style="color:#81A1C1;"> :</span><span style="color:#D8DEE9FF;"> list</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">print</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">wake</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> +</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">,</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-垃圾回收算法" tabindex="-1"><a class="header-anchor" href="#_2-垃圾回收算法"><span>2. 垃圾回收算法</span></a></h2><h4 id="_2-1-标记清除" tabindex="-1"><a class="header-anchor" href="#_2-1-标记清除"><span>2.1 标记清除</span></a></h4><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806087.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>定义</strong>：在虚拟机执行垃圾回收的过程中，先采用标记算法确定可回收对象，然后垃圾收集器根据标识清除相应的内容，给堆内存腾出相应的空间</p><blockquote><p>注意：这里的清除并不是将内存空间字节清零，而是记录这段内存的起始地址，下次分配内存的时候，会直接覆盖这段内存。</p></blockquote><p><strong>优点</strong>：速度快</p><p><strong>缺点</strong>：容易产生内存碎片。一旦分配较大内存的对象，由于内存不连续，导致无法分配，最后就会造成内存溢出问题</p><h4 id="_2-2-标记整理" tabindex="-1"><a class="header-anchor" href="#_2-2-标记整理"><span>2.2 标记整理</span></a></h4><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806182.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>定义</strong>：在虚拟机执行垃圾回收的过程中，先采用标记算法确定可回收对象，然后整理剩余的对象，将可用的对象移动到一起，使内存更加紧凑，连续的空间就更多。</p><p><strong>优点</strong>：不会有内存碎片</p><p><strong>缺点</strong>：整理时需要重新处理引用关系，速度慢</p><h4 id="_2-3-复制" tabindex="-1"><a class="header-anchor" href="#_2-3-复制"><span>2.3 复制</span></a></h4><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806969.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>定义</strong>：将内存分为等大小的两个区域，FROM和TO（TO中为空）。将被GC Root引用的对象从FROM放入TO中，再回收不被GC Root引用的对象。然后交换FROM和TO。这样也可以避免内存碎片的问题，但是会占用双倍的内存空间。</p><p><strong>优点</strong>：不会有内存碎片</p><p><strong>缺点</strong>：会占用双倍的内存空间。</p><h2 id="_3-分代垃圾回收" tabindex="-1"><a class="header-anchor" href="#_3-分代垃圾回收"><span>3. 分代垃圾回收</span></a></h2><p>将堆内存分为<strong>新生代</strong>和<strong>老年代</strong>，新生代有划分为<strong>伊甸园</strong>，<strong>幸存区To</strong>，<strong>幸存区From</strong>。</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806904.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h4 id="_3-1-回收流程" tabindex="-1"><a class="header-anchor" href="#_3-1-回收流程"><span>3.1 回收流程</span></a></h4><p>对象首先分配在伊甸园区域</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806959.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>新生代空间不足时，触发 <strong>Minor</strong> <strong>GC</strong>，伊甸园和 from 存活的对象使用 copy 复制到 to 中，存活的对象<strong>年龄加 1</strong>并且交换 from to</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806010.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806615.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806783.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>再次创建对象，若新生代的伊甸园又满了，则会再次触发 <strong>Minor</strong> <strong>GC</strong>（minor gc 会引发 <strong>stop the world（可以看下go语言的垃圾三色标记机制，减少STW）</strong>，暂停其它用户的线程，等垃圾回收结束，用户线程才恢复运行），这时不仅会回收伊甸园中的垃圾，<strong>还会回收幸存区中的垃圾</strong>，再将活跃对象复制到幸存区TO中。回收以后会交换两个幸存区，并让幸存区中的对象<strong>寿命加1</strong></p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806878.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>当对象寿命超过阈值时，会晋升至老年代，最大寿命是<strong>15</strong>（4bit），因为java对象头只用4个bit来表示，最大表示2进制1111。</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806958.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>当老年代空间不足，会先尝试触发<strong>Minor</strong> <strong>GC</strong>，如果之后空间仍不足，那么触发 <strong>Full GC</strong>，<strong>stop the world</strong>的时间更长</p><h4 id="_3-2-gc-分析" tabindex="-1"><a class="header-anchor" href="#_3-2-gc-分析"><span>3.2 GC 分析</span></a></h4><h5 id="相关vm参数" tabindex="-1"><a class="header-anchor" href="#相关vm参数"><span><strong>相关<strong><strong>VM</strong></strong>参数</strong></span></a></h5><p>含义参数堆初始大小-Xms堆最大大小-Xmx 或 -XX:MaxHeapSize=size新生代大小-Xmn 或 (-XX:NewSize=size + -XX:MaxNewSize=size )幸存区比例（动态）-XX:InitialSurvivorRatio=ratio 和 -XX:+UseAdaptiveSizePolicy幸存区比例-XX:SurvivorRatio=ratio晋升阈值-XX:MaxTenuringThreshold=threshold晋升详情-XX:+PrintTenuringDistributionGC详情-XX:+PrintGCDetails -verbose:gcFullGC 前 MinorGCXX:+ScavengeBeforeFullGC</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Code_10_GCTest</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> _512KB</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 512</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> _1MB</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> _6MB</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 6</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> _7MB</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 7</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> _8MB</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 8</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // -Xms20m -Xmx20m -Xmn10m -XX:+UseSerialGC -XX:+PrintGCDetails -verbose:gc</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        List</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;</span><span style="color:#D8DEE9;"> list</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> ArrayList</span><span style="color:#ECEFF4;">&lt;&gt;()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#81A1C1;"> byte</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">_6MB</span><span style="color:#ECEFF4;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#81A1C1;"> byte</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">_512KB</span><span style="color:#ECEFF4;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#81A1C1;"> byte</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">_6MB</span><span style="color:#ECEFF4;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#81A1C1;"> byte</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">_512KB</span><span style="color:#ECEFF4;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#81A1C1;"> byte</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">_6MB</span><span style="color:#ECEFF4;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过上面的代码，给 list 分配内存，来观察 新生代和老年代的情况，什么时候触发 minor gc，什么时候触发 full gc 等情况，使用前需要设置 jvm 参数。</p><h5 id="大对象处理策略" tabindex="-1"><a class="header-anchor" href="#大对象处理策略"><span><strong>大对象处理策略</strong></span></a></h5><p>遇到一个较大的对象时，就算新生代的伊甸园为空，也<strong>无法容纳该对象</strong>时，会将该对象<strong>直接晋升为老年代</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">/**</span></span>
<span class="line"><span style="color:#616E88;"> *  演示内存的分配策略</span></span>
<span class="line"><span style="color:#616E88;"> */</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Main</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> _512KB</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 512</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> _1MB</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> _6MB</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 6</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> _7MB</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 7</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> _8MB</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 8</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">    // -Xms20M -Xmx20M -Xmn10M -XX:+UseSerialGC -XX:+PrintGCDetails -verbose:gc -XX:-ScavengeBeforeFullGC</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> InterruptedException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        ArrayList</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;</span><span style="color:#D8DEE9;"> list</span><span style="color:#81A1C1;">=new</span><span style="color:#8FBCBB;"> ArrayList</span><span style="color:#ECEFF4;">&lt;&gt;()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#81A1C1;"> byte</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">_8MB</span><span style="color:#ECEFF4;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806023.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h5 id="线程内存溢出" tabindex="-1"><a class="header-anchor" href="#线程内存溢出"><span><strong>线程<strong><strong>内存</strong></strong>溢出</strong></span></a></h5><p>某个线程的内存溢出了而抛异常（out of memory），不会让其他的线程结束运行。这是因为当一个线程<strong>抛出<strong><strong>OOM</strong></strong>异常后</strong>，<strong>它所占据的内存资源会全部被释放掉</strong>，从而不会影响其他线程的运行，<strong>进程依然正常</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">/**</span></span>
<span class="line"><span style="color:#616E88;"> * 演示内存的分配策略</span></span>
<span class="line"><span style="color:#616E88;"> */</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Main</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> _512KB</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 512</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> _1MB</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> _6MB</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 6</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> _7MB</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 7</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> _8MB</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 8</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 1024</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // -Xms20M -Xmx20M -Xmn10M -XX:+UseSerialGC -XX:+PrintGCDetails -verbose:gc -XX:-ScavengeBeforeFullGC</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> InterruptedException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        new</span><span style="color:#88C0D0;"> Thread</span><span style="color:#ECEFF4;">(()</span><span style="color:#8FBCBB;"> -&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">            ArrayList</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#81A1C1;">byte</span><span style="color:#ECEFF4;">[]&gt;</span><span style="color:#D8DEE9;"> list</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> ArrayList</span><span style="color:#ECEFF4;">&lt;&gt;()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">            list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#81A1C1;"> byte</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">_8MB</span><span style="color:#ECEFF4;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">            list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#81A1C1;"> byte</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">_8MB</span><span style="color:#ECEFF4;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }).</span><span style="color:#88C0D0;">start</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">                //主线程还是会正常执行</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">sleep....</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        Thread</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1000L</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806120.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h2 id="_4-垃圾回收器" tabindex="-1"><a class="header-anchor" href="#_4-垃圾回收器"><span>4. 垃圾回收器</span></a></h2><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806464.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>垃圾收集器特点算法适用场景优点缺点Serial最基本、历史最悠久的单线程垃圾收集器。新生代采用标记-复制算法运行在 Client 模式下的虚拟机简单、高效垃圾回收时必须暂停其他所有的工作线程ParNewSerial 收集器的多线程版本新生代采用标记-复制算法运行在 Server 模式下的虚拟机并行，效率高 Parallel Scavenge使用标记-复制算法的多线程收集器，关注吞吐量新生代采用标记-复制算法JDK1.8 默认收集器在注重吞吐量及CPU资源的场合吞吐量高 Serial OldSerial 收集器的老年代版本标记-整理算法在 JDK&lt;1.5与 Parallel Scavenge 收集器搭配使用作为CMS收集器的后备方案简单、高效垃圾回收时必须暂停其他所有的工作线程Parallel OldParallel Scavenge 收集器的老年代标记-整理算法在注重吞吐量及CPU资源的场合吞吐量高 CMS多线程的垃圾收集器（用户线程和垃圾回收线程可以同时进行）标记-清除算法希望系统停顿时间最短，注重服务的响应速度的场景并发收集、低停顿对 CPU 资源敏感，无法处理浮动垃圾，产生垃圾碎片G1一款面向服务器的垃圾收集器，并行并发，空间整合，可预测的停顿时间标记-复制算法服务端应用、针对具有大内存多处理器的机器停顿时间可控、基本无空间碎片可能存在空间浪费、程序运行时的额外执行负载高</p><p><strong>相关概念</strong>：</p><ul><li><strong>并行****收集</strong>：指多条垃圾收集线程并行工作，但此时<strong>用户线程****仍处于等待状态</strong></li><li><strong>并发收集</strong>：指用户线程与垃圾收集线程<strong>同时工作</strong>（不一定是并行的可能会交替执行）。用户程序在继续运行，而垃圾收集程序运行在另一个CPU上</li><li><strong>吞吐量</strong>：即CPU用于<strong>运行用户代码的时间</strong>与CPU<strong>总消耗时间</strong>的比值（吞吐量 = 运行用户代码时间 / ( 运行用户代码时间 + 垃圾收集时间 )），也就是。例如：虚拟机共运行100分钟，垃圾收集器花掉1分钟，那么吞吐量就是99%</li></ul><h4 id="_4-1-串行-serial-serialold-新生代复制-老年代标记整理" tabindex="-1"><a class="header-anchor" href="#_4-1-串行-serial-serialold-新生代复制-老年代标记整理"><span>4.1 串行（Serial + SerialOld，新生代复制，老年代标记整理）</span></a></h4><ul><li>单线程</li><li>堆内存小，适合个人电脑</li></ul><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806544.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>开启串行回收器</strong>：</p><p><code>XX:+UseSerialGC = Serial + SerialOld</code>，新生代<strong>Serial</strong> ，老年代<strong>SerialOld</strong></p><p><strong>安全点</strong>：让其他线程都在这个点停下来，以免垃圾回收时移动对象地址，使得其他线程找不到被移动的对象。</p><p><strong>阻塞</strong>：因为是串行的，所以只有一个垃圾回收线程。且在该线程执行回收工作时，其他线程进入<strong>阻塞</strong>状态</p><p><strong>Serial 收集器</strong>：</p><ul><li>定义：Serial收集器是最基本的、发展历史最悠久的收集器</li><li>特点：<strong>单线程</strong>收集器。采用<strong>复制</strong>算法。工作在<strong>新生代</strong></li><li>Serial 收集器是最基本的、发展历史最悠久的收集器 <strong>特点</strong>：单线程、简单高效（与其他收集器的单线程相比），采用复制算法。对于限定单个 CPU 的环境来说，Serial 收集器由于没有线程交互的开销，专心做垃圾收集自然可以获得最高的单线程收集效率。收集器进行垃圾回收时，必须暂停其他所有的工作线程，直到它结束（Stop The World）！</li></ul><p><strong>Serial Old收集器</strong>：</p><ul><li>定义：Serial Old是Serial收集器的老年代版本</li><li>特点：<strong>单线程</strong>收集器。采用<strong>标记-整理</strong>算法。工作在<strong>老年代</strong></li><li>同样是单线程收集器，采用标记-整理算法</li></ul><p><strong>ParNew 收集器</strong> ParNew 收集器其实就是 Serial 收集器的多线程版本 <strong>特点</strong>：多线程、ParNew 收集器默认开启的收集线程数与CPU的数量相同，在 CPU 非常多的环境中，可以使用 -XX:ParallelGCThreads 参数来限制垃圾收集的线程数。和 Serial 收集器一样存在 Stop The World 问题</p><h4 id="_4-2-吞吐量优先" tabindex="-1"><a class="header-anchor" href="#_4-2-吞吐量优先"><span>4.2 吞吐量优先</span></a></h4><ul><li>多线程</li><li>堆内存较大，多核cpu</li><li>让<strong>单位时间****内</strong>暂停时间（STW）最短</li><li><strong>JDK1.8默认使用</strong>的垃圾回收器</li></ul><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806723.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:+</span><span style="color:#D8DEE9FF;">UseParallelGC </span><span style="color:#81A1C1;">~</span><span style="color:#81A1C1;"> -</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:+</span><span style="color:#8FBCBB;">UsePrallerOldGC</span></span>
<span class="line"><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:+</span><span style="color:#8FBCBB;">UseAdaptiveSizePolicy</span></span>
<span class="line"><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;">GCTimeRatio</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;">ratio </span><span style="color:#616E88;">// 1/(1+radio)</span></span>
<span class="line"><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;">MaxGCPauseMillis</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;">ms </span><span style="color:#616E88;">// 200ms</span></span>
<span class="line"><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;">ParallelGCThreads</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;">n</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Parallel 收集器</strong>：</p><ul><li>定义：与吞吐量关系密切，故也称为吞吐量优先收集器</li><li>特点：<strong>并行****的</strong>，工作于<strong>新生代</strong>，采用<strong>复制</strong>算法</li><li>与吞吐量关系密切，故也称为吞吐量优先收集器 <strong>特点</strong>：属于新生代收集器也是采用复制算法的收集器（用到了新生代的幸存区），又是并行的多线程收集器（与 ParNew 收集器类似）</li><li>该收集器的目标是达到一个可控制的吞吐量。还有一个值得关注的点是：GC自适应调节策略（与 ParNew 收集器最重要的一个区别）</li><li>GC自适应调节策略： Parallel Scavenge 收集器可设置 -XX:+UseAdptiveSizePolicy 参数。 当开关打开时不需要手动指定新生代的大小（-Xmn）、Eden 与 Survivor 区的比例（-XX:SurvivorRation）、 晋升老年代的对象年龄（-XX:PretenureSizeThreshold）等，虚拟机会根据系统的运行状况收集性能监控信息，动态设置这些参数以提供最优的停顿时间和最高的吞吐量，这种调节方式称为 GC 的自适应调节策略。</li></ul><p>Parallel Scavenge 收集器使用两个参数控制吞吐量：</p><ul><li>XX:MaxGCPauseMillis=ms 控制最大的垃圾收集停顿时间（默认200ms）</li><li>XX:GCTimeRatio=rario 直接设置吞吐量的大小</li></ul><p><strong>Parallel Old 收集器</strong>：</p><ul><li>定义：是Parallel 收集器的老年代版本</li><li>特点：<strong>并行****的</strong>，工作与<strong>老年代</strong>，采用<strong>标记-整理算法</strong></li><li>是 Parallel Scavenge 收集器的老年代版本 <strong>特点</strong>：多线程，采用标记-整理算法（老年代没有幸存区）</li></ul><h4 id="_4-3-响应时间优先" tabindex="-1"><a class="header-anchor" href="#_4-3-响应时间优先"><span>4.3 响应时间优先</span></a></h4><ul><li>多线程</li><li>堆内存较大，多核cpu</li><li>尽可能让<strong>单次的</strong>暂停时间（STW）最短</li></ul><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806901.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:+</span><span style="color:#D8DEE9FF;">UseConcMarkSweepGC </span><span style="color:#81A1C1;">~</span><span style="color:#81A1C1;"> -</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:+</span><span style="color:#D8DEE9FF;">UseParNewGC </span><span style="color:#81A1C1;">~</span><span style="color:#8FBCBB;"> SerialOld</span></span>
<span class="line"><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;">ParallelGCThreads</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;">n </span><span style="color:#81A1C1;">~</span><span style="color:#81A1C1;"> -</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;">ConcGCThreads</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;">threads</span></span>
<span class="line"><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;">CMSInitiatingOccupancyFraction</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;">percent</span></span>
<span class="line"><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:+</span><span style="color:#8FBCBB;">CMSScavengeBeforeRemark</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>CMS****收集器</strong>：</p><ul><li>定义：Concurrent Mark Sweep（并发，标记，清除）</li><li>特点：基于<strong>标记-清除</strong>算法的垃圾回收器。是并发的。工作在<strong>老年代</strong>。</li><li>Concurrent Mark Sweep，一种以获取最短回收停顿时间为目标的<strong>老年代收集器</strong> <strong>特点</strong>：基于标记-清除算法实现。并发收集、低停顿，但是会产生内存碎片 <strong>应用场景</strong>：适用于注重服务的响应速度，希望系统停顿时间最短，给用户带来更好的体验等场景下。如 web 程序、b/s 服务</li></ul><p><strong>CMS</strong> <strong>收集器的运行过程分为下列4步：</strong></p><ul><li><strong>初始标记</strong>：标记 GC Roots 能直接到的对象。速度很快但是仍存在 Stop The World 问题。</li><li><strong>并发标记</strong>：进行 GC Roots Tracing 的过程，找出存活对象且用户线程可并发执行。</li><li><strong>重新标记</strong>：为了修正并发标记期间因用户程序继续运行而导致标记产生变动的那一部分对象的标记记录。仍然存在 Stop The World 问题</li><li><strong>并发清除</strong>：对标记的对象进行清除回收，清除的过程中，可能任然会有新的垃圾产生，这些垃圾就叫浮动垃圾，如果当用户需要存入一个很大的对象时，新生代放不下去，老年代由于浮动垃圾过多，就会退化为 serial Old 收集器，将老年代垃圾进行标记-整理，当然这也是很耗费时间的！</li></ul><p>CMS 收集器的内存回收过程是与用户线程一起并发执行的，可以搭配 ParNew 收集器（多线程，新生代，复制算法）与 Serial Old 收集器（单线程，老年代，标记-整理算法）使用。</p><p><strong>ParNew 收集器</strong>：</p><ul><li>定义：ParNew收集器其实就是Serial收集器的多线程版本</li><li>特点：工作在<strong>新生代</strong>，基于<strong>复制</strong>算法的垃圾回收器。</li></ul><h4 id="_4-4-garbage-first" tabindex="-1"><a class="header-anchor" href="#_4-4-garbage-first"><span>4.4 Garbage First</span></a></h4><ul><li>JDK 9以后默认使用，而且替代了CMS 收集器</li></ul><p><strong>适用场景</strong>：</p><ul><li>同时注重<strong>吞吐量****（<strong><strong>Throughput</strong></strong>）和****低延迟</strong>（Low latency），默认的暂停目标是 200 ms</li><li>超大堆内存，会将堆划分为多个<strong>大小相等</strong>的 <strong>Region</strong></li><li>整体上是 <strong>标记+整理</strong> 算法，两个区域之间是 <strong>复制</strong> 算法</li></ul><p><strong>相关参数：</strong> JDK8 并不是默认开启的，所需要参数开启</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:+</span><span style="color:#8FBCBB;">UseG1GC</span></span>
<span class="line"><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;">G1HeapRegionSize</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;">size</span></span>
<span class="line"><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;">MaxGCPauseMillis</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;">time</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>垃圾回收****阶段</strong>：</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806946.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>新生代伊甸园垃圾回收—–&gt;内存不足，新生代回收+并发标记—–&gt;混合收集，回收新生代伊甸园、幸存区、老年代内存——&gt;新生代伊甸园垃圾回收（重新开始）</p><p>Young Collection：对新生代垃圾收集 Young Collection + Concurrent Mark：如果老年代内存到达一定的阈值了，新生代垃圾收集同时会执行一些并发的标记。 Mixed Collection：会对新生代 + 老年代 + 幸存区等进行混合收集，然后收集结束，会重新进入新生代收集。</p><h5 id="young-collection" tabindex="-1"><a class="header-anchor" href="#young-collection"><span>Young Collection</span></a></h5><p><strong>新生代存在 STW：</strong> 分代是按对象的生命周期划分，分区则是将堆空间划分连续几个不同小区间，每一个小区间独立回收，可以控制一次回收多少个小区间，方便控制 GC 产生的停顿时间！ E：eden，S：幸存区，O：老年代 新生代收集会产生 STW ！</p><p>E：伊甸园 S：幸存区 O：老年代</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806753.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806075.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806106.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h5 id="young-collection-cm" tabindex="-1"><a class="header-anchor" href="#young-collection-cm"><span><strong>Young Collection +</strong> <strong>CM</strong>：</span></a></h5><ul><li>CM：并发标记</li><li>在 Young GC 时会<strong>对 GC Root 进行初始标记</strong></li><li>在老年代<strong>占用<strong><strong>堆内存</strong></strong>的比例</strong>达到阈值时，对进行并发标记（不会STW），阈值可以根据用户来进行设定，由下面的 JVM 参数决定 -XX:InitiatingHeapOccupancyPercent=percent （默认45%）</li></ul><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806741.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h5 id="mixed-collection" tabindex="-1"><a class="header-anchor" href="#mixed-collection"><span><strong>Mixed Collection</strong></span></a></h5><p>会对E S O 进行<strong>全面的回收</strong></p><ul><li>最终标记（Remark）会STW</li><li>拷贝存活（Evacuation）会STW</li><li><code>-XX:MaxGCPauseMills:xxx</code> ：用于指定最长的停顿时间</li></ul><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806880.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><blockquote><p><strong>问</strong>：为什么有的老年代被拷贝了，有的没拷贝？</p><p>因为指定了最大停顿时间，如果对所有老年代都进行回收，耗时可能过高。为了保证时间不超过设定的停顿时间，会<strong>回收最有价值的老年代</strong>（回收后，能够得到更多内存）</p></blockquote><h5 id="full-gc" tabindex="-1"><a class="header-anchor" href="#full-gc"><span><strong>Full</strong> <strong>GC</strong></span></a></h5><ul><li><strong>SerialGC</strong><ul><li>新生代内存不足发生的垃圾收集 - minor gc</li><li>老年代内存不足发生的垃圾收集 - full gc</li></ul></li><li><strong>ParallelGC</strong><ul><li>新生代内存不足发生的垃圾收集 - minor gc</li><li>老年代内存不足发生的垃圾收集 - full gc</li></ul></li><li><strong>CMS</strong><ul><li>新生代内存不足发生的垃圾收集 - minor gc</li><li>老年代内存不足</li></ul></li><li><strong>G1</strong><ul><li>新生代内存不足发生的垃圾收集 - minor gc</li><li>老年代内存不足（老年代所占内存超过阈值） <ul><li>如果垃圾产生速度慢于垃圾回收速度，不会触发Full GC，还是并发地进行清理</li><li>如果垃圾产生速度快于垃圾回收速度，便会触发Full GC，然后退化成 serial Old 收集器串行的收集，就会导致停顿的时候长。</li></ul></li></ul></li></ul><h5 id="young-collection-跨代引用" tabindex="-1"><a class="header-anchor" href="#young-collection-跨代引用"><span>Young Collection 跨代引用</span></a></h5><ul><li>新生代回收的跨代引用（老年代引用新生代）问题</li></ul><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806753.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><ul><li>卡表：老年代被划为一个个卡表</li><li>Remembered Set：Remembered Set 存在于E（新生代）中，用于保存新生代对象对应的脏卡</li><li>脏卡：O被划分为多个区域（一个区域512K），如果该区域引用了新生代对象，则该区域被称为脏卡</li><li>在引用变更时通过post-write barried + dirty card queue</li><li>concurrent refinement threads 更新 Remembered Set</li></ul><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806868.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h5 id="remark" tabindex="-1"><a class="header-anchor" href="#remark"><span><strong>Remark</strong></span></a></h5><p>重新标记阶段 在垃圾回收时，收集器处理对象的过程中</p><ul><li>黑色：已被处理，需要保留的</li><li>灰色：正在处理中的</li><li>白色：还未处理的</li></ul><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806873.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806924.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806440.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>但是在<strong>并发标记过程中</strong>，有可能黑色A被处理了以后未引用C，后面又引用了C，这时就会用到remark</p><ul><li>之前C未被引用，这时A引用了C，就会给C加一个写屏障，写屏障的指令会被执行，将C放入一个队列当中，并将C变为 处理中 状态</li><li>在<strong>并发标记</strong>阶段结束以后，重新标记阶段会STW，然后将放在该队列中的对象重新处理，发现有强引用引用它，就会处理它</li></ul><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806424.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806496.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h5 id="jdk-8u20-字符串去重" tabindex="-1"><a class="header-anchor" href="#jdk-8u20-字符串去重"><span><strong>JDK 8u20 字符串去重</strong>：</span></a></h5><ul><li>优点：节省大量内存</li><li>缺点：略微多占用了 cpu 时间，新生代回收时间略微增加</li></ul><p>例如：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#8FBCBB;">String</span><span style="color:#D8DEE9;"> s1</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> String</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">hello</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // char[]{&#39;h&#39;,&#39;e&#39;,&#39;l&#39;,&#39;l&#39;,&#39;o&#39;}</span></span>
<span class="line"><span style="color:#8FBCBB;">String</span><span style="color:#D8DEE9;"> s2</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> String</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">hello</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // char[]{&#39;h&#39;,&#39;e&#39;,&#39;l&#39;,&#39;l&#39;,&#39;o&#39;}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>将所有新分配的字符串（底层是char[]）放入一个队列</li><li>当新生代回收时，G1并发检查是否有重复的字符串</li><li>如果字符串的值一样，就让他们<strong>引用同一个字符串对象</strong></li><li>注意，其与String.intern的区别 <ul><li>intern关注的是字符串对象</li><li>字符串去重关注的是char[]</li><li>在JVM内部，使用了不同的字符串表</li></ul></li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:+</span><span style="color:#8FBCBB;">UseStringDeduplication</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h5 id="jdk-8u40-并发标记类卸载" tabindex="-1"><a class="header-anchor" href="#jdk-8u40-并发标记类卸载"><span><strong>JDK 8u40 并发标记类卸载</strong></span></a></h5><p>所有对象都经过并发标记后，就能知道哪些类不再被使用，当一个类加载器的所有类都不再使用，则卸载它所加载的所有类</p><p><code>-XX:+ClassUnloadingWithConcurrentMark</code> 默认启用</p><h5 id="jdk-8u60-回收巨型对象" tabindex="-1"><a class="header-anchor" href="#jdk-8u60-回收巨型对象"><span>JDK 8u60 回收巨型对象</span></a></h5><ul><li>一个对象大于region的一半时，就称为巨型对象</li><li>G1不会对巨型对象进行拷贝</li><li>回收时被优先考虑</li><li>G1会跟踪老年代所有incoming引用，如果老年代incoming引用为0的巨型对象就可以在新生代垃圾回收时处理掉</li></ul><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806602.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>JDK 9 并发标记起始时间的调整</strong>：</p><ul><li>并发标记必须在堆空间占满前完成，否则退化为 FullGC</li><li>JDK 9 之前需要使用 <code>-XX:InitiatingHeapOccupancyPercent</code></li><li>JDK 9 可以动态调整 <ul><li><code>-XX:InitiatingHeapOccupancyPercent</code> 用来设置初始值</li><li>进行数据采样并动态调整</li><li>总会添加一个安全的空档空间</li></ul></li></ul><h2 id="_5-垃圾回收调优" tabindex="-1"><a class="header-anchor" href="#_5-垃圾回收调优"><span>5. 垃圾回收调优</span></a></h2><p>查看虚拟机参数命令</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">D</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;">\\</span><span style="color:#D8DEE9;">JavaJDK1</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">8</span><span style="color:#D8DEE9FF;">\\bin\\java  </span><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:+</span><span style="color:#D8DEE9FF;">PrintFlagsFinal </span><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">version </span><span style="color:#81A1C1;">|</span><span style="color:#D8DEE9FF;"> findstr </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">GC</span><span style="color:#ECEFF4;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>可以根据参数去查询具体的信息</p><h4 id="_5-1-调优领域" tabindex="-1"><a class="header-anchor" href="#_5-1-调优领域"><span>5.1 调优领域</span></a></h4><ul><li>内存</li><li>锁竞争</li><li>cpu 占用</li><li>io</li><li>gc</li></ul><h4 id="_5-2-确定目标" tabindex="-1"><a class="header-anchor" href="#_5-2-确定目标"><span>5.2 确定目标</span></a></h4><p>低延迟/高吞吐量？ 选择合适的GC，科学运算注重吞吐量，互联网注重低延迟。</p><ul><li>CMS G1 ZGC，低延迟</li><li>ParallelGC，高吞吐量</li><li>Zing</li></ul><h4 id="_5-3-最快的-gc是不发生gc" tabindex="-1"><a class="header-anchor" href="#_5-3-最快的-gc是不发生gc"><span>5.3 最快的 GC是不发生GC</span></a></h4><p>首先排除减少因为自身编写的代码而引发的内存问题</p><ul><li>查看 Full GC 前后的内存占用，考虑以下几个问题 <ul><li>数据是不是太多？ <ul><li>resultSet = statement.executeQuery(“select * from 大表 limit n”)</li></ul></li><li>数据表示是否太臃肿 <ul><li>对象图</li><li>对象大小 16 Integer 24 int 4</li></ul></li><li>是否存在内存泄漏 <ul><li>static Map map …</li><li>软</li><li>弱</li><li>第三方缓存实现 redis......</li></ul></li></ul></li></ul><h4 id="_5-4-新生代调优" tabindex="-1"><a class="header-anchor" href="#_5-4-新生代调优"><span>5.4 新生代调优</span></a></h4><ul><li>新生代的特点 <ul><li>所有的 new 操作分配内存都是非常廉价的 <ul><li>TLAB thread-local allocation buffer（可防止多个线程创建对象时的干扰）</li></ul></li><li>死亡对象回收零代价</li><li>大部分对象用过即死（朝生夕死）</li><li>Minor GC 所用时间远小于 Full GC</li></ul></li><li>新生代内存越大越好么？ <ul><li>不是 <ul><li>新生代内存太小：频繁触发 Minor GC ，会 STW ，会使得吞吐量下降</li><li>新生代内存太大：老年代内存占比有所降低，会更频繁地触发 Full GC。而且触发 Minor GC 时，清理新生代所花费的时间会更长</li></ul></li><li>新生代内存设置为内容纳[并发量*(请求-响应)]的数据为宜</li></ul></li></ul><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806701.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><ul><li>幸存区需要能够保存 当前活跃对象+需要晋升的对象</li><li>晋升阈值配置得当，让长时间存活的对象尽快晋升</li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;">MaxTenuringThreshold</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;">threshold</span></span>
<span class="line"><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:+</span><span style="color:#8FBCBB;">PrintTenuringDistrubution</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-5-老年代调优" tabindex="-1"><a class="header-anchor" href="#_5-5-老年代调优"><span>5.5 老年代调优</span></a></h4><p>以 CMS 为例：</p><ul><li>CMS 的老年代内存越大越好</li><li>先尝试不做调优，如果没有 Full GC 那么已经，否者先尝试调优新生代。</li><li>观察发现 Full GC 时老年代内存占用，将老年代内存预设调大 1/4 ~ 1/3</li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">XX</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;">CMSInitiatingOccupancyFraction</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;">percent</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_5-6-案例" tabindex="-1"><a class="header-anchor" href="#_5-6-案例"><span>5.6 案例</span></a></h4><p>案例1：Full GC 和 Minor GC 频繁 案例2：请求高峰期发生 Full GC，单次暂停时间特别长（CMS） 案例3：老年代充裕情况下，发生 Full GC（jdk1.7）</p><h1 id="三、类加载与字节码技术" tabindex="-1"><a class="header-anchor" href="#三、类加载与字节码技术"><span>三、类加载与字节码技术</span></a></h1><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806770.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h2 id="_1-类文件结构" tabindex="-1"><a class="header-anchor" href="#_1-类文件结构"><span>1. 类文件结构</span></a></h2><p>一个简单的 <code>HelloWorld.java</code></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// HelloWorld 示例</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> HelloWorld</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">hello world</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行 <code>javac -parameters -d . HellowWorld.java</code></p><blockquote><p>Linux 为：od -t xC HelloWorld.class</p></blockquote><p>编译为 <code>HelloWorld.class</code> 得到的<strong>字节码文件</strong>是这个样子的：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#B48EAD;">0000000</span><span style="color:#D8DEE9FF;"> ca fe ba be </span><span style="color:#B48EAD;">00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 34</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 23</span><span style="color:#D8DEE9FF;"> 0a </span><span style="color:#B48EAD;">00</span><span style="color:#B48EAD;"> 06</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 15</span><span style="color:#D8DEE9FF;"> 09 </span></span>
<span class="line"><span style="color:#B48EAD;">0000020</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 16</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 17</span><span style="color:#D8DEE9FF;"> 08 </span><span style="color:#B48EAD;">00</span><span style="color:#B48EAD;"> 18</span><span style="color:#D8DEE9FF;"> 0a </span><span style="color:#B48EAD;">00</span><span style="color:#B48EAD;"> 19</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 1a </span><span style="color:#B48EAD;">07</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 1b </span><span style="color:#B48EAD;">07</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000040</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 1c </span><span style="color:#B48EAD;">01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 06</span><span style="color:#D8DEE9FF;"> 3c </span><span style="color:#B48EAD;">69</span><span style="color:#D8DEE9FF;"> 6e </span><span style="color:#B48EAD;">69</span><span style="color:#B48EAD;"> 74</span><span style="color:#D8DEE9FF;"> 3e </span><span style="color:#B48EAD;">01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 03</span><span style="color:#B48EAD;"> 28</span><span style="color:#B48EAD;"> 29</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000060</span><span style="color:#B48EAD;"> 56</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 04</span><span style="color:#B48EAD;"> 43</span><span style="color:#B48EAD;"> 6f</span><span style="color:#B48EAD;"> 64</span><span style="color:#B48EAD;"> 65</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 0f</span><span style="color:#D8DEE9FF;"> 4c </span><span style="color:#B48EAD;">69</span><span style="color:#D8DEE9FF;"> 6e </span><span style="color:#B48EAD;">65</span><span style="color:#D8DEE9FF;"> 4e </span></span>
<span class="line"><span style="color:#B48EAD;">0000100</span><span style="color:#B48EAD;"> 75</span><span style="color:#B48EAD;"> 6d</span><span style="color:#B48EAD;"> 62</span><span style="color:#B48EAD;"> 65</span><span style="color:#B48EAD;"> 72</span><span style="color:#B48EAD;"> 54</span><span style="color:#B48EAD;"> 61</span><span style="color:#B48EAD;"> 62</span><span style="color:#D8DEE9FF;"> 6c </span><span style="color:#B48EAD;">65</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 12</span><span style="color:#D8DEE9FF;"> 4c </span><span style="color:#B48EAD;">6f</span><span style="color:#B48EAD;"> 63</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000120</span><span style="color:#B48EAD;"> 61</span><span style="color:#D8DEE9FF;"> 6c </span><span style="color:#B48EAD;">56</span><span style="color:#B48EAD;"> 61</span><span style="color:#B48EAD;"> 72</span><span style="color:#B48EAD;"> 69</span><span style="color:#B48EAD;"> 61</span><span style="color:#B48EAD;"> 62</span><span style="color:#D8DEE9FF;"> 6c </span><span style="color:#B48EAD;">65</span><span style="color:#B48EAD;"> 54</span><span style="color:#B48EAD;"> 61</span><span style="color:#B48EAD;"> 62</span><span style="color:#D8DEE9FF;"> 6c </span><span style="color:#B48EAD;">65</span><span style="color:#B48EAD;"> 01</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000140</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 04</span><span style="color:#B48EAD;"> 74</span><span style="color:#B48EAD;"> 68</span><span style="color:#B48EAD;"> 69</span><span style="color:#B48EAD;"> 73</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 1d</span><span style="color:#D8DEE9FF;"> 4c </span><span style="color:#B48EAD;">63</span><span style="color:#D8DEE9FF;"> 6e </span><span style="color:#B48EAD;">2f</span><span style="color:#B48EAD;"> 69</span><span style="color:#B48EAD;"> 74</span><span style="color:#B48EAD;"> 63</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000160</span><span style="color:#B48EAD;"> 61</span><span style="color:#B48EAD;"> 73</span><span style="color:#B48EAD;"> 74</span><span style="color:#B48EAD;"> 2f</span><span style="color:#D8DEE9FF;"> 6a </span><span style="color:#B48EAD;">76</span><span style="color:#B48EAD;"> 6d</span><span style="color:#B48EAD;"> 2f</span><span style="color:#B48EAD;"> 74</span><span style="color:#B48EAD;"> 35</span><span style="color:#B48EAD;"> 2f</span><span style="color:#B48EAD;"> 48</span><span style="color:#B48EAD;"> 65</span><span style="color:#D8DEE9FF;"> 6c 6c </span><span style="color:#B48EAD;">6f</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000200</span><span style="color:#B48EAD;"> 57</span><span style="color:#B48EAD;"> 6f</span><span style="color:#B48EAD;"> 72</span><span style="color:#D8DEE9FF;"> 6c </span><span style="color:#B48EAD;">64</span><span style="color:#D8DEE9FF;"> 3b </span><span style="color:#B48EAD;">01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 04</span><span style="color:#B48EAD;"> 6d</span><span style="color:#B48EAD;"> 61</span><span style="color:#B48EAD;"> 69</span><span style="color:#D8DEE9FF;"> 6e </span><span style="color:#B48EAD;">01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 16</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000220</span><span style="color:#B48EAD;"> 28</span><span style="color:#D8DEE9FF;"> 5b 4c 6a </span><span style="color:#B48EAD;">61</span><span style="color:#B48EAD;"> 76</span><span style="color:#B48EAD;"> 61</span><span style="color:#B48EAD;"> 2f</span><span style="color:#D8DEE9FF;"> 6c </span><span style="color:#B48EAD;">61</span><span style="color:#D8DEE9FF;"> 6e </span><span style="color:#B48EAD;">67</span><span style="color:#B48EAD;"> 2f</span><span style="color:#B48EAD;"> 53</span><span style="color:#B48EAD;"> 74</span><span style="color:#B48EAD;"> 72</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000240</span><span style="color:#B48EAD;"> 69</span><span style="color:#D8DEE9FF;"> 6e </span><span style="color:#B48EAD;">67</span><span style="color:#D8DEE9FF;"> 3b </span><span style="color:#B48EAD;">29</span><span style="color:#B48EAD;"> 56</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 04</span><span style="color:#B48EAD;"> 61</span><span style="color:#B48EAD;"> 72</span><span style="color:#B48EAD;"> 67</span><span style="color:#B48EAD;"> 73</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 13</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000260</span><span style="color:#D8DEE9FF;"> 5b 4c 6a </span><span style="color:#B48EAD;">61</span><span style="color:#B48EAD;"> 76</span><span style="color:#B48EAD;"> 61</span><span style="color:#B48EAD;"> 2f</span><span style="color:#D8DEE9FF;"> 6c </span><span style="color:#B48EAD;">61</span><span style="color:#D8DEE9FF;"> 6e </span><span style="color:#B48EAD;">67</span><span style="color:#B48EAD;"> 2f</span><span style="color:#B48EAD;"> 53</span><span style="color:#B48EAD;"> 74</span><span style="color:#B48EAD;"> 72</span><span style="color:#B48EAD;"> 69</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000300</span><span style="color:#D8DEE9FF;"> 6e </span><span style="color:#B48EAD;">67</span><span style="color:#D8DEE9FF;"> 3b </span><span style="color:#B48EAD;">01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 10</span><span style="color:#B48EAD;"> 4d</span><span style="color:#B48EAD;"> 65</span><span style="color:#B48EAD;"> 74</span><span style="color:#B48EAD;"> 68</span><span style="color:#B48EAD;"> 6f</span><span style="color:#B48EAD;"> 64</span><span style="color:#B48EAD;"> 50</span><span style="color:#B48EAD;"> 61</span><span style="color:#B48EAD;"> 72</span><span style="color:#B48EAD;"> 61</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000320</span><span style="color:#B48EAD;"> 6d</span><span style="color:#B48EAD;"> 65</span><span style="color:#B48EAD;"> 74</span><span style="color:#B48EAD;"> 65</span><span style="color:#B48EAD;"> 72</span><span style="color:#B48EAD;"> 73</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 0a </span><span style="color:#B48EAD;">53</span><span style="color:#B48EAD;"> 6f</span><span style="color:#B48EAD;"> 75</span><span style="color:#B48EAD;"> 72</span><span style="color:#B48EAD;"> 63</span><span style="color:#B48EAD;"> 65</span><span style="color:#B48EAD;"> 46</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000340</span><span style="color:#B48EAD;"> 69</span><span style="color:#D8DEE9FF;"> 6c </span><span style="color:#B48EAD;">65</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 0f</span><span style="color:#B48EAD;"> 48</span><span style="color:#B48EAD;"> 65</span><span style="color:#D8DEE9FF;"> 6c 6c </span><span style="color:#B48EAD;">6f</span><span style="color:#B48EAD;"> 57</span><span style="color:#B48EAD;"> 6f</span><span style="color:#B48EAD;"> 72</span><span style="color:#D8DEE9FF;"> 6c </span><span style="color:#B48EAD;">64</span></span>
<span class="line"><span style="color:#B48EAD;">0000360</span><span style="color:#D8DEE9FF;"> 2e 6a </span><span style="color:#B48EAD;">61</span><span style="color:#B48EAD;"> 76</span><span style="color:#B48EAD;"> 61</span><span style="color:#D8DEE9FF;"> 0c </span><span style="color:#B48EAD;">00</span><span style="color:#B48EAD;"> 07</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 08 </span><span style="color:#B48EAD;">07</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 1d</span><span style="color:#D8DEE9FF;"> 0c </span><span style="color:#B48EAD;">00</span><span style="color:#D8DEE9FF;"> 1e </span></span>
<span class="line"><span style="color:#B48EAD;">0000400</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 1f</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 0b </span><span style="color:#B48EAD;">68</span><span style="color:#B48EAD;"> 65</span><span style="color:#D8DEE9FF;"> 6c 6c </span><span style="color:#B48EAD;">6f</span><span style="color:#B48EAD;"> 20</span><span style="color:#B48EAD;"> 77</span><span style="color:#B48EAD;"> 6f</span><span style="color:#B48EAD;"> 72</span><span style="color:#D8DEE9FF;"> 6c </span><span style="color:#B48EAD;">64</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000420</span><span style="color:#B48EAD;"> 07</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 20</span><span style="color:#D8DEE9FF;"> 0c </span><span style="color:#B48EAD;">00</span><span style="color:#B48EAD;"> 21</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 22</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 1b </span><span style="color:#B48EAD;">63</span><span style="color:#D8DEE9FF;"> 6e </span><span style="color:#B48EAD;">2f</span><span style="color:#B48EAD;"> 69</span><span style="color:#B48EAD;"> 74</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000440</span><span style="color:#B48EAD;"> 63</span><span style="color:#B48EAD;"> 61</span><span style="color:#B48EAD;"> 73</span><span style="color:#B48EAD;"> 74</span><span style="color:#B48EAD;"> 2f</span><span style="color:#D8DEE9FF;"> 6a </span><span style="color:#B48EAD;">76</span><span style="color:#B48EAD;"> 6d</span><span style="color:#B48EAD;"> 2f</span><span style="color:#B48EAD;"> 74</span><span style="color:#B48EAD;"> 35</span><span style="color:#B48EAD;"> 2f</span><span style="color:#B48EAD;"> 48</span><span style="color:#B48EAD;"> 65</span><span style="color:#D8DEE9FF;"> 6c 6c </span></span>
<span class="line"><span style="color:#B48EAD;">0000460</span><span style="color:#B48EAD;"> 6f</span><span style="color:#B48EAD;"> 57</span><span style="color:#B48EAD;"> 6f</span><span style="color:#B48EAD;"> 72</span><span style="color:#D8DEE9FF;"> 6c </span><span style="color:#B48EAD;">64</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 10</span><span style="color:#D8DEE9FF;"> 6a </span><span style="color:#B48EAD;">61</span><span style="color:#B48EAD;"> 76</span><span style="color:#B48EAD;"> 61</span><span style="color:#B48EAD;"> 2f</span><span style="color:#D8DEE9FF;"> 6c </span><span style="color:#B48EAD;">61</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000500</span><span style="color:#D8DEE9FF;"> 6e </span><span style="color:#B48EAD;">67</span><span style="color:#B48EAD;"> 2f</span><span style="color:#B48EAD;"> 4f</span><span style="color:#B48EAD;"> 62</span><span style="color:#D8DEE9FF;"> 6a </span><span style="color:#B48EAD;">65</span><span style="color:#B48EAD;"> 63</span><span style="color:#B48EAD;"> 74</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 10</span><span style="color:#D8DEE9FF;"> 6a </span><span style="color:#B48EAD;">61</span><span style="color:#B48EAD;"> 76</span><span style="color:#B48EAD;"> 61</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000520</span><span style="color:#B48EAD;"> 2f</span><span style="color:#D8DEE9FF;"> 6c </span><span style="color:#B48EAD;">61</span><span style="color:#D8DEE9FF;"> 6e </span><span style="color:#B48EAD;">67</span><span style="color:#B48EAD;"> 2f</span><span style="color:#B48EAD;"> 53</span><span style="color:#B48EAD;"> 79</span><span style="color:#B48EAD;"> 73</span><span style="color:#B48EAD;"> 74</span><span style="color:#B48EAD;"> 65</span><span style="color:#B48EAD;"> 6d</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 03</span><span style="color:#B48EAD;"> 6f</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000540</span><span style="color:#B48EAD;"> 75</span><span style="color:#B48EAD;"> 74</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 15</span><span style="color:#D8DEE9FF;"> 4c 6a </span><span style="color:#B48EAD;">61</span><span style="color:#B48EAD;"> 76</span><span style="color:#B48EAD;"> 61</span><span style="color:#B48EAD;"> 2f</span><span style="color:#B48EAD;"> 69</span><span style="color:#B48EAD;"> 6f</span><span style="color:#B48EAD;"> 2f</span><span style="color:#B48EAD;"> 50</span><span style="color:#B48EAD;"> 72</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000560</span><span style="color:#B48EAD;"> 69</span><span style="color:#D8DEE9FF;"> 6e </span><span style="color:#B48EAD;">74</span><span style="color:#B48EAD;"> 53</span><span style="color:#B48EAD;"> 74</span><span style="color:#B48EAD;"> 72</span><span style="color:#B48EAD;"> 65</span><span style="color:#B48EAD;"> 61</span><span style="color:#B48EAD;"> 6d</span><span style="color:#D8DEE9FF;"> 3b </span><span style="color:#B48EAD;">01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 13</span><span style="color:#D8DEE9FF;"> 6a </span><span style="color:#B48EAD;">61</span><span style="color:#B48EAD;"> 76</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000600</span><span style="color:#B48EAD;"> 61</span><span style="color:#B48EAD;"> 2f</span><span style="color:#B48EAD;"> 69</span><span style="color:#B48EAD;"> 6f</span><span style="color:#B48EAD;"> 2f</span><span style="color:#B48EAD;"> 50</span><span style="color:#B48EAD;"> 72</span><span style="color:#B48EAD;"> 69</span><span style="color:#D8DEE9FF;"> 6e </span><span style="color:#B48EAD;">74</span><span style="color:#B48EAD;"> 53</span><span style="color:#B48EAD;"> 74</span><span style="color:#B48EAD;"> 72</span><span style="color:#B48EAD;"> 65</span><span style="color:#B48EAD;"> 61</span><span style="color:#B48EAD;"> 6d</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000620</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 07</span><span style="color:#B48EAD;"> 70</span><span style="color:#B48EAD;"> 72</span><span style="color:#B48EAD;"> 69</span><span style="color:#D8DEE9FF;"> 6e </span><span style="color:#B48EAD;">74</span><span style="color:#D8DEE9FF;"> 6c 6e </span><span style="color:#B48EAD;">01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 15</span><span style="color:#B48EAD;"> 28</span><span style="color:#D8DEE9FF;"> 4c 6a </span></span>
<span class="line"><span style="color:#B48EAD;">0000640</span><span style="color:#B48EAD;"> 61</span><span style="color:#B48EAD;"> 76</span><span style="color:#B48EAD;"> 61</span><span style="color:#B48EAD;"> 2f</span><span style="color:#D8DEE9FF;"> 6c </span><span style="color:#B48EAD;">61</span><span style="color:#D8DEE9FF;"> 6e </span><span style="color:#B48EAD;">67</span><span style="color:#B48EAD;"> 2f</span><span style="color:#B48EAD;"> 53</span><span style="color:#B48EAD;"> 74</span><span style="color:#B48EAD;"> 72</span><span style="color:#B48EAD;"> 69</span><span style="color:#D8DEE9FF;"> 6e </span><span style="color:#B48EAD;">67</span><span style="color:#D8DEE9FF;"> 3b </span></span>
<span class="line"><span style="color:#B48EAD;">0000660</span><span style="color:#B48EAD;"> 29</span><span style="color:#B48EAD;"> 56</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 21</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 05</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 06</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 02</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 01</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000700</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 07</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 08 </span><span style="color:#B48EAD;">00</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 09 </span><span style="color:#B48EAD;">00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 2f</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 01</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000720</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 05</span><span style="color:#D8DEE9FF;"> 2a b7 </span><span style="color:#B48EAD;">00</span><span style="color:#B48EAD;"> 01</span><span style="color:#D8DEE9FF;"> b1 </span><span style="color:#B48EAD;">00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 02</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 0a </span><span style="color:#B48EAD;">00</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000740</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 06</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 04</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 0b </span><span style="color:#B48EAD;">00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 0c </span><span style="color:#B48EAD;">00</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0000760</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 05</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 0c </span><span style="color:#B48EAD;">00</span><span style="color:#B48EAD;"> 0d</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 09 </span><span style="color:#B48EAD;">00</span><span style="color:#D8DEE9FF;"> 0e </span><span style="color:#B48EAD;">00</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0001000</span><span style="color:#B48EAD;"> 0f</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 02</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 09 </span><span style="color:#B48EAD;">00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 37</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 02</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0001020</span><span style="color:#D8DEE9FF;"> 09 b2 </span><span style="color:#B48EAD;">00</span><span style="color:#B48EAD;"> 02</span><span style="color:#B48EAD;"> 12</span><span style="color:#B48EAD;"> 03</span><span style="color:#D8DEE9FF;"> b6 </span><span style="color:#B48EAD;">00</span><span style="color:#B48EAD;"> 04</span><span style="color:#D8DEE9FF;"> b1 </span><span style="color:#B48EAD;">00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 02</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 0a </span></span>
<span class="line"><span style="color:#B48EAD;">0001040</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 0a </span><span style="color:#B48EAD;">00</span><span style="color:#B48EAD;"> 02</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 06</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 08 </span><span style="color:#B48EAD;">00</span><span style="color:#B48EAD;"> 07</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 0b </span></span>
<span class="line"><span style="color:#B48EAD;">0001060</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 0c </span><span style="color:#B48EAD;">00</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> 09 </span><span style="color:#B48EAD;">00</span><span style="color:#B48EAD;"> 10</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 11</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0001100</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 12</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 05</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 10</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 01</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 13</span><span style="color:#B48EAD;"> 00</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#B48EAD;">0001120</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 02</span><span style="color:#B48EAD;"> 00</span><span style="color:#B48EAD;"> 14</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>根据 JVM 规范，<strong>类文件结构</strong>如下</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">u4             magic</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">u2             minor_version</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#D8DEE9FF;">u2             major_version</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#D8DEE9FF;">u2             constant_pool_count</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#D8DEE9FF;">cp_info        constant_pool</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">constant_pool_count</span><span style="color:#81A1C1;">-</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#D8DEE9FF;">u2             access_flags</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#D8DEE9FF;">u2             this_class</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#D8DEE9FF;">u2             super_class</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">   </span></span>
<span class="line"><span style="color:#D8DEE9FF;">u2             interfaces_count</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#D8DEE9FF;">u2             interfaces</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">interfaces_count</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">   </span></span>
<span class="line"><span style="color:#D8DEE9FF;">u2             fields_count</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#D8DEE9FF;">field_info     fields</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">fields_count</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">   </span></span>
<span class="line"><span style="color:#D8DEE9FF;">u2             methods_count</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#D8DEE9FF;">method_info    methods</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">methods_count</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#D8DEE9FF;">u2             attributes_count</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#D8DEE9FF;">attribute_info attributes</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">attributes_count</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-1-魔数" tabindex="-1"><a class="header-anchor" href="#_1-1-魔数"><span>1.1 魔数</span></a></h3><p>u4 magic</p><p>对应字节码文件 0~3 字节，表示它是否是【class】类型的文件</p><p>0000000 <strong>ca fe ba be</strong> 00 00 00 34 00 23 0a 00 06 00 15 09</p><p>ca fe ba be ：意思是 .class 文件，不同的东西有不同的魔数，比如 jpg、png 图片等！</p><h3 id="_1-2-版本" tabindex="-1"><a class="header-anchor" href="#_1-2-版本"><span>1.2 版本</span></a></h3><p>u2 minor_version; u2 major_version; 0000000 ca fe ba be 00 00 00 34 00 23 0a 00 06 00 15 09 00 00 00 34：34H（16进制） = 52（10进制），代表JDK8</p><p>对应字节码文件 4~7 字节，表示类的版本 00 34（52） 表示是 Java 8</p><p>0000000 ca fe ba be <strong>00 00 00 34</strong> 00 23 0a 00 06 00 15 09</p><h3 id="_1-3-常量池" tabindex="-1"><a class="header-anchor" href="#_1-3-常量池"><span>1.3 常量池</span></a></h3><p>参考文档 <a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html" target="_blank" rel="noopener noreferrer">传送门</a></p><table><thead><tr><th><strong>Constant Type</strong></th><th><strong>Value</strong></th></tr></thead><tbody><tr><td>CONSTANT_Class</td><td>7</td></tr><tr><td>CONSTANT_Fieldref</td><td>9</td></tr><tr><td>CONSTANT_Methodref</td><td>10</td></tr><tr><td>CONSTANT_InterfaceMethodref</td><td>11</td></tr><tr><td>CONSTANT_String</td><td>8</td></tr><tr><td>CONSTANT_Integer</td><td>3</td></tr><tr><td>CONSTANT_Float</td><td>4</td></tr><tr><td>CONSTANT_Long</td><td>5</td></tr><tr><td>CONSTANT_Double</td><td>6</td></tr><tr><td>CONSTANT_NameAndType</td><td>12</td></tr><tr><td>CONSTANT_Utf8</td><td>1</td></tr><tr><td>CONSTANT_MethodHandle</td><td>15</td></tr><tr><td>CONSTANT_MethodType</td><td>16</td></tr><tr><td>CONSTANT_InvokeDynamic</td><td>18</td></tr></tbody></table><p>8~9 字节，表示常量池长度，00 23 （35） 表示常量池有 #1~#34项，注意 #0 项不计入，也没有值，</p><p>分析过程，碰到属于<strong>Constant Type的值就去表中找类型，</strong></p><p>比如第一项0a是CONSTANT_Methodref，00 06 00 15引用了常量池中 #6 和 #21 项，后面09是CONSTANT_Fieldref，00 16 00 17表示它引用了常量池中 #22 和 # 23 项，依次类推，另外utf-8的串用2个字节来表示长度，后面是数据。</p><p>0000000 ca fe ba be 00 00 00 34 00 23 0a 00 06 00 15 09</p><ol><li>第#1项 0a 表示一个 Method 信息，00 06 和 00 15（21） 表示它引用了常量池中 #6 和 #21 项来获得这个方法的【所属类】和【方法名】</li></ol><p>0000000 ca fe ba be 00 00 00 34 00 23 0a 00 06 00 15 09</p><ol><li>第#2项 09 表示一个 Field 信息，00 16（22）和 00 17（23） 表示它引用了常量池中 #22 和 # 23 项来获得这个成员变量的【所属类】和【成员变量名】 <ol><li><p>0000000 ca fe ba be 00 00 00 34 00 23 0a 00 06 00 15 09</p></li><li><p>0000020 00 16 00 17 08 00 18 0a 00 19 00 1a 07 00 1b 07</p></li></ol></li><li>第#3项 08 表示一个字符串常量名称，00 18（24）表示它引用了常量池中 #24 项</li></ol><p>0000020 00 16 00 17 08 00 18 0a 00 19 00 1a 07 00 1b 07</p><ol><li>第#4项 0a 表示一个 Method 信息，00 19（25） 和 00 1a（26） 表示它引用了常量池中 #25 和 #26</li></ol><p>项来获得这个方法的【所属类】和【方法名】</p><p>0000020 00 16 00 17 08 00 18 0a 00 19 00 1a 07 00 1b 07</p><ol><li>第#5项 07 表示一个 Class 信息，00 1b（27） 表示它引用了常量池中 #27 项</li></ol><p>0000020 00 16 00 17 08 00 18 0a 00 19 00 1a 07 00 1b 07</p><ol><li>第#6项 07 表示一个 Class 信息，00 1c（28） 表示它引用了常量池中 #28 项 <ol><li><p>0000020 00 16 00 17 08 00 18 0a 00 19 00 1a 07 00 1b 07</p></li><li><p>0000040 00 1c 01 00 06 3c 69 6e 69 74 3e 01 00 03 28 29</p></li></ol></li><li>第#7项 01 表示一个 utf8 串，00 06 表示长度，3c 69 6e 69 74 3e 是【 &lt;init&gt; 】</li></ol><p>0000040 00 1c 01 00 06 3c 69 6e 69 74 3e 01 00 03 28 29</p><ol><li>第#8项 01 表示一个 utf8 串，00 03 表示长度，28 29 56 是【()V】其实就是表示无参、无返回值</li></ol><p>0000040 00 1c 01 00 06 3c 69 6e 69 74 3e 01 00 03 28 29</p><p>0000060 56 01 00 04 43 6f 64 65 01 00 0f 4c 69 6e 65 4e</p><ol><li>第#9项 01 表示一个 utf8 串，00 04 表示长度，43 6f 64 65 是【Code】</li></ol><p>0000060 56 01 00 04 43 6f 64 65 01 00 0f 4c 69 6e 65 4e</p><ol><li>第#10项 01 表示一个 utf8 串，00 0f（15） 表示长度，4c 69 6e 65 4e 75 6d 62 65 72 54 61 62 6c 65是【LineNumberTable】 <ol><li><p>0000060 56 01 00 04 43 6f 64 65 01 00 0f 4c 69 6e 65 4e</p></li><li><p>0000100 75 6d 62 65 72 54 61 62 6c 65 01 00 12 4c 6f 63</p></li></ol></li><li>第#11项 01 表示一个 utf8 串，00 12（18） 表示长度，4c 6f 63 61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65是【LocalVariableTable】 <ol><li><p>0000100 75 6d 62 65 72 54 61 62 6c 65 01 00 12 4c 6f 63</p></li><li><p>0000120 61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65 01</p></li></ol></li><li>第#12项 01 表示一个 utf8 串，00 04 表示长度，74 68 69 73 是【this】 <ol><li><p>0000120 61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65 01</p></li><li><p>0000140 00 04 74 68 69 73 01 00 1d 4c 63 6e 2f 69 74 63</p></li></ol></li><li>第#13项 01 表示一个 utf8 串，00 1d（29） 表示长度，是【Lcn/itcast/jvm/t5/HelloWorld;】 <ol><li><p>0000140 00 04 74 68 69 73 01 00 1d 4c 63 6e 2f 69 74 63</p></li><li><p>0000160 61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c 6f</p></li><li><p>0000200 57 6f 72 6c 64 3b 01 00 04 6d 61 69 6e 01 00 16</p></li></ol></li><li>第#14项 01 表示一个 utf8 串，00 04 表示长度，74 68 69 73 是【main】</li></ol><p>0000200 57 6f 72 6c 64 3b 01 00 04 6d 61 69 6e 01 00 16</p><ol><li>第#15项 01 表示一个 utf8 串，00 16（22） 表示长度，是【([Ljava/lang/String;)V】其实就是参数为字符串数组，无返回值</li></ol><p>0000200 57 6f 72 6c 64 3b 01 00 04 6d 61 69 6e 01 00 16</p><p>0000220 28 5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72</p><p>0000240 69 6e 67 3b 29 56 01 00 04 61 72 67 73 01 00 13</p><ol><li>第#16项 01 表示一个 utf8 串，00 04 表示长度，是【args】</li></ol><p>0000240 69 6e 67 3b 29 56 01 00 04 61 72 67 73 01 00 13</p><ol><li>第#17项 01 表示一个 utf8 串，00 13（19） 表示长度，是【[Ljava/lang/String;】 <ol><li><p>0000240 69 6e 67 3b 29 56 01 00 04 61 72 67 73 01 00 13</p></li><li><p>0000260 5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69</p></li><li><p>0000300 6e 67 3b 01 00 10 4d 65 74 68 6f 64 50 61 72 61</p></li></ol></li><li>第#18项 01 表示一个 utf8 串，00 10（16） 表示长度，是【MethodParameters】 <ol><li><p>0000300 6e 67 3b 01 00 10 4d 65 74 68 6f 64 50 61 72 61</p></li><li><p>0000320 6d 65 74 65 72 73 01 00 0a 53 6f 75 72 63 65 46</p></li></ol></li><li>第#19项 01 表示一个 utf8 串，00 0a（10） 表示长度，是【SourceFile】 <ol><li><p>0000320 6d 65 74 65 72 73 01 00 0a 53 6f 75 72 63 65 46</p></li><li><p>0000340 69 6c 65 01 00 0f 48 65 6c 6c 6f 57 6f 72 6c 64</p></li></ol></li><li>第#20项 01 表示一个 utf8 串，00 0f（15） 表示长度，是【HelloWorld.java】 <ol><li><p>0000340 69 6c 65 01 00 0f 48 65 6c 6c 6f 57 6f 72 6c 64</p></li><li><p>0000360 2e 6a 61 76 61 0c 00 07 00 08 07 00 1d 0c 00 1e</p></li></ol></li><li>第#21项 0c 表示一个 【名+类型】，00 07 00 08 引用了常量池中 #7 #8 两项</li></ol><p>0000360 2e 6a 61 76 61 0c 00 07 00 08 07 00 1d 0c 00 1e</p><ol><li>第#22项 07 表示一个 Class 信息，00 1d（29） 引用了常量池中 #29 项</li></ol><p>0000360 2e 6a 61 76 61 0c 00 07 00 08 07 00 1d 0c 00 1e</p><ol><li>第#23项 0c 表示一个 【名+类型】，00 1e（30） 00 1f （31）引用了常量池中 #30 #31 两项 <ol><li><p>0000360 2e 6a 61 76 61 0c 00 07 00 08 07 00 1d 0c 00 1e</p></li><li><p>0000400 00 1f 01 00 0b 68 65 6c 6c 6f 20 77 6f 72 6c 64</p></li></ol></li><li>第#24项 01 表示一个 utf8 串，00 0f（15） 表示长度，是【hello world】</li></ol><p>0000400 00 1f 01 00 0b 68 65 6c 6c 6f 20 77 6f 72 6c 64</p><ol><li>第#25项 07 表示一个 Class 信息，00 20（32） 引用了常量池中 #32 项</li></ol><p>0000420 07 00 20 0c 00 21 00 22 01 00 1b 63 6e 2f 69 74</p><ol><li>第#26项 0c 表示一个 【名+类型】，00 21（33） 00 22（34）引用了常量池中 #33 #34 两项</li></ol><p>0000420 07 00 20 0c 00 21 00 22 01 00 1b 63 6e 2f 69 74</p><ol><li>第#27项 01 表示一个 utf8 串，00 1b（27） 表示长度，是【cn/itcast/jvm/t5/HelloWorld】 <ol><li><p>0000420 07 00 20 0c 00 21 00 22 01 00 1b 63 6e 2f 69 74</p></li><li><p>0000440 63 61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c</p></li><li><p>0000460 6f 57 6f 72 6c 64 01 00 10 6a 61 76 61 2f 6c 61</p></li></ol></li><li>第#28项 01 表示一个 utf8 串，00 10（16） 表示长度，是【java/lang/Object】 <ol><li><p>0000460 6f 57 6f 72 6c 64 01 00 10 6a 61 76 61 2f 6c 61</p></li><li><p>0000500 6e 67 2f 4f 62 6a 65 63 74 01 00 10 6a 61 76 61</p></li></ol></li><li>第#29项 01 表示一个 utf8 串，00 10（16） 表示长度，是【java/lang/System】 <ol><li><p>0000500 6e 67 2f 4f 62 6a 65 63 74 01 00 10 6a 61 76 61</p></li><li><p>0000520 2f 6c 61 6e 67 2f 53 79 73 74 65 6d 01 00 03 6f</p></li></ol></li><li>第#30项 01 表示一个 utf8 串，00 03 表示长度，是【out】 <ol><li><p>0000520 2f 6c 61 6e 67 2f 53 79 73 74 65 6d 01 00 03 6f</p></li><li><p>0000540 75 74 01 00 15 4c 6a 61 76 61 2f 69 6f 2f 50 72</p></li></ol></li><li>第#31项 01 表示一个 utf8 串，00 15（21） 表示长度，是【Ljava/io/PrintStream;】 <ol><li><p>0000540 75 74 01 00 15 4c 6a 61 76 61 2f 69 6f 2f 50 72</p></li><li><p>0000560 69 6e 74 53 74 72 65 61 6d 3b 01 00 13 6a 61 76</p></li><li><p>Flag Name Value Interpretation</p></li><li><p>ACC_PUBLIC 0x0001</p></li><li><p>Declared public ; may be accessed from outside its</p></li><li><p>package.</p></li><li><p>ACC_FINAL 0x0010 Declared final ; no subclasses allowed.</p></li><li><p>ACC_SUPER 0x0020</p></li><li><p>Treat superclass methods specially when invoked by the</p></li><li><p>invokespecial instruction.</p></li><li><p>ACC_INTERFACE 0x0200 Is an interface, not a class.</p></li><li><p>ACC_ABSTRACT 0x0400 Declared abstract ; must not be instantiated.</p></li><li><p>ACC_SYNTHETIC 0x1000 Declared synthetic; not present in the source code.</p></li><li><p>ACC_ANNOTATION 0x2000 Declared as an annotation type.</p></li><li><p>ACC_ENUM 0x4000 Declared as an enum type.</p></li></ol></li><li>第#32项 01 表示一个 utf8 串，00 13（19） 表示长度，是【java/io/PrintStream】 <ol><li><p>0000560 69 6e 74 53 74 72 65 61 6d 3b 01 00 13 6a 61 76</p></li><li><p>0000600 61 2f 69 6f 2f 50 72 69 6e 74 53 74 72 65 61 6d</p></li></ol></li><li>第#33项 01 表示一个 utf8 串，00 07 表示长度，是【println】</li></ol><p>0000620 01 00 07 70 72 69 6e 74 6c 6e 01 00 15 28 4c 6a</p><ol><li>第#34项 01 表示一个 utf8 串，00 15（21） 表示长度，是【(Ljava/lang/String;)V】 <ol><li><p>0000620 01 00 07 70 72 69 6e 74 6c 6e 01 00 15 28 4c 6a</p></li><li><p>0000640 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69 6e 67 3b</p></li><li><p>0000660 29 56 00 21 00 05 00 06 00 00 00 00 00 02 00 01</p></li></ol></li></ol><h3 id="_1-4-访问标识与继承信息" tabindex="-1"><a class="header-anchor" href="#_1-4-访问标识与继承信息"><span>1.4 访问标识与继承信息</span></a></h3><p>21 表示该 class 是一个类，公共的</p><p>0000660 29 56 00 21 00 05 00 06 00 00 00 00 00 02 00 01</p><p>05 表示根据常量池中 #5 找到本类全限定名</p><p>0000660 29 56 00 21 00 05 00 06 00 00 00 00 00 02 00 01</p><p>06 表示根据常量池中 #6 找到父类全限定名</p><p>0000660 29 56 00 21 00 05 00 06 00 00 00 00 00 02 00 01</p><p>表示接口的数量，本类为 0</p><p>0000660 29 56 00 21 00 05 00 06 00 00 00 00 00 02 00 01</p><h2 id="_2-字节码指令" tabindex="-1"><a class="header-anchor" href="#_2-字节码指令"><span>2. 字节码指令</span></a></h2><p>可参考： <a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5" target="_blank" rel="noopener noreferrer">字节码指令</a></p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806182.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806241.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h3 id="_2-1-javap工具" tabindex="-1"><a class="header-anchor" href="#_2-1-javap工具"><span>2.1 javap工具</span></a></h3><p>Oracle 提供了 javap 工具来反编译 class 文件，还有其他的idea插件可以直接查看。</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">javap </span><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">v 类名</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_2-2-图解方法执行流程" tabindex="-1"><a class="header-anchor" href="#_2-2-图解方法执行流程"><span>2.2 图解方法执行流程</span></a></h3><h4 id="_1-代码" tabindex="-1"><a class="header-anchor" href="#_1-代码"><span>（1）<strong>代码</strong></span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Demo3_1</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#81A1C1;">        public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;">        </span></span>
<span class="line"><span style="color:#81A1C1;">                int</span><span style="color:#D8DEE9;"> a</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">        </span></span>
<span class="line"><span style="color:#81A1C1;">                int</span><span style="color:#D8DEE9;"> b</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Short</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">MAX_VALUE</span><span style="color:#81A1C1;"> +</span><span style="color:#B48EAD;"> 1</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">        </span></span>
<span class="line"><span style="color:#81A1C1;">                int</span><span style="color:#D8DEE9;"> c</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> a </span><span style="color:#81A1C1;">+</span><span style="color:#D8DEE9FF;"> b</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">                </span></span>
<span class="line"><span style="color:#D8DEE9;">                System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">c</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">   </span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-编译后的字节码文件" tabindex="-1"><a class="header-anchor" href="#_2-编译后的字节码文件"><span>（2）编译后的字节码文件</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">C</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;">\\Users\\</span><span style="color:#B48EAD;">30287</span><span style="color:#D8DEE9FF;">\\IdeaProjects\\paiXppLL\\src\\main</span><span style="color:#81A1C1;">&gt;</span><span style="color:#D8DEE9FF;">javap </span><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">v </span><span style="color:#D8DEE9;">Main</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Classfile </span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">C</span><span style="color:#81A1C1;">:/</span><span style="color:#D8DEE9FF;">Users</span><span style="color:#81A1C1;">/</span><span style="color:#B48EAD;">30287</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">IdeaProjects</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">paiXppLL</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">src</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">main</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9;">Main</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span></span>
<span class="line"><span style="color:#8FBCBB;">  Last</span><span style="color:#D8DEE9FF;"> modified </span><span style="color:#B48EAD;">2021</span><span style="color:#81A1C1;">-</span><span style="color:#B48EAD;">10</span><span style="color:#81A1C1;">-</span><span style="color:#B48EAD;">14</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> size </span><span style="color:#B48EAD;">419</span><span style="color:#D8DEE9FF;"> bytes</span></span>
<span class="line"><span style="color:#8FBCBB;">  MD5</span><span style="color:#D8DEE9FF;"> checksum eda2e7897356a975438fe5899c0b4a6c</span></span>
<span class="line"><span style="color:#8FBCBB;">  Compiled</span><span style="color:#D8DEE9FF;"> from </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Main.java</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> main</span><span style="color:#D8DEE9FF;">.Main</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  minor version: 0</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  major version: 52</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  flags: ACC_PUBLIC, ACC_SUPER</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Constant pool:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">   #1 = Methodref          #6.#15         </span><span style="color:#616E88;">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span>
<span class="line"><span style="color:#D8DEE9FF;">   #2 = Fieldref           #16.#17        </span><span style="color:#616E88;">// java/lang/System.out:Ljava/io/PrintStream;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">   #3 = String             #18            </span><span style="color:#616E88;">// hello world!</span></span>
<span class="line"><span style="color:#D8DEE9FF;">   #4 = Methodref          #19.#20        </span><span style="color:#616E88;">// java/io/PrintStream.println:(Ljava/lang/String;)V</span></span>
<span class="line"><span style="color:#D8DEE9FF;">   #5 = Class              #21            </span><span style="color:#616E88;">// main/Main</span></span>
<span class="line"><span style="color:#D8DEE9FF;">   #6 = Class              #22            </span><span style="color:#616E88;">// java/lang/Object</span></span>
<span class="line"><span style="color:#D8DEE9FF;">   #7 = Utf8               </span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">init</span><span style="color:#ECEFF4;">&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">   #8 = Utf8               ()V</span></span>
<span class="line"><span style="color:#D8DEE9FF;">   #9 = Utf8               Code</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  #10 = Utf8               LineNumberTable</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  #11 = Utf8               main</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  #12 = Utf8               ([Ljava/lang/String;)V</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  #13 = Utf8               SourceFile</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  #14 = Utf8               Main.java</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  #15 = NameAndType        #7:#8          </span><span style="color:#616E88;">// &quot;&lt;init&gt;&quot;:()V</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  #16 = Class              #23            </span><span style="color:#616E88;">// java/lang/System</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  #17 = NameAndType        #24:#25        </span><span style="color:#616E88;">// out:Ljava/io/PrintStream;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  #18 = Utf8               hello world!</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  #19 = Class              #26            </span><span style="color:#616E88;">// java/io/PrintStream</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  #20 = NameAndType        #27:#28        </span><span style="color:#616E88;">// println:(Ljava/lang/String;)V</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  #21 = Utf8               main/Main</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  #22 = Utf8               java/lang/Object</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  #23 = Utf8               java/lang/System</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  #24 = Utf8               out</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  #25 = Utf8               Ljava/io/PrintStream;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  #26 = Utf8               java/io/PrintStream</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  #27 = Utf8               println</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  #28 = Utf8               (Ljava/lang/String;)V</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">  public</span><span style="color:#D8DEE9FF;"> main.</span><span style="color:#88C0D0;">Main</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    descriptor: ()V</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    flags: ACC_PUBLIC</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    Code:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      stack=1, locals=1, args_size=1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">         0: aload_0</span></span>
<span class="line"><span style="color:#D8DEE9FF;">         1: invokespecial #1                  </span><span style="color:#616E88;">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span>
<span class="line"><span style="color:#D8DEE9FF;">         4: return</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      LineNumberTable:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        line 13: 0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">  public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">java</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    descriptor: ([Ljava/lang/String</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#8FBCBB;">V</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    flags</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ACC_PUBLIC</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> ACC_STATIC</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    Code</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      stack</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> locals</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> args_size</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span></span>
<span class="line"><span style="color:#B48EAD;">         0</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> getstatic     #</span><span style="color:#B48EAD;">2</span><span style="color:#616E88;">                  // Field java/lang/System.out:Ljava/io/PrintStream;</span></span>
<span class="line"><span style="color:#B48EAD;">         3</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ldc           #</span><span style="color:#B48EAD;">3</span><span style="color:#616E88;">                  // String hello world!</span></span>
<span class="line"><span style="color:#B48EAD;">         5</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokevirtual #</span><span style="color:#B48EAD;">4</span><span style="color:#616E88;">                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span></span>
<span class="line"><span style="color:#B48EAD;">         8</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> return</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      LineNumberTable</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        line </span><span style="color:#B48EAD;">15</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;"> 0</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        line </span><span style="color:#B48EAD;">16</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;"> 8</span></span>
<span class="line"><span style="color:#D8DEE9FF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-常量池载入运行时常量池" tabindex="-1"><a class="header-anchor" href="#_3-常量池载入运行时常量池"><span>（3）常量池载入运行时常量池</span></a></h4><p>常量池也属于方法区，只不过这里单独提出来了</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806174.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h4 id="_4-方法字节码载入方法区" tabindex="-1"><a class="header-anchor" href="#_4-方法字节码载入方法区"><span>（4）<strong>方法字节码载入方法区</strong></span></a></h4><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806552.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h4 id="_5-main-线程开始运行-分配栈帧内存" tabindex="-1"><a class="header-anchor" href="#_5-main-线程开始运行-分配栈帧内存"><span>（5）main 线程开始运行，分配栈帧内存</span></a></h4><p>stack=2，locals=4） 对应操作数栈有2个空间（每个空间4个字节），局部变量表中有4个槽位</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806608.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h4 id="_6-执行引擎开始执行字节码-bipush-10" tabindex="-1"><a class="header-anchor" href="#_6-执行引擎开始执行字节码-bipush-10"><span><strong>（6）执行引擎开始执行字节码</strong> <strong>bipush 10</strong></span></a></h4><ul><li><strong>将一个 byte 压入操作数栈</strong>（其长度会补齐 4 个字节），类似的指令还有</li><li>sipush 将一个 short 压入操作数栈（其长度会补齐 4 个字节）</li><li>ldc 将一个 int 压入操作数栈</li><li>ldc2_w 将一个 long 压入操作数栈（<strong>分两次压入</strong>，因为 long 是 8 个字节）</li><li>这里小的数字都是和字节码指令存在一起，<strong>超过 short 范围的数字存入了****常量池</strong></li></ul><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806670.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>istore 1</strong> 将操作数栈栈顶元素弹出，放入局部变量表的 slot 1 中 对应代码中的 a = 10</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806036.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806984.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>ldc #3</strong></p><ul><li>读取运行时常量池中 #3 ，即 32768 (超过 short 最大值范围的数会被放到运行时常量池中)，将其加载到操作数栈中</li><li>注意 Short.MAX_VALUE 是 32767，所以 32768 = Short.MAX_VALUE + 1 实际是在编译期间计算好的。</li></ul><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806093.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>istore 2</strong> 将操作数栈中的元素弹出，放到局部变量表的 2 号位置</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806432.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>iload1 iload2</strong> 将局部变量表中 1 号位置和 2 号位置的元素放入操作数栈中。因为只能在操作数栈中执行运算操作</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806537.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806754.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>iadd</strong> 将操作数栈中的两个元素弹出栈并相加，结果在压入操作数栈中。</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806177.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806829.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>istore 3</strong> 将操作数栈中的元素弹出，放入局部变量表的3号位置。</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806104.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>getstatic #4</strong> 在运行时常量池中找到 #4 ，发现是一个对象，在堆内存中找到该对象，并将其引用放入操作数栈中</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806300.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806281.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>iload 3</strong> 将局部变量表中 3 号位置的元素压入操作数栈中。</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806529.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806658.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>invokevirtual #5</strong></p><ul><li>找到常量池 #5 项，</li><li>定位到方法区 java/io/PrintStream.println:(I)V 方法</li><li>生成新的栈帧（分配 locals、stack等）</li><li>传递参数，执行新栈帧中的字节码</li></ul><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806004.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>执行完毕，弹出栈帧 清除 main 操作数栈内容</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806053.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>return</strong> 完成 main 方法调用，弹出 main 栈帧，程序结束</p><h3 id="_2-3-练习-分析-i" tabindex="-1"><a class="header-anchor" href="#_2-3-练习-分析-i"><span>2.3 练习 - 分析 i++</span></a></h3><p>代码</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> cn</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">itcast</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">jvm</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">t3</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">bytecode</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">/**</span></span>
<span class="line"><span style="color:#616E88;">* 从字节码角度分析 a++ 相关题目</span></span>
<span class="line"><span style="color:#616E88;">*/</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Demo3_2</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    int</span><span style="color:#D8DEE9;"> a</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    int</span><span style="color:#D8DEE9;"> b</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> a</span><span style="color:#81A1C1;">++</span><span style="color:#81A1C1;"> +</span><span style="color:#81A1C1;"> ++</span><span style="color:#D8DEE9FF;">a </span><span style="color:#81A1C1;">+</span><span style="color:#D8DEE9FF;"> a</span><span style="color:#81A1C1;">--;</span></span>
<span class="line"><span style="color:#D8DEE9;">    System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">a</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">b</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">String</span><span style="color:#ECEFF4;">[])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">descriptor</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;"> ([</span><span style="color:#D8DEE9FF;">Ljava</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">String</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#8FBCBB;">V</span></span>
<span class="line"><span style="color:#D8DEE9FF;">flags</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;"> (</span><span style="color:#B48EAD;">0x0009</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> ACC_PUBLIC</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> ACC_STATIC</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Code</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">stack</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> locals</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">3</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> args_size</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span></span>
<span class="line"><span style="color:#B48EAD;">0</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush </span><span style="color:#B48EAD;">10</span></span>
<span class="line"><span style="color:#B48EAD;">2</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#B48EAD;">3</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iload_1</span></span>
<span class="line"><span style="color:#B48EAD;">4</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iinc </span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 1</span></span>
<span class="line"><span style="color:#B48EAD;">7</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iinc </span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 1</span></span>
<span class="line"><span style="color:#B48EAD;">10</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iload_1</span></span>
<span class="line"><span style="color:#B48EAD;">11</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iadd</span></span>
<span class="line"><span style="color:#B48EAD;">12</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iload_1</span></span>
<span class="line"><span style="color:#B48EAD;">13</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iinc </span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> -</span><span style="color:#B48EAD;">1</span></span>
<span class="line"><span style="color:#B48EAD;">16</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iadd</span></span>
<span class="line"><span style="color:#B48EAD;">17</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_2</span></span>
<span class="line"><span style="color:#B48EAD;">18</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> getstatic #</span><span style="color:#B48EAD;">2</span><span style="color:#616E88;"> // Field</span></span>
<span class="line"><span style="color:#D8DEE9FF;">java</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9;">System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;">Ljava</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">io</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">PrintStream</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#B48EAD;">21</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iload_1</span></span>
<span class="line"><span style="color:#B48EAD;">22</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokevirtual #</span><span style="color:#B48EAD;">3</span><span style="color:#616E88;"> // Method</span></span>
<span class="line"><span style="color:#D8DEE9FF;">java</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">io</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9;">PrintStream</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">println</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">I</span><span style="color:#ECEFF4;">)</span><span style="color:#8FBCBB;">V</span></span>
<span class="line"><span style="color:#B48EAD;">25</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> getstatic #</span><span style="color:#B48EAD;">2</span><span style="color:#616E88;"> // Field</span></span>
<span class="line"><span style="color:#D8DEE9FF;">java</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9;">System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;">Ljava</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">io</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">PrintStream</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#B48EAD;">28</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iload_2</span></span>
<span class="line"><span style="color:#B48EAD;">29</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokevirtual #</span><span style="color:#B48EAD;">3</span><span style="color:#616E88;"> // Method</span></span>
<span class="line"><span style="color:#D8DEE9FF;">java</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">io</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9;">PrintStream</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">println</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">I</span><span style="color:#ECEFF4;">)</span><span style="color:#8FBCBB;">V</span></span>
<span class="line"><span style="color:#B48EAD;">32</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> return</span></span>
<span class="line"><span style="color:#D8DEE9FF;">LineNumberTable</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">line </span><span style="color:#B48EAD;">8</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;"> 0</span></span>
<span class="line"><span style="color:#D8DEE9FF;">line </span><span style="color:#B48EAD;">9</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;"> 3</span></span>
<span class="line"><span style="color:#D8DEE9FF;">line </span><span style="color:#B48EAD;">10</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;"> 18</span></span>
<span class="line"><span style="color:#D8DEE9FF;">line </span><span style="color:#B48EAD;">11</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;"> 25</span></span>
<span class="line"><span style="color:#D8DEE9FF;">line </span><span style="color:#B48EAD;">12</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;"> 32</span></span>
<span class="line"><span style="color:#D8DEE9FF;">LocalVariableTable</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#8FBCBB;">Start</span><span style="color:#8FBCBB;"> Length</span><span style="color:#8FBCBB;"> Slot</span><span style="color:#8FBCBB;"> Name</span><span style="color:#8FBCBB;"> Signature</span></span>
<span class="line"><span style="color:#B48EAD;">0</span><span style="color:#B48EAD;"> 33</span><span style="color:#B48EAD;"> 0</span><span style="color:#D8DEE9FF;"> args </span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">Ljava</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">String</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#B48EAD;">3</span><span style="color:#B48EAD;"> 30</span><span style="color:#B48EAD;"> 1</span><span style="color:#D8DEE9FF;"> a </span><span style="color:#8FBCBB;">I</span></span>
<span class="line"><span style="color:#B48EAD;">18</span><span style="color:#B48EAD;"> 15</span><span style="color:#B48EAD;"> 2</span><span style="color:#D8DEE9FF;"> b </span><span style="color:#8FBCBB;">I</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>分析：</p><p>注意 iinc 指令是直接在局部变量 slot 上进行运算</p><p>a++ 和 ++a 的区别是先执行 iload 还是 先执行 iinc</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806072.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806127.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806165.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806461.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806768.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806950.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806098.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806079.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806159.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806271.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806382.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h3 id="_2-4-条件判断指令" tabindex="-1"><a class="header-anchor" href="#_2-4-条件判断指令"><span>2.4 条件判断指令</span></a></h3><table><thead><tr><th>指令</th><th>助记符</th><th>含义</th></tr></thead><tbody><tr><td>0x99</td><td>ifeq</td><td>判断是否 == 0</td></tr><tr><td>0x9a</td><td>ifne</td><td>判断是否 != 0</td></tr><tr><td>0x9b</td><td>iflt</td><td>判断是否 &lt; 0</td></tr></tbody></table><p>几点说明：</p><ul><li>byte，short，char 都会按 int 比较，因为操作数栈都是 4 字节</li><li>goto 用来进行跳转到指定行号的字节码</li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Demo3_3</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#D8DEE9;"> a</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        if</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">a </span><span style="color:#81A1C1;">==</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">            a </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        a </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 20</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#B48EAD;">0</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iconst_0</span></span>
<span class="line"><span style="color:#B48EAD;">1</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#B48EAD;">2</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iload_1</span></span>
<span class="line"><span style="color:#B48EAD;">3</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ifne </span><span style="color:#B48EAD;">12</span></span>
<span class="line"><span style="color:#B48EAD;">6</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush </span><span style="color:#B48EAD;">10</span></span>
<span class="line"><span style="color:#B48EAD;">8</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#B48EAD;">9</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> goto</span><span style="color:#B48EAD;"> 15</span></span>
<span class="line"><span style="color:#B48EAD;">12</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush </span><span style="color:#B48EAD;">20</span></span>
<span class="line"><span style="color:#B48EAD;">14</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#B48EAD;">15</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> return</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>思考</p><p>细心的同学应当注意到，以上比较指令中没有 long，float，double 的比较，那么它们要比较怎么办？</p><p>参考 https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-6.html#jvms-6.5.lcmp</p></blockquote><h3 id="_2-5-循环控制指令" tabindex="-1"><a class="header-anchor" href="#_2-5-循环控制指令"><span>2.5 循环控制指令</span></a></h3><p>其实循环控制还是前面介绍的那些指令，例如 while 循环：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Demo3_4</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> a</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">while</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">a </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 10</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">a</span><span style="color:#81A1C1;">++;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#B48EAD;">0</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iconst_0</span></span>
<span class="line"><span style="color:#B48EAD;">1</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#B48EAD;">2</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iload_1</span></span>
<span class="line"><span style="color:#B48EAD;">3</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush </span><span style="color:#B48EAD;">10</span></span>
<span class="line"><span style="color:#B48EAD;">5</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> if_icmpge </span><span style="color:#B48EAD;">14</span></span>
<span class="line"><span style="color:#B48EAD;">8</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iinc </span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 1</span></span>
<span class="line"><span style="color:#B48EAD;">11</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> goto</span><span style="color:#B48EAD;"> 2</span></span>
<span class="line"><span style="color:#B48EAD;">14</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> return</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再比如 do while 循环：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Demo3_5</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> a</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">do</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">a</span><span style="color:#81A1C1;">++;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#81A1C1;"> while</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">a </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 10</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#D8DEE9FF;">字节码是：</span></span>
<span class="line"><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iconst_0</span></span>
<span class="line"><span style="color:#B48EAD;"> 1</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#B48EAD;"> 2</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iinc </span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 1</span></span>
<span class="line"><span style="color:#B48EAD;"> 5</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iload_1</span></span>
<span class="line"><span style="color:#B48EAD;"> 6</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush </span><span style="color:#B48EAD;">10</span></span>
<span class="line"><span style="color:#B48EAD;"> 8</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> if_icmplt </span><span style="color:#B48EAD;">2</span></span>
<span class="line"><span style="color:#B48EAD;">11</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> return</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后再看看 for 循环：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Demo3_6</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#B48EAD;">0</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iconst_0</span></span>
<span class="line"><span style="color:#B48EAD;">1</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#B48EAD;">2</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iload_1</span></span>
<span class="line"><span style="color:#B48EAD;">3</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush </span><span style="color:#B48EAD;">10</span></span>
<span class="line"><span style="color:#B48EAD;">5</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> if_icmpge </span><span style="color:#B48EAD;">14</span></span>
<span class="line"><span style="color:#B48EAD;">8</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iinc </span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 1</span></span>
<span class="line"><span style="color:#B48EAD;">11</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> goto</span><span style="color:#B48EAD;"> 2</span></span>
<span class="line"><span style="color:#B48EAD;">14</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> return</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>注意</p><p>比较 while 和 for 的字节码，你发现它们是一模一样的，殊途也能同归😊</p></blockquote><h3 id="_2-6-练习-判断结果" tabindex="-1"><a class="header-anchor" href="#_2-6-练习-判断结果"><span>2.6 练习-判断结果</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Code_11_ByteCodeTest</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#D8DEE9;"> x</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        while</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 10</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">            x </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> x</span><span style="color:#81A1C1;">++;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">            i</span><span style="color:#81A1C1;">++;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">x</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // 0</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806675.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>为什么最终的 x 结果为 0 呢？ 通过分析字节码指令即可知晓</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">Code</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">     stack</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> locals</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">3</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> args_size</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span><span style="color:#616E88;">        // 操作数栈分配2个空间，局部变量表分配 3 个空间</span></span>
<span class="line"><span style="color:#B48EAD;">        0</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iconst_0        </span><span style="color:#616E88;">// 准备一个常数 0</span></span>
<span class="line"><span style="color:#B48EAD;">        1</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1        </span><span style="color:#616E88;">// 将常数 0 放入局部变量表的 1 号槽位 i = 0</span></span>
<span class="line"><span style="color:#B48EAD;">        2</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iconst_0        </span><span style="color:#616E88;">// 准备一个常数 0</span></span>
<span class="line"><span style="color:#B48EAD;">        3</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_2        </span><span style="color:#616E88;">// 将常数 0 放入局部变量的 2 号槽位 x = 0        </span></span>
<span class="line"><span style="color:#B48EAD;">        4</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iload_1                </span><span style="color:#616E88;">// 将局部变量表 1 号槽位的数放入操作数栈中</span></span>
<span class="line"><span style="color:#B48EAD;">        5</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush        </span><span style="color:#B48EAD;">10</span><span style="color:#616E88;">        // 将数字 10 放入操作数栈中，此时操作数栈中有 2 个数</span></span>
<span class="line"><span style="color:#B48EAD;">        7</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> if_icmpge     </span><span style="color:#B48EAD;">21</span><span style="color:#616E88;">        // 比较操作数栈中的两个数，如果下面的数大于上面的数，就跳转到 21 。这里的比较是将两个数做减法。因为涉及运算操作，所以会将两个数弹出操作数栈来进行运算。运算结束后操作数栈为空</span></span>
<span class="line"><span style="color:#B48EAD;">       10</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iload_2                </span><span style="color:#616E88;">// 将局部变量 2 号槽位的数放入操作数栈中，放入的值是 0 </span></span>
<span class="line"><span style="color:#B48EAD;">       11</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iinc          </span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 1</span><span style="color:#616E88;">        // 将局部变量 2 号槽位的数加 1 ，自增后，槽位中的值为 1 </span></span>
<span class="line"><span style="color:#B48EAD;">       14</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_2        </span><span style="color:#616E88;">//将操作数栈中的数放入到局部变量表的 2 号槽位，2 号槽位的值又变为了0</span></span>
<span class="line"><span style="color:#B48EAD;">       15</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iinc          </span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 1</span><span style="color:#616E88;"> // 1 号槽位的值自增 1 </span></span>
<span class="line"><span style="color:#B48EAD;">       18</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> goto</span><span style="color:#B48EAD;">          4</span><span style="color:#616E88;"> // 跳转到第4条指令</span></span>
<span class="line"><span style="color:#B48EAD;">       21</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> getstatic     #</span><span style="color:#B48EAD;">2</span><span style="color:#616E88;">                  // Field java/lang/System.out:Ljava/io/PrintStream;</span></span>
<span class="line"><span style="color:#B48EAD;">       24</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iload_2</span></span>
<span class="line"><span style="color:#B48EAD;">       25</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokevirtual #</span><span style="color:#B48EAD;">3</span><span style="color:#616E88;">                  // Method java/io/PrintStream.println:(I)V</span></span>
<span class="line"><span style="color:#B48EAD;">       28</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> return</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-7-构造方法" tabindex="-1"><a class="header-anchor" href="#_2-7-构造方法"><span>2.7 构造方法</span></a></h3><p><strong>cinit()V</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Code_12_CinitTest</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        static</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">        static</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">                i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 20</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">        static</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">                i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 30</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">        public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">                System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // 30</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编译器会按<strong>从上至下</strong>的顺序，收集所有 <code>static</code> 静态代码块和静态成员赋值的代码，<strong>合并</strong>为一个特殊的方法 <code>cinit()V</code> ：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">stack</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> locals</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> args_size</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">0</span></span>
<span class="line"><span style="color:#B48EAD;">         0</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush        </span><span style="color:#B48EAD;">10</span></span>
<span class="line"><span style="color:#B48EAD;">         2</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> putstatic     #</span><span style="color:#B48EAD;">3</span><span style="color:#616E88;">                  // Field i:I</span></span>
<span class="line"><span style="color:#B48EAD;">         5</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush        </span><span style="color:#B48EAD;">20</span></span>
<span class="line"><span style="color:#B48EAD;">         7</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> putstatic     #</span><span style="color:#B48EAD;">3</span><span style="color:#616E88;">                  // Field i:I</span></span>
<span class="line"><span style="color:#B48EAD;">        10</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush        </span><span style="color:#B48EAD;">30</span></span>
<span class="line"><span style="color:#B48EAD;">        12</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> putstatic     #</span><span style="color:#B48EAD;">3</span><span style="color:#616E88;">                  // Field i:I</span></span>
<span class="line"><span style="color:#B48EAD;">        15</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> return</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>cinit()V</code> 方法会在<a href="https://so.csdn.net/so/search?q=%E7%B1%BB%E5%8A%A0%E8%BD%BD&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener noreferrer">类加载</a>的初始化阶段被调用</p><p><strong>init()V</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Main</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#8FBCBB;"> String</span><span style="color:#D8DEE9;"> a</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">s1</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        b </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 20</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> b</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        a </span><span style="color:#81A1C1;">=</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">s2</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#88C0D0;"> Main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#D8DEE9;"> a</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> b</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">a</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> a</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">b</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> b</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        Main</span><span style="color:#D8DEE9;"> d</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Main</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">s3</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 30</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">d</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">a</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//s3</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">d</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">b</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//30</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编译器会按<strong>从上至下</strong>的顺序，收集所有 {} 代码块和成员变量赋值的代码，<strong>形成新的构造方法</strong>，但<strong>原始构造方法</strong>内的代码<strong>总是在后</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">Code</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">stack</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> locals</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">3</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> args_size</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">3</span></span>
<span class="line"><span style="color:#B48EAD;">0</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_0</span></span>
<span class="line"><span style="color:#B48EAD;">1</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokespecial #</span><span style="color:#B48EAD;">1</span><span style="color:#616E88;"> // super.&lt;init&gt;()V</span></span>
<span class="line"><span style="color:#B48EAD;">4</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_0</span></span>
<span class="line"><span style="color:#B48EAD;">5</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ldc #</span><span style="color:#B48EAD;">2</span><span style="color:#616E88;">         // &lt;- &quot;s1&quot;</span></span>
<span class="line"><span style="color:#B48EAD;">7</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> putfield #</span><span style="color:#B48EAD;">3</span><span style="color:#616E88;">    // -&gt; this.a</span></span>
<span class="line"><span style="color:#B48EAD;">10</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_0</span></span>
<span class="line"><span style="color:#B48EAD;">11</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush </span><span style="color:#B48EAD;">20</span><span style="color:#616E88;">     // &lt;- 20</span></span>
<span class="line"><span style="color:#B48EAD;">13</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> putfield #</span><span style="color:#B48EAD;">4</span><span style="color:#616E88;">   // -&gt; this.b</span></span>
<span class="line"><span style="color:#B48EAD;">16</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_0</span></span>
<span class="line"><span style="color:#B48EAD;">17</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush </span><span style="color:#B48EAD;">10</span><span style="color:#616E88;">     // &lt;- 10</span></span>
<span class="line"><span style="color:#B48EAD;">19</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> putfield #</span><span style="color:#B48EAD;">4</span><span style="color:#616E88;">   // -&gt; this.b</span></span>
<span class="line"><span style="color:#B48EAD;">22</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_0</span></span>
<span class="line"><span style="color:#B48EAD;">23</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ldc #</span><span style="color:#B48EAD;">5</span><span style="color:#616E88;">        // &lt;- &quot;s2&quot;</span></span>
<span class="line"><span style="color:#B48EAD;">25</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> putfield #</span><span style="color:#B48EAD;">3</span><span style="color:#616E88;">   // -&gt; this.a</span></span>
<span class="line"><span style="color:#B48EAD;">28</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_0       </span><span style="color:#616E88;">// ------------------------------</span></span>
<span class="line"><span style="color:#B48EAD;">29</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_1       </span><span style="color:#616E88;">// &lt;- slot 1(a) &quot;s3&quot;            |</span></span>
<span class="line"><span style="color:#B48EAD;">30</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> putfield #</span><span style="color:#B48EAD;">3</span><span style="color:#616E88;">   // -&gt; this.a                    |</span></span>
<span class="line"><span style="color:#B48EAD;">33</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_0                                       </span><span style="color:#81A1C1;">|</span></span>
<span class="line"><span style="color:#B48EAD;">34</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iload_2       </span><span style="color:#616E88;">// &lt;- slot 2(b) 30              |</span></span>
<span class="line"><span style="color:#B48EAD;">35</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> putfield #</span><span style="color:#B48EAD;">4</span><span style="color:#616E88;">   // -&gt; this.b --------------------</span></span>
<span class="line"><span style="color:#B48EAD;">38</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> return</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-8-方法调用" tabindex="-1"><a class="header-anchor" href="#_2-8-方法调用"><span>2.8 方法调用</span></a></h3><p>看一下几种不同的方法调用对应的字节码指令</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> main</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Main</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#88C0D0;"> Main</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> test1</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> final</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> test2</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> test3</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> test4</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        Main</span><span style="color:#D8DEE9;"> m</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Main</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        m</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">test1</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        m</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">test2</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        m</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">test3</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        Main</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">test4</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>不同方法在调用时，对应的虚拟机指令有所区别：</p><ul><li><strong>私有</strong>、<strong>构造</strong>、被<strong>final</strong>修饰的方法，在调用时都使用<strong>invokespecial</strong>指令，属于<strong>静态绑定</strong></li><li><strong>普通成员</strong>方法在调用时，使用<strong>invokevirtual</strong>指令。因为编译期间无法确定该方法的内容，只有在运行期间才能确定，属于<strong>动态绑定</strong>，即支持多态</li><li><strong>静态方法</strong>在调用时使用<strong>invokestatic</strong>指令</li></ul><p>对应的字节码文件：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;"> Code</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      stack</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> locals</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> args_size</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span></span>
<span class="line"><span style="color:#B48EAD;">         0</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> new</span><span style="color:#D8DEE9FF;">           #2                  </span><span style="color:#616E88;">// class main/Main</span></span>
<span class="line"><span style="color:#D8DEE9FF;">         3</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> dup</span></span>
<span class="line"><span style="color:#B48EAD;">         4</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokespecial #</span><span style="color:#B48EAD;">3</span><span style="color:#616E88;">                  // Method &quot;&lt;init&gt;&quot;:()V</span></span>
<span class="line"><span style="color:#B48EAD;">         7</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_1</span></span>
<span class="line"><span style="color:#B48EAD;">         8</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_1</span></span>
<span class="line"><span style="color:#B48EAD;">         9</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokespecial #</span><span style="color:#B48EAD;">4</span><span style="color:#616E88;">                  // Method test1:()V</span></span>
<span class="line"><span style="color:#B48EAD;">        12</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_1</span></span>
<span class="line"><span style="color:#B48EAD;">        13</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokespecial #</span><span style="color:#B48EAD;">5</span><span style="color:#616E88;">                  // Method test2:()V</span></span>
<span class="line"><span style="color:#B48EAD;">        16</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_1</span></span>
<span class="line"><span style="color:#B48EAD;">        17</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokevirtual #</span><span style="color:#B48EAD;">6</span><span style="color:#616E88;">                  // Method test3:()V</span></span>
<span class="line"><span style="color:#B48EAD;">        20</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokestatic  #</span><span style="color:#B48EAD;">7</span><span style="color:#616E88;">                  // Method test4:()V</span></span>
<span class="line"><span style="color:#B48EAD;">        23</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> return</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>new 是创建【对象】，给对象分配堆内存，执行成功会将【对象引用】压入操作数栈</li><li>dup 是复制操作数栈栈顶的内容，本例即为【对象引用】，为什么需要两份引用呢，一个是要配合 <code>invokespecial</code> 调用该对象的构造方法 <code>&quot;&lt;init&gt;&quot;:()V</code> （会消耗掉栈顶一个引用），另一个要配合 <code>astore_1</code> 赋值给局部变量</li><li>终方法（ﬁnal），私有方法（private），构造方法都是由 invokespecial 指令来调用，属于静态绑定</li><li>普通成员方法是由 invokevirtual 调用，属于动态绑定，即支持多态，成员方法与静态方法调用的另一个区别是，执行方法前是否需要【对象引用】</li><li>比较有意思的是 d.test4(); 是通过【对象引用】调用一个静态方法，可以看到在调用invokestatic 之前执行了 pop 指令，把【对象引用】从操作数栈弹掉了😂</li><li>还有一个执行 invokespecial 的情况是通过 super 调用父类方法</li></ul><h3 id="_2-9-多态的原理" tabindex="-1"><a class="header-anchor" href="#_2-9-多态的原理"><span>2.9 多态的原理</span></a></h3><p>因为普通成员方法需要在运行时才能确定具体的内容，所以虚拟机需要调用<strong>invokevirtual</strong>指令</p><p>在执行<strong>invokevirtual</strong>指令时，经历了以下几个步骤</p><ul><li>先通过栈帧中对象的引用找到对象</li><li>分析对象头，找到对象实际的Class</li><li>Class结构中有<strong>vtable</strong>，它在类加载的链接阶段就已经根据方法的重写规则生成好了</li><li>查询<strong>vtable</strong>找到方法的具体地址</li><li>执行方法的字节码</li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> cn</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">itcast</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">jvm</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">t3</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">bytecode</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">import</span><span style="color:#8FBCBB;"> java</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">io</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">IOException</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">/**</span></span>
<span class="line"><span style="color:#616E88;">* 演示多态原理，注意加上下面的 JVM 参数，禁用指针压缩</span></span>
<span class="line"><span style="color:#616E88;">* -XX:-UseCompressedOops -XX:-UseCompressedClassPointers</span></span>
<span class="line"><span style="color:#616E88;">*/</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Demo3_10</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> test</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">Animal</span><span style="color:#D8DEE9;"> animal</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        animal</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">eat</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">animal</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toString</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> IOException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">        test</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> Cat</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#88C0D0;">        test</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> Dog</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">in</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#81A1C1;">abstract</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Animal</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> abstract</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> eat</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#8FBCBB;"> String</span><span style="color:#88C0D0;"> toString</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">我是</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#81A1C1;"> this</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getClass</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">getSimpleName</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> Dog</span><span style="color:#81A1C1;"> extends</span><span style="color:#8FBCBB;font-weight:bold;"> Animal</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> eat</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">啃骨头</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> Cat</span><span style="color:#81A1C1;"> extends</span><span style="color:#8FBCBB;font-weight:bold;"> Animal</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> eat</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">吃鱼</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-运行代码" tabindex="-1"><a class="header-anchor" href="#_1-运行代码"><span>1）运行代码</span></a></h4><p>停在 System.in.read() 方法上，这时运行 jps 获取进程 id</p><h4 id="_2-运行-hsdb-工具" tabindex="-1"><a class="header-anchor" href="#_2-运行-hsdb-工具"><span>2）运行 HSDB 工具</span></a></h4><p>进入 JDK 安装目录，执行</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">java </span><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">cp </span><span style="color:#ECEFF4;">.</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lib</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">sa</span><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9;">jdi</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">jar</span><span style="color:#D8DEE9;"> sun</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">jvm</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">hotspot</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">HSDB</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>进入图形界面 attach 进程 id</p><h4 id="_3-查找某个对象" tabindex="-1"><a class="header-anchor" href="#_3-查找某个对象"><span>3）查找某个对象</span></a></h4><p>打开 Tools -&gt; Find Object By Query</p><p>输入</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">select d from </span><span style="color:#D8DEE9;">cn</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">itcast</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">jvm</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">t3</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">bytecode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Dog</span><span style="color:#D8DEE9FF;"> d</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>点击 Execute 执行</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806863.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h4 id="_4-查看对象内存结构" tabindex="-1"><a class="header-anchor" href="#_4-查看对象内存结构"><span>4）查看对象内存结构</span></a></h4><p>点击超链接可以看到对象的内存结构，此对象没有任何属性，因此只有对象头的 16 字节，前 8 字节是</p><p>MarkWord，后 8 字节就是对象的 Class 指针</p><p>但目前看不到它的实际地址</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806948.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h4 id="_5-查看对象-class-的内存地址" tabindex="-1"><a class="header-anchor" href="#_5-查看对象-class-的内存地址"><span>5）查看对象 Class 的内存地址</span></a></h4><p>可以通过 Windows -&gt; Console 进入命令行模式，执行</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">mem </span><span style="color:#B48EAD;">0x00000001299b4978</span><span style="color:#B48EAD;"> 2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>mem 有两个参数，参数 1 是对象地址，参数 2 是查看 2 行（即 16 字节）</p><p>结果中第二行 0x000000001b7d4028 即为 Class 的内存地址</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806050.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h4 id="_6-查看类的-vtable" tabindex="-1"><a class="header-anchor" href="#_6-查看类的-vtable"><span>6）查看类的 vtable</span></a></h4><p>方法1：Alt+R 进入 Inspector 工具，输入刚才的 Class 内存地址，看到如下界面</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806161.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>方法2：或者 Tools -&gt; Class Browser 输入 Dog 查找，可以得到相同的结果</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806177.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>无论通过哪种方法，都可以找到 Dog Class 的 vtable 长度为 6，意思就是 Dog 类有 6 个虚方法（多态相关的，final，static 不会列入）</p><p>那么这 6 个方法都是谁呢？从 Class 的起始地址开始算，偏移 0x1b8 就是 vtable 的起始地址，进行计算得到：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#B48EAD;">0x000000001b7d4028</span></span>
<span class="line"><span style="color:#D8DEE9FF;">               1b8 </span><span style="color:#81A1C1;">+</span></span>
<span class="line"><span style="color:#81A1C1;">---------------------</span></span>
<span class="line"><span style="color:#B48EAD;">0x000000001b7d41e0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过 Windows -&gt; Console 进入命令行模式，执行</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">mem </span><span style="color:#B48EAD;">0x000000001b7d41e0</span><span style="color:#B48EAD;"> 6</span></span>
<span class="line"><span style="color:#B48EAD;">0x000000001b7d41e0</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;"> 0x000000001b3d1b10</span></span>
<span class="line"><span style="color:#B48EAD;">0x000000001b7d41e8</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;"> 0x000000001b3d15e8</span></span>
<span class="line"><span style="color:#B48EAD;">0x000000001b7d41f0</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;"> 0x000000001b7d35e8</span></span>
<span class="line"><span style="color:#B48EAD;">0x000000001b7d41f8</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;"> 0x000000001b3d1540</span></span>
<span class="line"><span style="color:#B48EAD;">0x000000001b7d4200</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;"> 0x000000001b3d1678</span></span>
<span class="line"><span style="color:#B48EAD;">0x000000001b7d4208</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;"> 0x000000001b7d3fa8</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>就得到了 6 个虚方法的入口地址</p><h4 id="_7-验证方法地址" tabindex="-1"><a class="header-anchor" href="#_7-验证方法地址"><span>7）验证方法地址</span></a></h4><p>通过 Tools -&gt; Class Browser 查看每个类的方法定义，比较可知</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806295.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">Dog </span><span style="color:#81A1C1;">-</span><span style="color:#81A1C1;"> public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> eat</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> @</span><span style="color:#D08770;">0x000000001b7d3fa8</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Animal </span><span style="color:#81A1C1;">-</span><span style="color:#81A1C1;"> public</span><span style="color:#D8DEE9;"> java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">String</span><span style="color:#88C0D0;"> toString</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> @</span><span style="color:#D08770;">0x000000001b7d35e8</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Object </span><span style="color:#81A1C1;">-</span><span style="color:#81A1C1;"> protected</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> finalize</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> @</span><span style="color:#D08770;">0x000000001b3d1b10</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Object </span><span style="color:#81A1C1;">-</span><span style="color:#81A1C1;"> public</span><span style="color:#81A1C1;"> boolean</span><span style="color:#88C0D0;"> equals</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Object</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> @</span><span style="color:#D08770;">0x000000001b3d15e8</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Object </span><span style="color:#81A1C1;">-</span><span style="color:#81A1C1;"> public</span><span style="color:#81A1C1;"> native</span><span style="color:#81A1C1;"> int</span><span style="color:#88C0D0;"> hashCode</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> @</span><span style="color:#D08770;">0x000000001b3d1540</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Object </span><span style="color:#81A1C1;">-</span><span style="color:#81A1C1;"> protected</span><span style="color:#81A1C1;"> native</span><span style="color:#D8DEE9;"> java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Object</span><span style="color:#88C0D0;"> clone</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> @</span><span style="color:#D08770;">0x000000001b3d1678</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对号入座，发现</p><ul><li>eat() 方法是 Dog 类自己的</li><li>toString() 方法是继承 String 类的</li><li>finalize() ，equals()，hashCode()，clone() 都是继承 Object 类的</li></ul><h4 id="_8-小结" tabindex="-1"><a class="header-anchor" href="#_8-小结"><span>8）小结</span></a></h4><p>当执行 invokevirtual 指令时，</p><ol><li>先通过栈帧中的对象引用找到对象</li><li>分析对象头，找到对象的实际 Class</li><li>Class 结构中有 vtable，它在类加载的链接阶段就已经根据方法的重写规则生成好了</li><li>查表得到方法的具体地址</li><li>执行方法的字节码</li></ol><h3 id="_2-10-异常处理" tabindex="-1"><a class="header-anchor" href="#_2-10-异常处理"><span>2.10 异常处理</span></a></h3><h4 id="_1-try-catch" tabindex="-1"><a class="header-anchor" href="#_1-try-catch"><span>（1）try-catch</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Main</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">            i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">Exception</span><span style="color:#D8DEE9;"> e</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">            i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 20</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应的字节码文件（为了抓住重点，下面的字节码省略了不重要的部分）：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">  Code</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      stack</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> locals</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">3</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> args_size</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span></span>
<span class="line"><span style="color:#B48EAD;">         0</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iconst_0</span></span>
<span class="line"><span style="color:#B48EAD;">         1</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#B48EAD;">         2</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush        </span><span style="color:#B48EAD;">10</span></span>
<span class="line"><span style="color:#B48EAD;">         4</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#B48EAD;">         5</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> goto</span><span style="color:#B48EAD;">          12</span></span>
<span class="line"><span style="color:#B48EAD;">         8</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_2</span></span>
<span class="line"><span style="color:#B48EAD;">         9</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush        </span><span style="color:#B48EAD;">20</span></span>
<span class="line"><span style="color:#B48EAD;">        11</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#B48EAD;">        12</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> return</span></span>
<span class="line"><span style="color:#8FBCBB;">      Exception</span><span style="color:#D8DEE9;"> table</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">         from    to  target type</span></span>
<span class="line"><span style="color:#B48EAD;">             2</span><span style="color:#B48EAD;">     5</span><span style="color:#B48EAD;">     8</span><span style="color:#8FBCBB;">   Class</span><span style="color:#D8DEE9FF;"> java</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#8FBCBB;">Exception</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>可以看到多出来一个 <strong>Exception table</strong> 的结构，[from, to) 是<strong>前闭后开</strong>（也就是检测2~4行）的检测范围，一旦这个范围内的字节码执行出现异常，则通过 type 匹配异常类型，如果一致，进入 target 所指示行号</li><li>8行的字节码指令 astore_2 是将异常对象引用存入局部变量表的2号位置（为e）</li></ul><h4 id="_2-多个-single-catch-块的情况" tabindex="-1"><a class="header-anchor" href="#_2-多个-single-catch-块的情况"><span>（2）多个 single-catch 块的情况</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Demo3_11_2</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">            i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">ArithmeticException</span><span style="color:#D8DEE9;"> e</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">            i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 30</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">NullPointerException</span><span style="color:#D8DEE9;"> e</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">            i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 40</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">Exception</span><span style="color:#D8DEE9;"> e</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">            i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 50</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应的字节码文件：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">String</span><span style="color:#ECEFF4;">[])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    descriptor</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;"> ([</span><span style="color:#D8DEE9FF;">Ljava</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">String</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#8FBCBB;">V</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    flags</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ACC_PUBLIC</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> ACC_STATIC</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    Code</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        stack</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> locals</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">3</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> args_size</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span></span>
<span class="line"><span style="color:#B48EAD;">            0</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iconst_0</span></span>
<span class="line"><span style="color:#B48EAD;">            1</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#B48EAD;">            2</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush            </span><span style="color:#B48EAD;">10</span></span>
<span class="line"><span style="color:#B48EAD;">            4</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#B48EAD;">            5</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> goto</span><span style="color:#B48EAD;">              26</span></span>
<span class="line"><span style="color:#B48EAD;">            8</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_2</span></span>
<span class="line"><span style="color:#B48EAD;">            9</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush            </span><span style="color:#B48EAD;">30</span></span>
<span class="line"><span style="color:#B48EAD;">            11</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#B48EAD;">            12</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> goto</span><span style="color:#B48EAD;">             26</span></span>
<span class="line"><span style="color:#B48EAD;">            15</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_2</span></span>
<span class="line"><span style="color:#B48EAD;">            16</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush           </span><span style="color:#B48EAD;">40</span></span>
<span class="line"><span style="color:#B48EAD;">            18</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#B48EAD;">            19</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> goto</span><span style="color:#B48EAD;">             26</span></span>
<span class="line"><span style="color:#B48EAD;">            22</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_2</span></span>
<span class="line"><span style="color:#B48EAD;">            23</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush           </span><span style="color:#B48EAD;">50</span></span>
<span class="line"><span style="color:#B48EAD;">            25</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#B48EAD;">            26</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> return</span></span>
<span class="line"><span style="color:#8FBCBB;">    Exception</span><span style="color:#D8DEE9;"> table</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    from to target type</span></span>
<span class="line"><span style="color:#B48EAD;">       2</span><span style="color:#B48EAD;">  5</span><span style="color:#B48EAD;">   8</span><span style="color:#8FBCBB;">     Class</span><span style="color:#D8DEE9FF;"> java</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#8FBCBB;">ArithmeticException</span></span>
<span class="line"><span style="color:#B48EAD;">       2</span><span style="color:#B48EAD;">  5</span><span style="color:#B48EAD;">   15</span><span style="color:#8FBCBB;">     Class</span><span style="color:#D8DEE9FF;"> java</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#8FBCBB;">NullPointerException</span></span>
<span class="line"><span style="color:#B48EAD;">       2</span><span style="color:#B48EAD;">  5</span><span style="color:#B48EAD;">   22</span><span style="color:#8FBCBB;">     Class</span><span style="color:#D8DEE9FF;"> java</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#8FBCBB;">Exception</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    LineNumberTable</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;"> ...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    LocalVariableTable</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#8FBCBB;">    Start</span><span style="color:#8FBCBB;"> Length</span><span style="color:#8FBCBB;"> Slot</span><span style="color:#8FBCBB;"> Name</span><span style="color:#8FBCBB;"> Signature</span></span>
<span class="line"><span style="color:#B48EAD;">        9</span><span style="color:#B48EAD;">     3</span><span style="color:#B48EAD;">     2</span><span style="color:#D8DEE9FF;">   e     Ljava</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">ArithmeticException</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#B48EAD;">       16</span><span style="color:#B48EAD;">     3</span><span style="color:#B48EAD;">     2</span><span style="color:#D8DEE9FF;">   e     Ljava</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">NullPointerException</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#B48EAD;">       23</span><span style="color:#B48EAD;">     3</span><span style="color:#B48EAD;">     2</span><span style="color:#D8DEE9FF;">   e     Ljava</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">Exception</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#B48EAD;">        0</span><span style="color:#B48EAD;">    27</span><span style="color:#B48EAD;">     0</span><span style="color:#D8DEE9FF;">  args   </span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">Ljava</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">String</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#B48EAD;">        2</span><span style="color:#B48EAD;">    25</span><span style="color:#B48EAD;">     1</span><span style="color:#D8DEE9FF;">   i     </span><span style="color:#8FBCBB;">I</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    StackMapTable</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;"> ...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    MethodParameters</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;"> ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>因为异常出现时，<strong>只能进入</strong> Exception table 中<strong>一个分支</strong>，所以局部变量表 slot 2 位置<strong>被共用</strong></li></ul><h4 id="_3-multi-catch-的情况" tabindex="-1"><a class="header-anchor" href="#_3-multi-catch-的情况"><span>（3）multi-catch 的情况</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Demo3_11_3</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">                Method</span><span style="color:#D8DEE9;"> test</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Demo3_11_3</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getMethod</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">test</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">                test</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">invoke</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">null</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">NoSuchMethodException</span><span style="color:#ECEFF4;"> |</span><span style="color:#8FBCBB;"> IllegalAccessException</span><span style="color:#ECEFF4;"> |</span></span>
<span class="line"><span style="color:#8FBCBB;">            InvocationTargetException</span><span style="color:#D8DEE9;"> e</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">                e</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">printStackTrace</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">                }</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#81A1C1;">        public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> test</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ok</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">String</span><span style="color:#ECEFF4;">[])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">descriptor</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;"> ([</span><span style="color:#D8DEE9FF;">Ljava</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">String</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">)</span><span style="color:#8FBCBB;">V</span></span>
<span class="line"><span style="color:#D8DEE9FF;">flags</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ACC_PUBLIC</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> ACC_STATIC</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Code</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">stack</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">3</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> locals</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> args_size</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span></span>
<span class="line"><span style="color:#B48EAD;">0</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ldc #</span><span style="color:#B48EAD;">2</span></span>
<span class="line"><span style="color:#B48EAD;">2</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ldc #</span><span style="color:#B48EAD;">3</span></span>
<span class="line"><span style="color:#B48EAD;">4</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iconst_0</span></span>
<span class="line"><span style="color:#B48EAD;">5</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> anewarray #</span><span style="color:#B48EAD;">4</span></span>
<span class="line"><span style="color:#B48EAD;">8</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokevirtual #</span><span style="color:#B48EAD;">5</span></span>
<span class="line"><span style="color:#B48EAD;">11</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_1</span></span>
<span class="line"><span style="color:#B48EAD;">12</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_1</span></span>
<span class="line"><span style="color:#B48EAD;">13</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aconst_null</span></span>
<span class="line"><span style="color:#B48EAD;">14</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iconst_0</span></span>
<span class="line"><span style="color:#B48EAD;">15</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> anewarray #</span><span style="color:#B48EAD;">6</span></span>
<span class="line"><span style="color:#B48EAD;">18</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokevirtual #</span><span style="color:#B48EAD;">7</span></span>
<span class="line"><span style="color:#B48EAD;">21</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> pop</span></span>
<span class="line"><span style="color:#B48EAD;">22</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> goto</span><span style="color:#B48EAD;"> 30</span></span>
<span class="line"><span style="color:#B48EAD;">25</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_1</span></span>
<span class="line"><span style="color:#B48EAD;">26</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_1</span></span>
<span class="line"><span style="color:#B48EAD;">27</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokevirtual #</span><span style="color:#B48EAD;">11</span><span style="color:#616E88;"> // e.printStackTrace:()V</span></span>
<span class="line"><span style="color:#B48EAD;">30</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> return</span></span>
<span class="line"><span style="color:#8FBCBB;">Exception</span><span style="color:#D8DEE9;"> table</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">from to target type</span></span>
<span class="line"><span style="color:#B48EAD;">0</span><span style="color:#B48EAD;"> 22</span><span style="color:#B48EAD;"> 25</span><span style="color:#8FBCBB;"> Class</span><span style="color:#D8DEE9FF;"> java</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#8FBCBB;">NoSuchMethodException</span></span>
<span class="line"><span style="color:#B48EAD;">0</span><span style="color:#B48EAD;"> 22</span><span style="color:#B48EAD;"> 25</span><span style="color:#8FBCBB;"> Class</span><span style="color:#D8DEE9FF;"> java</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#8FBCBB;">IllegalAccessException</span></span>
<span class="line"><span style="color:#B48EAD;">0</span><span style="color:#B48EAD;"> 22</span><span style="color:#B48EAD;"> 25</span><span style="color:#8FBCBB;"> Class</span><span style="color:#D8DEE9FF;"> java</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">reflect</span><span style="color:#81A1C1;">/</span><span style="color:#8FBCBB;">InvocationTargetException</span></span>
<span class="line"><span style="color:#D8DEE9FF;">LineNumberTable</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;"> ...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">LocalVariableTable</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#8FBCBB;">Start</span><span style="color:#8FBCBB;"> Length</span><span style="color:#8FBCBB;"> Slot</span><span style="color:#8FBCBB;"> Name</span><span style="color:#8FBCBB;"> Signature</span></span>
<span class="line"><span style="color:#B48EAD;">12</span><span style="color:#B48EAD;"> 10</span><span style="color:#B48EAD;"> 1</span><span style="color:#D8DEE9FF;"> test Ljava</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">reflect</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">Method</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#B48EAD;">26</span><span style="color:#B48EAD;"> 4</span><span style="color:#B48EAD;"> 1</span><span style="color:#D8DEE9FF;"> e Ljava</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">ReflectiveOperationException</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#B48EAD;">0</span><span style="color:#B48EAD;"> 31</span><span style="color:#B48EAD;"> 0</span><span style="color:#D8DEE9FF;"> args </span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">Ljava</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">String</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">StackMapTable</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;"> ...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">MethodParameters</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;"> ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-finally" tabindex="-1"><a class="header-anchor" href="#_4-finally"><span>（4）finally</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Main</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">            i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">Exception</span><span style="color:#D8DEE9;"> e</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">            i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 20</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;"> finally</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">            i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 30</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应的字节码文件：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">   Code</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      stack</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> locals</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">4</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> args_size</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">          </span></span>
<span class="line"><span style="color:#B48EAD;">         0</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iconst_0</span></span>
<span class="line"><span style="color:#B48EAD;">         1</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#616E88;">          //try块</span></span>
<span class="line"><span style="color:#B48EAD;">         2</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush        </span><span style="color:#B48EAD;">10</span></span>
<span class="line"><span style="color:#B48EAD;">         4</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#B48EAD;">         5</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush        </span><span style="color:#B48EAD;">30</span></span>
<span class="line"><span style="color:#616E88;">         //try块执行完后，会执行finally </span></span>
<span class="line"><span style="color:#B48EAD;">         7</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#B48EAD;">         8</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> goto</span><span style="color:#B48EAD;">          27</span></span>
<span class="line"><span style="color:#616E88;">         //catch块</span></span>
<span class="line"><span style="color:#B48EAD;">        11</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_2</span></span>
<span class="line"><span style="color:#B48EAD;">        12</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush        </span><span style="color:#B48EAD;">20</span></span>
<span class="line"><span style="color:#B48EAD;">        14</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#616E88;">         //catch块执行完，会执行finally</span></span>
<span class="line"><span style="color:#B48EAD;">        15</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush        </span><span style="color:#B48EAD;">30</span></span>
<span class="line"><span style="color:#B48EAD;">        17</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#B48EAD;">        18</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> goto</span><span style="color:#B48EAD;">          27</span></span>
<span class="line"><span style="color:#616E88;">        //出现异常，但未被Exception捕获，会抛出其他异常，这时也需要执行finally块中的代码   </span></span>
<span class="line"><span style="color:#B48EAD;">        21</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_3</span></span>
<span class="line"><span style="color:#B48EAD;">        22</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush        </span><span style="color:#B48EAD;">30</span></span>
<span class="line"><span style="color:#B48EAD;">        24</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1</span></span>
<span class="line"><span style="color:#B48EAD;">        25</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_3</span></span>
<span class="line"><span style="color:#B48EAD;">        26</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> athrow </span><span style="color:#616E88;">//抛出异常</span></span>
<span class="line"><span style="color:#B48EAD;">        27</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> return</span></span>
<span class="line"><span style="color:#8FBCBB;">      Exception</span><span style="color:#D8DEE9;"> table</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">         from    to  target type</span></span>
<span class="line"><span style="color:#B48EAD;">             2</span><span style="color:#B48EAD;">     5</span><span style="color:#B48EAD;">    11</span><span style="color:#8FBCBB;">   Class</span><span style="color:#D8DEE9FF;"> java</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">lang</span><span style="color:#81A1C1;">/</span><span style="color:#8FBCBB;">Exception</span></span>
<span class="line"><span style="color:#B48EAD;">             2</span><span style="color:#B48EAD;">     5</span><span style="color:#B48EAD;">    21</span><span style="color:#D8DEE9FF;">   any </span><span style="color:#616E88;">//剩余的异常类型，比如 Error</span></span>
<span class="line"><span style="color:#B48EAD;">            11</span><span style="color:#B48EAD;">    15</span><span style="color:#B48EAD;">    21</span><span style="color:#D8DEE9FF;">   any </span><span style="color:#616E88;">//剩余的异常类型，比如 Erro</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到 finally 中的代码被复制了 3 份，分别放入 try 流程，catch 流程以及 catch 剩余的异常类型流程</p><blockquote><p>注意：</p><p>虽然从字节码指令看来，每个块中都有finally块，但是finally块中的代码<strong>只会被执行一次</strong></p></blockquote><h4 id="_5-finally中的return" tabindex="-1"><a class="header-anchor" href="#_5-finally中的return"><span>（5）finally中的return</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Main</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#D8DEE9;"> result</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> test</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">result</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//20</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> int</span><span style="color:#88C0D0;"> test</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            return</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;"> finally</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            return</span><span style="color:#B48EAD;"> 20</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应的字节码文件：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">Code</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">     stack</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> locals</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">3</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> args_size</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">0</span></span>
<span class="line"><span style="color:#B48EAD;">        0</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush        </span><span style="color:#B48EAD;">10</span></span>
<span class="line"><span style="color:#B48EAD;">        2</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_0</span></span>
<span class="line"><span style="color:#B48EAD;">        3</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iload_0</span></span>
<span class="line"><span style="color:#B48EAD;">        4</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1  </span><span style="color:#616E88;">// 暂存返回值</span></span>
<span class="line"><span style="color:#B48EAD;">        5</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush        </span><span style="color:#B48EAD;">20</span></span>
<span class="line"><span style="color:#B48EAD;">        7</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_0</span></span>
<span class="line"><span style="color:#B48EAD;">        8</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iload_0</span></span>
<span class="line"><span style="color:#B48EAD;">        9</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ireturn        </span><span style="color:#616E88;">// ireturn 会返回操作数栈顶的整型值 20</span></span>
<span class="line"><span style="color:#616E88;">       // 如果出现异常，还是会执行finally 块中的内容，没有抛出异常</span></span>
<span class="line"><span style="color:#B48EAD;">       10</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_2</span></span>
<span class="line"><span style="color:#B48EAD;">       11</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush        </span><span style="color:#B48EAD;">20</span></span>
<span class="line"><span style="color:#B48EAD;">       13</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_0</span></span>
<span class="line"><span style="color:#B48EAD;">       14</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iload_0</span></span>
<span class="line"><span style="color:#B48EAD;">       15</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ireturn        </span><span style="color:#616E88;">// 这里没有 athrow 了，也就是如果在 finally 块中如果有返回操作的话，且 try 块中出现异常，会吞掉异常！</span></span>
<span class="line"><span style="color:#8FBCBB;">     Exception</span><span style="color:#D8DEE9;"> table</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        from    to  target type</span></span>
<span class="line"><span style="color:#B48EAD;">            0</span><span style="color:#B48EAD;">     5</span><span style="color:#B48EAD;">    10</span><span style="color:#D8DEE9FF;">   any</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>由于 finally 中的 ireturn 被插入了所有可能的流程，因此返回结果肯定以 finally 的为准</li><li>跟前一个中的 finally 相比，发现没有 athrow 了，这告诉我们：如果在 finally 中出现了 return，会吞掉异常</li><li>所以不要在finally中进行返回操作</li></ul><p>运行下面的代码，不会抛出异常：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Main</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#D8DEE9;"> result</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> test</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">result</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> int</span><span style="color:#88C0D0;"> test</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 1</span><span style="color:#81A1C1;"> /</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">            return</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;"> finally</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            return</span><span style="color:#B48EAD;"> 20</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-finally不带return" tabindex="-1"><a class="header-anchor" href="#_6-finally不带return"><span>（6）finally不带return</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Main</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Main</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">test</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//输出为10</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> int</span><span style="color:#88C0D0;"> test</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            return</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;"> finally</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">            i </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 20</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应的字节码文件：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">Code</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      stack</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> locals</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">3</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> args_size</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">0</span></span>
<span class="line"><span style="color:#B48EAD;">        0</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush        </span><span style="color:#B48EAD;">10</span></span>
<span class="line"><span style="color:#B48EAD;">        2</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_0     </span><span style="color:#616E88;">//赋值给i 10</span></span>
<span class="line"><span style="color:#B48EAD;">        3</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iload_0      </span><span style="color:#616E88;">//加载到操作数栈顶</span></span>
<span class="line"><span style="color:#B48EAD;">        4</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_1     </span><span style="color:#616E88;">//加载到局部变量表的1号位置</span></span>
<span class="line"><span style="color:#B48EAD;">        5</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush        </span><span style="color:#B48EAD;">20</span></span>
<span class="line"><span style="color:#B48EAD;">        7</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_0     </span><span style="color:#616E88;">//赋值给i 20</span></span>
<span class="line"><span style="color:#B48EAD;">        8</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iload_1      </span><span style="color:#616E88;">//加载局部变量表1号位置的数10到操作数栈</span></span>
<span class="line"><span style="color:#B48EAD;">        9</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ireturn      </span><span style="color:#616E88;">//返回操作数栈顶元素 10</span></span>
<span class="line"><span style="color:#B48EAD;">       10</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_2</span></span>
<span class="line"><span style="color:#B48EAD;">       11</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush        </span><span style="color:#B48EAD;">20</span></span>
<span class="line"><span style="color:#B48EAD;">       13</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> istore_0</span></span>
<span class="line"><span style="color:#B48EAD;">       14</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_2      </span><span style="color:#616E88;">//加载异常</span></span>
<span class="line"><span style="color:#B48EAD;">       15</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> athrow       </span><span style="color:#616E88;">//抛出异常</span></span>
<span class="line"><span style="color:#8FBCBB;">      Exception</span><span style="color:#D8DEE9;"> table</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">         from    to  target type</span></span>
<span class="line"><span style="color:#B48EAD;">             3</span><span style="color:#B48EAD;">     5</span><span style="color:#B48EAD;">    10</span><span style="color:#D8DEE9FF;">   any</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-11-synchronized" tabindex="-1"><a class="header-anchor" href="#_2-11-synchronized"><span>2.11 synchronized</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Code_19_SyncTest</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        Object</span><span style="color:#D8DEE9;"> lock</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Object</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        synchronized</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">lock</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ok</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#D8DEE9FF;">Code</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      stack</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> locals</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">4</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> args_size</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span></span>
<span class="line"><span style="color:#B48EAD;">         0</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> new</span><span style="color:#D8DEE9FF;">           #2                  </span><span style="color:#616E88;">// class java/lang/Object</span></span>
<span class="line"><span style="color:#D8DEE9FF;">         3</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> dup </span><span style="color:#616E88;">// 复制一份栈顶，然后压入栈中。用于函数消耗</span></span>
<span class="line"><span style="color:#B48EAD;">         4</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokespecial #</span><span style="color:#B48EAD;">1</span><span style="color:#616E88;">                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span>
<span class="line"><span style="color:#B48EAD;">         7</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_1 </span><span style="color:#616E88;">// 将栈顶的对象地址方法 局部变量表中 1 中</span></span>
<span class="line"><span style="color:#B48EAD;">         8</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_1 </span><span style="color:#616E88;">// 加载到操作数栈</span></span>
<span class="line"><span style="color:#B48EAD;">         9</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> dup </span><span style="color:#616E88;">// 复制一份，放到操作数栈，用于加锁时消耗</span></span>
<span class="line"><span style="color:#B48EAD;">        10</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_2 </span><span style="color:#616E88;">// 将操作数栈顶元素弹出，暂存到局部变量表的 2 号槽位。这时操作数栈中有一份对象的引用</span></span>
<span class="line"><span style="color:#B48EAD;">        11</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> monitorenter </span><span style="color:#616E88;">// 加锁</span></span>
<span class="line"><span style="color:#B48EAD;">        12</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> getstatic     #</span><span style="color:#B48EAD;">3</span><span style="color:#616E88;">                  // Field java/lang/System.out:Ljava/io/PrintStream;</span></span>
<span class="line"><span style="color:#B48EAD;">        15</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> ldc           #</span><span style="color:#B48EAD;">4</span><span style="color:#616E88;">                  // String ok</span></span>
<span class="line"><span style="color:#B48EAD;">        17</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokevirtual #</span><span style="color:#B48EAD;">5</span><span style="color:#616E88;">                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span></span>
<span class="line"><span style="color:#B48EAD;">        20</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_2 </span><span style="color:#616E88;">// 加载对象到栈顶</span></span>
<span class="line"><span style="color:#B48EAD;">        21</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> monitorexit </span><span style="color:#616E88;">// 释放锁</span></span>
<span class="line"><span style="color:#B48EAD;">        22</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> goto</span><span style="color:#B48EAD;">          30</span></span>
<span class="line"><span style="color:#616E88;">        // 异常情况的解决方案 释放锁！</span></span>
<span class="line"><span style="color:#B48EAD;">        25</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_3</span></span>
<span class="line"><span style="color:#B48EAD;">        26</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_2</span></span>
<span class="line"><span style="color:#B48EAD;">        27</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> monitorexit</span></span>
<span class="line"><span style="color:#B48EAD;">        28</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_3</span></span>
<span class="line"><span style="color:#B48EAD;">        29</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> athrow</span></span>
<span class="line"><span style="color:#B48EAD;">        30</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> return</span></span>
<span class="line"><span style="color:#616E88;">        // 异常表！</span></span>
<span class="line"><span style="color:#8FBCBB;">      Exception</span><span style="color:#D8DEE9;"> table</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">         from    to  target type</span></span>
<span class="line"><span style="color:#B48EAD;">            12</span><span style="color:#B48EAD;">    22</span><span style="color:#B48EAD;">    25</span><span style="color:#D8DEE9FF;">   any</span></span>
<span class="line"><span style="color:#B48EAD;">            25</span><span style="color:#B48EAD;">    28</span><span style="color:#B48EAD;">    25</span><span style="color:#D8DEE9FF;">   any</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-编译器处理" tabindex="-1"><a class="header-anchor" href="#_3-编译器处理"><span>3. 编译器处理</span></a></h2><p>所谓的 <strong>语法糖</strong> ，其实就是指 java 编译器把 .java 源码编译为 .class 字节码的过程中，自动生成和转换的一些代码，主要是为了减轻程序员的负担，算是 java 编译器给我们的一个额外福利 <strong>注意</strong>，以下代码的分析，借助了 javap 工具，idea 的反编译功能，idea 插件 jclasslib 等工具。另外， 编译器转换的<strong>结果直接就是 class 字节码</strong>，只是为了便于阅读，给出了 几乎等价 的 java 源码方式，并不是编译器还会转换出中间的 java 源码，切记。</p><h3 id="_3-1-默认构造器" tabindex="-1"><a class="header-anchor" href="#_3-1-默认构造器"><span>3.1 默认构造器</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy1</span><span style="color:#ECEFF4;"> {}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>编译成class后的代码：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy1</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">   // 这个无参构造器是java编译器帮我们加上的</span></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#88C0D0;"> Candy1</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">      // 即调用父类 Object 的无参构造方法，即调用 java/lang/Object.&quot; &lt;init&gt;&quot;:()V</span></span>
<span class="line"><span style="color:#81A1C1;">      super</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-自动拆装箱" tabindex="-1"><a class="header-anchor" href="#_3-2-自动拆装箱"><span>3.2 自动拆装箱</span></a></h3><p>基本类型和其包装类型的相互转换过程，称为拆装箱 在 JDK 5 以后，它们的转换可以在编译期自动完成</p><p>这个特性是 <code>JDK 5</code> 开始加入的， 如下代码 ：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy2</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        Integer</span><span style="color:#D8DEE9;"> x</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 1</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#D8DEE9;"> y</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> x</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这段代码在 <code>JDK 5</code> 之前是无法编译通过的，必须改写下面这样 :</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy2</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">        //基本类型转包装类型→装箱</span></span>
<span class="line"><span style="color:#8FBCBB;">        Integer</span><span style="color:#D8DEE9;"> x</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Integer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">valueOf</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        //包装类型转基本类型→拆箱</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#D8DEE9;"> y</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> x</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">intValue</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>转换过程如下</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy2</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">      // 基本类型赋值给包装类型，称为装箱</span></span>
<span class="line"><span style="color:#8FBCBB;">      Integer</span><span style="color:#D8DEE9;"> x</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Integer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">valueOf</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">      // 包装类型赋值给基本类型，称谓拆箱</span></span>
<span class="line"><span style="color:#81A1C1;">      int</span><span style="color:#D8DEE9;"> y</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> x</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">intValue</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-泛型集合取值" tabindex="-1"><a class="header-anchor" href="#_3-3-泛型集合取值"><span>3.3 泛型集合取值</span></a></h3><p>泛型也是在 <code>JDK 5</code> 开始加入的特性，但 java 在编译泛型代码后会执行<strong>泛型擦除</strong> 的动作，即泛型信息在编译为字节码之后就丢失了（实际上有一些类信息没被擦除，为了反射使用），实际的类型都当做了 <strong>Object</strong> 类型来处理：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy3</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        List</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">Integer</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> list</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> ArrayList</span><span style="color:#ECEFF4;">&lt;&gt;()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">10</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // 实际调用的是 List.add(Object e)</span></span>
<span class="line"><span style="color:#8FBCBB;">        Integer</span><span style="color:#D8DEE9;"> x</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // 实际调用的是 Object obj = List.get(int index);</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所以在取值时，编译器真正生成的字节码中，还要额外做一个类型转换的操作：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// 需要将 Object 转为 Integer</span></span>
<span class="line"><span style="color:#8FBCBB;">Integer</span><span style="color:#D8DEE9;"> x</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">Integer</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9;">list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>如果前面的 x 变量类型修改为 int 基本类型那么最终生成的字节码是：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// 需要将 Object 转为 Integer, 并执行拆箱操作</span></span>
<span class="line"><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> x</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> ((</span><span style="color:#D8DEE9FF;">Integer</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9;">list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">)).</span><span style="color:#88C0D0;">intValue</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>对应字节码：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">Code</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    stack</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> locals</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">3</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> args_size</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span></span>
<span class="line"><span style="color:#B48EAD;">       0</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> new</span><span style="color:#D8DEE9FF;">           #2                  </span><span style="color:#616E88;">// class java/util/ArrayList</span></span>
<span class="line"><span style="color:#D8DEE9FF;">       3</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> dup</span></span>
<span class="line"><span style="color:#B48EAD;">       4</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokespecial #</span><span style="color:#B48EAD;">3</span><span style="color:#616E88;">                  // Method java/util/ArrayList.&quot;&lt;init&gt;&quot;:()V</span></span>
<span class="line"><span style="color:#B48EAD;">       7</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_1</span></span>
<span class="line"><span style="color:#B48EAD;">       8</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_1</span></span>
<span class="line"><span style="color:#B48EAD;">       9</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> bipush        </span><span style="color:#B48EAD;">10</span></span>
<span class="line"><span style="color:#B48EAD;">      11</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokestatic  #</span><span style="color:#B48EAD;">4</span><span style="color:#616E88;">                  // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</span></span>
<span class="line"><span style="color:#616E88;">      //这里进行了泛型擦除，实际调用的是add(Objcet o)</span></span>
<span class="line"><span style="color:#B48EAD;">      14</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokeinterface #</span><span style="color:#B48EAD;">5</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;">  2</span><span style="color:#616E88;">            // InterfaceMethod java/util/List.add:(Ljava/lang/Object;)Z</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B48EAD;">      19</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> pop</span></span>
<span class="line"><span style="color:#B48EAD;">      20</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_1</span></span>
<span class="line"><span style="color:#B48EAD;">      21</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> iconst_0</span></span>
<span class="line"><span style="color:#616E88;">      //这里也进行了泛型擦除，实际调用的是get(Object o)   </span></span>
<span class="line"><span style="color:#B48EAD;">      22</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokeinterface #</span><span style="color:#B48EAD;">6</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;">  2</span><span style="color:#616E88;">            // InterfaceMethod java/util/List.get:(I)Ljava/lang/Object;</span></span>
<span class="line"><span style="color:#616E88;">//这里进行了类型转换，将Object转换成了Integer</span></span>
<span class="line"><span style="color:#B48EAD;">      27</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> checkcast     #</span><span style="color:#B48EAD;">7</span><span style="color:#616E88;">                  // class java/lang/Integer</span></span>
<span class="line"><span style="color:#B48EAD;">      30</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> astore_2</span></span>
<span class="line"><span style="color:#B48EAD;">      31</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> return</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所以调用 get 函数取值时，有一个类型转换的操作。</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#8FBCBB;">Integer</span><span style="color:#D8DEE9;"> x</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">Integer</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9;"> list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>如果要将返回结果赋值给一个 int 类型的变量，则还有自动拆箱的操作</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> x</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">Integer</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9;"> list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">).</span><span style="color:#88C0D0;">intValue</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_3-4反射获取泛型信息" tabindex="-1"><a class="header-anchor" href="#_3-4反射获取泛型信息"><span>3.4反射获取泛型信息</span></a></h3><p>擦除的是字节码上的泛型信息，可以看到 LocalVariableTypeTable 仍然保留了方法参数泛型的信息</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#D8DEE9;"> cn</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">itcast</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">jvm</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">t3</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">candy</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Candy3</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    descriptor</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;"> ()</span><span style="color:#8FBCBB;">V</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    flags</span><span style="color:#81A1C1;">:</span><span style="color:#8FBCBB;"> ACC_PUBLIC</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    Code</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        stack</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> locals</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> args_size</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">1</span></span>
<span class="line"><span style="color:#B48EAD;">        0</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> aload_0</span></span>
<span class="line"><span style="color:#B48EAD;">        1</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> invokespecial #</span><span style="color:#B48EAD;">1</span><span style="color:#616E88;"> // Method java/lang/Object.&quot;</span></span>
<span class="line"><span style="color:#81A1C1;"> &lt;</span><span style="color:#D8DEE9FF;">init</span><span style="color:#81A1C1;">&gt;</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">:()V</span></span>
<span class="line"><span style="color:#A3BE8C;">        4: return</span></span>
<span class="line"><span style="color:#A3BE8C;">       LineNumberTable:</span></span>
<span class="line"><span style="color:#A3BE8C;">        line 6: 0</span></span>
<span class="line"><span style="color:#A3BE8C;">        LocalVariableTable:</span></span>
<span class="line"><span style="color:#A3BE8C;">        Start Length Slot Name Signature</span></span>
<span class="line"><span style="color:#A3BE8C;">            0     5     0 this Lcn/itcast/jvm/t3/candy/Candy3;</span></span>
<span class="line"><span style="color:#A3BE8C;">  public static void main(java.lang.String[]);</span></span>
<span class="line"><span style="color:#A3BE8C;">       descriptor: ([Ljava/lang/String;)V</span></span>
<span class="line"><span style="color:#A3BE8C;">       flags: ACC_PUBLIC, ACC_STATIC</span></span>
<span class="line"><span style="color:#A3BE8C;">       Code:</span></span>
<span class="line"><span style="color:#A3BE8C;">        stack=2, locals=3, args_size=1</span></span>
<span class="line"><span style="color:#A3BE8C;">        0: new #2 // class java/util/ArrayList</span></span>
<span class="line"><span style="color:#A3BE8C;">        3: dup</span></span>
<span class="line"><span style="color:#A3BE8C;">        4: invokespecial #3 // Method java/util/ArrayList.</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;</span><span style="color:#D8DEE9FF;">init</span><span style="color:#81A1C1;">&gt;</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">:()V</span></span>
<span class="line"><span style="color:#A3BE8C;">        7: astore_1</span></span>
<span class="line"><span style="color:#A3BE8C;">        8: aload_1</span></span>
<span class="line"><span style="color:#A3BE8C;">        9: bipush 10</span></span>
<span class="line"><span style="color:#A3BE8C;">        11: invokestatic #4 // Method</span></span>
<span class="line"><span style="color:#A3BE8C;">        java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</span></span>
<span class="line"><span style="color:#A3BE8C;">        14: invokeinterface #5, 2 // InterfaceMethod</span></span>
<span class="line"><span style="color:#A3BE8C;">        java/util/List.add:(Ljava/lang/Object;)Z</span></span>
<span class="line"><span style="color:#A3BE8C;">        19: pop</span></span>
<span class="line"><span style="color:#A3BE8C;">        20: aload_1</span></span>
<span class="line"><span style="color:#A3BE8C;">        21: iconst_0</span></span>
<span class="line"><span style="color:#A3BE8C;">        22: invokeinterface #6, 2 // InterfaceMethod</span></span>
<span class="line"><span style="color:#A3BE8C;">        java/util/List.get:(I)Ljava/lang/Object;</span></span>
<span class="line"><span style="color:#A3BE8C;">        27: checkcast #7 // class java/lang/Integer</span></span>
<span class="line"><span style="color:#A3BE8C;">        30: astore_2</span></span>
<span class="line"><span style="color:#A3BE8C;">        31: return</span></span>
<span class="line"><span style="color:#A3BE8C;">        LineNumberTable:</span></span>
<span class="line"><span style="color:#A3BE8C;">        line 8: 0</span></span>
<span class="line"><span style="color:#A3BE8C;">        line 9: 8</span></span>
<span class="line"><span style="color:#A3BE8C;">        line 10: 20</span></span>
<span class="line"><span style="color:#A3BE8C;">        line 11: 31</span></span>
<span class="line"><span style="color:#A3BE8C;">        LocalVariableTable:</span></span>
<span class="line"><span style="color:#A3BE8C;">        Start Length Slot Name Signature</span></span>
<span class="line"><span style="color:#A3BE8C;">            0     32   0  args [Ljava/lang/String;</span></span>
<span class="line"><span style="color:#A3BE8C;">            8     24   1  list Ljava/util/List;</span></span>
<span class="line"><span style="color:#A3BE8C;">        LocalVariableTypeTable:</span></span>
<span class="line"><span style="color:#A3BE8C;">        Start Length Slot Name Signature</span></span>
<span class="line"><span style="color:#A3BE8C;">            8     24  1   list Ljava/util/List&lt;Ljava/lang/Integer;&gt;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用反射可以得到，参数的类型以及泛型类型。泛型反射代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9FF;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> throws NoSuchMethodException </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">        // 1. 拿到方法</span></span>
<span class="line"><span style="color:#8FBCBB;">        Method</span><span style="color:#D8DEE9;"> method</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Code_20_ReflectTest</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getMethod</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">test</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> List</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> Map</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        // 2. 得到泛型参数的类型信息</span></span>
<span class="line"><span style="color:#8FBCBB;">        Type</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> types</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> method</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getGenericParameterTypes</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">Type</span><span style="color:#D8DEE9;"> type</span><span style="color:#81A1C1;"> :</span><span style="color:#D8DEE9FF;"> types</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">            // 3. 判断参数类型是否，带泛型的类型。</span></span>
<span class="line"><span style="color:#81A1C1;">            if</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">type </span><span style="color:#81A1C1;">instanceof</span><span style="color:#D8DEE9FF;"> ParameterizedType</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">                ParameterizedType</span><span style="color:#D8DEE9;"> parameterizedType</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">ParameterizedType</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> type</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">                // 4. 得到原始类型</span></span>
<span class="line"><span style="color:#D8DEE9;">                System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">原始类型 - </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9;"> parameterizedType</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getRawType</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">                // 5. 拿到泛型类型</span></span>
<span class="line"><span style="color:#8FBCBB;">                Type</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> arguments</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> parameterizedType</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getActualTypeArguments</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">                for</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9;"> arguments</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">length</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">                    System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">printf</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">泛型参数[%d] - %s</span><span style="color:#EBCB8B;">\\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> arguments</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">                }</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#8FBCBB;"> Set</span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9FF;">Integer</span><span style="color:#81A1C1;">&gt;</span><span style="color:#88C0D0;"> test</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">List</span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9FF;">String</span><span style="color:#81A1C1;">&gt;</span><span style="color:#D8DEE9FF;"> list</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> Map</span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9FF;">Integer</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> Object</span><span style="color:#81A1C1;">&gt;</span><span style="color:#D8DEE9FF;"> map</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#81A1C1;"> null;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#D8DEE9FF;">原始类型 - </span><span style="color:#81A1C1;">interface</span><span style="color:#8FBCBB;"> java</span><span style="color:#D8DEE9FF;">.util.List</span></span>
<span class="line"><span style="color:#D8DEE9FF;">泛型参数[0] - </span><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> java</span><span style="color:#D8DEE9FF;">.lang.String</span></span>
<span class="line"><span style="color:#D8DEE9FF;">原始类型 - </span><span style="color:#81A1C1;">interface</span><span style="color:#8FBCBB;"> java</span><span style="color:#D8DEE9FF;">.util.Map</span></span>
<span class="line"><span style="color:#D8DEE9FF;">泛型参数[0] - </span><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> java</span><span style="color:#D8DEE9FF;">.lang.Integer</span></span>
<span class="line"><span style="color:#D8DEE9FF;">泛型参数[1] - </span><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> java</span><span style="color:#D8DEE9FF;">.lang.Object</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5-可变参数" tabindex="-1"><a class="header-anchor" href="#_3-5-可变参数"><span>3.5 可变参数</span></a></h3><p>可变参数也是 JDK 5 开始加入的新特性： 例如：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy4</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> foo</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">...</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">      // 将 args 赋值给 arr ，可以看出 String... 实际就是 String[]  </span></span>
<span class="line"><span style="color:#8FBCBB;">      String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> arr</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> args</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">      System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">arr</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">length</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">      foo</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">hello</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">world</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可变参数 <code>String... args</code> 其实是一个 <code>String[] args</code> ，从代码中的赋值语句中就可以看出来。 同 样 java 编译器会在编译期间将上述代码变换为：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy4</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#D8DEE9FF;"> Candy4 </span><span style="color:#ECEFF4;">{}</span></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> foo</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">      String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> arr</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> args</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">      System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">arr</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">length</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">      foo</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#8FBCBB;"> String</span><span style="color:#ECEFF4;">[])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意，如果调用的是 foo() ，即未传递参数时，等价代码为 foo(new String[]{}) ，创建了一个空数组，而不是直接传递的 null .</p><h3 id="_3-6-foreach-循环" tabindex="-1"><a class="header-anchor" href="#_3-6-foreach-循环"><span>3.6 foreach 循环</span></a></h3><p>仍是 JDK 5 开始引入的语法糖，<strong>数组</strong>的循环：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy5_1</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> array</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> {</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 3</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 4</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 5</span><span style="color:#ECEFF4;">}</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // 数组赋初值的简化写法也是语法糖哦</span></span>
<span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> e</span><span style="color:#81A1C1;"> :</span><span style="color:#D8DEE9FF;"> array</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">e</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编译器会帮我们转换为</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy5_1</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#88C0D0;"> Candy5_1</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> array</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#81A1C1;"> int</span><span style="color:#ECEFF4;">[]{</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 3</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 4</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 5</span><span style="color:#ECEFF4;">}</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9;"> array</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">length</span><span style="color:#81A1C1;">;</span><span style="color:#81A1C1;"> ++</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            int</span><span style="color:#D8DEE9;"> e</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> array</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">e</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果是集合使用 foreach</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy5_2</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        List</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">Integer</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> list</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Arrays</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">asList</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;">3</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;">4</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;">5</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">Integer</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> :</span><span style="color:#D8DEE9FF;"> list</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>集合要使用 foreach ，需要该集合类实现了 Iterable 接口，因为集合的遍历需要用到迭代器 Iterator.</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy5</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#88C0D0;"> Candy5</span><span style="color:#ECEFF4;">(){}</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">      List</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">Integer</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> list</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Arrays</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">asList</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 3</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 4</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 5</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">      // 获得该集合的迭代器</span></span>
<span class="line"><span style="color:#8FBCBB;">      Iterator</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">Integer</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> iterator</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> list</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">iterator</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">      while</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">iterator</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">hasNext</span><span style="color:#ECEFF4;">())</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">         Integer</span><span style="color:#D8DEE9;"> x</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> iterator</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">next</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">         System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">x</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注意</strong> ：foreach 循环写法，能够配合数组，以及所有实现了 <strong>Iterable</strong> 接口的集合类一起使用，其 中 Iterable 用来获取集合的迭代器（ <strong>Iterator</strong> ）</p><h3 id="_3-7-switch-字符串" tabindex="-1"><a class="header-anchor" href="#_3-7-switch-字符串"><span>3.7 switch 字符串</span></a></h3><p>从 JDK 7 开始，switch 可以作用于字符串和枚举类，这个功能其实也是语法糖，例如：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Cnady6</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">      String</span><span style="color:#D8DEE9;"> str</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">hello</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">      switch</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">str</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">         case</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">hello</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> :</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">h</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">            break;</span></span>
<span class="line"><span style="color:#81A1C1;">         case</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">world</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> :</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">w</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">            break;</span></span>
<span class="line"><span style="color:#81A1C1;">         default:</span></span>
<span class="line"><span style="color:#81A1C1;">            break;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>注意</strong>： switch 配合 String 和枚举使用时，变量不能为null，原因分析完语法糖转换后的代码应当自然清楚</p></blockquote><p>会被编译器转换为：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy6</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#88C0D0;"> Candy6</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">      String</span><span style="color:#D8DEE9;"> str</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">hello</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">      int</span><span style="color:#D8DEE9;"> x</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> -</span><span style="color:#B48EAD;">1</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">      // 通过字符串的 hashCode + value 来判断是否匹配</span></span>
<span class="line"><span style="color:#81A1C1;">      switch</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">str</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">hashCode</span><span style="color:#ECEFF4;">())</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">         // hello 的 hashCode</span></span>
<span class="line"><span style="color:#81A1C1;">         case</span><span style="color:#B48EAD;"> 99162322</span><span style="color:#81A1C1;"> :</span></span>
<span class="line"><span style="color:#616E88;">            // 再次比较，因为字符串的 hashCode 有可能相等</span></span>
<span class="line"><span style="color:#81A1C1;">            if</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">str</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">equals</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">hello</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">               x </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#81A1C1;">            break;</span></span>
<span class="line"><span style="color:#616E88;">         // world 的 hashCode</span></span>
<span class="line"><span style="color:#81A1C1;">         case</span><span style="color:#B48EAD;"> 11331880</span><span style="color:#81A1C1;"> :</span></span>
<span class="line"><span style="color:#81A1C1;">            if</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">str</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">equals</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">world</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">               x </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 1</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#81A1C1;">            break;</span></span>
<span class="line"><span style="color:#81A1C1;">         default:</span></span>
<span class="line"><span style="color:#81A1C1;">            break;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">      // 用第二个 switch 在进行输出判断</span></span>
<span class="line"><span style="color:#81A1C1;">      switch</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">x</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">         case</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">h</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">            break;</span></span>
<span class="line"><span style="color:#81A1C1;">         case</span><span style="color:#B48EAD;"> 1</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">w</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">            break;</span></span>
<span class="line"><span style="color:#81A1C1;">         default:</span></span>
<span class="line"><span style="color:#81A1C1;">            break;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>过程说明：</p><ul><li>在编译期间，单个的 switch 被分为了两个 <ul><li>第一个用来匹配字符串，并给 x 赋值 <ul><li>字符串的匹配用到了字符串的 hashCode ，还用到了 equals 方法</li><li>使用 hashCode 是为了提高比较效率，使用 equals 是防止有 hashCode 冲突（如 BM 和 C .）</li></ul></li><li>第二个用来根据x的值来决定输出语句</li></ul></li></ul><p>以看到，执行了两遍 switch，第一遍是根据字符串的 hashCode 和 equals 将字符串的转换为相应 byte 类型，第二遍才是利用 byte 执行进行比较。</p><blockquote><p><strong>问</strong>：为什么第一遍时必须既比较 hashCode，又利用 equals 比较呢？hashCode 是为了提高效率，减少可能的比较；而 equals 是为了防止 hashCode 冲突。</p><p>例如 <code>BM</code> 和 <code>C.</code> 这两个字符串的hashCode值都是 2123 ，如果有如下代码：</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy6_1</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> choose</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#D8DEE9;"> str</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        switch</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">str</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            case</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">BM</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">                System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">h</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">                break;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#81A1C1;">            case</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">C.</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">                System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">w</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">                break;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>会被编译器转换为：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy6_1</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#88C0D0;"> Candy6_1</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> choose</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#D8DEE9;"> var0</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        byte</span><span style="color:#D8DEE9;"> var2</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> -</span><span style="color:#B48EAD;">1</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        switch</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">var0</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">hashCode</span><span style="color:#ECEFF4;">())</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        case</span><span style="color:#B48EAD;"> 2123</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#81A1C1;">            if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">var0</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">equals</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">C.</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">                var2 </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 1</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span><span style="color:#81A1C1;"> else</span><span style="color:#81A1C1;"> if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">var0</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">equals</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">BM</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">                var2 </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#81A1C1;">        default:</span></span>
<span class="line"><span style="color:#81A1C1;">            switch</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">var2</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            case</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9;">                System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">h</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">                break;</span></span>
<span class="line"><span style="color:#81A1C1;">            case</span><span style="color:#B48EAD;"> 1</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9;">                System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">w</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-8-switch-枚举" tabindex="-1"><a class="header-anchor" href="#_3-8-switch-枚举"><span>3.8 switch 枚举</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">enum</span><span style="color:#D8DEE9FF;"> SEX </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">   MALE</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> FEMALE</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy7</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">      SEX</span><span style="color:#D8DEE9;"> sex</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> SEX</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">MALE</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">      switch</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">sex</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">         case</span><span style="color:#D8DEE9FF;"> MALE</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">man</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">            break;</span></span>
<span class="line"><span style="color:#81A1C1;">         case</span><span style="color:#D8DEE9FF;"> FEMALE</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">woman</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">            break;</span></span>
<span class="line"><span style="color:#81A1C1;">         default:</span></span>
<span class="line"><span style="color:#81A1C1;">            break;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#81A1C1;">enum</span><span style="color:#D8DEE9FF;"> SEX </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">   MALE</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> FEMALE</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy7</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">   /**     </span></span>
<span class="line"><span style="color:#616E88;">    * 定义一个合成类（仅 jvm 使用，对我们不可见）     </span></span>
<span class="line"><span style="color:#616E88;">    * 用来映射枚举的 ordinal 与数组元素的关系     </span></span>
<span class="line"><span style="color:#616E88;">    * 枚举的 ordinal 表示枚举对象的序号，从 0 开始     </span></span>
<span class="line"><span style="color:#616E88;">    * 即 MALE 的 ordinal()=0，FEMALE 的 ordinal()=1     </span></span>
<span class="line"><span style="color:#616E88;">    */</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">   static</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> $MAP</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">      // 数组大小即为枚举元素个数，里面存放了 case 用于比较的数字</span></span>
<span class="line"><span style="color:#81A1C1;">      static</span><span style="color:#81A1C1;"> int</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> map</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#81A1C1;"> int</span><span style="color:#ECEFF4;">[</span><span style="color:#B48EAD;">2</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">      static</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">         // ordinal 即枚举元素对应所在的位置，MALE 为 0 ，FEMALE 为 1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">         map</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9;">SEX</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">MALE</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">ordinal</span><span style="color:#ECEFF4;">()]</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 1</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">         map</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9;">SEX</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">FEMALE</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">ordinal</span><span style="color:#ECEFF4;">()]</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 2</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">      SEX</span><span style="color:#D8DEE9;"> sex</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> SEX</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">MALE</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">      // 将对应位置枚举元素的值赋给 x ，用于 case 操作</span></span>
<span class="line"><span style="color:#81A1C1;">      int</span><span style="color:#D8DEE9;"> x</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> $MAP</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">map</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9;">sex</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">ordinal</span><span style="color:#ECEFF4;">()]</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">      switch</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">x</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">         case</span><span style="color:#B48EAD;"> 1</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">man</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">            break;</span></span>
<span class="line"><span style="color:#81A1C1;">         case</span><span style="color:#B48EAD;"> 2</span><span style="color:#81A1C1;">:</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">woman</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">            break;</span></span>
<span class="line"><span style="color:#81A1C1;">         default:</span></span>
<span class="line"><span style="color:#81A1C1;">            break;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-9-枚举类" tabindex="-1"><a class="header-anchor" href="#_3-9-枚举类"><span>3.9 枚举类</span></a></h3><p><code>JDK 7</code> 新增了枚举类，以前面的性别枚举为例：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> enum</span><span style="color:#D8DEE9FF;"> Sex </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">    MALE</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;">FEMALE</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>转换后的代码</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> final</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Sex</span><span style="color:#81A1C1;"> extends</span><span style="color:#8FBCBB;font-weight:bold;"> Enum</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">Sex</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;">   </span></span>
<span class="line"><span style="color:#616E88;">   // 对应枚举类中的元素</span></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#8FBCBB;"> Sex</span><span style="color:#D8DEE9;"> MALE</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#8FBCBB;"> Sex</span><span style="color:#D8DEE9;"> FEMALE</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#81A1C1;">   private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#8FBCBB;"> Sex</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> $VALUES</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">   </span></span>
<span class="line"><span style="color:#81A1C1;">    static</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;">       </span></span>
<span class="line"><span style="color:#616E88;">            // 调用构造函数，传入枚举元素的值及 ordinal</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        MALE </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Sex</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">MALE</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#D8DEE9FF;">        FEMALE </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Sex</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">FEMALE</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">   </span></span>
<span class="line"><span style="color:#D8DEE9FF;">        $VALUES </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> Sex</span><span style="color:#ECEFF4;">[]{</span><span style="color:#D8DEE9FF;">MALE</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> FEMALE</span><span style="color:#ECEFF4;">}</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#D8DEE9FF;">         </span></span>
<span class="line"><span style="color:#616E88;">   // 调用父类中的方法</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#88C0D0;"> Sex</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#D8DEE9;"> name</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> ordinal</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;">     </span></span>
<span class="line"><span style="color:#81A1C1;">        super</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">name</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> ordinal</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#D8DEE9FF;">   </span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#8FBCBB;"> Sex</span><span style="color:#ECEFF4;">[]</span><span style="color:#88C0D0;"> values</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;">  </span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#D8DEE9;"> $VALUES</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">clone</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">  </span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#8FBCBB;"> Sex</span><span style="color:#88C0D0;"> valueOf</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#D8DEE9;"> name</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#D8DEE9;"> Enum</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">valueOf</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">Sex</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> name</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;">  </span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#D8DEE9FF;">   </span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-10-try-with-resources" tabindex="-1"><a class="header-anchor" href="#_3-10-try-with-resources"><span>3.10 try-with-resources</span></a></h3><p>JDK 7 开始新增了对需要关闭的资源处理的特殊语法，‘try-with-resources’</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">try</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">资源变量 </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> 创建资源对象</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span></span>
<span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中资源对象需要实现 AutoCloseable 接口，例如 InputStream 、 OutputStream 、 Connection 、 Statement 、 ResultSet 等接口都实现了 AutoCloseable ，使用 try-with- resources 可以不用写 finally 语句块，编译器会帮助生成关闭资源代码，例如：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy9</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">        public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">                try</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">InputStream</span><span style="color:#D8DEE9;"> is</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> FileInputStream</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">d:</span><span style="color:#EBCB8B;">\\\\</span><span style="color:#A3BE8C;">1.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)){</span><span style="color:#D8DEE9FF;">        </span></span>
<span class="line"><span style="color:#D8DEE9;">                        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">is</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">                }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">IOException</span><span style="color:#D8DEE9;"> e</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#D8DEE9;">                        e</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">printStackTrace</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">                }</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>会被转换为：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy9</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#88C0D0;"> Candy9</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span><span style="color:#ECEFF4;"> }</span></span>
<span class="line"><span style="color:#D8DEE9FF;">   </span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">        try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">            InputStream</span><span style="color:#D8DEE9;"> is</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> FileInputStream</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">d:</span><span style="color:#EBCB8B;">\\\\</span><span style="color:#A3BE8C;">1.txt</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">            Throwable</span><span style="color:#D8DEE9;"> t</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> null;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">            try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">                System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">is</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">Throwable</span><span style="color:#D8DEE9;"> e1</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#616E88;">                // t 是我们代码出现的异常 </span></span>
<span class="line"><span style="color:#D8DEE9FF;">                t </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> e1</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">                throw</span><span style="color:#D8DEE9FF;"> e1</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span><span style="color:#81A1C1;"> finally</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">                // 判断了资源不为空 </span></span>
<span class="line"><span style="color:#81A1C1;">                if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">is </span><span style="color:#81A1C1;">!=</span><span style="color:#81A1C1;"> null</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#616E88;">                    // 如果我们代码有异常</span></span>
<span class="line"><span style="color:#81A1C1;">                    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">t </span><span style="color:#81A1C1;">!=</span><span style="color:#81A1C1;"> null</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">                        try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">                            is</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">                        }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">Throwable</span><span style="color:#D8DEE9;"> e2</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#616E88;">                            // 如果 close 出现异常，作为被压制异常添加</span></span>
<span class="line"><span style="color:#D8DEE9;">                            t</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">addSuppressed</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">e2</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">                        }</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">                    }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#616E88;">                        // 如果我们代码没有异常，close 出现的异常就是最后 catch 块中的 e </span></span>
<span class="line"><span style="color:#D8DEE9;">                        is</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">                    }</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">                }</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">IOException</span><span style="color:#D8DEE9;"> e</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">            e</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">printStackTrace</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为什么要设计一个 addSuppressed(Throwable e) （添加被压制异常）的方法呢？是为了防止异常信息的丢失（想想 try-with-resources 生成的 fianlly 中如果抛出了异常）：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Test6</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">        public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">                try</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">MyResource</span><span style="color:#D8DEE9;"> resource</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> MyResource</span><span style="color:#ECEFF4;">())</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">                        int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 1</span><span style="color:#81A1C1;">/</span><span style="color:#B48EAD;">0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">                }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">Exception</span><span style="color:#D8DEE9;"> e</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#D8DEE9;">                        e</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">printStackTrace</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">                }</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> MyResource</span><span style="color:#81A1C1;"> implements</span><span style="color:#8FBCBB;font-weight:bold;"> AutoCloseable</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">        public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> close</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> Exception</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">                throw</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Exception</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">close 异常</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9;">java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">ArithmeticException</span><span style="color:#81A1C1;">:</span><span style="color:#81A1C1;"> /</span><span style="color:#D8DEE9FF;"> by zero </span></span>
<span class="line"><span style="color:#D8DEE9FF;">        at </span><span style="color:#D8DEE9;">test</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Test6</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">main</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">Test6</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">java</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;">7</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#D8DEE9FF;">        Suppressed</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9;"> java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Exception</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> close 异常 </span></span>
<span class="line"><span style="color:#D8DEE9FF;">                at </span><span style="color:#D8DEE9;">test</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">MyResource</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">close</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">Test6</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">java</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;">18</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#D8DEE9FF;">                at </span><span style="color:#D8DEE9;">test</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Test6</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">main</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">Test6</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">java</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;">6</span><span style="color:#ECEFF4;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-11-方法重写时的桥接方法" tabindex="-1"><a class="header-anchor" href="#_3-11-方法重写时的桥接方法"><span>3.11 方法重写时的桥接方法</span></a></h3><ul><li>我们都知道，方法重写时对返回值分两种情况： 父子类的返回值完全一致 子类返回值可以是父类返回值的子类（比较绕口，见下面的例子）</li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> A</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">        public</span><span style="color:#8FBCBB;"> Number</span><span style="color:#88C0D0;"> m</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">                return</span><span style="color:#B48EAD;"> 1</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> B</span><span style="color:#81A1C1;"> extends</span><span style="color:#8FBCBB;font-weight:bold;"> A</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">        @</span><span style="color:#D08770;">Override</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#616E88;">        // 子类 m 方法的返回值是 Integer 是父类 m 方法返回值 Number 的子类         </span></span>
<span class="line"><span style="color:#81A1C1;">        public</span><span style="color:#8FBCBB;"> Integer</span><span style="color:#88C0D0;"> m</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">                return</span><span style="color:#B48EAD;"> 2</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于子类，java 编译器会做如下处理：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> B</span><span style="color:#81A1C1;"> extends</span><span style="color:#8FBCBB;font-weight:bold;"> A</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">        public</span><span style="color:#8FBCBB;"> Integer</span><span style="color:#88C0D0;"> m</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">                return</span><span style="color:#B48EAD;"> 2</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#616E88;">        // 此方法才是真正重写了父类 public Number m() 方法 </span></span>
<span class="line"><span style="color:#81A1C1;">        public</span><span style="color:#D8DEE9FF;"> synthetic bridge </span><span style="color:#8FBCBB;">Number</span><span style="color:#88C0D0;"> m</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#616E88;">                // 调用 public Integer m() </span></span>
<span class="line"><span style="color:#81A1C1;">                return</span><span style="color:#88C0D0;"> m</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中桥接方法比较特殊，仅对 java 虚拟机可见，并且与原来的 public Integer m() 没有命名冲突，可以 用下面反射代码来验证：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9FF;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">Method</span><span style="color:#D8DEE9;"> m</span><span style="color:#81A1C1;"> :</span><span style="color:#D8DEE9;"> B</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getDeclaredMethods</span><span style="color:#ECEFF4;">())</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">m</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#D8DEE9;"> java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Integer</span><span style="color:#D8DEE9;"> cn</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">ali</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">jvm</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">test</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">B</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">m</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#D8DEE9;"> java</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Number</span><span style="color:#D8DEE9;"> cn</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">ali</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">jvm</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">test</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">B</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">m</span><span style="color:#ECEFF4;">()</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-12-匿名内部类" tabindex="-1"><a class="header-anchor" href="#_3-12-匿名内部类"><span>3.12 匿名内部类</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy10</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">      Runnable</span><span style="color:#D8DEE9;"> runnable</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Runnable</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">         @</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">         public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> run</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">running...</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">         }</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>转换后的代码</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy10</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">      // 用额外创建的类来创建匿名内部类对象</span></span>
<span class="line"><span style="color:#8FBCBB;">      Runnable</span><span style="color:#D8DEE9;"> runnable</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Candy10$1</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// 创建了一个额外的类，实现了 Runnable 接口</span></span>
<span class="line"><span style="color:#81A1C1;">final</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy10$1</span><span style="color:#81A1C1;"> implements</span><span style="color:#8FBCBB;font-weight:bold;"> Runnable</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#D8DEE9FF;"> Demo8$</span><span style="color:#88C0D0;">1</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">   @</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> run</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">running...</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>引用局部变量的匿名内部类，源代码：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy11</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">        public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> test</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> x</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#8FBCBB;">                Runnable</span><span style="color:#D8DEE9;"> runnable</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Runnable</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">                        @</span><span style="color:#D08770;">Override</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">                        public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> run</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;">         </span></span>
<span class="line"><span style="color:#D8DEE9;">                                System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ok:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9FF;"> x</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">                        }</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">                }</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>转换后代码：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// 额外生成的类 </span></span>
<span class="line"><span style="color:#81A1C1;">final</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy11$1</span><span style="color:#81A1C1;"> implements</span><span style="color:#8FBCBB;font-weight:bold;"> Runnable</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#D8DEE9;"> val$x</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#D8DEE9FF;">        Candy11$</span><span style="color:#88C0D0;">1</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> x</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">                this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">val$x</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> x</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#81A1C1;">        public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> run</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#D8DEE9;">                System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ok:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#81A1C1;"> this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">val$x</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Candy11</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">        public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> test</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> x</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#8FBCBB;">                Runnable</span><span style="color:#D8DEE9;"> runnable</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Candy11$1</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">x</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意：这同时解释了为什么匿名内部类引用局部变量时，局部变量必须是 final 的：因为在创建 Candy11$1 对象时，将 x 的值赋值给了 Candy11$1 对象的 值后，如果不是 final 声明的 x 值发生了改变，匿名内部类则值不一致。</p><p>这同时解释了为什么匿名内部类引用局部变量时，局部变量必须是final的：因为在创建Candy11$1对象时，将x的值赋值给了Candy11$1对象的vala属性，所以x不应该再发生变化了，如果变化，那么ualx属性没有机会再跟着一起变化</p><h2 id="_4-类加载阶段" tabindex="-1"><a class="header-anchor" href="#_4-类加载阶段"><span>4. 类加载阶段</span></a></h2><h3 id="_4-1-加载" tabindex="-1"><a class="header-anchor" href="#_4-1-加载"><span>4.1 加载</span></a></h3><ul><li>将类的字节码载入方法区（1.8后为元空间，在本地内存中）中，内部采用 C++ 的 <strong>instanceKlass</strong> 描述 java 类，它的重要 ﬁeld 有： <ul><li><strong>_java_mirror</strong> 即 <strong>java 的类镜像</strong>，例如对 String 来说，它的镜像类就是 String.class，作用是把 klass 暴露给 java 使用</li><li>_super 即父类</li><li>_ﬁelds 即成员变量</li><li>_methods 即方法</li><li>_constants 即常量池</li><li>_class_loader 即类加载器</li><li>_vtable 虚方法表</li><li>_itable 接口方法</li></ul></li><li>如果这个类还有父类没有加载，<strong>先加载父类</strong></li><li>加载和链接可能是<strong>交替运行</strong>的</li><li><strong>instanceKlass</strong> 这样的【元数据】是存储在<strong>方法区</strong>（1.8 后的元空间内），但 <strong>_java_mirror</strong> 是存储在<strong>堆</strong>中，可以通过HSDB工具查看。</li><li>instanceKlass和_java_mirror（java镜像类）互相保存了对方的地址</li><li>类的对象在对象头中保存了 *.class 的地址。让对象可以通过其找到方法区中的instanceKlass，从而获取类的各种信息</li></ul><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806520.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>注意</strong></p><ul><li>instanceKlass 这样的【元数据】是存储在方法区（1.8 后的元空间内），但 _java_mirror 是存储在堆中</li><li>可以通过前面介绍的 HSDB 工具查看</li></ul><h3 id="_4-2-链接" tabindex="-1"><a class="header-anchor" href="#_4-2-链接"><span>4.2 链接</span></a></h3><h4 id="_1-验证" tabindex="-1"><a class="header-anchor" href="#_1-验证"><span>（1）验证</span></a></h4><p>验证类是否符合 JVM规范，安全性检查 用 UE 等支持二进制的编辑器修改 HelloWorld.class 的魔数，在控制台运行</p><h4 id="_2-准备" tabindex="-1"><a class="header-anchor" href="#_2-准备"><span>（2）准备</span></a></h4><p>为 <code>static</code> 变量分配空间，设置默认值</p><ul><li>static变量在JDK 7以前是存储与instanceKlass末尾。但在JDK 7以后就存储在_java_mirror末尾了</li><li>static变量在分配空间和赋值是在两个阶段完成的。<strong>分配空间</strong>在<strong>准备阶段</strong>完成，<strong>赋值</strong>在<strong>初始化阶段</strong>完成</li><li>如果 static 变量是 ﬁnal 的<strong>基本类型</strong>，以及<strong>字符串常量</strong>，那么编译阶段值就确定了，<strong>赋值在准备阶段完成</strong></li><li>如果 static 变量是 ﬁnal 的，但属于<strong>引用类型</strong>，那么<strong>赋值</strong>也会在<strong>初始化阶段完成</strong></li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Code_22_AnalysisTest</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> ClassNotFoundException</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> IOException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        ClassLoader</span><span style="color:#D8DEE9;"> classLoader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Code_22_AnalysisTest</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getClassLoader</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        Class</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">?</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> c</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> classLoader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">loadClass</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">cn.ali.jvm.test.C</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        // new C();</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">in</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> C</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">    D</span><span style="color:#D8DEE9;"> d</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> D</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> D</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-解析" tabindex="-1"><a class="header-anchor" href="#_3-解析"><span>（3）解析</span></a></h4><p>将常量池中的符号引用解析为直接引用</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> cn</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">itcast</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">jvm</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">t3</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">load</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">/**</span></span>
<span class="line"><span style="color:#616E88;">* 解析的含义</span></span>
<span class="line"><span style="color:#616E88;">*/</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Load2</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> ClassNotFoundException</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#8FBCBB;">    IOException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        ClassLoader</span><span style="color:#D8DEE9;"> classloader</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Load2</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getClassLoader</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        // loadClass 方法不会导致类的解析和初始化</span></span>
<span class="line"><span style="color:#8FBCBB;">        Class</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">?</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> c</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> classloader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">loadClass</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">cn.itcast.jvm.t3.load.C</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        // new C();</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">in</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">read</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> C</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">    D</span><span style="color:#D8DEE9;"> d</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> D</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> D</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-初始化" tabindex="-1"><a class="header-anchor" href="#_4-3-初始化"><span>4-3 初始化</span></a></h3><h4 id="_1-cinit-v-方法" tabindex="-1"><a class="header-anchor" href="#_1-cinit-v-方法"><span>（1）&lt;cinit&gt;()v 方法</span></a></h4><p>初始化即调用 <code>\\&lt;cinit&gt;()</code>V，虚拟机会保证这个类的【构造方法】的线程安全</p><h4 id="_2-发生的时机" tabindex="-1"><a class="header-anchor" href="#_2-发生的时机"><span>（2）发生的时机</span></a></h4><p><strong>类的初始化的懒惰的</strong>，以下情况会初始化：</p><ul><li>main 方法所在的类，总会被首先初始化</li><li>首次访问这个类的静态变量或静态方法时</li><li>子类初始化，如果父类还没初始化，会引发</li><li>子类访问父类的静态变量，只会触发父类的初始化</li><li><code>Class.forName</code></li><li>new 会导致初始化</li></ul><p>以下情况不会初始化：</p><ul><li>访问类的 static ﬁnal 静态常量（基本类型和字符串）</li><li>类对象.class 不会触发初始化</li><li>创建该类对象的数组</li><li>类加载器的.loadClass方法</li><li><code>Class.forName</code>的参数2为false时</li></ul><p><strong>验证类是否被初始化，可以看改类的静态代码块是否被执行</strong></p><p>这里一个例子来验证：（实验时请先全部注释，每次只执行其中一个）</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Load3</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    static</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">main init</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> ClassNotFoundException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">        // 1. 静态常量（基本类型和字符串）不会触发初始化</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">B</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">b</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        // 2. 类对象.class 不会触发初始化</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">B</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        // 3. 创建该类的数组不会触发初始化</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#8FBCBB;"> B</span><span style="color:#ECEFF4;">[</span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        // 4. 不会初始化类 B，但会加载 B、A</span></span>
<span class="line"><span style="color:#8FBCBB;">        ClassLoader</span><span style="color:#D8DEE9;"> cl</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Thread</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">currentThread</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">getContextClassLoader</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        cl</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">loadClass</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">cn.itcast.jvm.t3.B</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        // 5. 不会初始化类 B，但会加载 B、A</span></span>
<span class="line"><span style="color:#8FBCBB;">        ClassLoader</span><span style="color:#D8DEE9;"> c2</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Thread</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">currentThread</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">getContextClassLoader</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        Class</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">forName</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">cn.itcast.jvm.t3.B</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> false</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> c2</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span></span>
<span class="line"><span style="color:#616E88;">        // 1. 首次访问这个类的静态变量或静态方法时</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">A</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">a</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        // 2. 子类初始化，如果父类还没初始化，会引发</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">B</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">c</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        // 3. 子类访问父类静态变量，只触发父类初始化</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">B</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">a</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        // 4. 会初始化类 B，并先初始化类 A</span></span>
<span class="line"><span style="color:#D8DEE9;">        Class</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">forName</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">cn.itcast.jvm.t3.B</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> A</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    static</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> a</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    static</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">a init</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> B</span><span style="color:#81A1C1;"> extends</span><span style="color:#8FBCBB;font-weight:bold;"> A</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    final</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> double</span><span style="color:#D8DEE9;"> b</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 5.0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    static</span><span style="color:#81A1C1;"> boolean</span><span style="color:#D8DEE9;"> c</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> false;</span></span>
<span class="line"><span style="color:#81A1C1;">    static</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">b init</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-练习" tabindex="-1"><a class="header-anchor" href="#_4-练习"><span>4）练习</span></a></h3><p>从字节码分析，使用 a，b，c 这三个常量是否会导致 E 初始化</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Load2</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">E</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">a</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">E</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">b</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        // 会导致 E 类初始化，因为 Integer 是包装类</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">E</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">c</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> E</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> a</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#8FBCBB;"> String</span><span style="color:#D8DEE9;"> b</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">hello</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#8FBCBB;"> Integer</span><span style="color:#D8DEE9;"> c</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 20</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    static</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">E cinit</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>典型应用 - 完成懒惰初始化单例模式</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Singleton</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#88C0D0;"> Singleton</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span><span style="color:#ECEFF4;"> }</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#616E88;">    // 内部类中保存单例</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> LazyHolder</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">        static</span><span style="color:#81A1C1;"> final</span><span style="color:#8FBCBB;"> Singleton</span><span style="color:#D8DEE9;"> INSTANCE</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Singleton</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#616E88;">    // 第一次调用 getInstance 方法，才会导致内部类加载和初始化其静态成员 </span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#8FBCBB;"> Singleton</span><span style="color:#88C0D0;"> getInstance</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#D8DEE9;"> LazyHolder</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">INSTANCE</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上的实现特点是：</p><ul><li>懒惰实例化</li><li>初始化时的线程安全是有保障的</li></ul><h2 id="_5-类加载器" tabindex="-1"><a class="header-anchor" href="#_5-类加载器"><span>5.类加载器</span></a></h2><p>类加载器虽然只用于实现类的加载动作，但它在Java程序中起到的作用却远超类加载阶段 对于任意一个类，都必须由加载它的类加载器和这个类本身一起共同确立其在 Java 虚拟机中的唯一性，每一个类加载器，都拥有一个独立的类名称空间。这句话可以表达得更通俗一些：比较两个类是否“相等”，只有在这两个类是由同一个类加载器加载的前提下才有意义，否则，即使这两个类来源于同一个 Class 文件，被同一个 Java 虚拟机加载，只要加载它们的类加载器不同，那这两个类就必定不相等！</p><p>以 JDK 8 为例：</p><p>名称加载的类说明</p><table><thead><tr><th>名称</th><th>加载的类</th><th>说明</th></tr></thead><tbody><tr><td>Bootstrap ClassLoader（启动类加载器）</td><td>JAVA_HOME/jre/lib</td><td>无法直接访问</td></tr><tr><td>Extension ClassLoader(拓展类加载器)</td><td>JAVA_HOME/jre/lib/ext</td><td>上级为Bootstrap，显示为null</td></tr><tr><td>Application ClassLoader(应用程序类加载器)</td><td>classpath</td><td>上级为Extension</td></tr><tr><td>自定义类加载器</td><td>自定义</td><td>上级为Application</td></tr></tbody></table><h3 id="_5-1-启动类的加载器" tabindex="-1"><a class="header-anchor" href="#_5-1-启动类的加载器"><span>5.1 启动类的加载器</span></a></h3><p>可通过在控制台输入指令，使得类被启动类加器加载</p><p>用 Bootstrap 类加载器加载类：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> cn</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">itcast</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">jvm</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">t3</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">load</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> F</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    static</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">bootstrap F init</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> cn</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">itcast</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">jvm</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">t3</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">load</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Load5_1</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> ClassNotFoundException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        Class</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">?</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> aClass</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Class</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">forName</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">cn.itcast.jvm.t3.load.F</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">aClass</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getClassLoader</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#D8DEE9FF;">E</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;">\\git\\jvm\\out\\production\\jvm</span><span style="color:#81A1C1;">&gt;</span><span style="color:#D8DEE9FF;">java </span><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">Xbootclasspath</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">a</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;">.</span></span>
<span class="line"><span style="color:#D8DEE9;">cn</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">itcast</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">jvm</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">t3</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">load</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Load5</span></span>
<span class="line"><span style="color:#D8DEE9FF;">bootstrap </span><span style="color:#8FBCBB;">F</span><span style="color:#D8DEE9FF;"> init</span></span>
<span class="line"><span style="color:#81A1C1;">null</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>-Xbootclasspath 表示设置 bootclasspath</li><li>其中 /a:. 表示将当前目录追加至 bootclasspath 之后</li><li>可以用这个办法替换核心类 <ul><li><code>java -Xbootclasspath:&lt;new bootclasspath&gt;</code></li></ul></li><li>也可以追加 <ul><li><code>java -Xbootclasspath/a:&lt;追加路径&gt;</code>（后追加）</li><li><code>java -Xbootclasspath/p:&lt;追加路径&gt;</code>（前追加）</li></ul></li></ul><h3 id="_5-2-扩展类的加载器" tabindex="-1"><a class="header-anchor" href="#_5-2-扩展类的加载器"><span>5.2 扩展类的加载器</span></a></h3><p>如果 classpath 和 JAVA_HOME/jre/lib/ext 下有同名类，加载时会使用拓展类加载器加载。当应用程序类加载器发现拓展类加载器已将该同名类加载过了，则不会再次加载。</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> cn</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">itcast</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">jvm</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">t3</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">load</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> G</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    static</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">classpath G init</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#D8DEE9FF;">classpath </span><span style="color:#8FBCBB;">G</span><span style="color:#D8DEE9FF;"> init</span></span>
<span class="line"><span style="color:#D8DEE9;">sun</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">misc</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Launcher$AppClassLoader</span><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">18b4aac2</span></span>
<span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> cn</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">itcast</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">jvm</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">t3</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">load</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> G</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        static</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ext G init</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#D8DEE9FF;">E</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;">\\git\\jvm\\out\\production\\jvm</span><span style="color:#81A1C1;">&gt;</span><span style="color:#D8DEE9FF;">jar </span><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;">cvf </span><span style="color:#D8DEE9;">my</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">jar</span><span style="color:#D8DEE9FF;"> cn</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">itcast</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">jvm</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">t3</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">load</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9;">G</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span></span>
<span class="line"><span style="color:#D8DEE9FF;">已添加清单</span></span>
<span class="line"><span style="color:#D8DEE9FF;">正在添加</span><span style="color:#81A1C1;">:</span><span style="color:#D8DEE9FF;"> cn</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">itcast</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">jvm</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">t3</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">load</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9;">G</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">class</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">输入 </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 481</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">输出 </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 322</span><span style="color:#ECEFF4;">)(</span><span style="color:#D8DEE9FF;">压缩了 </span><span style="color:#B48EAD;">33</span><span style="color:#81A1C1;">%</span><span style="color:#ECEFF4;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将 jar 包拷贝到 JAVA_HOME/jre/lib/ext</p><p>重新执行 Load5_2</p><p>输出</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">ext </span><span style="color:#8FBCBB;">G</span><span style="color:#D8DEE9FF;"> init</span></span>
<span class="line"><span style="color:#D8DEE9;">sun</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">misc</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Launcher$ExtClassLoader</span><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">29453f44</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-双亲委派模式" tabindex="-1"><a class="header-anchor" href="#_5-3-双亲委派模式"><span>5.3 双亲委派模式</span></a></h3><ul><li>当AppClassLoader加载一个class时，它首先不会自己去尝试加载这个类，而是把类加载请求委派给父类加载器ExtClassLoader去完成。</li><li>当ExtClassLoader加载一个class时，它首先也不会自己去尝试加载这个类，而是把类加载请求委派给BootStrapClassLoader去完成。</li><li>如果BootStrapClassLoader加载失败(例如在$JAVA_HOME/jre/lib里未查找到该class)，会使用ExtClassLoader来尝试加载；</li><li>若ExtClassLoader也加载失败，则会使用AppClassLoader来加载，如果AppClassLoader也加载失败，则会报出异常ClassNotFoundException。</li></ul><p>所谓的<strong>双亲委派</strong>，就是指调用类加载器的 <strong>loadClass</strong> 方法时，查找类的规则</p><p>loadClass源码</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">protected</span><span style="color:#8FBCBB;"> Class</span><span style="color:#81A1C1;">&lt;?&gt;</span><span style="color:#88C0D0;"> loadClass</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#D8DEE9FF;"> name</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> boolean</span><span style="color:#D8DEE9FF;"> resolve</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    throws </span><span style="color:#8FBCBB;">ClassNotFoundException</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    synchronized</span><span style="color:#ECEFF4;"> (</span><span style="color:#88C0D0;">getClassLoadingLock</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">name</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">        // 首先查找该类是否已经被该类加载器加载过了</span></span>
<span class="line"><span style="color:#8FBCBB;">        Class</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">?</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> c</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> findLoadedClass</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">name</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        // 如果没有被加载过</span></span>
<span class="line"><span style="color:#81A1C1;">        if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">c </span><span style="color:#81A1C1;">==</span><span style="color:#81A1C1;"> null</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            long</span><span style="color:#D8DEE9;"> t0</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> System</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">nanoTime</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">            try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">                // 看是否被它的上级加载器加载过了 Extension 的上级是Bootstarp，但它显示为null</span></span>
<span class="line"><span style="color:#81A1C1;">                if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">parent </span><span style="color:#81A1C1;">!=</span><span style="color:#81A1C1;"> null</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">                    c </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9;"> parent</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">loadClass</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">name</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> false</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">                }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">                    // 看是否被启动类加载器加载过</span></span>
<span class="line"><span style="color:#D8DEE9FF;">                    c </span><span style="color:#81A1C1;">=</span><span style="color:#88C0D0;"> findBootstrapClassOrNull</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">name</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">                }</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">ClassNotFoundException</span><span style="color:#D8DEE9;"> e</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">                // ClassNotFoundException thrown if class not found</span></span>
<span class="line"><span style="color:#616E88;">                // from the non-null parent class loader</span></span>
<span class="line"><span style="color:#616E88;">                //捕获异常，但不做任何处理</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">            if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">c </span><span style="color:#81A1C1;">==</span><span style="color:#81A1C1;"> null</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">                // 如果还是没有找到，先让拓展类加载器调用 findClass 方法去找到该类，如果还是没找到，就抛出异常</span></span>
<span class="line"><span style="color:#616E88;">                // 然后让应用类加载器去找 classpath 下找该类</span></span>
<span class="line"><span style="color:#81A1C1;">                long</span><span style="color:#D8DEE9;"> t1</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> System</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">nanoTime</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">                c </span><span style="color:#81A1C1;">=</span><span style="color:#88C0D0;"> findClass</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">name</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">                // 记录时间</span></span>
<span class="line"><span style="color:#D8DEE9;">                sun</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">misc</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">PerfCounter</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getParentDelegationTime</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">addTime</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">t1 </span><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;"> t0</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">                sun</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">misc</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">PerfCounter</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getFindClassTime</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">addElapsedTimeFrom</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">t1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">                sun</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">misc</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">PerfCounter</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getFindClasses</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">increment</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#81A1C1;">        if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">resolve</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">            resolveClass</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">c</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#D8DEE9FF;"> c</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-自定义类加载器" tabindex="-1"><a class="header-anchor" href="#_5-4-自定义类加载器"><span>5.4 自定义类加载器</span></a></h3><p><strong>使用场景</strong></p><ul><li>想加载非 classpath 随意路径中的类文件</li><li>通过接口来使用实现，希望解耦时，常用在框架设计</li><li>这些类希望予以隔离，不同应用的同名类都可以加载，不冲突，常见于 tomcat 容器</li></ul><p><strong>步骤</strong></p><ul><li>继承 ClassLoader 父类</li><li>要遵从双亲委派机制，重写 ﬁndClass 方法 不是重写 loadClass 方法，否则不会走双亲委派机制</li><li>读取类文件的字节码</li><li>调用父类的 deﬁneClass 方法来加载类</li><li>使用者调用该类加载器的 loadClass 方法</li></ul><p><strong>破坏双亲委派模式</strong></p><ul><li>双亲委派模型的第一次“被破坏”其实发生在双亲委派模型出现之前——即JDK1.2面世以前的“远古”时代 <ul><li>建议用户重写findClass()方法，在类加载器中的loadClass()方法中也会调用该方法</li></ul></li><li>双亲委派模型的第二次“被破坏”是由这个模型自身的缺陷导致的 <ul><li>如果有基础类型又要调用回用户的代码，此时也会破坏双亲委派模式</li></ul></li><li>双亲委派模型的第三次“被破坏”是由于用户对程序动态性的追求而导致的 <ul><li>这里所说的“动态性”指的是一些非常“热”门的名词：代码热替换（Hot Swap）、模块热部署（Hot Deployment）等</li></ul></li></ul><h3 id="_5-5-线程上下文类加载器" tabindex="-1"><a class="header-anchor" href="#_5-5-线程上下文类加载器"><span>5.5 线程上下文类加载器</span></a></h3><h4 id="背景" tabindex="-1"><a class="header-anchor" href="#背景"><span>背景</span></a></h4><p>我们在使用 JDBC 时，都需要加载 Driver 驱动，不知道你注意到没有，不写</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9;">Class</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">forName</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">com.mysql.jdbc.Driver</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>也是可以让 com.mysql.jdbc.Driver 正确加载的，你知道是怎么做的吗？ 让我们追踪一下源码：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> DriverManager</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // 注册驱动的集合</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> final</span><span style="color:#81A1C1;"> static</span><span style="color:#8FBCBB;"> CopyOnWriteArrayList</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">DriverInfo</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9FF;"> registeredDrivers</span></span>
<span class="line"><span style="color:#81A1C1;">    =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> CopyOnWriteArrayList</span><span style="color:#ECEFF4;">&lt;&gt;()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">    // 初始化驱动</span></span>
<span class="line"><span style="color:#81A1C1;">    static</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">    loadInitialDrivers</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#88C0D0;">    println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">JDBC DriverManager initialized</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>先不看别的，看看 DriverManager 的类加载器：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9;">System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">DriverManager</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getClassLoader</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>打印 null，表示它的类加载器是 Bootstrap ClassLoader，会到 JAVA_HOME/jre/lib 下搜索类，但 JAVA_HOME/jre/lib 下显然没有 mysql-connector-java-5.1.47.jar 包，这样问题来了，在 DriverManager 的静态代码块中，怎么能正确加载 com.mysql.jdbc.Driver 呢？</p><h4 id="spi-服务提供接口" tabindex="-1"><a class="header-anchor" href="#spi-服务提供接口"><span>SPI 服务提供接口</span></a></h4><p>继续看 loadInitialDrivers() 方法：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> loadInitialDrivers</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">    String</span><span style="color:#D8DEE9;"> drivers</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        drivers </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9;"> AccessController</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">doPrivileged</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#8FBCBB;"> PrivilegedAction</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">&gt;</span></span>
<span class="line"><span style="color:#ECEFF4;">                ()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            public</span><span style="color:#8FBCBB;"> String</span><span style="color:#88C0D0;"> run</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">                return</span><span style="color:#D8DEE9;"> System</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getProperty</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">jdbc.drivers</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#ECEFF4;">        })</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">Exception</span><span style="color:#D8DEE9;"> ex</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        drivers </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> null;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#616E88;">// 1）使用 ServiceLoader 机制加载驱动，即 SPI</span></span>
<span class="line"><span style="color:#D8DEE9;">    AccessController</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">doPrivileged</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#8FBCBB;"> PrivilegedAction</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">Void</span><span style="color:#ECEFF4;">&gt;()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        public</span><span style="color:#8FBCBB;"> Void</span><span style="color:#88C0D0;"> run</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">            ServiceLoader</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">Driver</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> loadedDrivers</span><span style="color:#81A1C1;"> =</span></span>
<span class="line"><span style="color:#D8DEE9;">                    ServiceLoader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">load</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">Driver</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">            Iterator</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">Driver</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> driversIterator</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> loadedDrivers</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">iterator</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">            try</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">                while</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">driversIterator</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">hasNext</span><span style="color:#ECEFF4;">())</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">                    driversIterator</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">next</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">                }</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">Throwable</span><span style="color:#D8DEE9;"> t</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">// Do nothing</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#81A1C1;">            return</span><span style="color:#81A1C1;"> null;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    })</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#88C0D0;">    println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">DriverManager.initialize: jdbc.drivers = </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9FF;"> drivers</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">// 2）使用 jdbc.drivers 定义的驱动名加载驱动</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">drivers </span><span style="color:#81A1C1;">==</span><span style="color:#81A1C1;"> null</span><span style="color:#81A1C1;"> ||</span><span style="color:#D8DEE9;"> drivers</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">equals</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;&quot;</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        return;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#8FBCBB;">    String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> driversList</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> drivers</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">split</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#88C0D0;">    println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">number of Drivers:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9;"> driversList</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">length</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">String</span><span style="color:#D8DEE9;"> aDriver</span><span style="color:#81A1C1;"> :</span><span style="color:#D8DEE9FF;"> driversList</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">            println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">DriverManager.Initialize: loading </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9FF;"> aDriver</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">// 这里的 ClassLoader.getSystemClassLoader() 就是应用程序类加载器</span></span>
<span class="line"><span style="color:#D8DEE9;">            Class</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">forName</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">aDriver</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> true</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#D8DEE9;">                    ClassLoader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getSystemClassLoader</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">Exception</span><span style="color:#D8DEE9;"> ex</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">            println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">DriverManager.Initialize: load failed: </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9FF;"> ex</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>先看 2）发现它最后是使用 Class.forName 完成类的加载和初始化，关联的是应用程序类加载器，因此 可以顺利完成类加载 再看 1）它就是大名鼎鼎的 Service Provider Interface （SPI） 约定如下，在 jar 包的 META-INF/services 包下，以接口全限定名名为文件，文件内容是实现类名称</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407152008060.png" alt="image-20240715200831758" tabindex="0" loading="lazy"><figcaption>image-20240715200831758</figcaption></figure><h4 id="使用" tabindex="-1"><a class="header-anchor" href="#使用"><span>使用</span></a></h4><p>这样就可以使用</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#8FBCBB;">ServiceLoader</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#D8DEE9FF;">接口类型</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> allImpls</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> ServiceLoader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">load</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">接口类型</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">Iterator</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#D8DEE9FF;">接口类型</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> iter</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> allImpls</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">iterator</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">while</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">iter</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">hasNext</span><span style="color:#ECEFF4;">())</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        iter</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">next</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>来得到实现类，体现的是【面向接口编程+解耦】的思想，在下面一些框架中都运用了此思想：</p><ul><li>JDBC</li><li>Servlet 初始化器</li><li>Spring 容器</li><li>Dubbo（对 SPI 进行了扩展）</li></ul><h4 id="原理" tabindex="-1"><a class="header-anchor" href="#原理"><span>原理</span></a></h4><p>接着看 ServiceLoader.load 方法:</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> &lt;</span><span style="color:#D8DEE9FF;">S</span><span style="color:#81A1C1;">&gt;</span><span style="color:#8FBCBB;"> ServiceLoader</span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9FF;">S</span><span style="color:#81A1C1;">&gt;</span><span style="color:#88C0D0;"> load</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">Class</span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9FF;">S</span><span style="color:#81A1C1;">&gt;</span><span style="color:#D8DEE9FF;"> service</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">// 获取线程上下文类加载器</span></span>
<span class="line"><span style="color:#8FBCBB;">    ClassLoader</span><span style="color:#D8DEE9;"> cl</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Thread</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">currentThread</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">getContextClassLoader</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#D8DEE9;"> ServiceLoader</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">load</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">service</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> cl</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>线程上下文类加载器是当前线程使用的类加载器，默认就是应用程序类加载器，它内部又是由 Class.forName 调用了线程上下文类加载器完成类加载，具体代码在 ServiceLoader 的内部类 LazyIterator 中：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">private</span><span style="color:#8FBCBB;"> S</span><span style="color:#88C0D0;"> nextService</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#88C0D0;">hasNextService</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"><span style="color:#81A1C1;">        throw</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> NoSuchElementException</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">    String</span><span style="color:#D8DEE9;"> cn</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> nextName</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    nextName </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> null;</span></span>
<span class="line"><span style="color:#8FBCBB;">    Class</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">?</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> c</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> null;</span></span>
<span class="line"><span style="color:#81A1C1;">    try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        c </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9;"> Class</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">forName</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">cn</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> false</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> loader</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">ClassNotFoundException</span><span style="color:#D8DEE9;"> x</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">        fail</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">service</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#A3BE8C;">Provider </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9FF;"> cn </span><span style="color:#81A1C1;">+</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;"> not found</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#D8DEE9;">service</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">isAssignableFrom</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">c</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">        fail</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">service</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">                &quot;</span><span style="color:#A3BE8C;">Provider </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9FF;"> cn </span><span style="color:#81A1C1;">+</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;"> not a subtype</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#81A1C1;">    try</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        S</span><span style="color:#D8DEE9;"> p</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> service</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">cast</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">c</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">newInstance</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        providers</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">put</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">cn</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> p</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#D8DEE9FF;"> p</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">Throwable</span><span style="color:#D8DEE9;"> x</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">        fail</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">service</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">                &quot;</span><span style="color:#A3BE8C;">Provider </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9FF;"> cn </span><span style="color:#81A1C1;">+</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;"> could not be instantiated</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#D8DEE9FF;">                x</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#81A1C1;">    throw</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Error</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // This cannot happen</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6、运行期优化" tabindex="-1"><a class="header-anchor" href="#_6、运行期优化"><span>6、运行期优化</span></a></h2><h3 id="_6-1-即时编译" tabindex="-1"><a class="header-anchor" href="#_6-1-即时编译"><span>6.1 即时编译</span></a></h3><h4 id="_1-分层编译" tabindex="-1"><a class="header-anchor" href="#_1-分层编译"><span>（1）分层编译</span></a></h4><p>JVM 将执行状态分成了 5 个层次：</p><ul><li>0层：解释执行，用解释器将字节码翻译为机器码</li><li>1层：使用 C1 <strong>即时编译器</strong>编译执行（不带 proﬁling）</li><li>2层：使用 C1 即时编译器编译执行（带基本的profiling）</li><li>3层：使用 C1 即时编译器编译执行（带完全的profiling）</li><li>4层：使用 C2 即时编译器编译执行</li></ul><blockquote><p>proﬁling 是指在运行过程中收集一些程序执行状态的数据，例如【方法的调用次数】，【循环的 回边次数】等</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> JIT1</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 200</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            long</span><span style="color:#D8DEE9;"> start</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> System</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">nanoTime</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">            for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> j</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> j </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 1000</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> j</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">                new</span><span style="color:#88C0D0;"> Object</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#81A1C1;">            long</span><span style="color:#D8DEE9;"> end</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> System</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">nanoTime</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">printf</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">%d</span><span style="color:#EBCB8B;">\\t</span><span style="color:#A3BE8C;">%d</span><span style="color:#EBCB8B;">\\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">,(</span><span style="color:#D8DEE9FF;">end </span><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;"> start</span><span style="color:#ECEFF4;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>即时编译器（JIT）与解释器的区别</strong>：</p><ul><li>解释器 <ul><li>将字节码<strong>解释</strong>为机器码，下次即使遇到相同的字节码，仍会执行重复的解释</li><li>是将字节码解释为针对所有平台都通用的机器码</li></ul></li><li>即时编译器 <ul><li>将一些字节码<strong>编译</strong>为机器码，<strong>并存入 Code Cache</strong>，下次遇到相同的代码，直接执行，无需再编译</li><li>根据平台类型，生成平台特定的机器码</li></ul></li></ul><p>对于大部分的不常用的代码，我们无需耗费时间将其编译成机器码，而是采取解释执行的方式运行；另一方面，对于仅占据小部分的热点代码，我们则可以将其编译成机器码，以达到理想的运行速度。 执行效率上简单比较一下 Interpreter &lt; C1 &lt; C2，总的目标是发现热点代码（hotspot名称的由 来），并优化这些热点代码</p><p><strong>逃逸分析</strong>：</p><p>发现新建的对象是否逃逸。可以使用 <code>-XX:- DoEscapeAnalysis</code> 关闭逃逸分析</p><h4 id="_2-方法内联" tabindex="-1"><a class="header-anchor" href="#_2-方法内联"><span>（2）方法内联</span></a></h4><p>举个栗子：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> int</span><span style="color:#88C0D0;"> square</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">*</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9;">System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">square</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">9</span><span style="color:#ECEFF4;">))</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>如果发现 square 是热点方法，并且长度不太长时，会进行<strong>内联</strong>，所谓的内联就是把方法内代码拷贝、 粘贴到调用者的位置：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9;">System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">9</span><span style="color:#81A1C1;"> *</span><span style="color:#B48EAD;"> 9</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>还能够进行<strong>常量折叠</strong>（constant folding）的优化</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9;">System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">8</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> JIT2</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">    // -XX:+UnlockDiagnosticVMOptions -XX:+PrintInlining （解锁隐藏参数）打印</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    inlining 信息</span></span>
<span class="line"><span style="color:#616E88;">    // -XX:CompileCommand=dontinline,*JIT2.square 禁止某个方法 inlining</span></span>
<span class="line"><span style="color:#616E88;">// -XX:+PrintCompilation 打印编译信息</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#D8DEE9;"> x</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 500</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            long</span><span style="color:#D8DEE9;"> start</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> System</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">nanoTime</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">            for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> j</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> j </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 1000</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> j</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">                x </span><span style="color:#81A1C1;">=</span><span style="color:#88C0D0;"> square</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">9</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#81A1C1;">            long</span><span style="color:#D8DEE9;"> end</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> System</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">nanoTime</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">printf</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">%d</span><span style="color:#EBCB8B;">\\t</span><span style="color:#A3BE8C;">%d</span><span style="color:#EBCB8B;">\\t</span><span style="color:#A3BE8C;">%d</span><span style="color:#EBCB8B;">\\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;">x</span><span style="color:#ECEFF4;">,(</span><span style="color:#D8DEE9FF;">end </span><span style="color:#81A1C1;">-</span><span style="color:#D8DEE9FF;"> start</span><span style="color:#ECEFF4;">))</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> int</span><span style="color:#88C0D0;"> square</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">final</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> i</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">*</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-字段优化" tabindex="-1"><a class="header-anchor" href="#_3-字段优化"><span>（3）字段优化</span></a></h4><p>JMH 基准测试请参考：http://openjdk.java.net/projects/code-tools/jmh/ 创建 maven 工程，添加依赖如下</p><div class="language-xml line-numbers-mode" data-highlighter="shiki" data-ext="xml" data-title="xml" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">&lt;dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;groupId&gt;</span><span style="color:#D8DEE9FF;">org.openjdk.jmh</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">jmh-core</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;version&gt;</span><span style="color:#D8DEE9FF;">\${jmh.version}</span><span style="color:#81A1C1;">&lt;/version&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;groupId&gt;</span><span style="color:#D8DEE9FF;">org.openjdk.jmh</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">jmh-generator-annprocess</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;version&gt;</span><span style="color:#D8DEE9FF;">\${jmh.version}</span><span style="color:#81A1C1;">&lt;/version&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;scope&gt;</span><span style="color:#D8DEE9FF;">provided</span><span style="color:#81A1C1;">&lt;/scope&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/dependency&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> test</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">import</span><span style="color:#8FBCBB;"> org</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">openjdk</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">jmh</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">annotations</span><span style="color:#ECEFF4;">.</span><span style="color:#81A1C1;">*;</span></span>
<span class="line"><span style="color:#81A1C1;">import</span><span style="color:#8FBCBB;"> org</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">openjdk</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">jmh</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">runner</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">Runner</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">import</span><span style="color:#8FBCBB;"> org</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">openjdk</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">jmh</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">runner</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">RunnerException</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">import</span><span style="color:#8FBCBB;"> org</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">openjdk</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">jmh</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">runner</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">options</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">Options</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">import</span><span style="color:#8FBCBB;"> org</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">openjdk</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">jmh</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">runner</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">options</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">OptionsBuilder</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">import</span><span style="color:#8FBCBB;"> java</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">util</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">Random</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">import</span><span style="color:#8FBCBB;"> java</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">util</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">concurrent</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">ThreadLocalRandom</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Warmup</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">iterations</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> time</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Measurement</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">iterations</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 5</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> time</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">State</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">Scope</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Benchmark</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Benchmark1</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    int</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> elements</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> randomInts</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1_000</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> int</span><span style="color:#ECEFF4;">[]</span><span style="color:#88C0D0;"> randomInts</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> size</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        Random</span><span style="color:#D8DEE9;"> random</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> ThreadLocalRandom</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">current</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> values</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#81A1C1;"> int</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">size</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9FF;"> size</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">            values</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> random</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">nextInt</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#D8DEE9FF;"> values</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Benchmark</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> test1</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9;"> elements</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">length</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">            doSum</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">elements</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Benchmark</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> test2</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> local</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">elements</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9;"> local</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">length</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">            doSum</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">local</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">])</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Benchmark</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> test3</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> element</span><span style="color:#81A1C1;"> :</span><span style="color:#D8DEE9FF;"> elements</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">            doSum</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">element</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#81A1C1;">    static</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> sum</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">CompilerControl</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">CompilerControl</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Mode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">INLINE</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> doSum</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> x</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        sum </span><span style="color:#81A1C1;">+=</span><span style="color:#D8DEE9FF;"> x</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> RunnerException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        Options</span><span style="color:#D8DEE9;"> opt</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> OptionsBuilder</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#ECEFF4;">                .</span><span style="color:#88C0D0;">include</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">Benchmark1</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getSimpleName</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"><span style="color:#ECEFF4;">                .</span><span style="color:#88C0D0;">forks</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">                .</span><span style="color:#88C0D0;">build</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        new</span><span style="color:#88C0D0;"> Runner</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">opt</span><span style="color:#ECEFF4;">).</span><span style="color:#88C0D0;">run</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先启用 doSum 的方法内联，测试结果如下（每秒吞吐量，分数越高的更好）：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#8FBCBB;">Benchmark</span><span style="color:#8FBCBB;"> Mode</span><span style="color:#8FBCBB;"> Samples</span><span style="color:#8FBCBB;"> Score</span><span style="color:#8FBCBB;"> Score</span><span style="color:#D8DEE9FF;"> error </span><span style="color:#8FBCBB;">Units</span></span>
<span class="line"><span style="color:#D8DEE9;">t</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Benchmark1</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">test1</span><span style="color:#D8DEE9FF;"> thrpt </span><span style="color:#B48EAD;">5</span><span style="color:#B48EAD;"> 2420286.539</span><span style="color:#B48EAD;"> 390747.467</span><span style="color:#D8DEE9FF;"> ops</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">s</span></span>
<span class="line"><span style="color:#D8DEE9;">t</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Benchmark1</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">test2</span><span style="color:#D8DEE9FF;"> thrpt </span><span style="color:#B48EAD;">5</span><span style="color:#B48EAD;"> 2544313.594</span><span style="color:#B48EAD;"> 91304.136</span><span style="color:#D8DEE9FF;"> ops</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">s</span></span>
<span class="line"><span style="color:#D8DEE9;">t</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Benchmark1</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">test3</span><span style="color:#D8DEE9FF;"> thrpt </span><span style="color:#B48EAD;">5</span><span style="color:#B48EAD;"> 2469176.697</span><span style="color:#B48EAD;"> 450570.647</span><span style="color:#D8DEE9FF;"> ops</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来禁用 doSum 方法内联</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">CompilerControl</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">CompilerControl</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Mode</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">DONT_INLINE</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> doSum</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9FF;"> x</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">sum </span><span style="color:#81A1C1;">+=</span><span style="color:#D8DEE9FF;"> x</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试结果如下：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#8FBCBB;">Benchmark</span><span style="color:#8FBCBB;"> Mode</span><span style="color:#8FBCBB;"> Samples</span><span style="color:#8FBCBB;"> Score</span><span style="color:#8FBCBB;"> Score</span><span style="color:#D8DEE9FF;"> error </span><span style="color:#8FBCBB;">Units</span></span>
<span class="line"><span style="color:#D8DEE9;">t</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Benchmark1</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">test1</span><span style="color:#D8DEE9FF;"> thrpt </span><span style="color:#B48EAD;">5</span><span style="color:#B48EAD;"> 296141.478</span><span style="color:#B48EAD;"> 63649.220</span><span style="color:#D8DEE9FF;"> ops</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">s</span></span>
<span class="line"><span style="color:#D8DEE9;">t</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Benchmark1</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">test2</span><span style="color:#D8DEE9FF;"> thrpt </span><span style="color:#B48EAD;">5</span><span style="color:#B48EAD;"> 371262.351</span><span style="color:#B48EAD;"> 83890.984</span><span style="color:#D8DEE9FF;"> ops</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">s</span></span>
<span class="line"><span style="color:#D8DEE9;">t</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Benchmark1</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">test3</span><span style="color:#D8DEE9FF;"> thrpt </span><span style="color:#B48EAD;">5</span><span style="color:#B48EAD;"> 368960.847</span><span style="color:#B48EAD;"> 60163.391</span><span style="color:#D8DEE9FF;"> ops</span><span style="color:#81A1C1;">/</span><span style="color:#D8DEE9FF;">s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>分析： 在刚才的示例中，doSum 方法是否内联会影响 elements 成员变量读取的优化： 如果 doSum 方法内联了，刚才的 test1 方法会被优化成下面的样子（伪代码）：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Benchmark</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> test1</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">// elements.length 首次读取会缓存起来 -&gt; int[] local</span></span>
<span class="line"><span style="color:#81A1C1;">for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9;"> elements</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">length</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span><span style="color:#616E88;"> // 后续 999 次 求长度 &lt;- local</span></span>
<span class="line"><span style="color:#D8DEE9FF;">sum </span><span style="color:#81A1C1;">+=</span><span style="color:#D8DEE9FF;"> elements</span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">]</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // 1000 次取下标 i 的元素 &lt;- local</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以节省 1999 次 Field 读取操作 但如果 doSum 方法没有内联，则不会进行上面的优化 练习：在内联情况下将 elements 添加 volatile 修饰符，观察测试结果</p><h3 id="_6-2-反射优化" tabindex="-1"><a class="header-anchor" href="#_6-2-反射优化"><span>6.2 反射优化</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Reflect1</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> foo</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">      System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">foo...</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">   public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> NoSuchMethodException</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> InvocationTargetException</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> IllegalAccessException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">      Method</span><span style="color:#D8DEE9;"> foo</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Demo3</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getMethod</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">foo</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">      for</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">&lt;=</span><span style="color:#B48EAD;">16</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">         foo</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">invoke</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">null</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>foo.invoke 前面 0 ~ 15 次调用使用的是 MethodAccessor 的 NativeMethodAccessorImpl 实现 invoke 方法源码</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">import</span><span style="color:#8FBCBB;"> java</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">lang</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">reflect</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">Method</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">import</span><span style="color:#8FBCBB;"> sun</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">reflect</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">misc</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">ReflectUtil</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">class</span><span style="color:#8FBCBB;"> NativeMethodAccessorImpl</span><span style="color:#81A1C1;"> extends</span><span style="color:#8FBCBB;font-weight:bold;"> MethodAccessorImpl</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> final</span><span style="color:#8FBCBB;"> Method</span><span style="color:#D8DEE9;"> method</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#8FBCBB;"> DelegatingMethodAccessorImpl</span><span style="color:#D8DEE9;"> parent</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> numInvocations</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#88C0D0;">    NativeMethodAccessorImpl</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">Method</span><span style="color:#D8DEE9;"> method</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">method</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> method</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#8FBCBB;"> Object</span><span style="color:#88C0D0;"> invoke</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">Object</span><span style="color:#D8DEE9;"> target</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> Object</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">            throws</span><span style="color:#8FBCBB;"> IllegalArgumentException</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> InvocationTargetException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">// inflationThreshold 膨胀阈值，默认 15</span></span>
<span class="line"><span style="color:#81A1C1;">        if</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">++this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">numInvocations</span><span style="color:#81A1C1;"> &gt;</span><span style="color:#D8DEE9;"> ReflectionFactory</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">inflationThreshold</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#81A1C1;">                &amp;&amp;</span><span style="color:#81A1C1;"> !</span><span style="color:#D8DEE9;">ReflectUtil</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">isVMAnonymousClass</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">method</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getDeclaringClass</span><span style="color:#ECEFF4;">()))</span></span>
<span class="line"><span style="color:#ECEFF4;">        {</span></span>
<span class="line"><span style="color:#616E88;">// 使用 ASM 动态生成的新实现代替本地实现，速度较本地实现快 20 倍左右</span></span>
<span class="line"><span style="color:#8FBCBB;">            MethodAccessorImpl</span><span style="color:#D8DEE9;"> generatedMethodAccessor</span><span style="color:#81A1C1;"> =</span></span>
<span class="line"><span style="color:#ECEFF4;">                    (</span><span style="color:#D8DEE9FF;">MethodAccessorImpl</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">                            (</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> MethodAccessorGenerator</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"><span style="color:#ECEFF4;">                                    .</span><span style="color:#88C0D0;">generateMethod</span><span style="color:#ECEFF4;">(</span></span>
<span class="line"><span style="color:#81A1C1;">                                            this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">method</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getDeclaringClass</span><span style="color:#ECEFF4;">(),</span></span>
<span class="line"><span style="color:#81A1C1;">                                            this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">method</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getName</span><span style="color:#ECEFF4;">(),</span></span>
<span class="line"><span style="color:#81A1C1;">                                            this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">method</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getParameterTypes</span><span style="color:#ECEFF4;">(),</span></span>
<span class="line"><span style="color:#81A1C1;">                                            this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">method</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getReturnType</span><span style="color:#ECEFF4;">(),</span></span>
<span class="line"><span style="color:#81A1C1;">                                            this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">method</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getExceptionTypes</span><span style="color:#ECEFF4;">(),</span></span>
<span class="line"><span style="color:#81A1C1;">                                            this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">method</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getModifiers</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#ECEFF4;">                                    )</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">            this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">parent</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setDelegate</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">generatedMethodAccessor</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#616E88;">// 调用本地实现</span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#88C0D0;"> invoke0</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">method</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> target</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#81A1C1;">    void</span><span style="color:#88C0D0;"> setParent</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">DelegatingMethodAccessorImpl</span><span style="color:#D8DEE9;"> parent</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        this</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">parent</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> parent</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> native</span><span style="color:#8FBCBB;"> Object</span><span style="color:#88C0D0;"> invoke0</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">Method</span><span style="color:#D8DEE9;"> method</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> Object</span><span style="color:#D8DEE9;"> target</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> Object</span><span style="color:#ECEFF4;">[]</span></span>
<span class="line"><span style="color:#D8DEE9;">            args</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当调用到第 16 次（从0开始算）时，会采用运行时生成的类代替掉最初的实现，可以通过 debug 得到 类名为 sun.reflect.GeneratedMethodAccessor1 可以使用阿里的 arthas 工具查看：</p><p>java -jar arthas-boot.jar</p><h1 id="四、内存模型" tabindex="-1"><a class="header-anchor" href="#四、内存模型"><span>四、内存模型</span></a></h1><ul><li>很多人将【java 内存结构】与【java 内存模型】傻傻分不清，【java 内存模型】是 Java Memory Model（<strong>JMM</strong>）的意思。</li><li>简单的说，<strong>JMM</strong> 定义了一套在多线程读写共享数据时（成员变量、数组）时，对数据的<strong>可见性</strong>、<strong>有序性</strong>、和<strong>原子性</strong>的规则和保障</li><li>JMM 即 Java Memory Model，它定义了主存（共享内存）、工作内存（线程私有）抽象概念，底层对应着 CPU 寄存器、缓存、硬件内存、 CPU 指令优化等。 JMM 体现在以下几个方面 <ul><li>原子性 - 保证指令不会受到线程上下文切换的影响</li><li>可见性 - 保证指令不会受 cpu 缓存的影响</li><li>有序性 - 保证指令不会受 cpu 指令并行优化的影响</li></ul></li></ul><h2 id="_1-原子性" tabindex="-1"><a class="header-anchor" href="#_1-原子性"><span>1. 原子性</span></a></h2><h3 id="_1-1-问题解析" tabindex="-1"><a class="header-anchor" href="#_1-1-问题解析"><span>1-1 问题解析</span></a></h3><p>提出问题：两个线程对初始值为 0 的静态变量一个做自增，一个做自减，各做 5000 次，结果是 0 吗？</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Demo1</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    static</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> InterruptedException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8FBCBB;">        Thread</span><span style="color:#D8DEE9;"> t1</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Thread</span><span style="color:#ECEFF4;">(()</span><span style="color:#8FBCBB;"> -&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> j</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> j </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 50000</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> j</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">                i</span><span style="color:#81A1C1;">++;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#ECEFF4;">        })</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        Thread</span><span style="color:#D8DEE9;"> t2</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Thread</span><span style="color:#ECEFF4;">(()</span><span style="color:#8FBCBB;"> -&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> j</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> j </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 50000</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> j</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">                i</span><span style="color:#81A1C1;">--;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#ECEFF4;">        })</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        t1</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">start</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        t2</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">start</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        t1</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">join</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        t2</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">join</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上的结果可能是正数、负数、零。为什么呢？因为 Java 中<strong>对静态变量的自增，自减</strong>并<strong>不是原子操作</strong>。</p><p>例如对于 <code>i++</code> 而言（i 为静态变量），实际会产生如下的 JVM 字节码指令：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">getstatic i </span><span style="color:#616E88;">// 获取静态变量i的值</span></span>
<span class="line"><span style="color:#D8DEE9FF;">iconst_1 </span><span style="color:#616E88;">// 准备常量1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">iadd </span><span style="color:#616E88;">// 加法</span></span>
<span class="line"><span style="color:#D8DEE9FF;">putstatic i </span><span style="color:#616E88;">// 将修改后的值存入静态变量i</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>而对应 <code>i--</code> 也是类似：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">getstatic i </span><span style="color:#616E88;">// 获取静态变量i的值</span></span>
<span class="line"><span style="color:#D8DEE9FF;">iconst_1 </span><span style="color:#616E88;">// 准备常量1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">isub </span><span style="color:#616E88;">// 减法</span></span>
<span class="line"><span style="color:#D8DEE9FF;">putstatic i </span><span style="color:#616E88;">// 将修改后的值存入静态变量i</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>而 Java 的内存模型如下，完成静态变量的自增，自减需要在<strong>主存</strong>和<strong>线程内存</strong>中进行数据交换：</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407152130988.png" alt="image-20240715213034845" tabindex="0" loading="lazy"><figcaption>image-20240715213034845</figcaption></figure><p>如果是单线程以上 8 行代码是顺序执行（不会交错）没有问题：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// 假设i的初始值为0</span></span>
<span class="line"><span style="color:#D8DEE9FF;">getstatic i </span><span style="color:#616E88;">// 线程1-获取静态变量i的值 线程内i=0</span></span>
<span class="line"><span style="color:#D8DEE9FF;">iconst_1 </span><span style="color:#616E88;">// 线程1-准备常量1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">iadd </span><span style="color:#616E88;">// 线程1-自增 线程内i=1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">putstatic i </span><span style="color:#616E88;">// 线程1-将修改后的值存入静态变量i 静态变量i=1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">getstatic i </span><span style="color:#616E88;">// 线程1-获取静态变量i的值 线程内i=1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">iconst_1 </span><span style="color:#616E88;">// 线程1-准备常量1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">isub </span><span style="color:#616E88;">// 线程1-自减 线程内i=0</span></span>
<span class="line"><span style="color:#D8DEE9FF;">putstatic i </span><span style="color:#616E88;">// 线程1-将修改后的值存入静态变量i 静态变量i=0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但多线程下这 8 行代码可能交错运行（为什么会交错？思考一下）： 出现负数的情况：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// 假设i的初始值为0</span></span>
<span class="line"><span style="color:#D8DEE9FF;">getstatic i </span><span style="color:#616E88;">// 线程1-获取静态变量i的值 线程内i=0</span></span>
<span class="line"><span style="color:#D8DEE9FF;">getstatic i </span><span style="color:#616E88;">// 线程2-获取静态变量i的值 线程内i=0</span></span>
<span class="line"><span style="color:#D8DEE9FF;">iconst_1 </span><span style="color:#616E88;">// 线程1-准备常量1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">iadd </span><span style="color:#616E88;">// 线程1-自增 线程内i=1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">putstatic i </span><span style="color:#616E88;">// 线程1-将修改后的值存入静态变量i 静态变量i=1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">iconst_1 </span><span style="color:#616E88;">// 线程2-准备常量1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">isub </span><span style="color:#616E88;">// 线程2-自减 线程内i=-1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">putstatic i </span><span style="color:#616E88;">// 线程2-将修改后的值存入静态变量i 静态变量i=-1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>出现正数的情况：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// 假设i的初始值为0</span></span>
<span class="line"><span style="color:#D8DEE9FF;">getstatic i </span><span style="color:#616E88;">// 线程1-获取静态变量i的值 线程内i=0</span></span>
<span class="line"><span style="color:#D8DEE9FF;">getstatic i </span><span style="color:#616E88;">// 线程2-获取静态变量i的值 线程内i=0</span></span>
<span class="line"><span style="color:#D8DEE9FF;">iconst_1 </span><span style="color:#616E88;">// 线程1-准备常量1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">iadd </span><span style="color:#616E88;">// 线程1-自增 线程内i=1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">iconst_1 </span><span style="color:#616E88;">// 线程2-准备常量1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">isub </span><span style="color:#616E88;">// 线程2-自减 线程内i=-1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">putstatic i </span><span style="color:#616E88;">// 线程2-将修改后的值存入静态变量i 静态变量i=-1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">putstatic i </span><span style="color:#616E88;">// 线程1-将修改后的值存入静态变量i 静态变量i=1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-解决方法-加锁" tabindex="-1"><a class="header-anchor" href="#_1-2-解决方法-加锁"><span>1-2 解决方法 -加锁</span></a></h3><h4 id="_1-synchronized-同步关键字" tabindex="-1"><a class="header-anchor" href="#_1-synchronized-同步关键字"><span>（1）synchronized（同步关键字）</span></a></h4><p>语法：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">synchronized</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;"> 对象 </span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    要作为原子操作代码</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>用 <code>synchronized</code> 解决并发问题：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Demo1</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    static</span><span style="color:#81A1C1;"> int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    static</span><span style="color:#8FBCBB;"> Object</span><span style="color:#D8DEE9;"> obj</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Object</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> InterruptedException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8FBCBB;">        Thread</span><span style="color:#D8DEE9;"> t1</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Thread</span><span style="color:#ECEFF4;">(()</span><span style="color:#8FBCBB;"> -&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> j</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> j </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 50000</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> j</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">                synchronized</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">obj</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">                    i</span><span style="color:#81A1C1;">++;</span></span>
<span class="line"><span style="color:#ECEFF4;">                }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#ECEFF4;">        })</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        Thread</span><span style="color:#D8DEE9;"> t2</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Thread</span><span style="color:#ECEFF4;">(()</span><span style="color:#8FBCBB;"> -&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> j</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> j </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 50000</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> j</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">                synchronized</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">obj</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">                    i</span><span style="color:#81A1C1;">--;</span></span>
<span class="line"><span style="color:#ECEFF4;">                }</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#ECEFF4;">        })</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        t1</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">start</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        t2</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">start</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        t1</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">join</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        t2</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">join</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">i</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//输出为0</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>为什么需要这里的 <code>obj</code> 对象呢？</p></blockquote><p>我们可以这样理解：可以把 obj 想象成一个房间，线程 t1，t2 想象成两个人。</p><p>当线程 t1 执行到 <code>synchronized(obj)</code> 时就好比 t1 进入了这个房间，并反手锁住了门，在门内执行 count++ 代码。</p><p>这时候如果 t2 也运行到了 <code>synchronized(obj)</code> 时，它发现门被锁住了，只能在门外等待。</p><p>当 t1 执行完 <code>synchronized{}</code> 块内的代码，这时候才会解开门上的锁，从 obj 房间出来。t2 线程这时才可以进入 obj 房间，反锁住门，执行它的 count-- 代码。</p><blockquote><p>怎么从JVM角度理解呢？（这里引用《Java并发编程的艺术》里的一段话）</p></blockquote><p>从JVM规范中可以看到<code>Synchonized</code>在JVM里的实现原理，JVM基于进入和退出<code>Monitor</code>对象来实现方法同步和代码块同步，但两者的实现细节不一样。代码块同步是使用<code>monitorenter</code> 和<code>monitorexit</code>指令实现的。 <code>monitorenter</code>指令是在编译后插入到同步代码块的<strong>开始位置</strong>，而<code>monitorexit</code>是插入到<strong>方法结束处</strong>和<strong>异常处</strong>，JVM要保证每个<code>monitorenter</code>必须有对应的<code>monitorexit</code>与之配对。任何对象都有一个<code>monitor</code>与之关联，当且一个<code>monitor</code>被持有后，它将处于锁定状态。线程执行到<code>monitorenter</code> 指令时，将会尝试获取对象所对应的<code>monitor</code>的所有权，即尝试获得对象的锁。</p><h2 id="_2-可见性" tabindex="-1"><a class="header-anchor" href="#_2-可见性"><span>2.可见性</span></a></h2><h4 id="_2-1-退不出的循环" tabindex="-1"><a class="header-anchor" href="#_2-1-退不出的循环"><span>2-1 退不出的循环</span></a></h4><p>先来看一个现象，main 线程对 run 变量的修改对于 t 线程不可见，导致了 t 线程无法停止：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">static</span><span style="color:#81A1C1;"> boolean</span><span style="color:#D8DEE9;"> run</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> true;</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9FF;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> throws InterruptedException </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#8FBCBB;">    Thread</span><span style="color:#D8DEE9;"> t</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Thread</span><span style="color:#ECEFF4;">(()</span><span style="color:#8FBCBB;">-&gt;</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">        while</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">run</span><span style="color:#ECEFF4;">){</span></span>
<span class="line"><span style="color:#616E88;">            // ....</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    })</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    t</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">start</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    Thread</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1000</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    run </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> false;</span><span style="color:#616E88;"> // 线程t不会如预想的停下来</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为什么会这样？</p><ol><li>初始状态， t 线程刚开始从主内存读取了 run 的值到工作内存。</li></ol><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407152221819.png" alt="image-20240715222147607" tabindex="0" loading="lazy"><figcaption>image-20240715222147607</figcaption></figure><ol start="2"><li>因为 t 线程要频繁从<strong>主内存</strong>中读取 run 的值，<strong>JIT 编译器</strong>会将 run 的值缓存至自己工作内存中的<strong>高速缓存</strong>中，减少对主存中 run 的访问，提高效率</li></ol><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407152223824.png" alt="image-20240715222337696" tabindex="0" loading="lazy"><figcaption>image-20240715222337696</figcaption></figure><ol start="3"><li>1 秒之后，main 线程修改了 run 的值，并同步至主存，而 t 是从自己工作内存中的高速缓存中读取这个变量的值，结果永远是旧值</li></ol><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407152224719.png" alt="image-20240715222432570" tabindex="0" loading="lazy"><figcaption>image-20240715222432570</figcaption></figure><h4 id="_2-2-解决办法" tabindex="-1"><a class="header-anchor" href="#_2-2-解决办法"><span>2-2 解决办法</span></a></h4><h5 id="_1-volatile-易变关键字" tabindex="-1"><a class="header-anchor" href="#_1-volatile-易变关键字"><span>（1）volatile（易变关键字）</span></a></h5><p>它可以用来修饰<strong>成员变量</strong>和<strong>静态成员变量</strong>，他可以避免线程从自己的工作缓存中查找变量的值，必须到主存中获取它的值，线程操作 <strong>volatile</strong> 变量都是直接操作主存，保证了共享变量的<strong>可见性</strong>，但<strong>不能保证原子性</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Demo1</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    volatile</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> boolean</span><span style="color:#D8DEE9;"> run</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> true;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> InterruptedException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        Thread</span><span style="color:#D8DEE9;"> t</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Thread</span><span style="color:#ECEFF4;">(()</span><span style="color:#8FBCBB;"> -&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            while</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">run</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">// ....</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#ECEFF4;">        })</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        t</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">start</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        Thread</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1000</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        run </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> false;</span><span style="color:#616E88;"> // 线程t如预想的停下来</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>注意</strong>：</p><p><code>synchronized</code> 语句块既可以保证代码块的<strong>原子性</strong>，也同时保证代码块内变量的<strong>可见性</strong>。但 缺点是<code>synchronized</code>是属于重量级操作，<strong>性能相对更低</strong></p><p>如果在前面示例的死循环中加入 <code>System.out.println()</code> 会发现即使不加 volatile 修饰符，线程 t 也 能正确看到对 run 变量的修改了，想一想为什么？</p></blockquote><p>进入<code>println</code>源码：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> println</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9FF;"> x</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    synchronized</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">this</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#88C0D0;">        print</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">x</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#88C0D0;">        newLine</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看出加了<code>synchronized</code>，保证了每次<code>run</code>变量都会从主存中获取</p><h3 id="_2-3-可见性" tabindex="-1"><a class="header-anchor" href="#_2-3-可见性"><span>2-3 可见性</span></a></h3><p>前面例子体现的实际就是可见性，它保证的是在多个线程之间，一个线程对 volatile 变量的修改对另一 个线程可见， 不能保证原子性，仅用在一个写线程，多个读线程的情况： 上例从字节码理解是这样的：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">getstatic run </span><span style="color:#616E88;">// 线程 t 获取 run true</span></span>
<span class="line"><span style="color:#D8DEE9FF;">getstatic run </span><span style="color:#616E88;">// 线程 t 获取 run true</span></span>
<span class="line"><span style="color:#D8DEE9FF;">getstatic run </span><span style="color:#616E88;">// 线程 t 获取 run true</span></span>
<span class="line"><span style="color:#D8DEE9FF;">getstatic run </span><span style="color:#616E88;">// 线程 t 获取 run true</span></span>
<span class="line"><span style="color:#D8DEE9FF;">putstatic run </span><span style="color:#616E88;">// 线程 main 修改 run 为 false， 仅此一次</span></span>
<span class="line"><span style="color:#D8DEE9FF;">getstatic run </span><span style="color:#616E88;">// 线程 t 获取 run false</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>比较一下之前我们将线程安全时举的例子：两个线程一个 i++ 一个 i-- ，只能保证看到最新值，不能解 决指令交错</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// 假设i的初始值为0</span></span>
<span class="line"><span style="color:#D8DEE9FF;">getstatic i </span><span style="color:#616E88;">// 线程1-获取静态变量i的值 线程内i=0</span></span>
<span class="line"><span style="color:#D8DEE9FF;">getstatic i </span><span style="color:#616E88;">// 线程2-获取静态变量i的值 线程内i=0</span></span>
<span class="line"><span style="color:#D8DEE9FF;">iconst_1 </span><span style="color:#616E88;">// 线程1-准备常量1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">iadd </span><span style="color:#616E88;">// 线程1-自增 线程内i=1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">putstatic i </span><span style="color:#616E88;">// 线程1-将修改后的值存入静态变量i 静态变量i=1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">iconst_1 </span><span style="color:#616E88;">// 线程2-准备常量1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">isub </span><span style="color:#616E88;">// 线程2-自减 线程内i=-1</span></span>
<span class="line"><span style="color:#D8DEE9FF;">putstatic i </span><span style="color:#616E88;">// 线程2-将修改后的值存入静态变量i 静态变量i=-1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>虚拟机调优</p><h1 id="参考" tabindex="-1"><a class="header-anchor" href="#参考"><span>参考：</span></a></h1><p>参考文章：https://blog.csdn.net/qq_45966440/article/details/120824295?spm=1001.2014.3001.5502</p><p>参考文章：https://blog.csdn.net/weixin_50280576/article/details/113742011</p><p>参考视频：https://www.bilibili.com/video/BV1yE411Z7AP?p=19&amp;spm_id_from=pageDriver&amp;vd_source=cd81f8812505504b960957155cd81114</p>`,888);function t(i,E){return o(),n("div",null,[c,a(" more "),r])}const d=s(e,[["render",t],["__file","jvmed.html.vue"]]),C=JSON.parse('{"path":"/note/java/jvmed.html","title":"Java虚拟机","lang":"zh-CN","frontmatter":{"title":"Java虚拟机","cover":"/assets/images/cover1.jpg","icon":"file","order":3,"author":"HotMilk","date":"2024-07-15T00:00:00.000Z","category":["JVM"],"tag":["jvm"],"description":"Java 虚拟机","head":[["meta",{"property":"og:url","content":"https://reniunai.github.io/note/java/jvmed.html"}],["meta",{"property":"og:site_name","content":"热牛奶"}],["meta",{"property":"og:title","content":"Java虚拟机"}],["meta",{"property":"og:description","content":"Java 虚拟机"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://reniunai.github.io/assets/images/cover1.jpg"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-08-05T08:48:07.000Z"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://reniunai.github.io/assets/images/cover1.jpg"}],["meta",{"name":"twitter:image:alt","content":"Java虚拟机"}],["meta",{"property":"article:author","content":"HotMilk"}],["meta",{"property":"article:tag","content":"jvm"}],["meta",{"property":"article:published_time","content":"2024-07-15T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-08-05T08:48:07.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Java虚拟机\\",\\"image\\":[\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806488.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806323.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806481.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806492.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806444.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806556.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806505.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806336.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806606.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806528.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806611.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806759.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806509.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806290.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806559.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806527.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806840.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806056.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806314.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806561.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806479.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806087.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806182.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806969.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806904.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806959.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806010.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806615.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806783.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806878.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806958.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806023.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806120.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806464.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806544.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806723.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806901.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806946.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806753.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806075.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806106.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806741.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806880.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806753.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806868.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806873.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806924.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806440.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806424.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806496.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806602.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806701.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806770.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806182.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806241.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806174.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806552.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806608.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806670.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806036.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806984.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806093.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806432.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806537.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806754.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806177.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806829.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806104.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806300.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806281.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806529.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806658.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806004.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806053.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806072.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806127.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806165.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806461.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806768.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806950.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806098.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806079.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806159.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806271.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806382.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806675.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806863.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806948.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806050.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806161.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806177.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806295.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407151806520.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407152008060.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407152130988.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407152221819.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407152223824.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407152224719.png\\"],\\"datePublished\\":\\"2024-07-15T00:00:00.000Z\\",\\"dateModified\\":\\"2024-08-05T08:48:07.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"HotMilk\\"}]}"]]},"headers":[{"level":2,"title":"1.程序计数器","slug":"_1-程序计数器","link":"#_1-程序计数器","children":[]},{"level":2,"title":"2.虚拟机栈","slug":"_2-虚拟机栈","link":"#_2-虚拟机栈","children":[]},{"level":2,"title":"3.本地方法栈","slug":"_3-本地方法栈","link":"#_3-本地方法栈","children":[]},{"level":2,"title":"4.堆","slug":"_4-堆","link":"#_4-堆","children":[]},{"level":2,"title":"5.方法区","slug":"_5-方法区","link":"#_5-方法区","children":[]},{"level":2,"title":"6.直接内存","slug":"_6-直接内存","link":"#_6-直接内存","children":[]},{"level":2,"title":"1.如何判断对象可以回收","slug":"_1-如何判断对象可以回收","link":"#_1-如何判断对象可以回收","children":[]},{"level":2,"title":"2. 垃圾回收算法","slug":"_2-垃圾回收算法","link":"#_2-垃圾回收算法","children":[]},{"level":2,"title":"3. 分代垃圾回收","slug":"_3-分代垃圾回收","link":"#_3-分代垃圾回收","children":[]},{"level":2,"title":"4. 垃圾回收器","slug":"_4-垃圾回收器","link":"#_4-垃圾回收器","children":[]},{"level":2,"title":"5. 垃圾回收调优","slug":"_5-垃圾回收调优","link":"#_5-垃圾回收调优","children":[]},{"level":2,"title":"1. 类文件结构","slug":"_1-类文件结构","link":"#_1-类文件结构","children":[{"level":3,"title":"1.1 魔数","slug":"_1-1-魔数","link":"#_1-1-魔数","children":[]},{"level":3,"title":"1.2 版本","slug":"_1-2-版本","link":"#_1-2-版本","children":[]},{"level":3,"title":"1.3 常量池","slug":"_1-3-常量池","link":"#_1-3-常量池","children":[]},{"level":3,"title":"1.4 访问标识与继承信息","slug":"_1-4-访问标识与继承信息","link":"#_1-4-访问标识与继承信息","children":[]}]},{"level":2,"title":"2. 字节码指令","slug":"_2-字节码指令","link":"#_2-字节码指令","children":[{"level":3,"title":"2.1 javap工具","slug":"_2-1-javap工具","link":"#_2-1-javap工具","children":[]},{"level":3,"title":"2.2 图解方法执行流程","slug":"_2-2-图解方法执行流程","link":"#_2-2-图解方法执行流程","children":[]},{"level":3,"title":"2.3 练习 - 分析 i++","slug":"_2-3-练习-分析-i","link":"#_2-3-练习-分析-i","children":[]},{"level":3,"title":"2.4 条件判断指令","slug":"_2-4-条件判断指令","link":"#_2-4-条件判断指令","children":[]},{"level":3,"title":"2.5 循环控制指令","slug":"_2-5-循环控制指令","link":"#_2-5-循环控制指令","children":[]},{"level":3,"title":"2.6 练习-判断结果","slug":"_2-6-练习-判断结果","link":"#_2-6-练习-判断结果","children":[]},{"level":3,"title":"2.7 构造方法","slug":"_2-7-构造方法","link":"#_2-7-构造方法","children":[]},{"level":3,"title":"2.8 方法调用","slug":"_2-8-方法调用","link":"#_2-8-方法调用","children":[]},{"level":3,"title":"2.9 多态的原理","slug":"_2-9-多态的原理","link":"#_2-9-多态的原理","children":[]},{"level":3,"title":"2.10 异常处理","slug":"_2-10-异常处理","link":"#_2-10-异常处理","children":[]},{"level":3,"title":"2.11 synchronized","slug":"_2-11-synchronized","link":"#_2-11-synchronized","children":[]}]},{"level":2,"title":"3. 编译器处理","slug":"_3-编译器处理","link":"#_3-编译器处理","children":[{"level":3,"title":"3.1 默认构造器","slug":"_3-1-默认构造器","link":"#_3-1-默认构造器","children":[]},{"level":3,"title":"3.2 自动拆装箱","slug":"_3-2-自动拆装箱","link":"#_3-2-自动拆装箱","children":[]},{"level":3,"title":"3.3 泛型集合取值","slug":"_3-3-泛型集合取值","link":"#_3-3-泛型集合取值","children":[]},{"level":3,"title":"3.4反射获取泛型信息","slug":"_3-4反射获取泛型信息","link":"#_3-4反射获取泛型信息","children":[]},{"level":3,"title":"3.5 可变参数","slug":"_3-5-可变参数","link":"#_3-5-可变参数","children":[]},{"level":3,"title":"3.6 foreach 循环","slug":"_3-6-foreach-循环","link":"#_3-6-foreach-循环","children":[]},{"level":3,"title":"3.7 switch 字符串","slug":"_3-7-switch-字符串","link":"#_3-7-switch-字符串","children":[]},{"level":3,"title":"3.8 switch 枚举","slug":"_3-8-switch-枚举","link":"#_3-8-switch-枚举","children":[]},{"level":3,"title":"3.9 枚举类","slug":"_3-9-枚举类","link":"#_3-9-枚举类","children":[]},{"level":3,"title":"3.10 try-with-resources","slug":"_3-10-try-with-resources","link":"#_3-10-try-with-resources","children":[]},{"level":3,"title":"3.11 方法重写时的桥接方法","slug":"_3-11-方法重写时的桥接方法","link":"#_3-11-方法重写时的桥接方法","children":[]},{"level":3,"title":"3.12 匿名内部类","slug":"_3-12-匿名内部类","link":"#_3-12-匿名内部类","children":[]}]},{"level":2,"title":"4. 类加载阶段","slug":"_4-类加载阶段","link":"#_4-类加载阶段","children":[{"level":3,"title":"4.1 加载","slug":"_4-1-加载","link":"#_4-1-加载","children":[]},{"level":3,"title":"4.2 链接","slug":"_4-2-链接","link":"#_4-2-链接","children":[]},{"level":3,"title":"4-3 初始化","slug":"_4-3-初始化","link":"#_4-3-初始化","children":[]},{"level":3,"title":"4）练习","slug":"_4-练习","link":"#_4-练习","children":[]}]},{"level":2,"title":"5.类加载器","slug":"_5-类加载器","link":"#_5-类加载器","children":[{"level":3,"title":"5.1 启动类的加载器","slug":"_5-1-启动类的加载器","link":"#_5-1-启动类的加载器","children":[]},{"level":3,"title":"5.2 扩展类的加载器","slug":"_5-2-扩展类的加载器","link":"#_5-2-扩展类的加载器","children":[]},{"level":3,"title":"5.3 双亲委派模式","slug":"_5-3-双亲委派模式","link":"#_5-3-双亲委派模式","children":[]},{"level":3,"title":"5.4 自定义类加载器","slug":"_5-4-自定义类加载器","link":"#_5-4-自定义类加载器","children":[]},{"level":3,"title":"5.5 线程上下文类加载器","slug":"_5-5-线程上下文类加载器","link":"#_5-5-线程上下文类加载器","children":[]}]},{"level":2,"title":"6、运行期优化","slug":"_6、运行期优化","link":"#_6、运行期优化","children":[{"level":3,"title":"6.1 即时编译","slug":"_6-1-即时编译","link":"#_6-1-即时编译","children":[]},{"level":3,"title":"6.2 反射优化","slug":"_6-2-反射优化","link":"#_6-2-反射优化","children":[]}]},{"level":2,"title":"1. 原子性","slug":"_1-原子性","link":"#_1-原子性","children":[{"level":3,"title":"1-1 问题解析","slug":"_1-1-问题解析","link":"#_1-1-问题解析","children":[]},{"level":3,"title":"1-2 解决方法 -加锁","slug":"_1-2-解决方法-加锁","link":"#_1-2-解决方法-加锁","children":[]}]},{"level":2,"title":"2.可见性","slug":"_2-可见性","link":"#_2-可见性","children":[{"level":3,"title":"2-3 可见性","slug":"_2-3-可见性","link":"#_2-3-可见性","children":[]}]}],"git":{"createdTime":1721001506000,"updatedTime":1722847687000,"contributors":[{"name":"reniunai","email":"2843768@qq.com","commits":1}]},"readingTime":{"minutes":104.48,"words":31344},"filePathRelative":"note/java/jvmed.md","localizedDate":"2024年7月15日","excerpt":"<p>Java 虚拟机</p>\\n","autoDesc":true}');export{d as comp,C as data};
