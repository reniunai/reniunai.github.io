import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,d as l,a as s,e,o as p}from"./app-CfDCVS1X.js";const o={},i=s("h1",{id:"canal解决mysql和redis数据同步-tcp",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#canal解决mysql和redis数据同步-tcp"},[s("span",null,"Canal解决Mysql和Redis数据同步(TCP)")])],-1),c=e(`<ol><li>首选需要开启Mysql的bin-log</li><li>然后需要安装canal-server伪装成slave同步mysql中的数据</li><li>编写canal-client客户端监听canal-server，把数据从canal-server中同步过来</li><li>然后把拿到的数据写入Redis即可</li></ol><h2 id="开启mysql-bin-log日志" tabindex="-1"><a class="header-anchor" href="#开启mysql-bin-log日志"><span>开启Mysql bin-log日志</span></a></h2><p>找到Mysql安装目录中的my.ini 配置文件，我以mysql 5.5为例,在 mysqld 下做如下配置</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171226628.png" alt="image-20240717073638153" tabindex="0" loading="lazy"><figcaption>image-20240717073638153</figcaption></figure><div class="language-mysql line-numbers-mode" data-highlighter="shiki" data-ext="mysql" data-title="mysql" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>[mysqld]</span></span>
<span class="line"><span>#开启bInlog</span></span>
<span class="line"><span>log-bin=mysql-bin</span></span>
<span class="line"><span>#给mysql服务指定一个唯一的ID</span></span>
<span class="line"><span>server-id=1</span></span>
<span class="line"><span>#以数据的方式写binlog日志 ：statement 是记录SQL，row是记录数据</span></span>
<span class="line"><span>binlog-format=ROW</span></span>
<span class="line"><span>#同步的数据库名</span></span>
<span class="line"><span>#binlog-do-db=canaldb</span></span>
<span class="line"><span>#忽略的表</span></span>
<span class="line"><span>binlog-ignore-db=mysql</span></span>
<span class="line"><span># 启动mysql时不启动grant-tables授权表</span></span>
<span class="line"><span>skip-grant-tables</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改好之后，重启Mysql服务。注意：我这里指定了需要同步的数据库为canaldb，所以需要创建一个数据库，同时创建了一个employee表作为演示 <img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171219517.png" alt="在这里插入图片描述" loading="lazy"> 然后创建一个用户提供给canal来链接Mysql做数据同步</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">flush privileges;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">#创建用户cannal</span></span>
<span class="line"><span style="color:#81A1C1;">CREATE</span><span style="color:#81A1C1;"> USER</span><span style="color:#88C0D0;"> canal</span><span style="color:#D8DEE9FF;"> IDENTIFIED </span><span style="color:#81A1C1;">BY</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">canal</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">#把所有权限赋予canal，密码也是canal</span></span>
<span class="line"><span style="color:#81A1C1;">GRANT</span><span style="color:#D8DEE9FF;"> ALL PRIVILEGES </span><span style="color:#81A1C1;">ON</span><span style="color:#D8DEE9FF;"> canaldb.user </span><span style="color:#81A1C1;">TO</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">canal</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">@</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">%</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;"> identified </span><span style="color:#81A1C1;">by</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">canal</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">;</span></span>
<span class="line"><span style="color:#81A1C1;">//GRANT</span><span style="color:#81A1C1;"> SELECT</span><span style="color:#D8DEE9FF;">, REPLICATION SLAVE, REPLICATION CLIENT </span><span style="color:#81A1C1;">ON</span><span style="color:#81A1C1;"> *</span><span style="color:#D8DEE9FF;">.</span><span style="color:#81A1C1;">*</span><span style="color:#81A1C1;"> TO</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">canal</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">@</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">%</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;"> identified </span><span style="color:#81A1C1;">by</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">canal</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">#刷新权限</span></span>
<span class="line"><span style="color:#D8DEE9FF;">flush privileges;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>到这，Mysql部分就搞定了</p><h2 id="安装canal" tabindex="-1"><a class="header-anchor" href="#安装canal"><span>安装Canal</span></a></h2><p>去官网下载 Canal : https://github.com/alibaba/canal/releases ，我使用的是canal.deployer-1.1.5.tar.gz版本<img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171219494.png" alt="在这里插入图片描述" loading="lazy"></p><p>下载好之后解压，目录结构如下 <img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171219510.png" alt="在这里插入图片描述" loading="lazy"> 接下来修改instance 配置文件 ： conf/example/instance.properties</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">#  按需修改成自己的数据库信息</span></span>
<span class="line"><span style="color:#D8DEE9FF;">#################################################</span></span>
<span class="line"><span style="color:#D8DEE9FF;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">#我的端口是3307</span></span>
<span class="line"><span style="color:#D8DEE9FF;">canal.instance.master.address</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">192</span><span style="color:#D8DEE9FF;">.</span><span style="color:#B48EAD;">168</span><span style="color:#D8DEE9FF;">.</span><span style="color:#B48EAD;">1</span><span style="color:#D8DEE9FF;">.</span><span style="color:#B48EAD;">20</span><span style="color:#D8DEE9FF;">:</span><span style="color:#B48EAD;">3307</span></span>
<span class="line"><span style="color:#D8DEE9FF;"># username</span><span style="color:#81A1C1;">/password</span><span style="color:#D8DEE9FF;">,数据库的用户名和密码</span></span>
<span class="line"><span style="color:#D8DEE9FF;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">#刚才开通的mysql的账户密码</span></span>
<span class="line"><span style="color:#D8DEE9FF;">canal.instance.dbUsername </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> canal</span></span>
<span class="line"><span style="color:#D8DEE9FF;">canal.instance.dbPassword </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> canal</span></span>
<span class="line"><span style="color:#D8DEE9FF;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;"># 同步的表的规则</span></span>
<span class="line"><span style="color:#D8DEE9FF;"># </span><span style="color:#81A1C1;">table</span><span style="color:#D8DEE9FF;"> regex</span></span>
<span class="line"><span style="color:#D8DEE9FF;"># 同步所有表</span></span>
<span class="line"><span style="color:#D8DEE9FF;">#canal.instance.filter.regex</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;">.</span><span style="color:#81A1C1;">*</span><span style="color:#D8DEE9FF;">\\\\..</span><span style="color:#81A1C1;">*</span></span>
<span class="line"><span style="color:#D8DEE9FF;"># 同步多个表，用逗号隔开</span></span>
<span class="line"><span style="color:#D8DEE9FF;">canal.instance.filter.regex</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;">canaldb.employee,canaldb.dept</span></span>
<span class="line"><span style="color:#D8DEE9FF;">#################################################</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">...省略...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里注意如下几个东西，其他的不用管</p><ul><li>master.address ：Mysql的地址，我的端口是3307，默认是3306</li><li>dbUsername ：上面开通的Mysql用户</li><li>dbPassword ： 密码</li><li>ccanal.instance.filter.regex ： 要同步的表，多个表用逗号隔开</li></ul><p>接着修改canal 配置文件 conf/canal.properties</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;"># ...</span></span>
<span class="line"><span style="color:#D8DEE9FF;"># 可选项: </span><span style="color:#81A1C1;">tcp</span><span style="color:#D8DEE9FF;">(默认), kafka, RocketMQ</span></span>
<span class="line"><span style="color:#D8DEE9FF;"># 这里使用tcp , 还支持kafka和rocketmq</span></span>
<span class="line"><span style="color:#D8DEE9FF;">canal.serverMode </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> tcp</span></span>
<span class="line"><span style="color:#D8DEE9FF;">...省略...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里需要注意 : canal.serverMode = tcp： 我这里以tcp为例,指的是以tcp协议把数据同步数据，而不是同步到mq</p><p>配置好之后，找到 canal 安装目录下 bin目录下的 startup.bat 双击启动，linux上启动：startup.sh <img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171219557.png" alt="在这里插入图片描述" loading="lazy"></p><h2 id="编写canal-client" tabindex="-1"><a class="header-anchor" href="#编写canal-client"><span>编写canal-client</span></a></h2><p>接下来我们需要在项目中整合canal-client来同步canal-server中的数据，然后写入Redis</p><p>第一步：导入如下依赖，我这里使用了 <code>canal-spring-boot-starter</code> 来整合canal-client</p><div class="language-xml line-numbers-mode" data-highlighter="shiki" data-ext="xml" data-title="xml" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">&lt;parent&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;groupId&gt;</span><span style="color:#D8DEE9FF;">org.springframework.boot</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">spring-boot-starter-parent</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;version&gt;</span><span style="color:#D8DEE9FF;">2.2.5.RELEASE</span><span style="color:#81A1C1;">&lt;/version&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;/parent&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;dependencies&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">            &lt;groupId&gt;</span><span style="color:#D8DEE9FF;">org.projectlombok</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">            &lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">lombok</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">            &lt;optional&gt;</span><span style="color:#D8DEE9FF;">true</span><span style="color:#81A1C1;">&lt;/optional&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;/dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">            &lt;groupId&gt;</span><span style="color:#D8DEE9FF;">org.springframework.boot</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">            &lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">spring-boot-starter-web</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;/dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">            &lt;groupId&gt;</span><span style="color:#D8DEE9FF;">org.springframework.boot</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">            &lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">spring-boot-starter-test</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;/dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">            &lt;groupId&gt;</span><span style="color:#D8DEE9FF;">org.springframework.boot</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">            &lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">spring-boot-starter-data-redis</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;/dependency&gt;</span></span>
<span class="line"><span style="color:#616E88;">        &lt;!--Canal 依赖--&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">            &lt;groupId&gt;</span><span style="color:#D8DEE9FF;">top.javatool</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">            &lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">canal-spring-boot-starter</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">            &lt;version&gt;</span><span style="color:#D8DEE9FF;">1.2.1-RELEASE</span><span style="color:#81A1C1;">&lt;/version&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;/dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">            &lt;groupId&gt;</span><span style="color:#D8DEE9FF;">com.alibaba</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">            &lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">fastjson</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">            &lt;version&gt;</span><span style="color:#D8DEE9FF;">1.2.50</span><span style="color:#81A1C1;">&lt;/version&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;/dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;/dependencies&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第二步：在yaml配置canal地址，以及Redis相关参数</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" data-title="yaml" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#8FBCBB;">canal</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#8FBCBB;">  server</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> 127.0.0.1:11111</span><span style="color:#616E88;"> #canal的地址</span></span>
<span class="line"><span style="color:#8FBCBB;">  destination</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> example</span><span style="color:#616E88;"> #默认的数据同步的目的地</span></span>
<span class="line"><span style="color:#8FBCBB;">spring</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#8FBCBB;">  redis</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#8FBCBB;">    host</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 127.0.0.1</span></span>
<span class="line"><span style="color:#8FBCBB;">    password</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 123456</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编写启动类</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">SpringBootApplication</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> CanalApplication</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> main</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">[]</span><span style="color:#D8DEE9;"> args</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        SpringApplication</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">run</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">CanalApplication</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">class</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;">args</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第三步：对Redis做配置，实现自动序列化</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">//缓存的配置</span></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Configuration</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> RedisConfig</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Resource</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#8FBCBB;"> RedisConnectionFactory</span><span style="color:#D8DEE9;"> factory</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    //使用JSON进行序列化</span></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Bean</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#8FBCBB;"> RedisTemplate</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">Object</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> Object</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#88C0D0;"> redisTemplate</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        RedisTemplate</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">Object</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> Object</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> redisTemplate</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> RedisTemplate</span><span style="color:#ECEFF4;">&lt;&gt;()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">        redisTemplate</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setConnectionFactory</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">factory</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        //JSON格式序列化</span></span>
<span class="line"><span style="color:#8FBCBB;">        GenericFastJsonRedisSerializer</span><span style="color:#D8DEE9;"> serializer</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> GenericFastJsonRedisSerializer</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">         //key的序列化</span></span>
<span class="line"><span style="color:#D8DEE9;">        redisTemplate</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setKeySerializer</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">serializer</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        //value的序列化</span></span>
<span class="line"><span style="color:#D8DEE9;">        redisTemplate</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setValueSerializer</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">serializer</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        //hash结构key的虚拟化</span></span>
<span class="line"><span style="color:#D8DEE9;">        redisTemplate</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setHashKeySerializer</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> StringRedisSerializer</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        //hash结构value的虚拟化</span></span>
<span class="line"><span style="color:#D8DEE9;">        redisTemplate</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setHashValueSerializer</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">serializer</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#D8DEE9FF;"> redisTemplate</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第四步：编写实体类，对应要同步的数据库的表</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Data</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> Employee</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#8FBCBB;"> Long</span><span style="color:#D8DEE9;"> id</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#8FBCBB;"> String</span><span style="color:#D8DEE9;"> username</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第五步：编写数据同步处理器，canal-client提供了EntryHandler，该handler中提供了insert,delete,update方法，当监听到某张表的相关操作后，会回调对应的方法把数据传递进来，我们就可以拿到数据往Redis同步了。</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">CanalTable</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">employee</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Component</span></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Slf4j</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> EmployeeHandler</span><span style="color:#81A1C1;"> implements</span><span style="color:#8FBCBB;font-weight:bold;"> EntryHandler</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">Employee</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">	//把数据往Redis同步</span></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Autowired</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#8FBCBB;"> RedisTemplate</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">Object</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;">Object</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> redisTemplate</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> insert</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">Employee</span><span style="color:#D8DEE9;"> employee</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        redisTemplate</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">opsForValue</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">set</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">EMP:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">+</span><span style="color:#D8DEE9;">employee</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getId</span><span style="color:#ECEFF4;">(),</span><span style="color:#D8DEE9FF;">employee</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> delete</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">Employee</span><span style="color:#D8DEE9;"> employee</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        redisTemplate</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">delete</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">EMP:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">+</span><span style="color:#D8DEE9;">employee</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getId</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> update</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">Employee</span><span style="color:#D8DEE9;"> before</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> Employee</span><span style="color:#D8DEE9;"> after</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        redisTemplate</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">opsForValue</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">set</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">EMP:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">+</span><span style="color:#D8DEE9;">after</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getId</span><span style="color:#ECEFF4;">(),</span><span style="color:#D8DEE9FF;">after</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>@CanalTable(“employee”) ：监听的表</li><li><code>EntryHandler&lt;Employee&gt;</code> ： 拿到employee表的改变后的数据之后，会封装为Employee实体 投递给我们</li></ul><p>到这里代码就编写完成了，启动程序可以从控制台看到canal-client在不同尝试获取数据</p><p><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171219564.png" alt="在这里插入图片描述" loading="lazy"> 启动redis后， 尝试手动修改数据库 employee表中的数据，然后实例redis-cli 查看 数据，下面是表中的数据</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171219416.png" alt="在这里插入图片描述" tabindex="0" loading="lazy"><figcaption>在这里插入图片描述</figcaption></figure><p>下面是redis中的数据</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171219228.png" alt="在这里插入图片描述" tabindex="0" loading="lazy"><figcaption>在这里插入图片描述</figcaption></figure><pre><code>版权声明：本文为博主原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接和本声明。
</code></pre><p>原文链接：https://blog.csdn.net/u014494148/article/details/126433498</p>`,40);function t(r,d){return p(),a("div",null,[i,l(" more "),c])}const F=n(o,[["render",t],["__file","11. Canal解决Mysql和Redis数据同步(TCP).html.vue"]]),v=JSON.parse('{"path":"/note/redis/11.%20Canal%E8%A7%A3%E5%86%B3Mysql%E5%92%8CRedis%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5(TCP).html","title":"Canal解决Mysql和Redis数据同步(TCP)","lang":"zh-CN","frontmatter":{"title":"Canal解决Mysql和Redis数据同步(TCP)","cover":"/assets/images/cover1.jpg","icon":"file","order":11,"author":"HotMilk","category":["Redis"],"tag":["Redis","Canal","数据同步"],"head":[["meta",{"property":"og:url","content":"https://reniunai.github.io/note/redis/11.%20Canal%E8%A7%A3%E5%86%B3Mysql%E5%92%8CRedis%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5(TCP).html"}],["meta",{"property":"og:site_name","content":"热牛奶"}],["meta",{"property":"og:title","content":"Canal解决Mysql和Redis数据同步(TCP)"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://reniunai.github.io/assets/images/cover1.jpg"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-08-05T09:42:18.000Z"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://reniunai.github.io/assets/images/cover1.jpg"}],["meta",{"name":"twitter:image:alt","content":"Canal解决Mysql和Redis数据同步(TCP)"}],["meta",{"property":"article:author","content":"HotMilk"}],["meta",{"property":"article:tag","content":"Redis"}],["meta",{"property":"article:tag","content":"Canal"}],["meta",{"property":"article:tag","content":"数据同步"}],["meta",{"property":"article:modified_time","content":"2024-08-05T09:42:18.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Canal解决Mysql和Redis数据同步(TCP)\\",\\"image\\":[\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171226628.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171219517.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171219494.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171219510.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171219557.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171219564.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171219416.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171219228.png\\"],\\"dateModified\\":\\"2024-08-05T09:42:18.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"HotMilk\\"}]}"]]},"headers":[{"level":2,"title":"开启Mysql bin-log日志","slug":"开启mysql-bin-log日志","link":"#开启mysql-bin-log日志","children":[]},{"level":2,"title":"安装Canal","slug":"安装canal","link":"#安装canal","children":[]},{"level":2,"title":"编写canal-client","slug":"编写canal-client","link":"#编写canal-client","children":[]}],"git":{"createdTime":1722847687000,"updatedTime":1722850938000,"contributors":[{"name":"reniunai","email":"2843768@qq.com","commits":2}]},"readingTime":{"minutes":5.04,"words":1513},"filePathRelative":"note/redis/11. Canal解决Mysql和Redis数据同步(TCP).md","localizedDate":"2024年8月5日","excerpt":"\\n"}');export{F as comp,v as data};
