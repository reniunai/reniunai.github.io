import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,d as l,a as s,e,o as p}from"./app-zamys2Ga.js";const o={},c=s("h1",{id:"canal解决mysql和redis数据同步-mq",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#canal解决mysql和redis数据同步-mq"},[s("span",null,"Canal解决Mysql和Redis数据同步(MQ)")])],-1),i=e(`<h3 id="mysql-和-elasticsearch-数据同步方案" tabindex="-1"><a class="header-anchor" href="#mysql-和-elasticsearch-数据同步方案"><span>Mysql 和 ElasticSearch 数据同步方案</span></a></h3><p>根据上面所说，我们就可以通过Canal去自动同步数据库的binlog数据日志文件，然后再把数据同步到ElasticSearch。Canal支持把数据同步到的组件有 ： mysql、Kafka、ElasticSearch、Hbase、RocketMQ等 <img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303778.png" alt="在这里插入图片描述" loading="lazy"></p><p>和上一章节讲的Redis的同步流程不一样，因为Canal可以直接同步到ElasticSearch，只不过需要安装CanalAdapter来实现，流程如下 <img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303860.png" alt="在这里插入图片描述" loading="lazy"></p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171502584.png" alt="image-20240717150210528" tabindex="0" loading="lazy"><figcaption>image-20240717150210528</figcaption></figure><h3 id="开启mysql-bin-log日志" tabindex="-1"><a class="header-anchor" href="#开启mysql-bin-log日志"><span>开启Mysql bin-log日志</span></a></h3><p>找到Mysql安装目录中的my.ini 配置文件，我以mysql 5.5为例,在 mysqld 下做如下配置</p><div class="language-ini line-numbers-mode" data-highlighter="shiki" data-ext="ini" data-title="ini" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9FF;">mysqld</span><span style="color:#ECEFF4;">]</span></span>
<span class="line"><span style="color:#616E88;">#开启bInlog</span></span>
<span class="line"><span style="color:#81A1C1;">log-bin</span><span style="color:#ECEFF4;">=</span><span style="color:#D8DEE9FF;">mysql-bin</span></span>
<span class="line"><span style="color:#616E88;">#给mysql服务指定一个唯一的ID</span></span>
<span class="line"><span style="color:#81A1C1;">server-id</span><span style="color:#ECEFF4;">=</span><span style="color:#D8DEE9FF;">1</span></span>
<span class="line"><span style="color:#616E88;">#以数据的方式写binlog日志 ：statement 是记录SQL，row是记录数据</span></span>
<span class="line"><span style="color:#81A1C1;">binlog-format</span><span style="color:#ECEFF4;">=</span><span style="color:#D8DEE9FF;">ROW</span></span>
<span class="line"><span style="color:#616E88;">#同步的数据库名</span></span>
<span class="line"><span style="color:#81A1C1;">binlog-do-db</span><span style="color:#ECEFF4;">=</span><span style="color:#D8DEE9FF;">canaldb</span></span>
<span class="line"><span style="color:#616E88;">#忽略的表</span></span>
<span class="line"><span style="color:#81A1C1;">binlog-ignore-db</span><span style="color:#ECEFF4;">=</span><span style="color:#D8DEE9FF;">mysql</span></span>
<span class="line"><span style="color:#616E88;"># 启动mysql时不启动grant-tables授权表</span></span>
<span class="line"><span style="color:#D8DEE9FF;">skip-grant-tables</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改好之后，重启Mysql服务。注意：我这里指定了需要同步的数据库为canaldb，所以需要创建一个数据库，同时创建了一个employee表作为演示 <img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303743.png" alt="在这里插入图片描述" loading="lazy"> 然后创建一个用户提供给canal来链接Mysql做数据同步</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">flush privileges;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">#创建用户cannal</span></span>
<span class="line"><span style="color:#81A1C1;">CREATE</span><span style="color:#81A1C1;"> USER</span><span style="color:#88C0D0;"> canal</span><span style="color:#D8DEE9FF;"> IDENTIFIED </span><span style="color:#81A1C1;">BY</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">canal</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">#把所有权限赋予canal，密码也是canal</span></span>
<span class="line"><span style="color:#81A1C1;">GRANT</span><span style="color:#D8DEE9FF;"> ALL PRIVILEGES </span><span style="color:#81A1C1;">ON</span><span style="color:#D8DEE9FF;"> canaldb.user </span><span style="color:#81A1C1;">TO</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">canal</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">@</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">%</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;"> identified </span><span style="color:#81A1C1;">by</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">canal</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">;</span></span>
<span class="line"><span style="color:#81A1C1;">//GRANT</span><span style="color:#81A1C1;"> SELECT</span><span style="color:#D8DEE9FF;">, REPLICATION SLAVE, REPLICATION CLIENT </span><span style="color:#81A1C1;">ON</span><span style="color:#81A1C1;"> *</span><span style="color:#D8DEE9FF;">.</span><span style="color:#81A1C1;">*</span><span style="color:#81A1C1;"> TO</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">canal</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">@</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">%</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;"> identified </span><span style="color:#81A1C1;">by</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">canal</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">#刷新权限</span></span>
<span class="line"><span style="color:#D8DEE9FF;">flush privileges;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>到这，Mysql部分就搞定了</p><h3 id="安装canal" tabindex="-1"><a class="header-anchor" href="#安装canal"><span>安装Canal</span></a></h3><p>去官网下载 Canal : https://github.com/alibaba/canal/releases ，我使用的是canal.deployer-1.1.5.tar.gz版本<img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303740.png" alt="在这里插入图片描述" loading="lazy"></p><p>下载好之后解压，目录结构如下 <img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303699.png" alt="在这里插入图片描述" loading="lazy"> 接下来修改instance 配置文件 ： conf/example/instance.properties</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">#  按需修改成自己的数据库信息</span></span>
<span class="line"><span style="color:#D8DEE9FF;">#################################################</span></span>
<span class="line"><span style="color:#D8DEE9FF;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">#我的端口是3307</span></span>
<span class="line"><span style="color:#D8DEE9FF;">canal.instance.master.address</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">192</span><span style="color:#D8DEE9FF;">.</span><span style="color:#B48EAD;">168</span><span style="color:#D8DEE9FF;">.</span><span style="color:#B48EAD;">1</span><span style="color:#D8DEE9FF;">.</span><span style="color:#B48EAD;">20</span><span style="color:#D8DEE9FF;">:</span><span style="color:#B48EAD;">3307</span></span>
<span class="line"><span style="color:#D8DEE9FF;"># username</span><span style="color:#81A1C1;">/password</span><span style="color:#D8DEE9FF;">,数据库的用户名和密码</span></span>
<span class="line"><span style="color:#D8DEE9FF;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">#刚才开通的mysql的账户密码</span></span>
<span class="line"><span style="color:#D8DEE9FF;">canal.instance.dbUsername </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> canal</span></span>
<span class="line"><span style="color:#D8DEE9FF;">canal.instance.dbPassword </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> canal</span></span>
<span class="line"><span style="color:#D8DEE9FF;">...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">#################################################</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;"># mq config 数据同步到MQ中的topic名字</span></span>
<span class="line"><span style="color:#D8DEE9FF;">canal.mq.topic</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;">example</span></span>
<span class="line"><span style="color:#D8DEE9FF;"># 针对库名或者表名发送动态topic</span></span>
<span class="line"><span style="color:#D8DEE9FF;">#canal.mq.dynamicTopic</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;">mytest,.</span><span style="color:#81A1C1;">*</span><span style="color:#D8DEE9FF;">,mytest.user,mytest\\\\..</span><span style="color:#81A1C1;">*</span><span style="color:#D8DEE9FF;">,.</span><span style="color:#81A1C1;">*</span><span style="color:#D8DEE9FF;">\\\\..</span><span style="color:#81A1C1;">*</span></span>
<span class="line"><span style="color:#D8DEE9FF;">canal.mq.</span><span style="color:#81A1C1;">partition=</span><span style="color:#B48EAD;">0</span></span>
<span class="line"><span style="color:#D8DEE9FF;"># </span><span style="color:#81A1C1;">hash</span><span style="color:#81A1C1;"> partition</span><span style="color:#D8DEE9FF;"> config</span></span>
<span class="line"><span style="color:#D8DEE9FF;">#canal.mq.partitionsNum</span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;">3</span></span>
<span class="line"><span style="color:#D8DEE9FF;">#库名.表名: 唯一主键，多个表之间用逗号分隔</span></span>
<span class="line"><span style="color:#D8DEE9FF;">#canal.mq.partitionHash</span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;">mytest.person:id,mytest.role:id</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里注意如下几个东西，其他的不用管</p><ul><li>master.address ：Mysql的地址，我的端口是3307，默认是3306</li><li>dbUsername ：上面开通的Mysql用户</li><li>dbPassword ： 密码</li><li>canal.mq.topic=example ： 数据同步到MQ中的topic名字</li></ul><p>接着修改canal 配置文件 conf/canal.properties</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;"># ...</span></span>
<span class="line"><span style="color:#D8DEE9FF;"># 可选项: </span><span style="color:#81A1C1;">tcp</span><span style="color:#D8DEE9FF;">(默认), kafka, RocketMQ</span></span>
<span class="line"><span style="color:#D8DEE9FF;"># 这里使用tcp</span></span>
<span class="line"><span style="color:#D8DEE9FF;">canal.serverMode </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> tcp</span></span>
<span class="line"><span style="color:#D8DEE9FF;"># ...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">##################################################</span></span>
<span class="line"><span style="color:#D8DEE9FF;">######### 		    RocketMQ	     #############</span></span>
<span class="line"><span style="color:#D8DEE9FF;">##################################################</span></span>
<span class="line"><span style="color:#D8DEE9FF;">rocketmq.producer.group </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> test</span></span>
<span class="line"><span style="color:#D8DEE9FF;">rocketmq.enable.message.trace </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> false</span></span>
<span class="line"><span style="color:#D8DEE9FF;">rocketmq.customized.trace.topic </span><span style="color:#81A1C1;">=</span></span>
<span class="line"><span style="color:#D8DEE9FF;">rocketmq.namespace </span><span style="color:#81A1C1;">=</span></span>
<span class="line"><span style="color:#D8DEE9FF;"># RocketMQ的地址</span></span>
<span class="line"><span style="color:#D8DEE9FF;">rocketmq.namesrv.addr </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 127</span><span style="color:#D8DEE9FF;">.</span><span style="color:#B48EAD;">0</span><span style="color:#D8DEE9FF;">.</span><span style="color:#B48EAD;">0</span><span style="color:#D8DEE9FF;">.</span><span style="color:#B48EAD;">1</span><span style="color:#D8DEE9FF;">:</span><span style="color:#B48EAD;">9876</span></span>
<span class="line"><span style="color:#D8DEE9FF;">rocketmq.retry.</span><span style="color:#81A1C1;">times</span><span style="color:#D8DEE9FF;">.when.send.failed </span><span style="color:#81A1C1;">=</span><span style="color:#B48EAD;"> 0</span></span>
<span class="line"><span style="color:#D8DEE9FF;">rocketmq.vip.channel.enabled </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> false</span></span>
<span class="line"><span style="color:#D8DEE9FF;">rocketmq.tag </span><span style="color:#81A1C1;">=</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里需要注意：canal.serverMode = tcp ： 注意这里是tcp，tcp指的是直接同步到客户端。和上一章节Redis同步还是有点区别，上一章节我们是同步到RocketMQ</p><p>配置好之后，找到 canal 安装目录下 bin目录下的 <code>bin/startup.bat</code> 双击启动，linux上启动：bin/startup.sh <img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303800.png" alt="在这里插入图片描述" loading="lazy"></p><h3 id="安装-canal-adapter" tabindex="-1"><a class="header-anchor" href="#安装-canal-adapter"><span>安装 canal-adapter</span></a></h3><p>去官网下载 Canal-adapter : https://github.com/alibaba/canal/releases ，我使用的是canal.adapter-1.1.5.tar.gz 版本 <img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303408.png" alt="在这里插入图片描述" loading="lazy"></p><p>下载好之后解压，目录如下 <img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303413.png" alt="在这里插入图片描述" loading="lazy"> 进入到config目录，修改 config/application.yml 文件 <img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303787.png" alt="在这里插入图片描述" loading="lazy"> 修改内容如下</p><div class="language-yml line-numbers-mode" data-highlighter="shiki" data-ext="yml" data-title="yml" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">...</span><span style="color:#A3BE8C;">省略...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8FBCBB;">canal.conf</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#8FBCBB;">  mode</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> tcp</span><span style="color:#616E88;"> #tcp kafka rocketMQ rabbitMQ</span></span>
<span class="line"><span style="color:#A3BE8C;">  ...省略...</span></span>
<span class="line"><span style="color:#8FBCBB;">  consumerProperties</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#616E88;">    # canal tcp consumer</span></span>
<span class="line"><span style="color:#8FBCBB;">    canal.tcp.server.host</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> 127.0.0.1:11111</span><span style="color:#616E88;"> #canal的地址</span></span>
<span class="line"><span style="color:#A3BE8C;">   ...省略...</span></span>
<span class="line"><span style="color:#8FBCBB;">  srcDataSources</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#8FBCBB;">    defaultDS</span><span style="color:#ECEFF4;">:</span><span style="color:#616E88;"> #同步的数据库，账号，密码，修改为自己的数据库信息</span></span>
<span class="line"><span style="color:#8FBCBB;">      url</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> jdbc:mysql://127.0.0.1:3307/canaldb?useUnicode=true</span></span>
<span class="line"><span style="color:#8FBCBB;">      username</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> root</span></span>
<span class="line"><span style="color:#8FBCBB;">      password</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> admin</span></span>
<span class="line"><span style="color:#8FBCBB;">  canalAdapters</span><span style="color:#ECEFF4;">:</span><span style="color:#616E88;"> #adapter配置</span></span>
<span class="line"><span style="color:#ECEFF4;">  -</span><span style="color:#8FBCBB;"> instance</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> example</span><span style="color:#616E88;"> # canal instance Name or mq topic name</span></span>
<span class="line"><span style="color:#8FBCBB;">    groups</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#ECEFF4;">    -</span><span style="color:#8FBCBB;"> groupId</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> g1</span></span>
<span class="line"><span style="color:#8FBCBB;">      outerAdapters</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#ECEFF4;">      -</span><span style="color:#8FBCBB;"> name</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> logger</span></span>
<span class="line"><span style="color:#ECEFF4;">      -</span><span style="color:#8FBCBB;"> name</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> es6</span><span style="color:#616E88;"> #es配置，这里使用9200通信 也就是rest模式</span></span>
<span class="line"><span style="color:#8FBCBB;">        hosts</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">http://127.0.0.1:9200</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#8FBCBB;">        properties</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#8FBCBB;">          mode</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> rest</span><span style="color:#616E88;"> # or rest</span></span>
<span class="line"><span style="color:#616E88;">#          # security.auth: test:123456 #  only used for rest mode</span></span>
<span class="line"><span style="color:#8FBCBB;">          cluster.name</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> elasticsearch</span><span style="color:#616E88;"> #集群名字</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面把要修改的内容展示出来了，其他的不用管，具体要修改的如下</p><ul><li>canal.tcp.server.host: 127.0.0.1:11111 ：这个需要指向canal地址</li><li>srcDataSources.defaultDS : 这个跟的是要同步的数据库，包括用户名密码要修改为自己的</li><li>outerAdapters ：代表数据向哪儿输出，我们配置的是ES6，- name ：es6因为我使用的是es6 , hosts使用的是es的9200端口，mode使用rest方式。也可以使用9300，transport模式</li></ul><p>然后进入es6目录，基于mytest_user.yml拷贝重命名一个employee.yml(对应要同步的数据库表),然后删除其他的yml文件</p><p><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303703.png" alt="在这里插入图片描述" loading="lazy"> employee.yml内容如下</p><div class="language-yml line-numbers-mode" data-highlighter="shiki" data-ext="yml" data-title="yml" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#8FBCBB;">dataSourceKey</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> defaultDS</span></span>
<span class="line"><span style="color:#8FBCBB;">destination</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> example</span></span>
<span class="line"><span style="color:#8FBCBB;">groupId</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> g1</span></span>
<span class="line"><span style="color:#8FBCBB;">esMapping</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#8FBCBB;">  _index</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> employee</span><span style="color:#616E88;"> #索引库名字</span></span>
<span class="line"><span style="color:#8FBCBB;">  _type</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> _doc</span><span style="color:#616E88;"> #es的type</span></span>
<span class="line"><span style="color:#8FBCBB;">  _id</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> _id</span><span style="color:#616E88;"> #id作为文档ID</span></span>
<span class="line"><span style="color:#8FBCBB;">  upsert</span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> true</span></span>
<span class="line"><span style="color:#616E88;">  #pk: id # 如果不需要_id, 则需要指定一个属性为主键属性</span></span>
<span class="line"><span style="color:#616E88;">  #sql映射 ，把列名和es进行一一映射    _id 会作为文档ID</span></span>
<span class="line"><span style="color:#8FBCBB;">  sql</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">select id _id,username from employee</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#616E88;">#  objFields:</span></span>
<span class="line"><span style="color:#616E88;">#    _labels: array:;</span></span>
<span class="line"><span style="color:#8FBCBB;">  etlCondition</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">where a.c_time&gt;={}</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#8FBCBB;">  commitBatch</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 3000</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>几个需要修改的参数</p><ul><li>_index: employee #索引库名字</li><li>_type: _doc #es的type</li><li>_id: _id #id作为文档ID</li><li>sql : sql映射 ，根据查询的列名和es的field进行一一映射 ， 支持join连表查询</li></ul><p>到这Canal的配置完成了，启动 canal-adapapter : <code>bin/startup.bat</code> 但是我在启动的时候出现了一个问题 <img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303918.png" alt="在这里插入图片描述" loading="lazy"> 这个是因为Canal中的druid包和 canal.adapter\\plugin\\client-adapter.es6x-1.1.5-jar-with-dependencies.jar 包中的druid冲突了，我的做法是这样的</p><p>1.下载canal源码：https://github.com/alibaba/canal/tree/canal-1.1.5 <img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303951.png" alt="在这里插入图片描述" loading="lazy"></p><p>2.使用IDEA打开项目，找到 escore模块，修改pom.xml中druid增加scope如下</p><div class="language-xml line-numbers-mode" data-highlighter="shiki" data-ext="xml" data-title="xml" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">	&lt;dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">      &lt;groupId&gt;</span><span style="color:#D8DEE9FF;">com.alibaba</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">druid</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;scope&gt;</span><span style="color:#D8DEE9FF;">provided</span><span style="color:#81A1C1;">&lt;/scope&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;/dependency&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3.使用mvn install 重新打包 es6x 模块，然后再target中得到 client-adapter.es6x-1.1.5-jar-with-dependencies.jar</p><p>4.把 client-adapter.es6x-1.1.5-jar-with-dependencies.jar 拷贝到canal-adapter安装目录的plugin目录中，覆盖原本的client-adapter.es6x-1.1.5-jar-with-dependencies.jar。</p><p>下面我提供一份打包好的 <a href="https://download.csdn.net/download/u014494148/84348026" target="_blank" rel="noopener noreferrer">client-adapter.es6x-1.1.5-jar-with-dependencies.jar</a> ，您直接下载即可</p><p>5.依次启动canal ，canal-adpater <img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303210.png" alt="在这里插入图片描述" loading="lazy"></p><h3 id="es创建索引库和映射" tabindex="-1"><a class="header-anchor" href="#es创建索引库和映射"><span>ES创建索引库和映射</span></a></h3><p>启动ES6，启动kibana , 创建索引库和映射，注意：需要对应 canal-adapter配置的索引库</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">PUT employee</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">#创建映射</span></span>
<span class="line"><span style="color:#D8DEE9FF;">PUT employee/_doc/_mapping</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">_doc</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">properties</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">id</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">            &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">long</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">          },</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">username</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">            &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">text</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">            &quot;</span><span style="color:#8FBCBB;">analyzer</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">ik_smart</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">          }</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#B48EAD;">1234567891011121314151617</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后修改数据库employee表中的数据，然后使用<code>GET employee/_search</code> 观察ES中是否有数据同步 <img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303153.png" alt="在这里插入图片描述" loading="lazy"></p><p>文章到这就结束了，喜欢的话请给个好评，你的鼓励是我最大的动力，谢谢。</p>`,44);function t(r,d){return p(),a("div",null,[c,l(" more "),i])}const F=n(o,[["render",t],["__file","13. Canal解决Mysql和ES数据同步.html.vue"]]),m=JSON.parse('{"path":"/note/redis/13.%20Canal%E8%A7%A3%E5%86%B3Mysql%E5%92%8CES%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5.html","title":"Canal解决Mysql和Redis数据同步(MQ)","lang":"zh-CN","frontmatter":{"title":"Canal解决Mysql和Redis数据同步(MQ)","cover":"/assets/images/cover1.jpg","icon":"file","order":3,"author":"HotMilk","category":["Redis"],"tag":["Redis","Canal","数据同步","MQ"],"head":[["meta",{"property":"og:url","content":"https://reniunai.github.io/note/redis/13.%20Canal%E8%A7%A3%E5%86%B3Mysql%E5%92%8CES%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5.html"}],["meta",{"property":"og:site_name","content":"热牛奶"}],["meta",{"property":"og:title","content":"Canal解决Mysql和Redis数据同步(MQ)"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://reniunai.github.io/assets/images/cover1.jpg"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-08-05T08:48:07.000Z"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://reniunai.github.io/assets/images/cover1.jpg"}],["meta",{"name":"twitter:image:alt","content":"Canal解决Mysql和Redis数据同步(MQ)"}],["meta",{"property":"article:author","content":"HotMilk"}],["meta",{"property":"article:tag","content":"Redis"}],["meta",{"property":"article:tag","content":"Canal"}],["meta",{"property":"article:tag","content":"数据同步"}],["meta",{"property":"article:tag","content":"MQ"}],["meta",{"property":"article:modified_time","content":"2024-08-05T08:48:07.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Canal解决Mysql和Redis数据同步(MQ)\\",\\"image\\":[\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303778.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303860.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171502584.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303743.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303740.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303699.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303800.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303408.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303413.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303787.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303703.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303918.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303951.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303210.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407171303153.png\\"],\\"dateModified\\":\\"2024-08-05T08:48:07.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"HotMilk\\"}]}"]]},"headers":[{"level":3,"title":"Mysql 和 ElasticSearch 数据同步方案","slug":"mysql-和-elasticsearch-数据同步方案","link":"#mysql-和-elasticsearch-数据同步方案","children":[]},{"level":3,"title":"开启Mysql bin-log日志","slug":"开启mysql-bin-log日志","link":"#开启mysql-bin-log日志","children":[]},{"level":3,"title":"安装Canal","slug":"安装canal","link":"#安装canal","children":[]},{"level":3,"title":"安装 canal-adapter","slug":"安装-canal-adapter","link":"#安装-canal-adapter","children":[]},{"level":3,"title":"ES创建索引库和映射","slug":"es创建索引库和映射","link":"#es创建索引库和映射","children":[]}],"git":{"createdTime":1722847687000,"updatedTime":1722847687000,"contributors":[{"name":"reniunai","email":"2843768@qq.com","commits":1}]},"readingTime":{"minutes":6.28,"words":1883},"filePathRelative":"note/redis/13. Canal解决Mysql和ES数据同步.md","localizedDate":"2024年8月5日","excerpt":"\\n"}');export{F as comp,m as data};
