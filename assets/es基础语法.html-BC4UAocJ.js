import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as n,d as a,a as l,e as o,o as p}from"./app-zamys2Ga.js";const e={},t=l("p",null,"数据同步到Elasticsearch，同步写，异步写，中间件实现同步。",-1),c=o(`<h2 id="_4、初步检索" tabindex="-1"><a class="header-anchor" href="#_4、初步检索"><span>4、初步检索</span></a></h2><p><strong>1、_cat</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>GET /_cat/nodes：查看所有节点</span></span>
<span class="line"><span>GET /_cat/health：查看 es 健康状况</span></span>
<span class="line"><span>GET /_cat/master：查看主节点</span></span>
<span class="line"><span>GET /_cat/indices：查看所有索引 show databases;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2、索引一个文档（保存）</strong></p><p>保存一个数据，保存在哪个索引的哪个类型下，指定用哪个唯一标识PUT customer/external/1；在 customer 索引下的 external 类型下保存 1 号数据为</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span># # 在customer索引下的external类型下保存1号数据</span></span>
<span class="line"><span>PUT customer/external/1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>httpclinet</p><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">PUT</span><span style="color:#D8DEE9FF;"> http://59.110.106.16:9200/customer/external/1</span></span>
<span class="line"><span style="color:#81A1C1;">Content-Type:</span><span style="color:#A3BE8C;"> application/json</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">name</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">John Doe</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回数据</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">返回数据：</span></span>
<span class="line"><span style="color:#D8DEE9FF;">带有下划线开头的，称为元数据，反映了当前的基本信息。</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">_index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">customer</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> 表明该数据在哪个数据库下；</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">_type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">external</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> 表明该数据在哪个类型下；</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">_id</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">1</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;">  表明被保存数据的id；</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">_version</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;">  被保存数据的版本</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">result</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">created</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> 这里是创建了一条数据，如果重新put一条数据，则该状态会变为updated，并且版本号也会发生变化。</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">_shards</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">total</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">successful</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">failed</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 0</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">_seq_no</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">_primary_term</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 1</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>PUT 和 POST 都可以， POST 新增。如果不指定 id，会自动生成 id, 新增这个数据。指定 id 就会修改这个数据，并新增版本号 PUT 可以新增可以修改。PUT 必须指定 id；由于 PUT 需要指定 id，我们一般都用来做修改操作，不指定 id 会报错。</p></blockquote><p><strong>3、查询文档</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>GET customer/external/1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>httpclient</p><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">### GET request with a header</span></span>
<span class="line"><span style="color:#81A1C1;">GET</span><span style="color:#D8DEE9FF;"> http://59.110.106.16:9200/customer/external/1</span></span>
<span class="line"><span style="color:#81A1C1;">Accept:</span><span style="color:#A3BE8C;"> application/json</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回数据：</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">_index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">customer</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">_type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">external</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">_id</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">1</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">_version</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">_seq_no</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">,</span><span style="color:#616E88;"> //并发控制字段，每次更新都会+1，用来做乐观锁</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">_primary_term</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">,</span><span style="color:#616E88;">//同上，主分片重新分配，如重启，就会变化</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">found</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> true</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">_source</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#616E88;"> //存储的信息</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">name</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">John Doe</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>乐观锁用法：通过“<code>if_seq_no=1&amp;if_primary_term=1</code>”，当序列号匹配的时候，才进行修改，否则不修改。</p></blockquote><p>示例：</p><p>当seq_no=1&amp;primary_term=1时，就修改</p><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">###</span></span>
<span class="line"><span style="color:#81A1C1;">PUT</span><span style="color:#D8DEE9FF;"> http://59.110.106.16:9200/customer/external/1?if_seq_no=1&amp;if_primary_term=1</span></span>
<span class="line"><span style="color:#81A1C1;">Content-Type:</span><span style="color:#A3BE8C;"> application/json</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">name</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">John Doe</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改成功，修改之后seq_no变成2</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407231954667.png" alt="image-20211011134234874" tabindex="0" loading="lazy"><figcaption>image-20211011134234874</figcaption></figure><p>再次发送上面的请求，修改失败，乐观锁是生效</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407231954673.png" alt="image-20211011134451525" tabindex="0" loading="lazy"><figcaption>image-20211011134451525</figcaption></figure><p><strong>4、更新文档</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>POST customer/external/1/_update</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>   &quot;doc&quot;:{</span></span>
<span class="line"><span>       &quot;name&quot;: &quot;John Doew&quot;</span></span>
<span class="line"><span>   }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>或者</span></span>
<span class="line"><span>POST customer/external/1</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span></span></span>
<span class="line"><span>   &quot;name&quot;: &quot;John Doe2&quot;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>或者</span></span>
<span class="line"><span>PUT customer/external/1</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>   &quot;name&quot;: &quot;John Doe&quot;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><ul><li>注意带不带_update的语法不同</li><li>带_update会跟原数据对比，跟原来一样就什么都不做,version不增加。 应用场景：对于大并发查询，偶尔更新，带update；对比更新呢，重新计算分配规则</li><li>post不带_update,不会检查原数据,直接更新。 应用场景：对于大并发更新，不带update</li></ul></blockquote><p>发送之后，与元素据对比，发现相同，不做任何操作</p><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">POST</span><span style="color:#D8DEE9FF;"> http://59.110.106.16:9200/customer/external/1/_update</span></span>
<span class="line"><span style="color:#81A1C1;">Content-Type:</span><span style="color:#A3BE8C;"> application/json</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">doc</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:{</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">name</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">John</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>5、删除文档&amp;索引</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>DELETE customer/external/1</span></span>
<span class="line"><span>DELETE customer</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>注：elasticsearch并没有提供删除类型的操作，只提供了删除索引和文档的操作。</p></blockquote><p>删除id=1的数据</p><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">DELETE</span><span style="color:#D8DEE9FF;"> http://59.110.106.16:9200/customer/external/1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407231954684.png" alt="image-20211011140906175" tabindex="0" loading="lazy"><figcaption>image-20211011140906175</figcaption></figure><p>删除customer索引</p><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">DELETE</span><span style="color:#D8DEE9FF;"> http://59.110.106.16:9200/customer</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">响应</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">acknowledged</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> true</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>6、ES的批量操作——bulk</strong></p><p>用Kibana之中的Dev Tools</p><p>示例1:</p><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">POST</span><span style="color:#D8DEE9FF;"> customer/external/_bulk</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">{</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:{</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">_id</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">1</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">}}</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">name</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">John Doe</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">{</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:{</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">_id</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">2</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">}}</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">name</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Jane Doe</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>语法格式: 两行一组，第一行为操作，第二行为数据</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>{ action: { metadata }}\\n</span></span>
<span class="line"><span>{ request body}\\n</span></span>
<span class="line"><span></span></span>
<span class="line"><span>{ action: { metadata }}\\n</span></span>
<span class="line"><span>{ request body}\\n</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里的批量操作，当发生某一条执行发生失败时，其他的数据仍然能够接着执行，也就是说彼此之间是独立的。</p><blockquote><p>bulk API 以此按顺序执行所有的 action（动作）。如果一个单个的动作因任何原因而失败，它将继续处理它后面剩余的动作。当 bulk API 返回时，它将提供每个动作的状态（与发送的顺序相同），所以您可以检查是否一个指定的动作是不是失败了。</p></blockquote><p>返回数据</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">#! Deprecation: </span><span style="color:#ECEFF4;">[</span><span style="color:#D8DEE9;">types</span><span style="color:#D8DEE9;"> removal</span><span style="color:#ECEFF4;">]</span><span style="color:#D8DEE9FF;"> Specifying types in bulk requests is deprecated.</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">took</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 318</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;">  花费了多少ms</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">errors</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#81A1C1;"> false</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> 没有发生任何错误</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">items</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> [</span><span style="color:#D8DEE9;"> 每个数据的结果</span></span>
<span class="line"><span style="color:#ECEFF4;">    {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> 保存</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">_index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">customer</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> 索引</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">_type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">external</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> 类型</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">_id</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">1</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> 文档</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">_version</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> 版本</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">result</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">created</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> 创建</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">_shards</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">total</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">successful</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">failed</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 0</span></span>
<span class="line"><span style="color:#ECEFF4;">        },</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">_seq_no</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">_primary_term</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">status</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 201</span><span style="color:#D8DEE9;"> 新建完成</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">    {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> 第二条记录</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">_index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">customer</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">_type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">external</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">_id</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">2</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">_version</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">result</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">created</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">_shards</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">total</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">successful</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">failed</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 0</span></span>
<span class="line"><span style="color:#ECEFF4;">        },</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">_seq_no</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">_primary_term</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">status</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 201</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  ]</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>示例2：</p><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">POST</span><span style="color:#D8DEE9FF;"> /_bulk</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">{</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">delete</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:{</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">_index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">website</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">_type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">blog</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">_id</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">123</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">}}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">{</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">create</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:{</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">_index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">website</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">_type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">blog</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">_id</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">123</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">}}</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">title</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">my first blog post</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">{</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:{</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">_index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">website</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">_type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">blog</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">}}</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">title</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">my second blog post</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">{</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">update</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:{</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">_index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">website</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">_type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">blog</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">_id</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">123</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">}}</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">doc</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:{</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">title</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">my updated blog post</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">}}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>7、样本测试数据</strong></p><p>一份顾客银行账户信息的虚构的 JSON 文档样本。每个文档都有下列的 schema(模式):</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">account_number</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">balance</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 16623</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">firstname</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Bradshaw</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">lastname</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Mckenzie</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">age</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 29</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">gender</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">F</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">address</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">244 Columbus Place</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">employer</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Euron</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">email</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">bradshawmckenzie@euron.com</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">city</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Hobucken</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">state</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">CO</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试数据地址https://gitee.com/xlh_blog/common_content/blob/master/es%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE.json</p><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">POST</span><span style="color:#D8DEE9FF;"> bank/account/_bulk</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">//上面的数据</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">//GET _cat/indices, 查看索引</span></span>
<span class="line"><span style="color:#616E88;">//刚导入了1000条数据</span></span>
<span class="line"><span style="color:#D8DEE9FF;">yellow open bank                     dno5JY9tTrGHdsjIMkvQyA 1 1 1000 0 414.2kb 414.2kb</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5、进阶检索" tabindex="-1"><a class="header-anchor" href="#_5、进阶检索"><span>5、进阶检索</span></a></h2><h3 id="_1、searchapi" tabindex="-1"><a class="header-anchor" href="#_1、searchapi"><span><strong>1、SearchAPI</strong></span></a></h3><p>ES 支持两种基本方式检索：</p><ul><li>一个是通过使用 REST request URI 发送搜索参数（uri+检索参数）</li><li>另一个是通过使用 REST request body 来发送它们（uri+请求体）</li></ul><p>1）、信息检索</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>GET bank/_search     													检索 bank 下所有信息，包括 type 和 docs</span></span>
<span class="line"><span></span></span>
<span class="line"><span>GET bank/_search?q=*&amp;sort=account_number:asc							请求参数方式检索</span></span>
<span class="line"><span>说明：</span></span>
<span class="line"><span>q=* # 查询所有</span></span>
<span class="line"><span>sort # 排序字段</span></span>
<span class="line"><span>asc #升序</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回内容：</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407231954670.png" alt="image-20211011143910397" tabindex="0" loading="lazy"><figcaption>image-20211011143910397</figcaption></figure><p><code>took</code> – 花费多少ms搜索 <code>timed_out</code> – 是否超时 <code>_shards </code>– 多少分片被搜索了，以及多少成功/失败的搜索分片 <code>max_score</code> –文档相关性最高得分 <code>hits.total.value</code> - 多少匹配文档被找到 <code>hits.sort</code> - 结果的排序key（列），没有的话按照score排序 <code>hits._score</code> - 相关得分 (not applicable when using match_all)</p><p>uri+请求体行检索</p><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">GET</span><span style="color:#D8DEE9FF;"> /bank/_search</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">query</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#8FBCBB;">match_all</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {}</span><span style="color:#ECEFF4;"> },</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">sort</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> [</span></span>
<span class="line"><span style="color:#ECEFF4;">    {</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#8FBCBB;">account_number</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">asc</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> },</span></span>
<span class="line"><span style="color:#ECEFF4;">    {</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#8FBCBB;">balance</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">desc</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#ECEFF4;">  ]</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>HTTP客户端工具（POSTMAN），get请求不能携带请求体，我们变为post也是一样的。我们POST一个JSON风格的查询请求体到_search API。</p><p>需要了解，一旦搜索的结果被返回Elasticsearch就完成了这次请求，并且不会维护任何服务端的资源或者结果的cursor（游标）</p><h3 id="_2、query-dsl" tabindex="-1"><a class="header-anchor" href="#_2、query-dsl"><span>2、Query DSL</span></a></h3><p>Elasticsearch提供了一个可以执行查询的Json风格的DSL(domain-specific language领域特定语言)。这个被称为Query DSL，该查询语言非常全面。</p><p>1、基本语法格式</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">如果针对于某个字段，那么它的结构如下：</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">  QUERY_NAME</span><span style="color:#ECEFF4;">:{</span><span style="color:#D8DEE9;">   #</span><span style="color:#D8DEE9;"> 使用的功能</span></span>
<span class="line"><span style="color:#D8DEE9;">     FIELD_NAME</span><span style="color:#ECEFF4;">:{</span><span style="color:#D8DEE9;">  #</span><span style="color:#D8DEE9;">  功能参数</span></span>
<span class="line"><span style="color:#D8DEE9;">       ARGUMENT</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9;">VALUE</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#D8DEE9;">       ARGUMENT</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9;">VALUE</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;">...</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span><span style="color:#D8DEE9FF;">   </span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">示例  使用时不要加#注释内容</span></span>
<span class="line"><span style="color:#8FBCBB;">GET</span><span style="color:#D8DEE9FF;"> bank</span><span style="color:#81A1C1;">/</span><span style="color:#8FBCBB;">_search</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#A3BE8C;">query</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;">  #  查询的字段</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#A3BE8C;">match_all</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;"> {}</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#A3BE8C;">from</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;">  # 从第几条文档开始查</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#A3BE8C;">size</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">:</span><span style="color:#B48EAD;"> 5</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;">  # 查几条文档</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#A3BE8C;">_source</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;">[</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">balance</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">],</span><span style="color:#D8DEE9FF;"> # 返回的数据字段， 这里只查balance</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#A3BE8C;">sort</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;"> [</span></span>
<span class="line"><span style="color:#ECEFF4;">    {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#A3BE8C;">account_number</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;">  # 返回结果按哪个列排序</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#A3BE8C;">order</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">desc</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">  # 降序</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  ]</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>query定义如何查询；</p><ul><li>match_all查询类型【代表查询所有的索引】，es中可以在query中组合非常多的查询类型完成复杂查询；</li><li>除了query参数之外，我们可也传递其他的参数以改变查询结果，如sort，size；</li><li>from+size限定，完成分页功能；</li><li>sort排序，多字段排序，会在前序字段相等时后续字段内部排序，否则以前序为准；</li></ul><p>2、<code>query/match</code>匹配查询</p><blockquote><p>如果是非字符串，会进行精确匹配。如果是字符串，会进行全文检索</p></blockquote><ul><li>基本类型（非字符串），精确控制: 查询account_number == 20的文档</li></ul><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">GET</span><span style="color:#D8DEE9FF;"> bank/_search</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">query</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">match</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">account_number</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">20</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>字符串，全文检索: 查询address中含有kings的文档</li></ul><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">GET</span><span style="color:#D8DEE9FF;"> bank/_search</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">query</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">match</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">address</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">kings</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>字符串，全文检索：最终查询出 address 中包含 mill 或者 road 或者 mill road 的所有记录，并给出相关性得分</li></ul><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">GET</span><span style="color:#D8DEE9FF;"> bank/_search</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">   &quot;</span><span style="color:#8FBCBB;">query</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">match</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">         &quot;</span><span style="color:#8FBCBB;">address</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">mill road</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>全文检索，最终会按照评分进行排序，会对检索条件进行分词匹配。</p><p>3、<code>query/match_phrase</code>【短语匹配】</p><p>将需要匹配的值当成一整个单词（不分词）进行检索</p><ul><li><code>match</code>：拆分字符串进行检索。 包含mill 或 road 或 mill road</li><li><code>match_phrase</code>：不拆分字符串进行检索。 包含mill road</li><li><code>字段.keyword</code>：必须全匹配上才检索成功。</li></ul><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">GET</span><span style="color:#D8DEE9FF;"> bank/_search</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">query</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">match_phrase</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">address</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">mill road</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9;">   #</span><span style="color:#D8DEE9;">  就是说不要匹配只有mill或只有road的，要匹配mill</span><span style="color:#D8DEE9;"> road一整个子串</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span></span>
<span class="line"><span style="color:#D8DEE9;">      #</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">address.keyword</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">990 Mill</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9;">  #</span><span style="color:#D8DEE9;"> 字段后面加上</span><span style="color:#D8DEE9;"> .keyword</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> 必须完全匹配</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      </span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4、<code>query/multi_math</code>【多字段匹配】</p><p><code>state或者address中包含mill</code>，并且在查询过程中，会对于查询条件进行分词。</p><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">GET</span><span style="color:#D8DEE9FF;"> bank/_search</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">query</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">multi_match</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;">  #</span><span style="color:#D8DEE9;"> 前面的match仅指定了一个字段。</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">query</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">mill</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">fields</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> [</span><span style="color:#D8DEE9;"> #</span><span style="color:#D8DEE9;"> state和address有mill子串</span><span style="color:#D8DEE9;">  不要求都有</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#A3BE8C;">state</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#A3BE8C;">address</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">      ]</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>5、<code>query/bool/must</code>复合查询</p><p>复合语句可以合并，任何其他查询语句，包括符合语句。这也就意味着，复合语句之间可以互相嵌套，可以表达非常复杂的逻辑。</p><ul><li>must：必须达到must所列举的所有条件</li><li>must_not：必须不匹配must_not所列举的所有条件。</li><li>should：应该满足should所列举的条件。满足条件最好，不满足也可以，满足得分更高</li></ul><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">GET</span><span style="color:#D8DEE9FF;"> bank/_search</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">query</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">bool</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">must</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> [</span><span style="color:#D8DEE9;">   #</span><span style="color:#D8DEE9;"> gender必须是M，</span><span style="color:#D8DEE9;"> address必须包含mill</span></span>
<span class="line"><span style="color:#ECEFF4;">        {</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">match</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">            &quot;</span><span style="color:#8FBCBB;">gender</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">M</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">          }</span></span>
<span class="line"><span style="color:#ECEFF4;">        },</span></span>
<span class="line"><span style="color:#ECEFF4;">        {</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">match</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">            &quot;</span><span style="color:#8FBCBB;">address</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">mill</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">          }</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">      ],</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">must_not</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> [</span><span style="color:#D8DEE9;">   #</span><span style="color:#D8DEE9;"> age必须不等于</span><span style="color:#B48EAD;">18</span></span>
<span class="line"><span style="color:#ECEFF4;">        {</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">match</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">            &quot;</span><span style="color:#8FBCBB;">age</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">18</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">          }</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">      ],</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">should</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> [</span><span style="color:#D8DEE9;">    #</span><span style="color:#D8DEE9;"> lastname最好包含wallace</span></span>
<span class="line"><span style="color:#ECEFF4;">        {</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">match</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">            &quot;</span><span style="color:#8FBCBB;">lastname</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Wallace</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">          }</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">      ]</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>6、<code>query/filter</code>【结果过滤】</p><ul><li><p>上面的must和should影响相关性得分，而must_not仅仅是一个filter ，不贡献得分</p></li><li><p>must改为filter就使must不贡献得分</p></li><li><p>如果只有filter条件的话，我们会发现得分都是0</p></li></ul><p>并不是所有的查询都需要产生分数，特别是哪些仅用于filtering过滤的文档。不参与评分更快, 为了不计算分数，elasticsearch会自动检查场景并且优化查询的执行。</p><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">GET</span><span style="color:#D8DEE9FF;"> bank/_search</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">query</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">bool</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">must</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> [</span></span>
<span class="line"><span style="color:#ECEFF4;">        {</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#8FBCBB;">match</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">address</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">mill</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> }</span><span style="color:#ECEFF4;"> }</span></span>
<span class="line"><span style="color:#ECEFF4;">      ],</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">filter</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;">  #</span><span style="color:#D8DEE9;"> query.bool.filter</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">range</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">balance</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;">  #</span><span style="color:#D8DEE9;"> 哪个字段</span></span>
<span class="line"><span style="color:#ECEFF4;">            &quot;</span><span style="color:#8FBCBB;">gte</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">10000</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">            &quot;</span><span style="color:#8FBCBB;">lte</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">20000</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">          }</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">这里先是查询所有匹配address包含mill的文档，然后再根据</span><span style="color:#B48EAD;">10000</span><span style="color:#D8DEE9FF;">&lt;=balance&lt;=</span><span style="color:#B48EAD;">20000</span><span style="color:#D8DEE9FF;">进行过滤查询结果</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>7、<code>query/term</code></p><p>和 match 一样。匹配某个属性的值。全文检索字段用 match，其他非 text 字段匹配用 term。</p><p>比如：年龄为23岁，用term， address为mill road就用match</p><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">GET</span><span style="color:#D8DEE9FF;"> bank/_search</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">   &quot;</span><span style="color:#8FBCBB;">query</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">bool</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">         &quot;</span><span style="color:#8FBCBB;">must</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> [</span></span>
<span class="line"><span style="color:#ECEFF4;">            {</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">term</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">               &quot;</span><span style="color:#8FBCBB;">age</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">                  &quot;</span><span style="color:#8FBCBB;">value</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">28</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">               }</span></span>
<span class="line"><span style="color:#ECEFF4;">            }},</span></span>
<span class="line"><span style="color:#ECEFF4;">            {</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;">match</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">               &quot;</span><span style="color:#8FBCBB;">address</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">990 Mill Road</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">            }}</span></span>
<span class="line"><span style="color:#ECEFF4;">         ]</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>8、<code>aggregations</code>（执行聚合）</p><p>​ 聚合提供了从数据中分组和提取数据的能力。最简单的聚合方法大致等于 SQL GROUP BY 和 SQL 聚合函数。在 Elasticsearch 中，<code>有执行搜索返回 hits（命中结果），并且同时返回聚合结果</code>，把一个响应中的所有 hits（命中结果）分隔开的能力。这是非常强大且有效的，您可以执行查询和多个聚合，并且在一次使用中得到各自的（任何一个的）返回结果，使用一次简洁和简化的 API 来避免网络往返。</p><p>例：搜索 address 中包含 mill 的所有人的年龄分布以及平均年龄，但不显示这些人的详情。</p><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">GET</span><span style="color:#D8DEE9FF;"> bank/_search</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">query</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> #</span><span style="color:#D8DEE9;"> 查询出包含mill的</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">match</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">address</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Mill</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">aggs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> #基于查询聚合</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">ageAgg</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;">  #</span><span style="color:#D8DEE9;"> 聚合的名字，随便起</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">terms</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> #</span><span style="color:#D8DEE9;"> 看值的可能性分布</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">field</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">age</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">size</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 10</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">ageAvg</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">avg</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> #</span><span style="color:#D8DEE9;"> 看age值的平均</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">field</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">age</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">balanceAvg</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">avg</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> #</span><span style="color:#D8DEE9;"> 看balance的平均</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">field</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">balance</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">size</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 0</span><span style="color:#D8DEE9;">  #</span><span style="color:#D8DEE9;"> 不看详情</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查询结果：</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">took</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">timed_out</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#81A1C1;"> false</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">_shards</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">total</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">successful</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">skipped</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">failed</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 0</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">hits</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">total</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">value</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 4</span><span style="color:#ECEFF4;">,</span><span style="color:#616E88;"> // 命中4条</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">relation</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">eq</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">max_score</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#81A1C1;"> null</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">hits</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> [</span><span style="color:#ECEFF4;"> ]</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">aggregations</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">ageAgg</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> {</span><span style="color:#616E88;"> // 第一个聚合的结果</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">doc_count_error_upper_bound</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">sum_other_doc_count</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">buckets</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> [</span></span>
<span class="line"><span style="color:#ECEFF4;">        {</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">key</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 38</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;">  #</span><span style="color:#D8DEE9;"> age为38的有2条</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">doc_count</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 2</span></span>
<span class="line"><span style="color:#ECEFF4;">        },</span></span>
<span class="line"><span style="color:#ECEFF4;">        {</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">key</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 28</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">doc_count</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1</span></span>
<span class="line"><span style="color:#ECEFF4;">        },</span></span>
<span class="line"><span style="color:#ECEFF4;">        {</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">key</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 32</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">doc_count</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">      ]</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">ageAvg</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> {</span><span style="color:#616E88;"> // 第二个聚合的结果</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">value</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 34.0</span><span style="color:#D8DEE9;">  #</span><span style="color:#D8DEE9;"> balance字段的平均值是</span><span style="color:#B48EAD;">34</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">balanceAvg</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">value</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 25208.0</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>例：按照年龄聚合，并且求这些年龄段的这些人的平均薪资</p><p><code>aggs/aggName/aggs/aggName</code>子聚合</p><blockquote><p>写到一个聚合里是基于上个聚合进行子聚合。</p><p>下面求每个age分布的平均balance</p></blockquote><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">GET</span><span style="color:#D8DEE9FF;"> bank/_search</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">query</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">match_all</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {}</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">aggs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">ageAgg</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">terms</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> #</span><span style="color:#D8DEE9;"> 看分布</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">field</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">age</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">size</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 100</span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">aggs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> #</span><span style="color:#D8DEE9;"> 与terms并列</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">ageAvg</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> #平均</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">avg</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">            &quot;</span><span style="color:#8FBCBB;">field</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">balance</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">          }</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">size</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 0</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>例：复杂子聚合：查出所有年龄分布，并且这些<strong>年龄段</strong>中M的平均薪资和F的平均薪资以及这个年龄段的总体平均薪资</p><div class="language-http line-numbers-mode" data-highlighter="shiki" data-ext="http" data-title="http" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">GET</span><span style="color:#D8DEE9FF;"> bank/_search</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">query</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">match_all</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {}</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">aggs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">ageAgg</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">terms</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;">  #</span><span style="color:#D8DEE9;">  看age分布</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">field</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">age</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">size</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 100</span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">aggs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> #</span><span style="color:#D8DEE9;"> 子聚合</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">genderAgg</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">terms</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> #</span><span style="color:#D8DEE9;"> 看gender分布</span></span>
<span class="line"><span style="color:#ECEFF4;">            &quot;</span><span style="color:#8FBCBB;">field</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">gender.keyword</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9;"> #</span><span style="color:#D8DEE9;"> 注意这里，文本字段应该用.keyword</span></span>
<span class="line"><span style="color:#ECEFF4;">          },</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">aggs</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> #</span><span style="color:#D8DEE9;"> 子聚合</span></span>
<span class="line"><span style="color:#ECEFF4;">            &quot;</span><span style="color:#8FBCBB;">balanceAvg</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">              &quot;</span><span style="color:#8FBCBB;">avg</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> #</span><span style="color:#D8DEE9;"> 男性的平均</span></span>
<span class="line"><span style="color:#ECEFF4;">                &quot;</span><span style="color:#8FBCBB;">field</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">balance</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">              }</span></span>
<span class="line"><span style="color:#ECEFF4;">            }</span></span>
<span class="line"><span style="color:#ECEFF4;">          }</span></span>
<span class="line"><span style="color:#ECEFF4;">        },</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">ageBalanceAvg</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">avg</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;"> #age分布的平均（男女）</span></span>
<span class="line"><span style="color:#ECEFF4;">            &quot;</span><span style="color:#8FBCBB;">field</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">balance</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">          }</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">size</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 0</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3、mapping字段映射" tabindex="-1"><a class="header-anchor" href="#_3、mapping字段映射"><span>3、Mapping字段映射</span></a></h3><p>1、字段类型</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407231954677.png" alt="image-20211012145448490" tabindex="0" loading="lazy"><figcaption>image-20211012145448490</figcaption></figure><blockquote><ul><li><code>text</code> ⽤于全⽂索引，搜索时会自动使用分词器进⾏分词再匹配</li><li><code>keyword</code> 不分词，搜索时需要匹配完整的值</li></ul></blockquote><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407231954708.png" alt="image-20211012145516034" tabindex="0" loading="lazy"><figcaption>image-20211012145516034</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407231954291.png" alt="image-20211012145531890" tabindex="0" loading="lazy"><figcaption>image-20211012145531890</figcaption></figure><p>2、Mapping（映射） Mapping 是用来定义一个文档（document），以及它所包含的属性（field）是如何存储和索引的。比如，使用 mapping 来定义：</p><ul><li>哪些字符串属性应该被看做全文本属性（full text fields）；</li><li>哪些属性包含数字，日期或地理位置；</li><li>文档中的所有属性是否都能被索引（all 配置）；</li><li>日期的格式；</li><li>自定义映射规则来执行动态添加属性；</li><li>查看mapping信息：<code>GET bank/_mapping</code></li></ul><p>3、新版本改变</p><p>ElasticSearch7-去掉type概念</p><ul><li>关系型数据库中两个数据表示是独立的，即使他们里面有相同名称的列也不影响使用，但ES中不是这样的。elasticsearch是基于Lucene开发的搜索引擎，而ES中不同type下名称相同的filed最终在Lucene中的处理方式是一样的。 <ul><li>两个不同type下的两个user_name，在ES同一个索引下其实被认为是同一个filed，你必须在两个不同的type中定义相同的filed映射。否则，不同type中的相同字段名称就会在处理中出现冲突的情况，导致Lucene处理效率下降。</li><li>去掉type就是为了提高ES处理数据的效率。</li></ul></li></ul><p>Elasticsearch 7.x URL中的type参数为可选。比如，索引一个文档不再要求提供文档类型。</p><p>Elasticsearch 8.x 不再支持URL中的type参数。</p><p>解决： 1）将索引从多类型迁移到单类型，每种类型文档一个独立索引</p><p>2）将已存在的索引下的类型数据，全部迁移到指定位置即可。详见数据迁移</p><p>4、对映射的操作</p><p>1）创建索引并指定映射</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">PUT /my_index</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">mappings</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">properties</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">age</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">integer</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">email</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">keyword</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9;"> #</span><span style="color:#D8DEE9;"> 指定为keyword</span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">name</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">text</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9;"> #</span><span style="color:#D8DEE9;"> 全文检索。保存时候分词，检索时候进行分词匹配</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）添加新的字段映射</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">PUT /my_index/_mapping</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">properties</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">employee-id</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">keyword</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> false</span><span style="color:#D8DEE9;"> #</span><span style="color:#D8DEE9;"> 字段不能被检索。检索</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3)更新映射</p><p>对于已经存在的映射字段，我们不能更新。更新必须创建新的索引进行数据迁移</p><p>4）数据迁移</p><p>先创建new_twitter的正确映射，然后使用如下方式进行数据迁移。</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#B48EAD;">6.0</span><span style="color:#D8DEE9FF;">以后写法</span></span>
<span class="line"><span style="color:#D8DEE9FF;">POST reindex</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">source</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:{</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">twitter</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">   },</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">dest</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:{</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">new_twitters</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">老版本写法</span></span>
<span class="line"><span style="color:#D8DEE9FF;">POST reindex</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">source</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:{</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">twitter</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">twitter</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">twitter</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">   },</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">dest</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:{</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">new_twitters</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">   }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>示例：把bank/account下的文档迁移到newbank下</p><ul><li><p>创建newbank索引</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">PUT /newbank</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">mappings</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">properties</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">account_number</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">long</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">address</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">text</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">age</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">integer</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">balance</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">long</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">city</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">keyword</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">email</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">keyword</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">employer</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">keyword</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">firstname</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">text</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">gender</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">keyword</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">lastname</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">text</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">fields</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">          &quot;</span><span style="color:#8FBCBB;">keyword</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">            &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">keyword</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">            &quot;</span><span style="color:#8FBCBB;">ignore_above</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 256</span></span>
<span class="line"><span style="color:#ECEFF4;">          }</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">      },</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">state</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">keyword</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">      }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>数据迁移</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">POST _reindex</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">source</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">bank</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">account</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">  },</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">dest</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">newbank</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">  }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>查看newbank中的数据</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">GET /newbank/_search</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF;">输出</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#A3BE8C;">hits</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;"> : </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">total</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">value</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1000</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">relation</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">eq</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">max_score</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1.0</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#8FBCBB;">hits</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> [</span></span>
<span class="line"><span style="color:#ECEFF4;">      {</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">_index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">newbank</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">        &quot;</span><span style="color:#8FBCBB;">_type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">_doc</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> #</span><span style="color:#D8DEE9;"> 没有了类型</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="_4、分词" tabindex="-1"><a class="header-anchor" href="#_4、分词"><span>4、分词</span></a></h3><ul><li><p>一个tokenizer（分词器）接收一个字符流，将之分割为独立的tokens（词元，通常是独立的单词），然后输出tokens流。</p></li><li><p>例如：whitespace tokenizer遇到空白字符时分割文本。它会将文本&quot;Quick brown fox!&quot;分割为[Quick,brown,fox!]</p></li><li><p>该tokenizer（分词器）还负责记录各个terms(词条)的顺序或position位置（用于phrase短语和word proximity词近邻查询），以及term（词条）所代表的原始word（单词）的start（起始）和end（结束）的character offsets（字符串偏移量）（用于高亮显示搜索的内容）。</p></li><li><p>elasticsearch提供了很多内置的分词器（标准分词器），可以用来构建custom analyzers（自定义分词器）</p></li></ul><p>示例：</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">POST _analyze</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">analyzer</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">standard</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">text</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">Quick brown fox!</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>分词结果：</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407231954361.png" alt="image-20211012154808341" tabindex="0" loading="lazy"><figcaption>image-20211012154808341</figcaption></figure><p><strong>1、安装ik分词器</strong></p><p>所有的语言分词，默认使用的都是“Standard Analyzer”，但是这些分词器针对于中文的分词，并不友好。为此需要安装中文的分词器。</p><p>下载地址：https://github.com/medcl/elasticsearch-analysis-ik/releases</p><p>在前面安装的elasticsearch时，我们已经将elasticsearch容器的“/usr/share/elasticsearch/plugins”目录，映射到宿主机的“ /mydata/elasticsearch/plugins”目录下，所以比较方便的做法就是下载“/elasticsearch-analysis-ik-7.4.2.zip”文件，然后解压到该文件夹下即可。安装完毕后，需要重启elasticsearch容器。</p><p><strong>2、测试分词器</strong></p><p>1、ik_smart</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">POST _analyze</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">analyzer</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">ik_smart</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">text</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">我是中国人</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回结果</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">tokens</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> [</span></span>
<span class="line"><span style="color:#ECEFF4;">    {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">token</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">我</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">start_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">end_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">CN_CHAR</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">position</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 0</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">    {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">token</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">是</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">start_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">end_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">CN_CHAR</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">position</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">    {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">token</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">中国人</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">start_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">end_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 5</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">CN_WORD</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">position</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 2</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  ]</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、ik_max_word</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">POST _analyze</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">analyzer</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">ik_max_word</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">text</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">我是中国人</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回结果</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">tokens</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> [</span></span>
<span class="line"><span style="color:#ECEFF4;">    {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">token</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">我</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">start_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">end_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">CN_CHAR</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">position</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 0</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">    {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">token</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">是</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">start_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">end_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">CN_CHAR</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">position</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">    {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">token</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">中国人</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">start_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">end_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 5</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">CN_WORD</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">position</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 2</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">    {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">token</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">中国</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">start_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 2</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">end_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 4</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">CN_WORD</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">position</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 3</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">    {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">token</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">国人</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">start_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 3</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">end_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 5</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">CN_WORD</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">position</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 4</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  ]</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3、自定义词库</strong></p><p>先安装nginx</p><p>1）随便启动一个 nginx 实例，只是为了复制出配置</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#88C0D0;">docker</span><span style="color:#A3BE8C;"> run</span><span style="color:#A3BE8C;"> -p</span><span style="color:#A3BE8C;"> 80:80</span><span style="color:#A3BE8C;"> --name</span><span style="color:#A3BE8C;"> nginx</span><span style="color:#A3BE8C;"> -d</span><span style="color:#A3BE8C;"> nginx:1.10</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>2)将容器内的配置文件拷贝到当前目录</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#88C0D0;">docker</span><span style="color:#A3BE8C;"> container</span><span style="color:#A3BE8C;"> cp</span><span style="color:#A3BE8C;"> nginx:/etc/nginx</span><span style="color:#A3BE8C;"> .</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>3）修改文件名称：mv nginx conf 把这个 conf 移动到/mydata/nginx 下</p><p>4）终止原容器：docker stop nginx</p><p>5）执行命令删除原容器：docker rm $ContainerId</p><p>6）创建新的 nginx；执行以下命令</p><div class="language-she line-numbers-mode" data-highlighter="shiki" data-ext="she" data-title="she" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>docker run -p 80:80 --name nginx \\</span></span>
<span class="line"><span>-v /mydata/nginx/html:/usr/share/nginx/html \\</span></span>
<span class="line"><span>-v /mydata/nginx/logs:/var/log/nginx \\</span></span>
<span class="line"><span>-v /mydata/nginx/conf:/etc/nginx \\</span></span>
<span class="line"><span>-d nginx:1.10</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>7)给 nginx 的 html 下面放的所有资源可以直接访问；</p><p>8)在nginx/html/中创建一个es文件夹，在里面新建文件fenci.txt，用作分词表，写入：尚硅谷</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407231954484.png" alt="image-20211012192408901" tabindex="0" loading="lazy"><figcaption>image-20211012192408901</figcaption></figure><p>9）访问，由于访问nginx中资源，都在html文件夹下查找，所以直接访问/es/fenci.txt即可（乱码先不用管，访问到了即可）</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407231954706.png" alt="image-20211012192537189" tabindex="0" loading="lazy"><figcaption>image-20211012192537189</figcaption></figure><p>10）修改/usr/share/elasticsearch/plugins/ik/config中的IKAnalyzer.cfg.xml</p><div class="language-xml line-numbers-mode" data-highlighter="shiki" data-ext="xml" data-title="xml" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">&lt;?</span><span style="color:#5E81AC;">xml</span><span style="color:#8FBCBB;"> version</span><span style="color:#D8DEE9FF;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">1.0</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;"> encoding</span><span style="color:#D8DEE9FF;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">UTF-8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">?&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;!</span><span style="color:#5E81AC;">DOCTYPE</span><span style="color:#81A1C1;"> properties</span><span style="color:#D8DEE9FF;"> SYSTEM &quot;http://java.sun.com/dtd/properties.dtd&quot;</span><span style="color:#81A1C1;">&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;properties&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">	&lt;comment&gt;</span><span style="color:#D8DEE9FF;">IK Analyzer 扩展配置</span><span style="color:#81A1C1;">&lt;/comment&gt;</span></span>
<span class="line"><span style="color:#616E88;">	&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">	&lt;entry</span><span style="color:#8FBCBB;"> key</span><span style="color:#D8DEE9FF;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ext_dict</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;&lt;/entry&gt;</span></span>
<span class="line"><span style="color:#616E88;">	 &lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">	&lt;entry</span><span style="color:#8FBCBB;"> key</span><span style="color:#D8DEE9FF;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ext_stopwords</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;&lt;/entry&gt;</span></span>
<span class="line"><span style="color:#616E88;">	&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">	&lt;entry</span><span style="color:#8FBCBB;"> key</span><span style="color:#D8DEE9FF;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">remote_ext_dict</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;</span><span style="color:#D8DEE9FF;">http://192.168.56.10/es/fenci.txt</span><span style="color:#81A1C1;">&lt;/entry&gt;</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#616E88;">	&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span></span>
<span class="line"><span style="color:#616E88;">	&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/properties&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>11）重启es,验证分词效果</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">POST _analyze</span></span>
<span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">analyzer</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">ik_max_word</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">text</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">尚硅谷不错</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>分词效果</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#8FBCBB;">tokens</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> [</span></span>
<span class="line"><span style="color:#ECEFF4;">    {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">token</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">尚硅谷</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">start_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">end_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 3</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">CN_WORD</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">position</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 0</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">    {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">token</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">硅谷</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">start_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">end_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 3</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">CN_WORD</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">position</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 1</span></span>
<span class="line"><span style="color:#ECEFF4;">    },</span></span>
<span class="line"><span style="color:#ECEFF4;">    {</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">token</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">不错</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">start_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 3</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">end_offset</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 5</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">CN_WORD</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">      &quot;</span><span style="color:#8FBCBB;">position</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> :</span><span style="color:#B48EAD;"> 2</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">  ]</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="go-elasticsearch" tabindex="-1"><a class="header-anchor" href="#go-elasticsearch"><span>go-elasticsearch</span></a></h1><p><a href="https://www.elastic.co/guide/en/elasticsearch/client/go-api/current/getting-started-go.html" target="_blank" rel="noopener noreferrer">开始使用 |Elasticsearch Go 客户端 </a></p><p>使用第三方组件步骤</p><p>创建客户端，</p><p>使用客户端操作相应API</p><h1 id="创建客户端" tabindex="-1"><a class="header-anchor" href="#创建客户端"><span>创建客户端</span></a></h1><p>go提供了2种两种客户端，一种是低级api，一种是全类型API，下面提供了示例全是基于全类型的。具体的可以查看上方给出的官网。</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407241747556.png" alt="image-20240724174725467" tabindex="0" loading="lazy"><figcaption>image-20240724174725467</figcaption></figure><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// ES 配置</span></span>
<span class="line"><span style="color:#D8DEE9;">cfg</span><span style="color:#81A1C1;"> :=</span><span style="color:#D8DEE9FF;"> elasticsearch</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">Config</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">	Addresses</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> []</span><span style="color:#81A1C1;">string</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">		&quot;</span><span style="color:#A3BE8C;">http://localhost:9200</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">	},</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// 创建客户端连接</span></span>
<span class="line"><span style="color:#D8DEE9;">client</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#81A1C1;"> :=</span><span style="color:#D8DEE9;"> elasticsearch</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">NewTypedClient</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">cfg</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9;"> err</span><span style="color:#81A1C1;"> !=</span><span style="color:#81A1C1;"> nil</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">	fmt</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Printf</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">elasticsearch.NewTypedClient failed, err:</span><span style="color:#EBCB8B;">%v\\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">	return</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>看到该客户端有API</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407241749128.png" alt="image-20240724174902053" tabindex="0" loading="lazy"><figcaption>image-20240724174902053</figcaption></figure><h1 id="创建索引" tabindex="-1"><a class="header-anchor" href="#创建索引"><span>创建索引</span></a></h1><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9;">typedClient</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Indices</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Create</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">my_index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">).</span><span style="color:#88C0D0;">Do</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">context</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">TODO</span><span style="color:#ECEFF4;">())</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h1 id="增加文档" tabindex="-1"><a class="header-anchor" href="#增加文档"><span>增加文档</span></a></h1><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9;">document</span><span style="color:#81A1C1;"> :=</span><span style="color:#81A1C1;"> struct</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    Name</span><span style="color:#81A1C1;"> string</span><span style="color:#ECEFF4;"> \`</span><span style="color:#A3BE8C;">json:&quot;name&quot;</span><span style="color:#ECEFF4;">\`</span></span>
<span class="line"><span style="color:#ECEFF4;">}{</span></span>
<span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#A3BE8C;">go-elasticsearch</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"><span style="color:#D8DEE9;">typedClient</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Index</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">my_index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">).</span></span>
<span class="line"><span style="color:#88C0D0;">		Id</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">1</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">).</span></span>
<span class="line"><span style="color:#88C0D0;">		Request</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">document</span><span style="color:#ECEFF4;">).</span></span>
<span class="line"><span style="color:#88C0D0;">		Do</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">context</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">TODO</span><span style="color:#ECEFF4;">())</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="查询文档" tabindex="-1"><a class="header-anchor" href="#查询文档"><span>查询文档</span></a></h1><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9;">typedClient</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Get</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">my_index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">id</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">).</span><span style="color:#88C0D0;">Do</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">context</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">TODO</span><span style="color:#ECEFF4;">())</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h1 id="更新文档" tabindex="-1"><a class="header-anchor" href="#更新文档"><span>更新文档</span></a></h1><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9;">typedClient</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Update</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">my_index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">id</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">).</span></span>
<span class="line"><span style="color:#88C0D0;">	Request</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">&amp;</span><span style="color:#D8DEE9FF;">update</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">Request</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">        Doc</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9;"> json</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">RawMessage</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">\`</span><span style="color:#A3BE8C;">{ language: &quot;Go&quot; }</span><span style="color:#ECEFF4;">\`</span><span style="color:#ECEFF4;">),</span></span>
<span class="line"><span style="color:#ECEFF4;">    }).</span><span style="color:#88C0D0;">Do</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">context</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">TODO</span><span style="color:#ECEFF4;">())</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="删除文档" tabindex="-1"><a class="header-anchor" href="#删除文档"><span>删除文档</span></a></h1><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9;">typedClient</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Delete</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">my_index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">id</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">).</span><span style="color:#88C0D0;">Do</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">context</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">TODO</span><span style="color:#ECEFF4;">())</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h1 id="删除索引" tabindex="-1"><a class="header-anchor" href="#删除索引"><span>删除索引</span></a></h1><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9;">typedClient</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Indices</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Delete</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">my_index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">).</span><span style="color:#88C0D0;">Do</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">context</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">TODO</span><span style="color:#ECEFF4;">())</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h1 id="简单实现帖子全文检索" tabindex="-1"><a class="header-anchor" href="#简单实现帖子全文检索"><span>简单实现帖子全文检索</span></a></h1><h2 id="定义实体" tabindex="-1"><a class="header-anchor" href="#定义实体"><span>定义实体</span></a></h2><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">type</span><span style="color:#D8DEE9FF;"> Post </span><span style="color:#81A1C1;">struct</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">	ID</span><span style="color:#81A1C1;">          int64</span><span style="color:#ECEFF4;">     \`</span><span style="color:#A3BE8C;">json:&quot;id,string&quot; db:&quot;post_id&quot;</span><span style="color:#ECEFF4;">\`</span><span style="color:#616E88;">                            // 帖子id</span></span>
<span class="line"><span style="color:#D8DEE9;">	AuthorID</span><span style="color:#81A1C1;">    int64</span><span style="color:#ECEFF4;">     \`</span><span style="color:#A3BE8C;">json:&quot;author_id&quot; db:&quot;author_id&quot;</span><span style="color:#ECEFF4;">\`</span><span style="color:#616E88;">                          // 作者id</span></span>
<span class="line"><span style="color:#D8DEE9;">	CommunityID</span><span style="color:#81A1C1;"> int64</span><span style="color:#ECEFF4;">     \`</span><span style="color:#A3BE8C;">json:&quot;community_id&quot; db:&quot;community_id&quot; binding:&quot;required&quot;</span><span style="color:#ECEFF4;">\`</span><span style="color:#616E88;"> // 社区id</span></span>
<span class="line"><span style="color:#D8DEE9;">	Status</span><span style="color:#81A1C1;">      int32</span><span style="color:#ECEFF4;">     \`</span><span style="color:#A3BE8C;">json:&quot;status&quot; db:&quot;status&quot;</span><span style="color:#ECEFF4;">\`</span><span style="color:#616E88;">                                // 帖子状态</span></span>
<span class="line"><span style="color:#D8DEE9;">	Title</span><span style="color:#81A1C1;">       string</span><span style="color:#ECEFF4;">    \`</span><span style="color:#A3BE8C;">json:&quot;title&quot; db:&quot;title&quot; binding:&quot;required&quot;</span><span style="color:#ECEFF4;">\`</span><span style="color:#616E88;">               // 帖子标题</span></span>
<span class="line"><span style="color:#D8DEE9;">	Content</span><span style="color:#81A1C1;">     string</span><span style="color:#ECEFF4;">    \`</span><span style="color:#A3BE8C;">json:&quot;content&quot; db:&quot;content&quot; binding:&quot;required&quot;</span><span style="color:#ECEFF4;">\`</span><span style="color:#616E88;">           // 帖子内容</span></span>
<span class="line"><span style="color:#D8DEE9;">	CreateTime</span><span style="color:#D8DEE9FF;">  time</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">Time </span><span style="color:#ECEFF4;">\`</span><span style="color:#A3BE8C;">json:&quot;create_time&quot; db:&quot;create_time&quot;</span><span style="color:#ECEFF4;">\`</span><span style="color:#616E88;">                      // 帖子创建时间</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="创建索引-1" tabindex="-1"><a class="header-anchor" href="#创建索引-1"><span>创建索引</span></a></h2><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// createIndex 创建索引</span></span>
<span class="line"><span style="color:#81A1C1;">func</span><span style="color:#88C0D0;"> createIndex</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">client</span><span style="color:#81A1C1;"> *</span><span style="color:#D8DEE9FF;">elasticsearch</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">TypedClient</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">	resp</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#81A1C1;"> :=</span><span style="color:#D8DEE9;"> client</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Indices</span><span style="color:#ECEFF4;">.</span></span>
<span class="line"><span style="color:#88C0D0;">		Create</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">post</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">).</span></span>
<span class="line"><span style="color:#88C0D0;">		Do</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">context</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Background</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"><span style="color:#81A1C1;">	if</span><span style="color:#D8DEE9;"> err</span><span style="color:#81A1C1;"> !=</span><span style="color:#81A1C1;"> nil</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">		fmt</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Printf</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">create index failed, err:</span><span style="color:#EBCB8B;">%v\\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">		return</span></span>
<span class="line"><span style="color:#ECEFF4;">	}</span></span>
<span class="line"><span style="color:#D8DEE9;">	fmt</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Printf</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">index:</span><span style="color:#EBCB8B;">%#v\\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> resp</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Index</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="增加文档-1" tabindex="-1"><a class="header-anchor" href="#增加文档-1"><span>增加文档</span></a></h2><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">// indexDocument 索引文档</span></span>
<span class="line"><span style="color:#81A1C1;">func</span><span style="color:#88C0D0;"> indexDocument</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">client</span><span style="color:#81A1C1;"> *</span><span style="color:#D8DEE9FF;">elasticsearch</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">TypedClient</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;">post</span><span style="color:#D8DEE9FF;"> Post</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">	// 定义 document 结构体对象</span></span>
<span class="line"><span style="color:#616E88;">	//Post{</span></span>
<span class="line"><span style="color:#616E88;">    //  ID: 1,             // 帖子id</span></span>
<span class="line"><span style="color:#616E88;">    //    AuthorID:          // 作者id</span></span>
<span class="line"><span style="color:#616E88;">    //    CommunityID:       // 社区id</span></span>
<span class="line"><span style="color:#616E88;">    //    Status:            // 帖子状态</span></span>
<span class="line"><span style="color:#616E88;">    //    Title:             // 帖子标题</span></span>
<span class="line"><span style="color:#616E88;">    //    Content:           // 帖子内容</span></span>
<span class="line"><span style="color:#616E88;">    //    CreateTime:        //帖子创建时间</span></span>
<span class="line"><span style="color:#616E88;">	//		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">	// 添加文档</span></span>
<span class="line"><span style="color:#D8DEE9;">	resp</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#81A1C1;"> :=</span><span style="color:#D8DEE9;"> client</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Index</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">post</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">).</span></span>
<span class="line"><span style="color:#88C0D0;">		Id</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">strconv</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">FormatInt</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">post</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">ID</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 10</span><span style="color:#ECEFF4;">)).</span></span>
<span class="line"><span style="color:#88C0D0;">		Document</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">post</span><span style="color:#ECEFF4;">).</span></span>
<span class="line"><span style="color:#88C0D0;">		Do</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">context</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Background</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"><span style="color:#81A1C1;">	if</span><span style="color:#D8DEE9;"> err</span><span style="color:#81A1C1;"> !=</span><span style="color:#81A1C1;"> nil</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">		fmt</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Printf</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">indexing document failed, err:</span><span style="color:#EBCB8B;">%v\\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">		return</span></span>
<span class="line"><span style="color:#ECEFF4;">	}</span></span>
<span class="line"><span style="color:#D8DEE9;">	fmt</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Printf</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">result:</span><span style="color:#EBCB8B;">%#v\\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> resp</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Result</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="动态搜索文档" tabindex="-1"><a class="header-anchor" href="#动态搜索文档"><span>动态搜索文档</span></a></h2><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">import</span><span style="color:#ECEFF4;"> (</span></span>
<span class="line"><span style="color:#ECEFF4;">	&quot;</span><span style="color:#A3BE8C;">context</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">	&quot;</span><span style="color:#A3BE8C;">fmt</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">	&quot;</span><span style="color:#A3BE8C;">github.com/elastic/go-elasticsearch/v8</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">	&quot;</span><span style="color:#A3BE8C;">github.com/elastic/go-elasticsearch/v8/typedapi/types</span><span style="color:#ECEFF4;">&quot;</span></span>
<span class="line"><span style="color:#ECEFF4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">// searchDocument 指定条件搜索文档</span></span>
<span class="line"><span style="color:#81A1C1;">func</span><span style="color:#88C0D0;"> searchDocument</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">client</span><span style="color:#81A1C1;"> *</span><span style="color:#D8DEE9FF;">elasticsearch</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">TypedClient</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;">str</span><span style="color:#81A1C1;"> string</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9;"> data</span><span style="color:#ECEFF4;"> []</span><span style="color:#81A1C1;">string</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#616E88;">	// 搜索content中包含的文档</span></span>
<span class="line"><span style="color:#D8DEE9;">	resp</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#81A1C1;"> :=</span><span style="color:#D8DEE9;"> client</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Search</span><span style="color:#ECEFF4;">().</span></span>
<span class="line"><span style="color:#88C0D0;">		Index</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">post</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">).</span></span>
<span class="line"><span style="color:#88C0D0;">		Query</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">&amp;</span><span style="color:#D8DEE9FF;">types</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">Query</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#D8DEE9;">			MatchPhrase</span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> map</span><span style="color:#ECEFF4;">[</span><span style="color:#81A1C1;">string</span><span style="color:#ECEFF4;">]</span><span style="color:#D8DEE9FF;">types</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9FF;">MatchPhraseQuery</span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#ECEFF4;">				&quot;</span><span style="color:#A3BE8C;">content</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> {</span><span style="color:#D8DEE9;">Query</span><span style="color:#ECEFF4;">:</span><span style="color:#D8DEE9;"> str</span><span style="color:#ECEFF4;">},</span></span>
<span class="line"><span style="color:#ECEFF4;">			},</span></span>
<span class="line"><span style="color:#ECEFF4;">		}).</span></span>
<span class="line"><span style="color:#88C0D0;">		Do</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">context</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Background</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"><span style="color:#81A1C1;">	if</span><span style="color:#D8DEE9;"> err</span><span style="color:#81A1C1;"> !=</span><span style="color:#81A1C1;"> nil</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">		fmt</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Printf</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">search document failed, err:</span><span style="color:#EBCB8B;">%v\\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> err</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">		return</span></span>
<span class="line"><span style="color:#ECEFF4;">	}</span></span>
<span class="line"><span style="color:#616E88;">	//fmt.Printf(&quot;total: %d\\n&quot;, resp.Hits.Total.Value)</span></span>
<span class="line"><span style="color:#616E88;">	//// 遍历所有结果</span></span>
<span class="line"><span style="color:#81A1C1;">	for</span><span style="color:#D8DEE9;"> _</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> hit</span><span style="color:#81A1C1;"> :=</span><span style="color:#81A1C1;"> range</span><span style="color:#D8DEE9;"> resp</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Hits</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Hits</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">		fmt</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Printf</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#EBCB8B;">%s\\n</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> hit</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Source_</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#616E88;">        // 这里假设hit.Source_是字符串类型，如果实际类型不同，需要做相应的转换</span></span>
<span class="line"><span style="color:#D8DEE9;">		data</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> append</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">data</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> fmt</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">Sprintf</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#EBCB8B;">%v</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> hit</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Source_</span><span style="color:#ECEFF4;">))</span></span>
<span class="line"><span style="color:#ECEFF4;">	}</span></span>
<span class="line"><span style="color:#81A1C1;">    return</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,216);function r(E,i){return p(),n("div",null,[t,a(" more "),c])}const d=s(e,[["render",r],["__file","es基础语法.html.vue"]]),C=JSON.parse('{"path":"/note/es/es%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95.html","title":"数据同步到Elasticsearch","lang":"zh-CN","frontmatter":{"title":"数据同步到Elasticsearch","cover":"/assets/images/cover1.jpg","icon":"file","order":3,"author":"HotMilk","date":"2024-07-15T00:00:00.000Z","category":["Elasticsearch"],"tag":["elasticsearch","数据同步"],"description":"数据同步到Elasticsearch，同步写，异步写，中间件实现同步。","head":[["meta",{"property":"og:url","content":"https://reniunai.github.io/note/es/es%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95.html"}],["meta",{"property":"og:site_name","content":"热牛奶"}],["meta",{"property":"og:title","content":"数据同步到Elasticsearch"}],["meta",{"property":"og:description","content":"数据同步到Elasticsearch，同步写，异步写，中间件实现同步。"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://reniunai.github.io/assets/images/cover1.jpg"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-08-05T08:48:07.000Z"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://reniunai.github.io/assets/images/cover1.jpg"}],["meta",{"name":"twitter:image:alt","content":"数据同步到Elasticsearch"}],["meta",{"property":"article:author","content":"HotMilk"}],["meta",{"property":"article:tag","content":"elasticsearch"}],["meta",{"property":"article:tag","content":"数据同步"}],["meta",{"property":"article:published_time","content":"2024-07-15T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-08-05T08:48:07.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"数据同步到Elasticsearch\\",\\"image\\":[\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407231954667.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407231954673.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407231954684.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407231954670.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407231954677.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407231954708.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407231954291.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407231954361.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407231954484.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407231954706.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407241747556.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407241749128.png\\"],\\"datePublished\\":\\"2024-07-15T00:00:00.000Z\\",\\"dateModified\\":\\"2024-08-05T08:48:07.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"HotMilk\\"}]}"]]},"headers":[{"level":2,"title":"4、初步检索","slug":"_4、初步检索","link":"#_4、初步检索","children":[]},{"level":2,"title":"5、进阶检索","slug":"_5、进阶检索","link":"#_5、进阶检索","children":[{"level":3,"title":"1、SearchAPI","slug":"_1、searchapi","link":"#_1、searchapi","children":[]},{"level":3,"title":"2、Query DSL","slug":"_2、query-dsl","link":"#_2、query-dsl","children":[]},{"level":3,"title":"3、Mapping字段映射","slug":"_3、mapping字段映射","link":"#_3、mapping字段映射","children":[]},{"level":3,"title":"4、分词","slug":"_4、分词","link":"#_4、分词","children":[]}]},{"level":2,"title":"定义实体","slug":"定义实体","link":"#定义实体","children":[]},{"level":2,"title":"创建索引","slug":"创建索引-1","link":"#创建索引-1","children":[]},{"level":2,"title":"增加文档","slug":"增加文档-1","link":"#增加文档-1","children":[]},{"level":2,"title":"动态搜索文档","slug":"动态搜索文档","link":"#动态搜索文档","children":[]}],"git":{"createdTime":1722847687000,"updatedTime":1722847687000,"contributors":[{"name":"reniunai","email":"2843768@qq.com","commits":1}]},"readingTime":{"minutes":18.49,"words":5548},"filePathRelative":"note/es/es基础语法.md","localizedDate":"2024年7月15日","excerpt":"<p>数据同步到Elasticsearch，同步写，异步写，中间件实现同步。</p>\\n","autoDesc":true}');export{d as comp,C as data};
