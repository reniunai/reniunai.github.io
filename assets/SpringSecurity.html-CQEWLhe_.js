import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as n,d as a,a as l,e,o as p}from"./app-Bv3jHGDE.js";const o={},t=l("p",null,"SpringSecurity",-1),r=e(`<h1 id="第一章-spring-security快速入门" tabindex="-1"><a class="header-anchor" href="#第一章-spring-security快速入门"><span>第一章 Spring Security快速入门</span></a></h1><p><strong>官方文档：</strong></p><p>https://docs.spring.io/spring-security/reference/index.html</p><p>https://www.bilibili.com/video/BV14b4y1A7Wz</p><p><strong>功能：</strong></p><ul><li>身份认证（authentication）</li><li>授权（authorization）</li><li>防御常见攻击（protection against common attacks）</li></ul><p><strong>身份认证：</strong></p><ul><li>身份认证是验证<code>谁正在访问系统资源</code>，判断用户是否为合法用户。认证用户的常见方式是要求用户输入用户名和密码。</li></ul><p><strong>授权：</strong></p><ul><li>用户进行身份认证后，系统会控制<code>谁能访问哪些资源</code>，这个过程叫做授权。用户无法访问没有权限的资源。</li></ul><p><strong>防御常见攻击：</strong></p><ul><li>CSRF</li><li>HTTP Headers</li><li>HTTP Requests</li></ul><h2 id="_1、身份认证-authentication" tabindex="-1"><a class="header-anchor" href="#_1、身份认证-authentication"><span>1、身份认证（authentication）</span></a></h2><p><strong>官方代码示例：</strong><a href="https://github.com/spring-projects/spring-security-samples/tree/main" target="_blank" rel="noopener noreferrer">GitHub - spring-projects/spring-security-samples</a></p><h3 id="_1-1、创建spring-boot项目" tabindex="-1"><a class="header-anchor" href="#_1-1、创建spring-boot项目"><span>1.1、创建Spring Boot项目</span></a></h3><p>项目名：security-demo</p><p>JDK：17</p><p>SpringBoot：3.2.0（依赖了Spring Security 6.2.0）</p><p>Dependencies：Spring Web、Spring Security、Thymeleaf</p><h3 id="_1-2、创建indexcontroller" tabindex="-1"><a class="header-anchor" href="#_1-2、创建indexcontroller"><span>1.2、创建IndexController</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> com</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">atguigu</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">securitydemo</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">controller</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Controller</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> IndexController</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">GetMapping</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">/</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#8FBCBB;"> String</span><span style="color:#88C0D0;"> index</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-3、创建index-html" tabindex="-1"><a class="header-anchor" href="#_1-3、创建index-html"><span>1.3、创建index.html</span></a></h3><p>在路径resources/templates中创建index.html</p><div class="language-html line-numbers-mode" data-highlighter="shiki" data-ext="html" data-title="html" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">&lt;html</span><span style="color:#8FBCBB;"> xmlns:th</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://www.thymeleaf.org</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;head&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">  &lt;title&gt;</span><span style="color:#D8DEE9FF;">Hello Security!</span><span style="color:#81A1C1;">&lt;/title&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/head&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;body&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;h1&gt;</span><span style="color:#D8DEE9FF;">Hello Security</span><span style="color:#81A1C1;">&lt;/h1&gt;</span></span>
<span class="line"><span style="color:#616E88;">&lt;!--通过使用@{/logout}，Thymeleaf将自动处理生成正确的URL，以适应当前的上下文路径。</span></span>
<span class="line"><span style="color:#616E88;">这样，无论应用程序部署在哪个上下文路径下，生成的URL都能正确地指向注销功能。--&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;a</span><span style="color:#8FBCBB;"> th:href</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">@{/logout}</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;</span><span style="color:#D8DEE9FF;">Log Out</span><span style="color:#81A1C1;">&lt;/a&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/body&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/html&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-4、启动项目测试controller" tabindex="-1"><a class="header-anchor" href="#_1-4、启动项目测试controller"><span>1.4、启动项目测试Controller</span></a></h3><p>浏览器中访问：http://localhost:8080/</p><p>**浏览器自动跳转到登录页面：**http://localhost:8080/login</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244594.png" alt="image-20230410140908841" tabindex="0" loading="lazy"><figcaption>image-20230410140908841</figcaption></figure><p>输入用户名：user</p><p>输入密码：在控制台的启动日志中查找初始的默认密码</p><p>点击&quot;Sign in&quot;进行登录，浏览器就跳转到了index页面</p><h3 id="_1-5、注意事项" tabindex="-1"><a class="header-anchor" href="#_1-5、注意事项"><span>1.5、注意事项</span></a></h3><h4 id="_1-5-1、-logout-的作用" tabindex="-1"><a class="header-anchor" href="#_1-5-1、-logout-的作用"><span>1.5.1、@{/logout}的作用</span></a></h4><p>通过使用@{/logout}，Thymeleaf将自动处理生成正确的URL，以适应当前的上下文路径。这样，无论应用程序部署在哪个上下文路径下，生成的URL都能正确地指向注销功能。</p><p>例如：如果我们在配置文件中添加如下内容</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" data-title="yaml" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#A3BE8C;">server.servlet.context-path=/demo</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>那么@{/logout}可以自动处理url为正确的相对路径</p><p>但是如果是普通的/logout，路径就会不正确</p><h4 id="_1-5-2、页面样式无法加载的问题" tabindex="-1"><a class="header-anchor" href="#_1-5-2、页面样式无法加载的问题"><span>1.5.2、页面样式无法加载的问题</span></a></h4><p>页面样式bootstrap.min.css是一个CDN地址，需要通过科学上网的方式访问</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244633.png" alt="image-20231130152247055" tabindex="0" loading="lazy"><figcaption>image-20231130152247055</figcaption></figure><p>否则你的登录页会加载很久，并且看到的页面是这样的（登录按钮没有样式文件渲染，但是不影响登录功能的执行）</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244637.png" alt="image-20231130152345471" tabindex="0" loading="lazy"><figcaption>image-20231130152345471</figcaption></figure><h3 id="_1-6、spring-security默认做了什么" tabindex="-1"><a class="header-anchor" href="#_1-6、spring-security默认做了什么"><span>1.6、Spring Security默认做了什么</span></a></h3><ul><li>保护应用程序URL，要求对应用程序的任何交互进行身份验证。</li><li>程序启动时生成一个默认用户“user”。</li><li>生成一个默认的随机密码，并将此密码记录在控制台上。</li><li>生成默认的登录表单和注销页面。</li><li>提供基于表单的登录和注销流程。</li><li>对于Web请求，重定向到登录页面；</li><li>对于服务请求，返回401未经授权。</li><li>处理跨站请求伪造（CSRF）攻击。</li><li>处理会话劫持攻击。</li><li>写入Strict-Transport-Security以确保HTTPS。</li><li>写入X-Content-Type-Options以处理嗅探攻击。</li><li>写入Cache Control头来保护经过身份验证的资源。</li><li>写入X-Frame-Options以处理点击劫持攻击。</li></ul><h2 id="_2、spring-security-的底层原理" tabindex="-1"><a class="header-anchor" href="#_2、spring-security-的底层原理"><span>2、Spring Security 的底层原理</span></a></h2><p><strong>官方文档：</strong><a href="https://docs.spring.io/spring-security/reference/servlet/architecture.html" target="_blank" rel="noopener noreferrer">Spring Security的底层原理</a></p><p>Spring Security之所以默认帮助我们做了那么多事情，它的底层原理是传统的<code>Servlet过滤器</code></p><h3 id="_2-1、filter" tabindex="-1"><a class="header-anchor" href="#_2-1、filter"><span>2.1、Filter</span></a></h3><p>下图展示了处理一个Http请求时，过滤器和Servlet的工作流程：</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244640.png" alt="filterchain" tabindex="0" loading="lazy"><figcaption>filterchain</figcaption></figure><p>因此我们可以在过滤器中对请求进行修改或增强。</p><h3 id="_2-2、delegatingfilterproxy" tabindex="-1"><a class="header-anchor" href="#_2-2、delegatingfilterproxy"><span>2.2、DelegatingFilterProxy</span></a></h3><p>DelegatingFilterProxy 是 Spring Security 提供的一个 Filter 实现，可以在 Servlet 容器和 Spring 容器之间建立桥梁。通过使用 DelegatingFilterProxy，这样就可以将Servlet容器中的 Filter 实例放在 Spring 容器中管理。</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244656.png" alt="delegatingfilterproxy" tabindex="0" loading="lazy"><figcaption>delegatingfilterproxy</figcaption></figure><h3 id="_2-3、filterchainproxy" tabindex="-1"><a class="header-anchor" href="#_2-3、filterchainproxy"><span>2.3、FilterChainProxy</span></a></h3><p>复杂的业务中不可能只有一个过滤器。因此FilterChainProxy是Spring Security提供的一个特殊的Filter，它允许通过SecurityFilterChain将过滤器的工作委托给多个Bean Filter实例。</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244682.png" alt="filterchainproxy" tabindex="0" loading="lazy"><figcaption>filterchainproxy</figcaption></figure><h3 id="_2-4、securityfilterchain" tabindex="-1"><a class="header-anchor" href="#_2-4、securityfilterchain"><span>2.4、SecurityFilterChain</span></a></h3><p>SecurityFilterChain 被 FilterChainProxy 使用，负责查找当前的请求需要执行的Security Filter列表。</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244274.png" alt="securityfilterchain" tabindex="0" loading="lazy"><figcaption>securityfilterchain</figcaption></figure><h3 id="_2-5、multiple-securityfilterchain" tabindex="-1"><a class="header-anchor" href="#_2-5、multiple-securityfilterchain"><span>2.5、Multiple SecurityFilterChain</span></a></h3><p>可以有多个SecurityFilterChain的配置，FilterChainProxy决定使用哪个SecurityFilterChain。如果请求的URL是/api/messages/，它首先匹配SecurityFilterChain0的模式/api/**，因此只调用SecurityFilterChain 0。假设没有其他SecurityFilterChain实例匹配，那么将调用SecurityFilterChain n。</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244341.png" alt="multi securityfilterchain" tabindex="0" loading="lazy"><figcaption>multi securityfilterchain</figcaption></figure><h2 id="_3、程序的启动和运行" tabindex="-1"><a class="header-anchor" href="#_3、程序的启动和运行"><span>3、程序的启动和运行</span></a></h2><h3 id="_3-1、defaultsecurityfilterchain" tabindex="-1"><a class="header-anchor" href="#_3-1、defaultsecurityfilterchain"><span>3.1、DefaultSecurityFilterChain</span></a></h3><p>SecurityFilterChain接口的实现，加载了默认的16个Filter</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244442.png" alt="image-20231204230216259" tabindex="0" loading="lazy"><figcaption>image-20231204230216259</figcaption></figure><h3 id="_3-2、securityproperties" tabindex="-1"><a class="header-anchor" href="#_3-2、securityproperties"><span>3.2、SecurityProperties</span></a></h3><p>默认情况下Spring Security将初始的用户名和密码存在了SecurityProperties类中。这个类中有一个静态内部类User，配置了默认的用户名（name = &quot;user&quot;）和密码（password = uuid）</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244812.png" alt="image-20231205164049257" tabindex="0" loading="lazy"><figcaption>image-20231205164049257</figcaption></figure><p>我们也可以将用户名、密码配置在SpringBoot的配置文件中：在application.properties中配置自定义用户名和密码</p><div class="language-properties line-numbers-mode" data-highlighter="shiki" data-ext="properties" data-title="properties" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">spring.security.user.name</span><span style="color:#ECEFF4;">=</span><span style="color:#D8DEE9FF;">user</span></span>
<span class="line"><span style="color:#81A1C1;">spring.security.user.password</span><span style="color:#ECEFF4;">=</span><span style="color:#D8DEE9FF;">123</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="第二章-spring-security自定义配置" tabindex="-1"><a class="header-anchor" href="#第二章-spring-security自定义配置"><span>第二章 Spring Security自定义配置</span></a></h1><h2 id="_1、基于内存的用户认证" tabindex="-1"><a class="header-anchor" href="#_1、基于内存的用户认证"><span>1、基于内存的用户认证</span></a></h2><h3 id="_1-1、创建自定义配置" tabindex="-1"><a class="header-anchor" href="#_1-1、创建自定义配置"><span>1.1、创建自定义配置</span></a></h3><p>实际开发的过程中，我们需要应用程序更加灵活，可以在SpringSecurity中创建自定义配置文件</p><p><strong>官方文档：</strong><a href="https://docs.spring.io/spring-security/reference/servlet/configuration/java.html" target="_blank" rel="noopener noreferrer">Java自定义配置</a></p><p><strong>UserDetailsService</strong>用来管理用户信息，<strong>InMemoryUserDetailsManager</strong>是UserDetailsService的一个实现，用来管理基于内存的用户信息。</p><p>创建一个WebSecurityConfig文件：</p><p>定义一个@Bean，类型是UserDetailsService，实现是InMemoryUserDetailsManager</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> com</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">atguigu</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">securitydemo</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">config</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Configuration</span><span style="color:#616E88;">  //配置类</span></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">EnableWebSecurity</span><span style="color:#616E88;">//Spring项目总需要添加此注解，SpringBoot项目中不需要</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> WebSecurityConfig</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Bean</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#8FBCBB;"> UserDetailsService</span><span style="color:#88C0D0;"> userDetailsService</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        InMemoryUserDetailsManager</span><span style="color:#D8DEE9;"> manager</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> InMemoryUserDetailsManager</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        manager</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createUser</span><span style="color:#ECEFF4;">(</span><span style="color:#616E88;"> //此行设置断点可以查看创建的user对象</span></span>
<span class="line"><span style="color:#8FBCBB;">            User</span></span>
<span class="line"><span style="color:#ECEFF4;">            .</span><span style="color:#88C0D0;">withDefaultPasswordEncoder</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#ECEFF4;">            .</span><span style="color:#88C0D0;">username</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">huan</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#616E88;"> //自定义用户名</span></span>
<span class="line"><span style="color:#ECEFF4;">            .</span><span style="color:#88C0D0;">password</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">password</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#616E88;"> //自定义密码</span></span>
<span class="line"><span style="color:#ECEFF4;">            .</span><span style="color:#88C0D0;">roles</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">USER</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#616E88;"> //自定义角色</span></span>
<span class="line"><span style="color:#ECEFF4;">            .</span><span style="color:#88C0D0;">build</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#ECEFF4;">        )</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#D8DEE9FF;"> manager</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**测试：**使用用户名huan，密码password登录</p><h3 id="_1-2、基于内存的用户认证流程" tabindex="-1"><a class="header-anchor" href="#_1-2、基于内存的用户认证流程"><span>1.2、基于内存的用户认证流程</span></a></h3><ul><li>程序启动时： <ul><li>创建<code>InMemoryUserDetailsManager</code>对象</li><li>创建<code>User</code>对象，封装用户名密码</li><li>使用InMemoryUserDetailsManager<code>将User存入内存</code></li></ul></li><li>校验用户时： <ul><li>SpringSecurity自动使用<code>InMemoryUserDetailsManager</code>的<code>loadUserByUsername</code>方法从<code>内存中</code>获取User对象</li><li>在<code>UsernamePasswordAuthenticationFilter</code>过滤器中的<code>attemptAuthentication</code>方法中将用户输入的用户名密码和从内存中获取到的用户信息进行比较，进行用户认证</li></ul></li></ul><h2 id="_2、基于数据库的数据源" tabindex="-1"><a class="header-anchor" href="#_2、基于数据库的数据源"><span>2、基于数据库的数据源</span></a></h2><h3 id="_2-1、sql" tabindex="-1"><a class="header-anchor" href="#_2-1、sql"><span>2.1、SQL</span></a></h3><p>创建三个数据库表并插入测试数据</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">-- 创建数据库</span></span>
<span class="line"><span style="color:#81A1C1;">CREATE</span><span style="color:#81A1C1;"> DATABASE</span><span style="color:#ECEFF4;"> \`</span><span style="color:#A3BE8C;">security-demo</span><span style="color:#ECEFF4;">\`</span><span style="color:#D8DEE9FF;">;</span></span>
<span class="line"><span style="color:#81A1C1;">USE</span><span style="color:#ECEFF4;"> \`</span><span style="color:#A3BE8C;">security-demo</span><span style="color:#ECEFF4;">\`</span><span style="color:#D8DEE9FF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">-- 创建用户表</span></span>
<span class="line"><span style="color:#81A1C1;">CREATE</span><span style="color:#81A1C1;"> TABLE</span><span style="color:#D8DEE9FF;"> \`</span><span style="color:#88C0D0;">user</span><span style="color:#D8DEE9FF;">\`(</span></span>
<span class="line"><span style="color:#ECEFF4;">	\`</span><span style="color:#A3BE8C;">id</span><span style="color:#ECEFF4;">\`</span><span style="color:#81A1C1;"> INT</span><span style="color:#81A1C1;"> NOT NULL</span><span style="color:#D8DEE9FF;"> AUTO_INCREMENT </span><span style="color:#81A1C1;">PRIMARY KEY</span><span style="color:#D8DEE9FF;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">	\`</span><span style="color:#A3BE8C;">username</span><span style="color:#ECEFF4;">\`</span><span style="color:#81A1C1;"> VARCHAR</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">50</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">DEFAULT</span><span style="color:#81A1C1;"> NULL</span><span style="color:#D8DEE9FF;"> ,</span></span>
<span class="line"><span style="color:#ECEFF4;">	\`</span><span style="color:#A3BE8C;">password</span><span style="color:#ECEFF4;">\`</span><span style="color:#81A1C1;"> VARCHAR</span><span style="color:#D8DEE9FF;">(</span><span style="color:#B48EAD;">500</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">DEFAULT</span><span style="color:#81A1C1;"> NULL</span><span style="color:#D8DEE9FF;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">	\`</span><span style="color:#A3BE8C;">enabled</span><span style="color:#ECEFF4;">\`</span><span style="color:#81A1C1;"> BOOLEAN</span><span style="color:#81A1C1;"> NOT NULL</span></span>
<span class="line"><span style="color:#D8DEE9FF;">);</span></span>
<span class="line"><span style="color:#616E88;">-- 唯一索引</span></span>
<span class="line"><span style="color:#81A1C1;">CREATE</span><span style="color:#81A1C1;"> UNIQUE INDEX</span><span style="color:#D8DEE9FF;"> \`</span><span style="color:#88C0D0;">user_username_uindex</span><span style="color:#D8DEE9FF;">\` </span><span style="color:#81A1C1;">ON</span><span style="color:#ECEFF4;"> \`</span><span style="color:#A3BE8C;">user</span><span style="color:#ECEFF4;">\`</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">\`</span><span style="color:#A3BE8C;">username</span><span style="color:#ECEFF4;">\`</span><span style="color:#D8DEE9FF;">); </span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">-- 插入用户数据(密码是 &quot;abc&quot; )</span></span>
<span class="line"><span style="color:#81A1C1;">INSERT INTO</span><span style="color:#ECEFF4;"> \`</span><span style="color:#A3BE8C;">user</span><span style="color:#ECEFF4;">\`</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#ECEFF4;">\`</span><span style="color:#A3BE8C;">username</span><span style="color:#ECEFF4;">\`</span><span style="color:#D8DEE9FF;">, </span><span style="color:#ECEFF4;">\`</span><span style="color:#A3BE8C;">password</span><span style="color:#ECEFF4;">\`</span><span style="color:#D8DEE9FF;">, </span><span style="color:#ECEFF4;">\`</span><span style="color:#A3BE8C;">enabled</span><span style="color:#ECEFF4;">\`</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">VALUES</span></span>
<span class="line"><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">admin</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">, </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">{bcrypt}$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">, TRUE),</span></span>
<span class="line"><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">Helen</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">, </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">{bcrypt}$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">, TRUE),</span></span>
<span class="line"><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">Tom</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">, </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">{bcrypt}$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">, TRUE);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2、引入依赖" tabindex="-1"><a class="header-anchor" href="#_2-2、引入依赖"><span>2.2、引入依赖</span></a></h3><div class="language-xml line-numbers-mode" data-highlighter="shiki" data-ext="xml" data-title="xml" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">&lt;dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;groupId&gt;</span><span style="color:#D8DEE9FF;">mysql</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">mysql-connector-java</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;version&gt;</span><span style="color:#D8DEE9FF;">8.0.30</span><span style="color:#81A1C1;">&lt;/version&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/dependency&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">&lt;dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;groupId&gt;</span><span style="color:#D8DEE9FF;">com.baomidou</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">mybatis-plus-boot-starter</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;version&gt;</span><span style="color:#D8DEE9FF;">3.5.4.1</span><span style="color:#81A1C1;">&lt;/version&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;exclusions&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;exclusion&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">            &lt;groupId&gt;</span><span style="color:#D8DEE9FF;">org.mybatis</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">            &lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">mybatis-spring</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;/exclusion&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;/exclusions&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/dependency&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">&lt;dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;groupId&gt;</span><span style="color:#D8DEE9FF;">org.mybatis</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">mybatis-spring</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;version&gt;</span><span style="color:#D8DEE9FF;">3.0.3</span><span style="color:#81A1C1;">&lt;/version&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/dependency&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">&lt;dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;groupId&gt;</span><span style="color:#D8DEE9FF;">org.projectlombok</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">lombok</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/dependency&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3、配置数据源" tabindex="-1"><a class="header-anchor" href="#_2-3、配置数据源"><span>2.3、配置数据源</span></a></h3><div class="language-properties line-numbers-mode" data-highlighter="shiki" data-ext="properties" data-title="properties" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">#MySQL数据源</span></span>
<span class="line"><span style="color:#81A1C1;">spring.datasource.driver-class-name</span><span style="color:#ECEFF4;">=</span><span style="color:#D8DEE9FF;">com.mysql.cj.jdbc.Driver</span></span>
<span class="line"><span style="color:#81A1C1;">spring.datasource.url</span><span style="color:#ECEFF4;">=</span><span style="color:#D8DEE9FF;">jdbc:mysql://localhost:3306/security-demo</span></span>
<span class="line"><span style="color:#81A1C1;">spring.datasource.username</span><span style="color:#ECEFF4;">=</span><span style="color:#D8DEE9FF;">root</span></span>
<span class="line"><span style="color:#81A1C1;">spring.datasource.password</span><span style="color:#ECEFF4;">=</span><span style="color:#D8DEE9FF;">123456</span></span>
<span class="line"><span style="color:#616E88;">#SQL日志</span></span>
<span class="line"><span style="color:#81A1C1;">mybatis-plus.configuration.log-impl</span><span style="color:#ECEFF4;">=</span><span style="color:#D8DEE9FF;">org.apache.ibatis.logging.stdout.StdOutImpl</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4、实体类" tabindex="-1"><a class="header-anchor" href="#_2-4、实体类"><span>2.4、实体类</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> com</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">atguigu</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">securitydemo</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">entity</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Data</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> User</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">TableId</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">id</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> type</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> IdType</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">AUTO</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#8FBCBB;"> Integer</span><span style="color:#D8DEE9;"> id</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#8FBCBB;"> String</span><span style="color:#D8DEE9;"> username</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#8FBCBB;"> String</span><span style="color:#D8DEE9;"> password</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#8FBCBB;"> Boolean</span><span style="color:#D8DEE9;"> enabled</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-5、mapper" tabindex="-1"><a class="header-anchor" href="#_2-5、mapper"><span>2.5、Mapper</span></a></h3><p>接口</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> com</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">atguigu</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">securitydemo</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">mapper</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Mapper</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> interface</span><span style="color:#8FBCBB;"> UserMapper</span><span style="color:#81A1C1;"> extends</span><span style="color:#8FBCBB;font-weight:bold;"> BaseMapper</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">User</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>xml</p><p>resources/mapper/UserMapper.xml</p><div class="language-xml line-numbers-mode" data-highlighter="shiki" data-ext="xml" data-title="xml" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">&lt;?</span><span style="color:#5E81AC;">xml</span><span style="color:#8FBCBB;"> version</span><span style="color:#D8DEE9FF;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">1.0</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;"> encoding</span><span style="color:#D8DEE9FF;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">UTF-8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">?&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;!</span><span style="color:#5E81AC;">DOCTYPE</span><span style="color:#81A1C1;"> mapper</span><span style="color:#D8DEE9FF;"> PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span><span style="color:#81A1C1;">&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;mapper</span><span style="color:#8FBCBB;"> namespace</span><span style="color:#D8DEE9FF;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">com.atguigu.securitydemo.mapper.UserMapper</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">&lt;/mapper&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-6、service" tabindex="-1"><a class="header-anchor" href="#_2-6、service"><span>2.6、Service</span></a></h3><p>接口</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> com</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">atguigu</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">securitydemo</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">service</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> interface</span><span style="color:#8FBCBB;"> UserService</span><span style="color:#81A1C1;"> extends</span><span style="color:#8FBCBB;font-weight:bold;"> IService</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">User</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> com</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">atguigu</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">securitydemo</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">service</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">impl</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Service</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> UserServiceImpl</span><span style="color:#81A1C1;"> extends</span><span style="color:#8FBCBB;font-weight:bold;"> ServiceImpl</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">UserMapper</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> User</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#81A1C1;"> implements</span><span style="color:#8FBCBB;font-weight:bold;"> UserService</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-7、controller" tabindex="-1"><a class="header-anchor" href="#_2-7、controller"><span>2.7、Controller</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> com</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">atguigu</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">securitydemo</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">controller</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">RestController</span></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">RequestMapping</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">/user</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> UserController</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Resource</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#8FBCBB;"> UserService</span><span style="color:#D8DEE9;"> userService</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">GetMapping</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">/list</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#8FBCBB;"> List</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">User</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#88C0D0;"> getList</span><span style="color:#ECEFF4;">(){</span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#D8DEE9;"> userService</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">list</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>测试：</strong><a href="http://localhost:8080/demo/user/list" target="_blank" rel="noopener noreferrer">localhost:8080/demo/user/list</a></p><h2 id="_3、基于数据库的用户认证" tabindex="-1"><a class="header-anchor" href="#_3、基于数据库的用户认证"><span>3、基于数据库的用户认证</span></a></h2><h3 id="_3-1、基于数据库的用户认证流程" tabindex="-1"><a class="header-anchor" href="#_3-1、基于数据库的用户认证流程"><span>3.1、基于数据库的用户认证流程</span></a></h3><ul><li>程序启动时： <ul><li>创建<code>DBUserDetailsManager</code>类，实现接口 UserDetailsManager, UserDetailsPasswordService</li><li>在应用程序中初始化这个类的对象</li></ul></li><li>校验用户时： <ul><li>SpringSecurity自动使用<code>DBUserDetailsManager</code>的<code>loadUserByUsername</code>方法从<code>数据库中</code>获取User对象</li><li>在<code>UsernamePasswordAuthenticationFilter</code>过滤器中的<code>attemptAuthentication</code>方法中将用户输入的用户名密码和从数据库中获取到的用户信息进行比较，进行用户认证</li></ul></li></ul><h3 id="_3-2、定义dbuserdetailsmanager" tabindex="-1"><a class="header-anchor" href="#_3-2、定义dbuserdetailsmanager"><span>3.2、定义DBUserDetailsManager</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> com</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">atguigu</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">securitydemo</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">config</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> DBUserDetailsManager</span><span style="color:#81A1C1;"> implements</span><span style="color:#8FBCBB;font-weight:bold;"> UserDetailsManager</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;font-weight:bold;"> UserDetailsPasswordService</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Resource</span></span>
<span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#8FBCBB;"> UserMapper</span><span style="color:#D8DEE9;"> userMapper</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#8FBCBB;"> UserDetails</span><span style="color:#88C0D0;"> loadUserByUsername</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#D8DEE9;"> username</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> UsernameNotFoundException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8FBCBB;">        QueryWrapper</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">User</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> queryWrapper</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> QueryWrapper</span><span style="color:#ECEFF4;">&lt;&gt;()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        queryWrapper</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">eq</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">username</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> username</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#8FBCBB;">        User</span><span style="color:#D8DEE9;"> user</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> userMapper</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">selectOne</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">queryWrapper</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">user </span><span style="color:#81A1C1;">==</span><span style="color:#81A1C1;"> null</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">            throw</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> UsernameNotFoundException</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">username</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">            Collection</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">GrantedAuthority</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> authorities</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> ArrayList</span><span style="color:#ECEFF4;">&lt;&gt;()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">            return</span><span style="color:#81A1C1;"> new</span><span style="color:#D8DEE9FF;"> org</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">springframework</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">security</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">core</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">userdetails</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">User</span><span style="color:#ECEFF4;">(</span></span>
<span class="line"><span style="color:#D8DEE9;">                    user</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getUsername</span><span style="color:#ECEFF4;">(),</span></span>
<span class="line"><span style="color:#D8DEE9;">                    user</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getPassword</span><span style="color:#ECEFF4;">(),</span></span>
<span class="line"><span style="color:#D8DEE9;">                    user</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getEnabled</span><span style="color:#ECEFF4;">(),</span></span>
<span class="line"><span style="color:#81A1C1;">                    true</span><span style="color:#ECEFF4;">,</span><span style="color:#616E88;"> //用户账号是否过期</span></span>
<span class="line"><span style="color:#81A1C1;">                    true</span><span style="color:#ECEFF4;">,</span><span style="color:#616E88;"> //用户凭证是否过期</span></span>
<span class="line"><span style="color:#81A1C1;">                    true</span><span style="color:#ECEFF4;">,</span><span style="color:#616E88;"> //用户是否未被锁定</span></span>
<span class="line"><span style="color:#D8DEE9FF;">                    authorities</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> //权限列表</span></span>
<span class="line"><span style="color:#ECEFF4;">        }</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#8FBCBB;"> UserDetails</span><span style="color:#88C0D0;"> updatePassword</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">UserDetails</span><span style="color:#D8DEE9;"> user</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> String</span><span style="color:#D8DEE9;"> newPassword</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#81A1C1;"> null;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> createUser</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">UserDetails</span><span style="color:#D8DEE9;"> user</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> updateUser</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">UserDetails</span><span style="color:#D8DEE9;"> user</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> deleteUser</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#D8DEE9;"> username</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> changePassword</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#D8DEE9;"> oldPassword</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> String</span><span style="color:#D8DEE9;"> newPassword</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> boolean</span><span style="color:#88C0D0;"> userExists</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#D8DEE9;"> username</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#81A1C1;"> false;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3、初始化userdetailsservice" tabindex="-1"><a class="header-anchor" href="#_3-3、初始化userdetailsservice"><span>3.3、初始化UserDetailsService</span></a></h3><p>修改WebSecurityConfig中的userDetailsService方法如下</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Bean</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#8FBCBB;"> UserDetailsService</span><span style="color:#88C0D0;"> userDetailsService</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">    DBUserDetailsManager</span><span style="color:#D8DEE9;"> manager</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> DBUserDetailsManager</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#D8DEE9FF;"> manager</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>或者直接在DBUserDetailsManager类上添加@Component注解</strong></p><p>**测试：**使用数据库中配置的用户名和密码进行登录</p><h2 id="_4、springsecurity的默认配置" tabindex="-1"><a class="header-anchor" href="#_4、springsecurity的默认配置"><span>4、SpringSecurity的默认配置</span></a></h2><p>在WebSecurityConfig中添加如下配置</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Bean</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#8FBCBB;"> SecurityFilterChain</span><span style="color:#88C0D0;"> filterChain</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">HttpSecurity</span><span style="color:#D8DEE9FF;"> http</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;"> throws Exception </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#616E88;">    //authorizeRequests()：开启授权保护</span></span>
<span class="line"><span style="color:#616E88;">    //anyRequest()：对所有请求开启授权保护</span></span>
<span class="line"><span style="color:#616E88;">    //authenticated()：已认证请求会自动被授权</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    http</span></span>
<span class="line"><span style="color:#ECEFF4;">        .</span><span style="color:#88C0D0;">authorizeRequests</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">authorize </span><span style="color:#8FBCBB;">-&gt;</span><span style="color:#D8DEE9;"> authorize</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">anyRequest</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">authenticated</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"><span style="color:#ECEFF4;">        .</span><span style="color:#88C0D0;">formLogin</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">withDefaults</span><span style="color:#ECEFF4;">())</span><span style="color:#616E88;">//表单授权方式</span></span>
<span class="line"><span style="color:#ECEFF4;">        .</span><span style="color:#88C0D0;">httpBasic</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">withDefaults</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//基本授权方式</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#D8DEE9;"> http</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">build</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5、添加用户功能" tabindex="-1"><a class="header-anchor" href="#_5、添加用户功能"><span>5、添加用户功能</span></a></h2><h3 id="_5-1、controller" tabindex="-1"><a class="header-anchor" href="#_5-1、controller"><span>5.1、Controller</span></a></h3><p>UserController中添加方法</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">PostMapping</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">/add</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> add</span><span style="color:#ECEFF4;">(@</span><span style="color:#D08770;">RequestBody</span><span style="color:#8FBCBB;"> User</span><span style="color:#D8DEE9FF;"> user</span><span style="color:#ECEFF4;">){</span></span>
<span class="line"><span style="color:#D8DEE9;">    userService</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">saveUserDetails</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">user</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2、service" tabindex="-1"><a class="header-anchor" href="#_5-2、service"><span>5.2、Service</span></a></h3><p>UserService接口中添加方法</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">void</span><span style="color:#88C0D0;"> saveUserDetails</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">User</span><span style="color:#D8DEE9FF;"> user</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>UserServiceImpl实现中添加方法</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Resource</span></span>
<span class="line"><span style="color:#81A1C1;">private</span><span style="color:#8FBCBB;"> DBUserDetailsManager</span><span style="color:#D8DEE9;"> dbUserDetailsManager</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> saveUserDetails</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">User</span><span style="color:#D8DEE9FF;"> user</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8FBCBB;">    UserDetails</span><span style="color:#D8DEE9;"> userDetails</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> org</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">springframework</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">security</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">core</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">userdetails</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">User</span></span>
<span class="line"><span style="color:#ECEFF4;">            .</span><span style="color:#88C0D0;">withDefaultPasswordEncoder</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#ECEFF4;">            .</span><span style="color:#88C0D0;">username</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">user</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getUsername</span><span style="color:#ECEFF4;">())</span><span style="color:#616E88;"> //自定义用户名</span></span>
<span class="line"><span style="color:#ECEFF4;">            .</span><span style="color:#88C0D0;">password</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">user</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getPassword</span><span style="color:#ECEFF4;">())</span><span style="color:#616E88;"> //自定义密码</span></span>
<span class="line"><span style="color:#ECEFF4;">            .</span><span style="color:#88C0D0;">build</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    dbUserDetailsManager</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createUser</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">userDetails</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3、修改配置" tabindex="-1"><a class="header-anchor" href="#_5-3、修改配置"><span>5.3、修改配置</span></a></h3><p>DBUserDetailsManager中添加方法</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> createUser</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">UserDetails</span><span style="color:#D8DEE9FF;"> userDetails</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8FBCBB;">    User</span><span style="color:#D8DEE9;"> user</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> User</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    user</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setUsername</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">userDetails</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getUsername</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    user</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setPassword</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">userDetails</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getPassword</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    user</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setEnabled</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">true</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    userMapper</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">insert</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">user</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4、使用swagger测试" tabindex="-1"><a class="header-anchor" href="#_5-4、使用swagger测试"><span>5.4、使用Swagger测试</span></a></h3><p>pom中添加配置用于测试</p><div class="language-xml line-numbers-mode" data-highlighter="shiki" data-ext="xml" data-title="xml" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">&lt;!--swagger测试--&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;groupId&gt;</span><span style="color:#D8DEE9FF;">com.github.xiaoymin</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">knife4j-openapi3-jakarta-spring-boot-starter</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;version&gt;</span><span style="color:#D8DEE9FF;">4.1.0</span><span style="color:#81A1C1;">&lt;/version&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/dependency&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**Swagger测试地址：**http://localhost:8080/demo/doc.html</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244907.png" alt="image-20231206022701725" tabindex="0" loading="lazy"><figcaption>image-20231206022701725</figcaption></figure><h3 id="_5-5、关闭csrf攻击防御" tabindex="-1"><a class="header-anchor" href="#_5-5、关闭csrf攻击防御"><span>5.5、关闭csrf攻击防御</span></a></h3><p>默认情况下SpringSecurity开启了csrf攻击防御的功能，这要求请求参数中必须有一个隐藏的**_csrf**字段，如下：</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244173.png" alt="image-20231206023030864" tabindex="0" loading="lazy"><figcaption>image-20231206023030864</figcaption></figure><p>在filterChain方法中添加如下代码，关闭csrf攻击防御</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">//关闭csrf攻击防御</span></span>
<span class="line"><span style="color:#D8DEE9;">http</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">csrf</span><span style="color:#ECEFF4;">((</span><span style="color:#D8DEE9FF;">csrf</span><span style="color:#ECEFF4;">)</span><span style="color:#8FBCBB;"> -&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    csrf</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">disable</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">})</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6、密码加密算法" tabindex="-1"><a class="header-anchor" href="#_6、密码加密算法"><span>6、密码加密算法</span></a></h2><p><strong>参考文档：</strong><a href="https://docs.spring.io/spring-security/reference/features/authentication/password-storage.html" target="_blank" rel="noopener noreferrer">Password Storage :: Spring Security</a></p><h3 id="_6-1、密码加密方式" tabindex="-1"><a class="header-anchor" href="#_6-1、密码加密方式"><span>6.1、密码加密方式</span></a></h3><p><strong>明文密码：</strong></p><p>最初，密码以明文形式存储在数据库中。但是恶意用户可能会通过SQL注入等手段获取到明文密码，或者程序员将数据库数据泄露的情况也可能发生。</p><p><strong>Hash算法：</strong></p><p>Spring Security的<code>PasswordEncoder</code>接口用于对密码进行<code>单向转换</code>，从而将密码安全地存储。对密码单向转换需要用到<code>哈希算法</code>，例如MD5、SHA-256、SHA-512等，哈希算法是单向的，<code>只能加密，不能解密</code>。</p><p>因此，<code>数据库中存储的是单向转换后的密码</code>，Spring Security在进行用户身份验证时需要将用户输入的密码进行单向转换，然后与数据库的密码进行比较。</p><p>因此，如果发生数据泄露，只有密码的单向哈希会被暴露。由于哈希是单向的，并且在给定哈希的情况下只能通过<code>暴力破解的方式猜测密码</code>。</p><p><strong>彩虹表：</strong></p><p>恶意用户创建称为<code>彩虹表</code>的查找表。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>彩虹表就是一个庞大的、针对各种可能的字母组合预先生成的哈希值集合，有了它可以快速破解各类密码。越是复杂的密码，需要的彩虹表就越大，主流的彩虹表都是100G以上，目前主要的算法有LM, NTLM, MD5, SHA1, MYSQLSHA1, HALFLMCHALL, NTLMCHALL, ORACLE-SYSTEM, MD5-HALF。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>加盐密码：</strong></p><p>为了减轻彩虹表的效果，开发人员开始使用加盐密码。不再只使用密码作为哈希函数的输入，而是为每个用户的密码生成随机字节（称为盐）。盐和用户的密码将一起经过哈希函数运算，生成一个唯一的哈希。盐将以明文形式与用户的密码一起存储。然后，当用户尝试进行身份验证时，盐和用户输入的密码一起经过哈希函数运算，再与存储的密码进行比较。唯一的盐意味着彩虹表不再有效，因为对于每个盐和密码的组合，哈希都是不同的。</p><p><strong>自适应单向函数：</strong></p><p>随着硬件的不断发展，加盐哈希也不再安全。原因是，计算机可以每秒执行数十亿次哈希计算。这意味着我们可以轻松地破解每个密码。</p><p>现在，开发人员开始使用自适应单向函数来存储密码。使用自适应单向函数验证密码时，<code>故意占用资源（故意使用大量的CPU、内存或其他资源）</code>。自适应单向函数允许配置一个<code>“工作因子”</code>，随着硬件的改进而增加。我们建议将“工作因子”调整到系统中验证密码需要约一秒钟的时间。这种权衡是为了<code>让攻击者难以破解密码</code>。</p><p>自适应单向函数包括<code>bcrypt、PBKDF2、scrypt和argon2</code>。</p><h3 id="_6-2、passwordencoder" tabindex="-1"><a class="header-anchor" href="#_6-2、passwordencoder"><span>6.2、PasswordEncoder</span></a></h3><p><strong>BCryptPasswordEncoder</strong></p><p>使用广泛支持的bcrypt算法来对密码进行哈希。为了增加对密码破解的抵抗力，bcrypt故意设计得较慢。和其他自适应单向函数一样，应该调整其参数，使其在您的系统上验证一个密码大约需要1秒的时间。BCryptPasswordEncoder的默认实现使用强度10。建议您在自己的系统上调整和测试强度参数，以便验证密码时大约需要1秒的时间。</p><p><strong>Argon2PasswordEncoder</strong></p><p>使用Argon2算法对密码进行哈希处理。Argon2是密码哈希比赛的获胜者。为了防止在自定义硬件上进行密码破解，Argon2是一种故意缓慢的算法，需要大量内存。与其他自适应单向函数一样，它应该在您的系统上调整为大约1秒来验证一个密码。当前的Argon2PasswordEncoder实现需要使用BouncyCastle库。</p><p><strong>Pbkdf2PasswordEncoder</strong></p><p>使用PBKDF2算法对密码进行哈希处理。为了防止密码破解，PBKDF2是一种故意缓慢的算法。与其他自适应单向函数一样，它应该在您的系统上调整为大约1秒来验证一个密码。当需要FIPS认证时，这种算法是一个很好的选择。</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244283.png" alt="image-20230421184645177" tabindex="0" loading="lazy"><figcaption>image-20230421184645177</figcaption></figure><p><strong>SCryptPasswordEncoder</strong></p><p>使用scrypt算法对密码进行哈希处理。为了防止在自定义硬件上进行密码破解，scrypt是一种故意缓慢的算法，需要大量内存。与其他自适应单向函数一样，它应该在您的系统上调整为大约1秒来验证一个密码。</p><h3 id="_6-3、密码加密测试" tabindex="-1"><a class="header-anchor" href="#_6-3、密码加密测试"><span>6.3、密码加密测试</span></a></h3><p>在测试类中编写一个测试方法</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Test</span></span>
<span class="line"><span style="color:#81A1C1;">void</span><span style="color:#88C0D0;"> testPassword</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    // 工作因子，默认值是10，最小值是4，最大值是31，值越大运算速度越慢</span></span>
<span class="line"><span style="color:#8FBCBB;">    PasswordEncoder</span><span style="color:#D8DEE9;"> encoder</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> BCryptPasswordEncoder</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">4</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">    //明文：&quot;password&quot;</span></span>
<span class="line"><span style="color:#616E88;">    //密文：result，即使明文密码相同，每次生成的密文也不一致</span></span>
<span class="line"><span style="color:#8FBCBB;">    String</span><span style="color:#D8DEE9;"> result</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> encoder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">encode</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">password</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">    System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">result</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">    //密码校验</span></span>
<span class="line"><span style="color:#D8DEE9;">    Assert</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">isTrue</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">encoder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">matches</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">password</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> result</span><span style="color:#ECEFF4;">),</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">密码不一致</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-4、delegatingpasswordencoder" tabindex="-1"><a class="header-anchor" href="#_6-4、delegatingpasswordencoder"><span>6.4、DelegatingPasswordEncoder</span></a></h3><ul><li>表中存储的密码形式：<code>{bcrypt}</code>$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW</li><li>通过如下源码可以知道：可以通过<code>{bcrypt}</code>前缀动态获取和密码的形式类型一致的PasswordEncoder对象</li><li>目的：方便随时做密码策略的升级，兼容数据库中的老版本密码策略生成的密码</li></ul><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244440.png" alt="image-20231209011827867" tabindex="0" loading="lazy"><figcaption>image-20231209011827867</figcaption></figure><h2 id="_7、自定义登录页面" tabindex="-1"><a class="header-anchor" href="#_7、自定义登录页面"><span>7、自定义登录页面</span></a></h2><h3 id="_7-1、创建登录controller" tabindex="-1"><a class="header-anchor" href="#_7-1、创建登录controller"><span>7.1、创建登录Controller</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> com</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">atguigu</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">securitydemo</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">controller</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Controller</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> LoginController</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">GetMapping</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">/login</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#8FBCBB;"> String</span><span style="color:#88C0D0;"> login</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">login</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2、创建登录页面" tabindex="-1"><a class="header-anchor" href="#_7-2、创建登录页面"><span>7.2、创建登录页面</span></a></h3><p>resources/templates/login.html</p><div class="language-html line-numbers-mode" data-highlighter="shiki" data-ext="html" data-title="html" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">&lt;!DOCTYPE</span><span style="color:#8FBCBB;"> html</span><span style="color:#81A1C1;">&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;html</span><span style="color:#8FBCBB;"> xmlns:th</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://www.thymeleaf.org</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;head&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;title&gt;</span><span style="color:#D8DEE9FF;">登录</span><span style="color:#81A1C1;">&lt;/title&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/head&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;body&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;h1&gt;</span><span style="color:#D8DEE9FF;">登录</span><span style="color:#81A1C1;">&lt;/h1&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;div</span><span style="color:#8FBCBB;"> th:if</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">\${param.error}</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    错误的用户名和密码.</span><span style="color:#81A1C1;">&lt;/div&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">&lt;!--method必须为&quot;post&quot;--&gt;</span></span>
<span class="line"><span style="color:#616E88;">&lt;!--th:action=&quot;@{/login}&quot; ，</span></span>
<span class="line"><span style="color:#616E88;">使用动态参数，表单中会自动生成_csrf隐藏字段，用于防止csrf攻击</span></span>
<span class="line"><span style="color:#616E88;">login: 和登录页面保持一致即可，SpringSecurity自动进行登录认证--&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;form</span><span style="color:#8FBCBB;"> th:action</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">@{/login}</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;"> method</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">post</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;div&gt;</span></span>
<span class="line"><span style="color:#616E88;">        &lt;!--name必须为&quot;username&quot;--&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;input</span><span style="color:#8FBCBB;"> type</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">text</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;"> name</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">username</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;"> placeholder</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">用户名</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">/&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;/div&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;div&gt;</span></span>
<span class="line"><span style="color:#616E88;">        &lt;!--name必须为&quot;password&quot;--&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;input</span><span style="color:#8FBCBB;"> type</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">password</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;"> name</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">password</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;"> placeholder</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">密码</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">/&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;/div&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;input</span><span style="color:#8FBCBB;"> type</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">submit</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;"> value</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">登录</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> /&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/form&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/body&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/html&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-3、配置securityfilterchain" tabindex="-1"><a class="header-anchor" href="#_7-3、配置securityfilterchain"><span>7.3、配置SecurityFilterChain</span></a></h3><p>SecurityConfiguration：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">formLogin</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;"> form </span><span style="color:#8FBCBB;">-&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    form</span></span>
<span class="line"><span style="color:#ECEFF4;">        .</span><span style="color:#88C0D0;">loginPage</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">/login</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">).</span><span style="color:#88C0D0;">permitAll</span><span style="color:#ECEFF4;">()</span><span style="color:#616E88;"> //登录页面无需授权即可访问</span></span>
<span class="line"><span style="color:#ECEFF4;">        .</span><span style="color:#88C0D0;">usernameParameter</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">username</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#616E88;"> //自定义表单用户名参数，默认是username</span></span>
<span class="line"><span style="color:#ECEFF4;">        .</span><span style="color:#88C0D0;">passwordParameter</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">password</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#616E88;"> //自定义表单密码参数，默认是password</span></span>
<span class="line"><span style="color:#ECEFF4;">        .</span><span style="color:#88C0D0;">failureUrl</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">/login?error</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#616E88;"> //登录失败的返回地址</span></span>
<span class="line"><span style="color:#81A1C1;">        ;</span></span>
<span class="line"><span style="color:#ECEFF4;">})</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> //使用表单授权方式</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="第三章-前后端分离" tabindex="-1"><a class="header-anchor" href="#第三章-前后端分离"><span>第三章 前后端分离</span></a></h1><h2 id="_1、用户认证流程" tabindex="-1"><a class="header-anchor" href="#_1、用户认证流程"><span>1、用户认证流程</span></a></h2><ul><li>登录成功后调用：AuthenticationSuccessHandler</li><li>登录失败后调用：AuthenticationFailureHandler</li></ul><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244056.png" alt="usernamepasswordauthenticationfilter" tabindex="0" loading="lazy"><figcaption>usernamepasswordauthenticationfilter</figcaption></figure><h2 id="_2、引入fastjson" tabindex="-1"><a class="header-anchor" href="#_2、引入fastjson"><span>2、引入fastjson</span></a></h2><div class="language-xml line-numbers-mode" data-highlighter="shiki" data-ext="xml" data-title="xml" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">&lt;dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;groupId&gt;</span><span style="color:#D8DEE9FF;">com.alibaba.fastjson2</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">fastjson2</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;version&gt;</span><span style="color:#D8DEE9FF;">2.0.37</span><span style="color:#81A1C1;">&lt;/version&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/dependency&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3、认证成功的响应" tabindex="-1"><a class="header-anchor" href="#_3、认证成功的响应"><span>3、认证成功的响应</span></a></h2><h3 id="_3-1、成功结果处理" tabindex="-1"><a class="header-anchor" href="#_3-1、成功结果处理"><span>3.1、成功结果处理</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> com</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">atguigu</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">securitydemo</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">config</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> MyAuthenticationSuccessHandler</span><span style="color:#81A1C1;"> implements</span><span style="color:#8FBCBB;font-weight:bold;"> AuthenticationSuccessHandler</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> onAuthenticationSuccess</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">HttpServletRequest</span><span style="color:#D8DEE9;"> request</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> HttpServletResponse</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> Authentication</span><span style="color:#D8DEE9;"> authentication</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> IOException</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> ServletException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //获取用户身份信息</span></span>
<span class="line"><span style="color:#8FBCBB;">        Object</span><span style="color:#D8DEE9;"> principal</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> authentication</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getPrincipal</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //创建结果对象</span></span>
<span class="line"><span style="color:#8FBCBB;">        HashMap</span><span style="color:#D8DEE9;"> result</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> HashMap</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        result</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">put</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">code</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        result</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">put</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">message</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">登录成功</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        result</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">put</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> principal</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //转换成json字符串</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> json</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> JSON</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toJSONString</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">result</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //返回响应</span></span>
<span class="line"><span style="color:#D8DEE9;">        response</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setContentType</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">application/json;charset=UTF-8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        response</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">json</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2、securityfilterchain配置" tabindex="-1"><a class="header-anchor" href="#_3-2、securityfilterchain配置"><span>3.2、SecurityFilterChain配置</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9;">form</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">successHandler</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> MyAuthenticationSuccessHandler</span><span style="color:#ECEFF4;">())</span><span style="color:#616E88;"> //认证成功时的处理</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_4、认证失败响应" tabindex="-1"><a class="header-anchor" href="#_4、认证失败响应"><span>4、认证失败响应</span></a></h2><h3 id="_4-1、失败结果处理" tabindex="-1"><a class="header-anchor" href="#_4-1、失败结果处理"><span>4.1、失败结果处理</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> com</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">atguigu</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">securitydemo</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">config</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> MyAuthenticationFailureHandler</span><span style="color:#81A1C1;"> implements</span><span style="color:#8FBCBB;font-weight:bold;"> AuthenticationFailureHandler</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> onAuthenticationFailure</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">HttpServletRequest</span><span style="color:#D8DEE9;"> request</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> HttpServletResponse</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> AuthenticationException</span><span style="color:#D8DEE9;"> exception</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> IOException</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> ServletException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //获取错误信息</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> localizedMessage</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> exception</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getLocalizedMessage</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //创建结果对象</span></span>
<span class="line"><span style="color:#8FBCBB;">        HashMap</span><span style="color:#D8DEE9;"> result</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> HashMap</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        result</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">put</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">code</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> -</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        result</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">put</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">message</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> localizedMessage</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //转换成json字符串</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> json</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> JSON</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toJSONString</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">result</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //返回响应</span></span>
<span class="line"><span style="color:#D8DEE9;">        response</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setContentType</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">application/json;charset=UTF-8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        response</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">json</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2securityfilterchain配置" tabindex="-1"><a class="header-anchor" href="#_4-2securityfilterchain配置"><span>4.2SecurityFilterChain配置</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9;">form</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">failureHandler</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> MyAuthenticationFailureHandler</span><span style="color:#ECEFF4;">())</span><span style="color:#616E88;"> //认证失败时的处理</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_5、注销响应" tabindex="-1"><a class="header-anchor" href="#_5、注销响应"><span>5、注销响应</span></a></h2><h3 id="_5-1、注销结果处理" tabindex="-1"><a class="header-anchor" href="#_5-1、注销结果处理"><span>5.1、注销结果处理</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> com</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">atguigu</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">securitydemo</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">config</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> MyLogoutSuccessHandler</span><span style="color:#81A1C1;"> implements</span><span style="color:#8FBCBB;font-weight:bold;"> LogoutSuccessHandler</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> onLogoutSuccess</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">HttpServletRequest</span><span style="color:#D8DEE9;"> request</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> HttpServletResponse</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> Authentication</span><span style="color:#D8DEE9;"> authentication</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> IOException</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> ServletException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //创建结果对象</span></span>
<span class="line"><span style="color:#8FBCBB;">        HashMap</span><span style="color:#D8DEE9;"> result</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> HashMap</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        result</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">put</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">code</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        result</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">put</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">message</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">注销成功</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //转换成json字符串</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> json</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> JSON</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toJSONString</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">result</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //返回响应</span></span>
<span class="line"><span style="color:#D8DEE9;">        response</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setContentType</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">application/json;charset=UTF-8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        response</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">json</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2、securityfilterchain配置" tabindex="-1"><a class="header-anchor" href="#_5-2、securityfilterchain配置"><span>5.2、SecurityFilterChain配置</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9;">http</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">logout</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">logout </span><span style="color:#8FBCBB;">-&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    logout</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">logoutSuccessHandler</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> MyLogoutSuccessHandler</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> //注销成功时的处理</span></span>
<span class="line"><span style="color:#ECEFF4;">})</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6、请求未认证的接口" tabindex="-1"><a class="header-anchor" href="#_6、请求未认证的接口"><span>6、请求未认证的接口</span></a></h2><h3 id="_6-1、实现authenticationentrypoint接口" tabindex="-1"><a class="header-anchor" href="#_6-1、实现authenticationentrypoint接口"><span>6.1、实现AuthenticationEntryPoint接口</span></a></h3><p><a href="https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html" target="_blank" rel="noopener noreferrer">Servlet Authentication Architecture :: Spring Security</a></p><p>当访问一个需要认证之后才能访问的接口的时候，Spring Security会使用<code>AuthenticationEntryPoint</code>将用户请求跳转到登录页面，要求用户提供登录凭证。</p><p>这里我们也希望系统<code>返回json结果</code>，因此我们定义类<code>实现AuthenticationEntryPoint接口</code></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> com</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">atguigu</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">securitydemo</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">config</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> MyAuthenticationEntryPoint</span><span style="color:#81A1C1;"> implements</span><span style="color:#8FBCBB;font-weight:bold;"> AuthenticationEntryPoint</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> commence</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">HttpServletRequest</span><span style="color:#D8DEE9;"> request</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> HttpServletResponse</span><span style="color:#D8DEE9;"> response</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> AuthenticationException</span><span style="color:#D8DEE9;"> authException</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> IOException</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> ServletException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //获取错误信息</span></span>
<span class="line"><span style="color:#616E88;">        //String localizedMessage = authException.getLocalizedMessage();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //创建结果对象</span></span>
<span class="line"><span style="color:#8FBCBB;">        HashMap</span><span style="color:#D8DEE9;"> result</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> HashMap</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        result</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">put</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">code</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> -</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        result</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">put</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">message</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">需要登录</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //转换成json字符串</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> json</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> JSON</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toJSONString</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">result</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //返回响应</span></span>
<span class="line"><span style="color:#D8DEE9;">        response</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setContentType</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">application/json;charset=UTF-8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        response</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">json</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2、securityfilterchain配置" tabindex="-1"><a class="header-anchor" href="#_6-2、securityfilterchain配置"><span>6.2、SecurityFilterChain配置</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">//错误处理</span></span>
<span class="line"><span style="color:#D8DEE9;">http</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">exceptionHandling</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">exception  </span><span style="color:#8FBCBB;">-&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    exception</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">authenticationEntryPoint</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> MyAuthenticationEntryPoint</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//请求未认证的接口</span></span>
<span class="line"><span style="color:#ECEFF4;">})</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7、跨域" tabindex="-1"><a class="header-anchor" href="#_7、跨域"><span>7、跨域</span></a></h2><p>跨域全称是跨域资源共享(Cross-Origin Resources Sharing,CORS)，它是浏览器的保护机制，只允许网页请求统一域名下的服务，同一域名指=&gt;协议、域名、端口号都要保持一致，如果有一项不同，那么就是跨域请求。在前后端分离的项目中，需要解决跨域的问题。</p><p>在SpringSecurity中解决跨域很简单，在配置文件中添加如下配置即可</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">//跨域</span></span>
<span class="line"><span style="color:#D8DEE9;">http</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">cors</span><span style="color:#ECEFF4;">(</span><span style="color:#88C0D0;">withDefaults</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="第四章-身份认证" tabindex="-1"><a class="header-anchor" href="#第四章-身份认证"><span>第四章 身份认证</span></a></h1><h2 id="_1、用户认证信息" tabindex="-1"><a class="header-anchor" href="#_1、用户认证信息"><span>1、用户认证信息</span></a></h2><h3 id="_1-1、基本概念" tabindex="-1"><a class="header-anchor" href="#_1-1、基本概念"><span>1.1、基本概念</span></a></h3><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244189.png" alt="securitycontextholder" tabindex="0" loading="lazy"><figcaption>securitycontextholder</figcaption></figure><p>在Spring Security框架中，SecurityContextHolder、SecurityContext、Authentication、Principal和Credential是一些与身份验证和授权相关的重要概念。它们之间的关系如下：</p><ol><li>SecurityContextHolder：SecurityContextHolder 是 Spring Security 存储已认证用户详细信息的地方。</li><li>SecurityContext：SecurityContext 是从 SecurityContextHolder 获取的内容，包含当前已认证用户的 Authentication 信息。</li><li>Authentication：Authentication 表示用户的身份认证信息。它包含了用户的Principal、Credential和Authority信息。</li><li>Principal：表示用户的身份标识。它通常是一个表示用户的实体对象，例如用户名。Principal可以通过Authentication对象的getPrincipal()方法获取。</li><li>Credentials：表示用户的凭证信息，例如密码、证书或其他认证凭据。Credential可以通过Authentication对象的getCredentials()方法获取。</li><li>GrantedAuthority：表示用户被授予的权限</li></ol><p>总结起来，SecurityContextHolder用于管理当前线程的安全上下文，存储已认证用户的详细信息，其中包含了SecurityContext对象，该对象包含了Authentication对象，后者表示用户的身份验证信息，包括Principal（用户的身份标识）和Credential（用户的凭证信息）。</p><h3 id="_1-2、在controller中获取用户信息" tabindex="-1"><a class="header-anchor" href="#_1-2、在controller中获取用户信息"><span>1.2、在Controller中获取用户信息</span></a></h3><p>IndexController：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> com</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">atguigu</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">securitydemo</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">controller</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">RestController</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> IndexController</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">GetMapping</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">/</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#8FBCBB;"> Map</span><span style="color:#88C0D0;"> index</span><span style="color:#ECEFF4;">(){</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">index controller</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8FBCBB;">        SecurityContext</span><span style="color:#D8DEE9;"> context</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> SecurityContextHolder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getContext</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//存储认证对象的上下文</span></span>
<span class="line"><span style="color:#8FBCBB;">        Authentication</span><span style="color:#D8DEE9;"> authentication</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> context</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getAuthentication</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//认证对象</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> username</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> authentication</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getName</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//用户名</span></span>
<span class="line"><span style="color:#8FBCBB;">        Object</span><span style="color:#D8DEE9;"> principal</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;">authentication</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getPrincipal</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//身份</span></span>
<span class="line"><span style="color:#8FBCBB;">        Object</span><span style="color:#D8DEE9;"> credentials</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> authentication</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getCredentials</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//凭证(脱敏)</span></span>
<span class="line"><span style="color:#8FBCBB;">        Collection</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">?</span><span style="color:#81A1C1;"> extends</span><span style="color:#8FBCBB;"> GrantedAuthority</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> authorities</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> authentication</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getAuthorities</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//权限</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">username</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">principal</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">credentials</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">authorities</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //创建结果对象</span></span>
<span class="line"><span style="color:#8FBCBB;">        HashMap</span><span style="color:#D8DEE9;"> result</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> HashMap</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        result</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">put</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">code</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        result</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">put</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">data</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> username</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#D8DEE9FF;"> result</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2、会话并发处理" tabindex="-1"><a class="header-anchor" href="#_2、会话并发处理"><span>2、会话并发处理</span></a></h2><p>后登录的账号会使先登录的账号失效</p><h3 id="_2-1、实现处理器接口" tabindex="-1"><a class="header-anchor" href="#_2-1、实现处理器接口"><span>2.1、实现处理器接口</span></a></h3><p>实现接口SessionInformationExpiredStrategy</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> com</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">atguigu</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">securitydemo</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">config</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> MySessionInformationExpiredStrategy</span><span style="color:#81A1C1;"> implements</span><span style="color:#8FBCBB;font-weight:bold;"> SessionInformationExpiredStrategy</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Override</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> onExpiredSessionDetected</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">SessionInformationExpiredEvent</span><span style="color:#D8DEE9;"> event</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> IOException</span><span style="color:#ECEFF4;">,</span><span style="color:#8FBCBB;"> ServletException</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //创建结果对象</span></span>
<span class="line"><span style="color:#8FBCBB;">        HashMap</span><span style="color:#D8DEE9;"> result</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> HashMap</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        result</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">put</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">code</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> -</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        result</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">put</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">message</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">该账号已从其他设备登录</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //转换成json字符串</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> json</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> JSON</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toJSONString</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">result</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8FBCBB;">        HttpServletResponse</span><span style="color:#D8DEE9;"> response</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> event</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getResponse</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        //返回响应</span></span>
<span class="line"><span style="color:#D8DEE9;">        response</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setContentType</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">application/json;charset=UTF-8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        response</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">json</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2、securityfilterchain配置" tabindex="-1"><a class="header-anchor" href="#_2-2、securityfilterchain配置"><span>2.2、SecurityFilterChain配置</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">//会话管理</span></span>
<span class="line"><span style="color:#D8DEE9;">http</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sessionManagement</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">session </span><span style="color:#8FBCBB;">-&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    session</span></span>
<span class="line"><span style="color:#ECEFF4;">        .</span><span style="color:#88C0D0;">maximumSessions</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">        .</span><span style="color:#88C0D0;">expiredSessionStrategy</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> MySessionInformationExpiredStrategy</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">})</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="第五章-授权" tabindex="-1"><a class="header-anchor" href="#第五章-授权"><span>第五章 授权</span></a></h1><p>授权管理的实现在SpringSecurity中非常灵活，可以帮助应用程序实现以下两种常见的授权需求：</p><ul><li><p>用户-权限-资源：例如张三的权限是添加用户、查看用户列表，李四的权限是查看用户列表</p></li><li><p>用户-角色-权限-资源：例如 张三是角色是管理员、李四的角色是普通用户，管理员能做所有操作，普通用户只能查看信息</p></li></ul><h2 id="_1、基于request的授权" tabindex="-1"><a class="header-anchor" href="#_1、基于request的授权"><span>1、基于request的授权</span></a></h2><h3 id="_1-1、用户-权限-资源" tabindex="-1"><a class="header-anchor" href="#_1-1、用户-权限-资源"><span>1.1、用户-权限-资源</span></a></h3><p><strong>需求：</strong></p><ul><li>具有USER_LIST权限的用户可以访问/user/list接口</li><li>具有USER_ADD权限的用户可以访问/user/add接口</li></ul><h4 id="配置权限" tabindex="-1"><a class="header-anchor" href="#配置权限"><span>配置权限</span></a></h4><p>SecurityFilterChain</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">//开启授权保护</span></span>
<span class="line"><span style="color:#D8DEE9;">http</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">authorizeRequests</span><span style="color:#ECEFF4;">(</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        authorize </span><span style="color:#8FBCBB;">-&gt;</span><span style="color:#D8DEE9FF;"> authorize</span></span>
<span class="line"><span style="color:#616E88;">    			//具有USER_LIST权限的用户可以访问/user/list</span></span>
<span class="line"><span style="color:#ECEFF4;">                .</span><span style="color:#88C0D0;">requestMatchers</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">/user/list</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">).</span><span style="color:#88C0D0;">hasAuthority</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">USER_LIST</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#616E88;">    			//具有USER_ADD权限的用户可以访问/user/add</span></span>
<span class="line"><span style="color:#ECEFF4;">    			.</span><span style="color:#88C0D0;">requestMatchers</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">/user/add</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">).</span><span style="color:#88C0D0;">hasAuthority</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">USER_ADD</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#616E88;">                //对所有请求开启授权保护</span></span>
<span class="line"><span style="color:#ECEFF4;">                .</span><span style="color:#88C0D0;">anyRequest</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#616E88;">                //已认证的请求会被自动授权</span></span>
<span class="line"><span style="color:#ECEFF4;">                .</span><span style="color:#88C0D0;">authenticated</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#ECEFF4;">        )</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="授予权限" tabindex="-1"><a class="header-anchor" href="#授予权限"><span>授予权限</span></a></h4><p>DBUserDetailsManager中的loadUserByUsername方法：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#8FBCBB;">Collection</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">GrantedAuthority</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> authorities</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#8FBCBB;"> ArrayList</span><span style="color:#ECEFF4;">&lt;&gt;()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">authorities</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(()</span><span style="color:#8FBCBB;">-&gt;</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">USER_LIST</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">authorities</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(()</span><span style="color:#8FBCBB;">-&gt;</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">USER_ADD</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">/*authorities.add(new GrantedAuthority() {</span></span>
<span class="line"><span style="color:#616E88;">    @Override</span></span>
<span class="line"><span style="color:#616E88;">    public String getAuthority() {</span></span>
<span class="line"><span style="color:#616E88;">        return &quot;USER_LIST&quot;;</span></span>
<span class="line"><span style="color:#616E88;">    }</span></span>
<span class="line"><span style="color:#616E88;">});</span></span>
<span class="line"><span style="color:#616E88;">authorities.add(new GrantedAuthority() {</span></span>
<span class="line"><span style="color:#616E88;">    @Override</span></span>
<span class="line"><span style="color:#616E88;">    public String getAuthority() {</span></span>
<span class="line"><span style="color:#616E88;">        return &quot;USER_ADD&quot;;</span></span>
<span class="line"><span style="color:#616E88;">    }</span></span>
<span class="line"><span style="color:#616E88;">});*/</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="请求未授权的接口" tabindex="-1"><a class="header-anchor" href="#请求未授权的接口"><span>请求未授权的接口</span></a></h4><p>SecurityFilterChain</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">//错误处理</span></span>
<span class="line"><span style="color:#D8DEE9;">http</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">exceptionHandling</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">exception  </span><span style="color:#8FBCBB;">-&gt;</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">    exception</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">authenticationEntryPoint</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#88C0D0;"> MyAuthenticationEntryPoint</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;">//请求未认证的接口</span></span>
<span class="line"><span style="color:#D8DEE9;">    exception</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">accessDeniedHandler</span><span style="color:#ECEFF4;">((</span><span style="color:#D8DEE9FF;">request</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> response</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> e</span><span style="color:#ECEFF4;">)</span><span style="color:#8FBCBB;">-&gt;</span><span style="color:#ECEFF4;">{</span><span style="color:#616E88;"> //请求未授权的接口</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //创建结果对象</span></span>
<span class="line"><span style="color:#8FBCBB;">        HashMap</span><span style="color:#D8DEE9;"> result</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> HashMap</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        result</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">put</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">code</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> -</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        result</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">put</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">message</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">没有权限</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //转换成json字符串</span></span>
<span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> json</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> JSON</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">toJSONString</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">result</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">        //返回响应</span></span>
<span class="line"><span style="color:#D8DEE9;">        response</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setContentType</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">application/json;charset=UTF-8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        response</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getWriter</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">json</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    })</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">})</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>更多的例子：</strong><a href="https://docs.spring.io/spring-security/reference/servlet/authorization/authorize-http-requests.html" target="_blank" rel="noopener noreferrer">Authorize HttpServletRequests :: Spring Security</a></p><h3 id="_1-2、用户-角色-资源" tabindex="-1"><a class="header-anchor" href="#_1-2、用户-角色-资源"><span>1.2、用户-角色-资源</span></a></h3><p>**需求：**角色为ADMIN的用户才可以访问/user/**路径下的资源</p><h4 id="配置角色" tabindex="-1"><a class="header-anchor" href="#配置角色"><span>配置角色</span></a></h4><p>SecurityFilterChain</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">//开启授权保护</span></span>
<span class="line"><span style="color:#D8DEE9;">http</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">authorizeRequests</span><span style="color:#ECEFF4;">(</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        authorize </span><span style="color:#8FBCBB;">-&gt;</span><span style="color:#D8DEE9FF;"> authorize</span></span>
<span class="line"><span style="color:#616E88;">                //具有管理员角色的用户可以访问/user/**</span></span>
<span class="line"><span style="color:#ECEFF4;">                .</span><span style="color:#88C0D0;">requestMatchers</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">/user/**</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">).</span><span style="color:#88C0D0;">hasRole</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ADMIN</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#616E88;">                //对所有请求开启授权保护</span></span>
<span class="line"><span style="color:#ECEFF4;">                .</span><span style="color:#88C0D0;">anyRequest</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#616E88;">                //已认证的请求会被自动授权</span></span>
<span class="line"><span style="color:#ECEFF4;">                .</span><span style="color:#88C0D0;">authenticated</span><span style="color:#ECEFF4;">()</span></span>
<span class="line"><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="授予角色" tabindex="-1"><a class="header-anchor" href="#授予角色"><span>授予角色</span></a></h4><p>DBUserDetailsManager中的loadUserByUsername方法：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">return</span><span style="color:#D8DEE9;"> org</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">springframework</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">security</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">core</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">userdetails</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">User</span></span>
<span class="line"><span style="color:#ECEFF4;">        .</span><span style="color:#88C0D0;">withUsername</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">user</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getUsername</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"><span style="color:#ECEFF4;">        .</span><span style="color:#88C0D0;">password</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">user</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getPassword</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"><span style="color:#ECEFF4;">        .</span><span style="color:#88C0D0;">roles</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ADMIN</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">        .</span><span style="color:#88C0D0;">build</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-3、用户-角色-权限-资源" tabindex="-1"><a class="header-anchor" href="#_1-3、用户-角色-权限-资源"><span>1.3、用户-角色-权限-资源</span></a></h3><p>RBAC（Role-Based Access Control，基于角色的访问控制）是一种常用的数据库设计方案，它将用户的权限分配和管理与角色相关联。以下是一个基本的RBAC数据库设计方案的示例：</p><ol><li>用户表（User table）：包含用户的基本信息，例如用户名、密码和其他身份验证信息。</li></ol><table><thead><tr><th>列名</th><th>数据类型</th><th>描述</th></tr></thead><tbody><tr><td>user_id</td><td>int</td><td>用户ID</td></tr><tr><td>username</td><td>varchar</td><td>用户名</td></tr><tr><td>password</td><td>varchar</td><td>密码</td></tr><tr><td>email</td><td>varchar</td><td>电子邮件地址</td></tr><tr><td>...</td><td>...</td><td>...</td></tr></tbody></table><ol start="2"><li>角色表（Role table）：存储所有可能的角色及其描述。</li></ol><table><thead><tr><th>列名</th><th>数据类型</th><th>描述</th></tr></thead><tbody><tr><td>role_id</td><td>int</td><td>角色ID</td></tr><tr><td>role_name</td><td>varchar</td><td>角色名称</td></tr><tr><td>description</td><td>varchar</td><td>角色描述</td></tr><tr><td>...</td><td>...</td><td>...</td></tr></tbody></table><ol start="3"><li>权限表（Permission table）：定义系统中所有可能的权限。</li></ol><table><thead><tr><th>列名</th><th>数据类型</th><th>描述</th></tr></thead><tbody><tr><td>permission_id</td><td>int</td><td>权限ID</td></tr><tr><td>permission_name</td><td>varchar</td><td>权限名称</td></tr><tr><td>description</td><td>varchar</td><td>权限描述</td></tr><tr><td>...</td><td>...</td><td>...</td></tr></tbody></table><ol start="4"><li>用户角色关联表（User-Role table）：将用户与角色关联起来。</li></ol><table><thead><tr><th>列名</th><th>数据类型</th><th>描述</th></tr></thead><tbody><tr><td>user_role_id</td><td>int</td><td>用户角色关联ID</td></tr><tr><td>user_id</td><td>int</td><td>用户ID</td></tr><tr><td>role_id</td><td>int</td><td>角色ID</td></tr><tr><td>...</td><td>...</td><td>...</td></tr></tbody></table><ol start="5"><li>角色权限关联表（Role-Permission table）：将角色与权限关联起来。</li></ol><table><thead><tr><th>列名</th><th>数据类型</th><th>描述</th></tr></thead><tbody><tr><td>role_permission_id</td><td>int</td><td>角色权限关联ID</td></tr><tr><td>role_id</td><td>int</td><td>角色ID</td></tr><tr><td>permission_id</td><td>int</td><td>权限ID</td></tr><tr><td>...</td><td>...</td><td>...</td></tr></tbody></table><p>在这个设计方案中，用户可以被分配一个或多个角色，而每个角色又可以具有一个或多个权限。通过对用户角色关联和角色权限关联表进行操作，可以实现灵活的权限管理和访问控制。</p><p>当用户尝试访问系统资源时，系统可以根据用户的角色和权限决定是否允许访问。这样的设计方案使得权限管理更加简单和可维护，因为只需调整角色和权限的分配即可，而不需要针对每个用户进行单独的设置。</p><h2 id="_2、基于方法的授权" tabindex="-1"><a class="header-anchor" href="#_2、基于方法的授权"><span>2、基于方法的授权</span></a></h2><h3 id="_2-1、开启方法授权" tabindex="-1"><a class="header-anchor" href="#_2-1、开启方法授权"><span>2.1、开启方法授权</span></a></h3><p>在配置文件中添加如下注解</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">EnableMethodSecurity</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_2-2、给用户授予角色和权限" tabindex="-1"><a class="header-anchor" href="#_2-2、给用户授予角色和权限"><span>2.2、给用户授予角色和权限</span></a></h3><p>DBUserDetailsManager中的loadUserByUsername方法：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">return</span><span style="color:#D8DEE9;"> org</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">springframework</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">security</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">core</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">userdetails</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">User</span></span>
<span class="line"><span style="color:#ECEFF4;">        .</span><span style="color:#88C0D0;">withUsername</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">user</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getUsername</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"><span style="color:#ECEFF4;">        .</span><span style="color:#88C0D0;">password</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">user</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getPassword</span><span style="color:#ECEFF4;">())</span></span>
<span class="line"><span style="color:#ECEFF4;">        .</span><span style="color:#88C0D0;">roles</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">ADMIN</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">        .</span><span style="color:#88C0D0;">authorities</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">USER_ADD</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">USER_UPDATE</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">        .</span><span style="color:#88C0D0;">build</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2、常用授权注解" tabindex="-1"><a class="header-anchor" href="#_2-2、常用授权注解"><span>2.2、常用授权注解</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">//用户必须有 ADMIN 角色 并且 用户名是 admin 才能访问此方法</span></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">PreAuthorize</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">hasRole(&#39;ADMIN&#39;) and authentication.name == &#39;admim&#39;</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">GetMapping</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">/list</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#8FBCBB;"> List</span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9FF;">User</span><span style="color:#81A1C1;">&gt;</span><span style="color:#88C0D0;"> getList</span><span style="color:#ECEFF4;">(){</span></span>
<span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#D8DEE9;"> userService</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">list</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">//用户必须有 USER_ADD 权限 才能访问此方法</span></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">PreAuthorize</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">hasAuthority(&#39;USER_ADD&#39;)</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">PostMapping</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">/add</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> add</span><span style="color:#ECEFF4;">(@</span><span style="color:#D08770;">RequestBody</span><span style="color:#8FBCBB;"> User</span><span style="color:#D8DEE9FF;"> user</span><span style="color:#ECEFF4;">){</span></span>
<span class="line"><span style="color:#D8DEE9;">    userService</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">saveUserDetails</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">user</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>更多的例子：</strong><a href="https://docs.spring.io/spring-security/reference/servlet/authorization/method-security.html" target="_blank" rel="noopener noreferrer">Method Security :: Spring Security</a></p><h1 id="第六章-oauth2" tabindex="-1"><a class="header-anchor" href="#第六章-oauth2"><span>第六章 OAuth2</span></a></h1><h2 id="_1、oauth2简介" tabindex="-1"><a class="header-anchor" href="#_1、oauth2简介"><span>1、OAuth2简介</span></a></h2><h3 id="_1-1、oauth2是什么" tabindex="-1"><a class="header-anchor" href="#_1-1、oauth2是什么"><span>1.1、OAuth2是什么</span></a></h3><p>“Auth” 表示 “授权” Authorization</p><p>“O” 是 Open 的简称，表示 “开放”</p><p>连在一起就表示 <strong>“开放授权”</strong>，OAuth2是一种开放授权协议。</p><p><strong>OAuth2最简向导：</strong><a href="https://darutk.medium.com/the-simplest-guide-to-oauth-2-0-8c71bd9a15bb" target="_blank" rel="noopener noreferrer">The Simplest Guide To OAuth 2.0</a></p><h3 id="_1-2、oauth2的角色" tabindex="-1"><a class="header-anchor" href="#_1-2、oauth2的角色"><span>1.2、OAuth2的角色</span></a></h3><p>OAuth 2协议包含以下角色：</p><ol><li>资源所有者（Resource Owner）：即用户，资源的拥有人，想要通过客户应用访问资源服务器上的资源。</li><li>客户应用（Client）：通常是一个Web或者无线应用，它需要访问用户的受保护资源。</li><li>资源服务器（Resource Server）：存储受保护资源的服务器或定义了可以访问到资源的API，接收并验证客户端的访问令牌，以决定是否授权访问资源。</li><li>授权服务器（Authorization Server）：负责验证资源所有者的身份并向客户端颁发访问令牌。</li></ol><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244347.png" alt="image-20231222124053994" tabindex="0" loading="lazy"><figcaption>image-20231222124053994</figcaption></figure><h3 id="_1-3、oauth2的使用场景" tabindex="-1"><a class="header-anchor" href="#_1-3、oauth2的使用场景"><span>1.3、OAuth2的使用场景</span></a></h3><h4 id="开放系统间授权" tabindex="-1"><a class="header-anchor" href="#开放系统间授权"><span>开放系统间授权</span></a></h4><h5 id="社交登录" tabindex="-1"><a class="header-anchor" href="#社交登录"><span>社交登录</span></a></h5><p>在传统的身份验证中，用户需要提供用户名和密码，还有很多网站登录时，允许使用第三方网站的身份，这称为&quot;第三方登录&quot;。所谓第三方登录，实质就是 OAuth 授权。用户想要登录 A 网站，A 网站让用户提供第三方网站的数据，证明自己的身份。获取第三方网站的身份数据，就需要 OAuth 授权。</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244490.png" alt="image-20231222131233025" tabindex="0" loading="lazy"><figcaption>image-20231222131233025</figcaption></figure><h5 id="开放api" tabindex="-1"><a class="header-anchor" href="#开放api"><span>开放API</span></a></h5><p>例如云冲印服务的实现</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244937.png" alt="image-20231222131118611" tabindex="0" loading="lazy"><figcaption>image-20231222131118611</figcaption></figure><h4 id="现代微服务安全" tabindex="-1"><a class="header-anchor" href="#现代微服务安全"><span>现代微服务安全</span></a></h4><h5 id="单块应用安全" tabindex="-1"><a class="header-anchor" href="#单块应用安全"><span>单块应用安全</span></a></h5><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244263.png" alt="image-20231222152734546" tabindex="0" loading="lazy"><figcaption>image-20231222152734546</figcaption></figure><h5 id="微服务安全" tabindex="-1"><a class="header-anchor" href="#微服务安全"><span>微服务安全</span></a></h5><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244437.png" alt="image-20231222152557861" tabindex="0" loading="lazy"><figcaption>image-20231222152557861</figcaption></figure><h4 id="企业内部应用认证授权" tabindex="-1"><a class="header-anchor" href="#企业内部应用认证授权"><span>企业内部应用认证授权</span></a></h4><ul><li><p>SSO：Single Sign On 单点登录</p></li><li><p>IAM：Identity and Access Management 身份识别与访问管理</p></li></ul><h3 id="_1-4、oauth2的四种授权模式" tabindex="-1"><a class="header-anchor" href="#_1-4、oauth2的四种授权模式"><span>1.4、OAuth2的四种授权模式</span></a></h3><p>RFC6749：</p><p><a href="https://datatracker.ietf.org/doc/html/rfc6749" target="_blank" rel="noopener noreferrer">RFC 6749 - The OAuth 2.0 Authorization Framework (ietf.org)</a></p><p>阮一峰：</p><p><a href="https://www.ruanyifeng.com/blog/2019/04/oauth-grant-types.html" target="_blank" rel="noopener noreferrer">OAuth 2.0 的四种方式 - 阮一峰的网络日志 (ruanyifeng.com)</a></p><p>四种模式：</p><ul><li>授权码（authorization-code）</li><li>隐藏式（implicit）</li><li>密码式（password）</li><li>客户端凭证（client credentials）</li></ul><h4 id="第一种方式-授权码" tabindex="-1"><a class="header-anchor" href="#第一种方式-授权码"><span>第一种方式：授权码</span></a></h4><p><strong>授权码（authorization code），指的是第三方应用先申请一个授权码，然后再用该码获取令牌。</strong></p><p>这种方式是最常用，最复杂，也是最安全的，它适用于那些有后端的 Web 应用。授权码通过前端传送，令牌则是储存在后端，而且所有与资源服务器的通信都在后端完成。这样的前后端分离，可以避免令牌泄漏。</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244533.png" alt="image-20231220180422742" tabindex="0" loading="lazy"><figcaption>image-20231220180422742</figcaption></figure><ul><li>注册客户应用：客户应用如果想要访问资源服务器需要有凭证，需要在授权服务器上注册客户应用。注册后会<strong>获取到一个ClientID和ClientSecrets</strong></li></ul><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244627.png" alt="image-20231222203153125" tabindex="0" loading="lazy"><figcaption>image-20231222203153125</figcaption></figure><h4 id="第二种方式-隐藏式" tabindex="-1"><a class="header-anchor" href="#第二种方式-隐藏式"><span>第二种方式：隐藏式</span></a></h4><p><strong>隐藏式（implicit），也叫简化模式，有些 Web 应用是纯前端应用，没有后端。这时就不能用上面的方式了，必须将令牌储存在前端。</strong></p><p>RFC 6749 规定了这种方式，允许直接向前端颁发令牌。这种方式没有授权码这个中间步骤，所以称为隐藏式。这种方式把令牌直接传给前端，是很不安全的。因此，只能用于一些安全要求不高的场景，并且令牌的有效期必须非常短，通常就是会话期间（session）有效，浏览器关掉，令牌就失效了。</p><p>​ <img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244713.png" alt="image-20231220185958063" loading="lazy"></p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244937.png" alt="image-20231222203218334" tabindex="0" loading="lazy"><figcaption>image-20231222203218334</figcaption></figure><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span>https://a.com/callback#token=ACCESS_TOKEN</span></span>
<span class="line"><span>将访问令牌包含在URL锚点中的好处：锚点在HTTP请求中不会发送到服务器，减少了泄漏令牌的风险。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="第三种方式-密码式" tabindex="-1"><a class="header-anchor" href="#第三种方式-密码式"><span>第三种方式：密码式</span></a></h4><p><strong>密码式（Resource Owner Password Credentials）：如果你高度信任某个应用，RFC 6749 也允许用户把用户名和密码，直接告诉该应用。该应用就使用你的密码，申请令牌。</strong></p><p>这种方式需要用户给出自己的用户名/密码，显然风险很大，因此只适用于其他授权方式都无法采用的情况，而且必须是用户高度信任的应用。</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244517.png" alt="image-20231220190152888" tabindex="0" loading="lazy"><figcaption>image-20231220190152888</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244777.png" alt="image-20231222203240921" tabindex="0" loading="lazy"><figcaption>image-20231222203240921</figcaption></figure><h4 id="第四种方式-凭证式" tabindex="-1"><a class="header-anchor" href="#第四种方式-凭证式"><span>第四种方式：凭证式</span></a></h4><p><strong>凭证式（client credentials）：也叫客户端模式，适用于没有前端的命令行应用，即在命令行下请求令牌。</strong></p><p>这种方式给出的令牌，是针对第三方应用的，而不是针对用户的，即有可能多个用户共享同一个令牌。</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244713.png" alt="image-20231220185958063" tabindex="0" loading="lazy"><figcaption>image-20231220185958063</figcaption></figure><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244095.png" alt="image-20231222203259785" tabindex="0" loading="lazy"><figcaption>image-20231222203259785</figcaption></figure><h3 id="_1-5、授权类型的选择" tabindex="-1"><a class="header-anchor" href="#_1-5、授权类型的选择"><span>1.5、授权类型的选择</span></a></h3><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244348.png" alt="image-20231223020052999" tabindex="0" loading="lazy"><figcaption>image-20231223020052999</figcaption></figure><h2 id="_2、spring中的oauth2" tabindex="-1"><a class="header-anchor" href="#_2、spring中的oauth2"><span>2、Spring中的OAuth2</span></a></h2><h3 id="_2-1、相关角色" tabindex="-1"><a class="header-anchor" href="#_2-1、相关角色"><span>2.1、相关角色</span></a></h3><p>**回顾：**OAuth 2中的角色</p><ol><li>资源所有者（Resource Owner）</li><li>客户应用（Client）</li><li>资源服务器（Resource Server）</li><li>授权服务器（Authorization Server）</li></ol><h3 id="_2-2、spring中的实现" tabindex="-1"><a class="header-anchor" href="#_2-2、spring中的实现"><span>2.2、Spring中的实现</span></a></h3><p><a href="https://docs.spring.io/spring-security/reference/servlet/oauth2/index.html" target="_blank" rel="noopener noreferrer">OAuth2 :: Spring Security</a></p><p><strong>Spring Security</strong></p><ul><li>客户应用（OAuth2 Client）：OAuth2客户端功能中包含OAuth2 Login</li><li>资源服务器（OAuth2 Resource Server）</li></ul><p><strong>Spring</strong></p><ul><li>授权服务器（Spring Authorization Server）：它是在Spring Security之上的一个单独的项目。</li></ul><h3 id="_2-3、相关依赖" tabindex="-1"><a class="header-anchor" href="#_2-3、相关依赖"><span>2.3、相关依赖</span></a></h3><div class="language-xml line-numbers-mode" data-highlighter="shiki" data-ext="xml" data-title="xml" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#616E88;">&lt;!-- 资源服务器 --&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">	&lt;groupId&gt;</span><span style="color:#D8DEE9FF;">org.springframework.boot</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">	&lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">spring-boot-starter-oauth2-resource-server</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/dependency&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">&lt;!-- 客户应用 --&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">	&lt;groupId&gt;</span><span style="color:#D8DEE9FF;">org.springframework.boot</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">	&lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">spring-boot-starter-oauth2-client</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/dependency&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88;">&lt;!-- 授权服务器 --&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;dependency&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;groupId&gt;</span><span style="color:#D8DEE9FF;">org.springframework.boot</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">spring-boot-starter-oauth2-authorization-server</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/dependency&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4、授权登录的实现思路" tabindex="-1"><a class="header-anchor" href="#_2-4、授权登录的实现思路"><span>2.4、授权登录的实现思路</span></a></h3><p>使用OAuth2 Login</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244456.png" alt="image-20231223164128030" tabindex="0" loading="lazy"><figcaption>image-20231223164128030</figcaption></figure><h2 id="_3、giuhub社交登录案例" tabindex="-1"><a class="header-anchor" href="#_3、giuhub社交登录案例"><span>3、GiuHub社交登录案例</span></a></h2><h3 id="_3-1、创建应用" tabindex="-1"><a class="header-anchor" href="#_3-1、创建应用"><span>3.1、创建应用</span></a></h3><p><strong>注册客户应用：</strong></p><p>登录GitHub，在开发者设置中找到OAuth Apps，创建一个application，为客户应用创建访问GitHub的凭据：</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244568.png" alt="image-20230510154255157" tabindex="0" loading="lazy"><figcaption>image-20230510154255157</figcaption></figure><p>填写应用信息：<code>默认的重定向URI模板为{baseUrl}/login/oauth2/code/{registrationId}</code>。registrationId是ClientRegistration的唯一标识符。</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244721.png" alt="image-20231221000906168" tabindex="0" loading="lazy"><figcaption>image-20231221000906168</figcaption></figure><p>获取应用程序id，生成应用程序密钥：</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244978.png" alt="image-20230510163101376" tabindex="0" loading="lazy"><figcaption>image-20230510163101376</figcaption></figure><h3 id="_3-2、创建测试项目" tabindex="-1"><a class="header-anchor" href="#_3-2、创建测试项目"><span>3.2、创建测试项目</span></a></h3><p>创建一个springboot项目oauth2-login-demo，创建时引入如下依赖</p><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244235.png" alt="image-20230510165314829" tabindex="0" loading="lazy"><figcaption>image-20230510165314829</figcaption></figure><p>示例代码参考：<a href="https://github.com/spring-projects/spring-security-samples/tree/6.2.x/servlet/spring-boot/java/oauth2/login" target="_blank" rel="noopener noreferrer">spring-security-samples/servlet/spring-boot/java/oauth2/login at 6.2.x · spring-projects/spring-security-samples (github.com)</a></p><h3 id="_3-3、配置oauth客户端属性" tabindex="-1"><a class="header-anchor" href="#_3-3、配置oauth客户端属性"><span>3.3、配置OAuth客户端属性</span></a></h3><p>application.yml：</p><div class="language-properties line-numbers-mode" data-highlighter="shiki" data-ext="properties" data-title="properties" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">spring:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">  security:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    oauth2:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">      client:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        registration:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">          github:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">            client-id: 7807cc3bb1534abce9f2</span></span>
<span class="line"><span style="color:#D8DEE9FF;">            client-secret: 008dc141879134433f4db7f62b693c4a5361771b</span></span>
<span class="line"><span style="color:#616E88;">#            redirectUri: http://localhost:8200/login/oauth2/code/github</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-4、创建controller" tabindex="-1"><a class="header-anchor" href="#_3-4、创建controller"><span>3.4、创建Controller</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">package</span><span style="color:#8FBCBB;"> com</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">atguigu</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">oauthdemo</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">controller</span><span style="color:#81A1C1;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Controller</span></span>
<span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> IndexController</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">GetMapping</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">/</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#8FBCBB;"> String</span><span style="color:#88C0D0;"> index</span><span style="color:#ECEFF4;">(</span></span>
<span class="line"><span style="color:#8FBCBB;">            Model</span><span style="color:#D8DEE9;"> model</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">            @</span><span style="color:#D08770;">RegisteredOAuth2AuthorizedClient</span><span style="color:#8FBCBB;"> OAuth2AuthorizedClient</span><span style="color:#D8DEE9;"> authorizedClient</span><span style="color:#ECEFF4;">,</span></span>
<span class="line"><span style="color:#ECEFF4;">            @</span><span style="color:#D08770;">AuthenticationPrincipal</span><span style="color:#8FBCBB;"> OAuth2User</span><span style="color:#D8DEE9;"> oauth2User</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#D8DEE9;">        model</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">addAttribute</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">userName</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> oauth2User</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getName</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        model</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">addAttribute</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">clientName</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> authorizedClient</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getClientRegistration</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">getClientName</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        model</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">addAttribute</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">userAttributes</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> oauth2User</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getAttributes</span><span style="color:#ECEFF4;">())</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">index</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5、创建html页面" tabindex="-1"><a class="header-anchor" href="#_3-5、创建html页面"><span>3.5、创建html页面</span></a></h3><p>resources/templates/index.html</p><div class="language-html line-numbers-mode" data-highlighter="shiki" data-ext="html" data-title="html" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#81A1C1;">&lt;!DOCTYPE</span><span style="color:#8FBCBB;"> html</span><span style="color:#81A1C1;">&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;html</span><span style="color:#8FBCBB;"> xmlns</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">http://www.w3.org/1999/xhtml</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;"> xmlns:th</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://www.thymeleaf.org</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;"> xmlns:sec</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://www.thymeleaf.org/thymeleaf-extras-springsecurity5</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;head&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;title&gt;</span><span style="color:#D8DEE9FF;">Spring Security - OAuth 2.0 Login</span><span style="color:#81A1C1;">&lt;/title&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;meta</span><span style="color:#8FBCBB;"> charset</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">utf-8</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> /&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/head&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;body&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;div</span><span style="color:#8FBCBB;"> style</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">float: right</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;"> th:fragment</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">logout</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;"> sec:authorize</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">isAuthenticated()</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;div</span><span style="color:#8FBCBB;"> style</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">float:left</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;span</span><span style="color:#8FBCBB;"> style</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">font-weight:bold</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;</span><span style="color:#D8DEE9FF;">User: </span><span style="color:#81A1C1;">&lt;/span&gt;&lt;span</span><span style="color:#8FBCBB;"> sec:authentication</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">name</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;&lt;/span&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;/div&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;div</span><span style="color:#8FBCBB;"> style</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">float:none</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;&amp;</span><span style="color:#EBCB8B;">nbsp</span><span style="color:#81A1C1;">;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;div</span><span style="color:#8FBCBB;"> style</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">float:right</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;form</span><span style="color:#8FBCBB;"> action</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">#</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;"> th:action</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">@{/logout}</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;"> method</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">post</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">            &lt;input</span><span style="color:#8FBCBB;"> type</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">submit</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;"> value</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Logout</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> /&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;/form&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;/div&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/div&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;h1&gt;</span><span style="color:#D8DEE9FF;">OAuth 2.0 Login with Spring Security</span><span style="color:#81A1C1;">&lt;/h1&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    You are successfully logged in </span><span style="color:#81A1C1;">&lt;span</span><span style="color:#8FBCBB;"> style</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">font-weight:bold</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;"> th:text</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">\${userName}</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;&lt;/span&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    via the OAuth 2.0 Client </span><span style="color:#81A1C1;">&lt;span</span><span style="color:#8FBCBB;"> style</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">font-weight:bold</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;"> th:text</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">\${clientName}</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;&lt;/span&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/div&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;div&gt;&amp;</span><span style="color:#EBCB8B;">nbsp</span><span style="color:#81A1C1;">;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;div&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;span</span><span style="color:#8FBCBB;"> style</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">font-weight:bold</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;</span><span style="color:#D8DEE9FF;">User Attributes:</span><span style="color:#81A1C1;">&lt;/span&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;ul&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;li</span><span style="color:#8FBCBB;"> th:each</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">userAttribute : \${userAttributes}</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">            &lt;span</span><span style="color:#8FBCBB;"> style</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">font-weight:bold</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#8FBCBB;"> th:text</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">\${userAttribute.key}</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;&lt;/span&gt;</span><span style="color:#D8DEE9FF;">: </span><span style="color:#81A1C1;">&lt;span</span><span style="color:#8FBCBB;"> th:text</span><span style="color:#ECEFF4;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">\${userAttribute.value}</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">&gt;&lt;/span&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">        &lt;/li&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">    &lt;/ul&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/div&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/body&gt;</span></span>
<span class="line"><span style="color:#81A1C1;">&lt;/html&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-6、启动应用程序" tabindex="-1"><a class="header-anchor" href="#_3-6、启动应用程序"><span>3.6、启动应用程序</span></a></h3><ul><li>启动程序并访问localhost:8080。浏览器将被重定向到默认的自动生成的登录页面，该页面显示了一个用于GitHub登录的链接。</li><li>点击GitHub链接，浏览器将被重定向到GitHub进行身份验证。</li><li>使用GitHub账户凭据进行身份验证后，用户会看到授权页面，询问用户是否允许或拒绝客户应用访问GitHub上的用户数据。点击允许以授权OAuth客户端访问用户的基本个人资料信息。</li><li>此时，OAuth客户端访问GitHub的获取用户信息的接口获取基本个人资料信息，并建立一个已认证的会话。</li></ul><h2 id="_4、案例分析" tabindex="-1"><a class="header-anchor" href="#_4、案例分析"><span>4、案例分析</span></a></h2><h3 id="_4-1、登录流程" tabindex="-1"><a class="header-anchor" href="#_4-1、登录流程"><span>4.1、登录流程</span></a></h3><ol><li><strong>A 网站让用户跳转到 GitHub，并携带参数ClientID 以及 Redirection URI。</strong></li><li>GitHub 要求用户登录，然后询问用户&quot;A 网站要求获取用户信息的权限，你是否同意？&quot;</li><li>用户同意，GitHub 就会重定向回 A 网站，同时发回一个授权码。</li><li><strong>A 网站使用授权码，向 GitHub 请求令牌。</strong></li><li>GitHub 返回令牌.</li><li><strong>A 网站使用令牌，向 GitHub 请求用户数据。</strong></li><li>GitHub返回用户数据</li><li><strong>A 网站使用 GitHub用户数据登录</strong></li></ol><figure><img src="https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244409.png" alt="image-20231223203225688" tabindex="0" loading="lazy"><figcaption>image-20231223203225688</figcaption></figure><h3 id="_4-2、commonoauth2provider" tabindex="-1"><a class="header-anchor" href="#_4-2、commonoauth2provider"><span>4.2、CommonOAuth2Provider</span></a></h3><p>CommonOAuth2Provider是一个预定义的通用OAuth2Provider，为一些知名资源服务API提供商（如Google、GitHub、Facebook）预定义了一组默认的属性。</p><p>例如，<strong>授权URI、令牌URI和用户信息URI</strong>通常不经常变化。因此，提供默认值以减少所需的配置。</p><p>因此，当我们配置GitHub客户端时，只需要提供client-id和client-secret属性。</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="background-color:#2e3440ff;color:#d8dee9ff;"><pre class="shiki nord vp-code"><code><span class="line"><span style="color:#D8DEE9FF;">GITHUB </span><span style="color:#ECEFF4;">{</span></span>
<span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#D8DEE9;"> ClientRegistration</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">Builder</span><span style="color:#88C0D0;"> getBuilder</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#D8DEE9FF;"> registrationId</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span>
<span class="line"><span style="color:#8FBCBB;">        ClientRegistration</span><span style="color:#ECEFF4;">.</span><span style="color:#8FBCBB;">Builder</span><span style="color:#D8DEE9;"> builder</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> this</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getBuilder</span><span style="color:#ECEFF4;">(</span></span>
<span class="line"><span style="color:#D8DEE9FF;">        registrationId</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#D8DEE9;">        ClientAuthenticationMethod</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">CLIENT_SECRET_BASIC</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> </span></span>
<span class="line"><span style="color:#D8DEE9FF;">        </span></span>
<span class="line"><span style="color:#616E88;">        //授权回调地址(GitHub向客户应用发送回调请求，并携带授权码)   </span></span>
<span class="line"><span style="color:#ECEFF4;">		&quot;</span><span style="color:#A3BE8C;">{baseUrl}/{action}/oauth2/code/{registrationId}</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#D8DEE9;">        builder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">scope</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">new</span><span style="color:#8FBCBB;"> String</span><span style="color:#ECEFF4;">[]{</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">read:user</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">})</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        //授权页面</span></span>
<span class="line"><span style="color:#D8DEE9;">        builder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">authorizationUri</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://github.com/login/oauth/authorize</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        //客户应用使用授权码，向 GitHub 请求令牌</span></span>
<span class="line"><span style="color:#D8DEE9;">        builder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">tokenUri</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://github.com/login/oauth/access_token</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        //客户应用使用令牌向GitHub请求用户数据</span></span>
<span class="line"><span style="color:#D8DEE9;">        builder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">userInfoUri</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">https://api.github.com/user</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        //username属性显示GitHub中获取的哪个属性的信息</span></span>
<span class="line"><span style="color:#D8DEE9;">        builder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">userNameAttributeName</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">id</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#616E88;">        //登录页面超链接的文本</span></span>
<span class="line"><span style="color:#D8DEE9;">        builder</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">clientName</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">GitHub</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#D8DEE9FF;"> builder</span><span style="color:#81A1C1;">;</span></span>
<span class="line"><span style="color:#ECEFF4;">    }</span></span>
<span class="line"><span style="color:#ECEFF4;">},</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,390);function i(c,d){return p(),n("div",null,[t,a(" more "),r])}const F=s(o,[["render",i],["__file","SpringSecurity.html.vue"]]),u=JSON.parse('{"path":"/note/java/SpringSecurity.html","title":"SpringSecurity","lang":"zh-CN","frontmatter":{"title":"SpringSecurity","cover":"/assets/images/cover1.jpg","icon":"file","order":3,"author":"HotMilk","date":"2024-07-15T00:00:00.000Z","category":["Java","Spring"],"tag":["SpringSecurity"],"description":"SpringSecurity","head":[["meta",{"property":"og:url","content":"https://reniunai.github.io/note/java/SpringSecurity.html"}],["meta",{"property":"og:site_name","content":"热牛奶"}],["meta",{"property":"og:title","content":"SpringSecurity"}],["meta",{"property":"og:description","content":"SpringSecurity"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://reniunai.github.io/assets/images/cover1.jpg"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-08-05T08:48:07.000Z"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://reniunai.github.io/assets/images/cover1.jpg"}],["meta",{"name":"twitter:image:alt","content":"SpringSecurity"}],["meta",{"property":"article:author","content":"HotMilk"}],["meta",{"property":"article:tag","content":"SpringSecurity"}],["meta",{"property":"article:published_time","content":"2024-07-15T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-08-05T08:48:07.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"SpringSecurity\\",\\"image\\":[\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244594.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244633.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244637.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244640.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244656.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244682.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244274.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244341.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244442.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244812.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244907.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244173.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244283.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244440.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244056.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244189.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244347.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244490.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244937.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244263.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244437.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244533.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244627.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244713.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244937.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244517.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244777.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244713.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244095.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244348.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244456.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244568.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244721.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244978.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244235.png\\",\\"https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407252244409.png\\"],\\"datePublished\\":\\"2024-07-15T00:00:00.000Z\\",\\"dateModified\\":\\"2024-08-05T08:48:07.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"HotMilk\\"}]}"]]},"headers":[{"level":2,"title":"1、身份认证（authentication）","slug":"_1、身份认证-authentication","link":"#_1、身份认证-authentication","children":[{"level":3,"title":"1.1、创建Spring Boot项目","slug":"_1-1、创建spring-boot项目","link":"#_1-1、创建spring-boot项目","children":[]},{"level":3,"title":"1.2、创建IndexController","slug":"_1-2、创建indexcontroller","link":"#_1-2、创建indexcontroller","children":[]},{"level":3,"title":"1.3、创建index.html","slug":"_1-3、创建index-html","link":"#_1-3、创建index-html","children":[]},{"level":3,"title":"1.4、启动项目测试Controller","slug":"_1-4、启动项目测试controller","link":"#_1-4、启动项目测试controller","children":[]},{"level":3,"title":"1.5、注意事项","slug":"_1-5、注意事项","link":"#_1-5、注意事项","children":[]},{"level":3,"title":"1.6、Spring Security默认做了什么","slug":"_1-6、spring-security默认做了什么","link":"#_1-6、spring-security默认做了什么","children":[]}]},{"level":2,"title":"2、Spring Security 的底层原理","slug":"_2、spring-security-的底层原理","link":"#_2、spring-security-的底层原理","children":[{"level":3,"title":"2.1、Filter","slug":"_2-1、filter","link":"#_2-1、filter","children":[]},{"level":3,"title":"2.2、DelegatingFilterProxy","slug":"_2-2、delegatingfilterproxy","link":"#_2-2、delegatingfilterproxy","children":[]},{"level":3,"title":"2.3、FilterChainProxy","slug":"_2-3、filterchainproxy","link":"#_2-3、filterchainproxy","children":[]},{"level":3,"title":"2.4、SecurityFilterChain","slug":"_2-4、securityfilterchain","link":"#_2-4、securityfilterchain","children":[]},{"level":3,"title":"2.5、Multiple SecurityFilterChain","slug":"_2-5、multiple-securityfilterchain","link":"#_2-5、multiple-securityfilterchain","children":[]}]},{"level":2,"title":"3、程序的启动和运行","slug":"_3、程序的启动和运行","link":"#_3、程序的启动和运行","children":[{"level":3,"title":"3.1、DefaultSecurityFilterChain","slug":"_3-1、defaultsecurityfilterchain","link":"#_3-1、defaultsecurityfilterchain","children":[]},{"level":3,"title":"3.2、SecurityProperties","slug":"_3-2、securityproperties","link":"#_3-2、securityproperties","children":[]}]},{"level":2,"title":"1、基于内存的用户认证","slug":"_1、基于内存的用户认证","link":"#_1、基于内存的用户认证","children":[{"level":3,"title":"1.1、创建自定义配置","slug":"_1-1、创建自定义配置","link":"#_1-1、创建自定义配置","children":[]},{"level":3,"title":"1.2、基于内存的用户认证流程","slug":"_1-2、基于内存的用户认证流程","link":"#_1-2、基于内存的用户认证流程","children":[]}]},{"level":2,"title":"2、基于数据库的数据源","slug":"_2、基于数据库的数据源","link":"#_2、基于数据库的数据源","children":[{"level":3,"title":"2.1、SQL","slug":"_2-1、sql","link":"#_2-1、sql","children":[]},{"level":3,"title":"2.2、引入依赖","slug":"_2-2、引入依赖","link":"#_2-2、引入依赖","children":[]},{"level":3,"title":"2.3、配置数据源","slug":"_2-3、配置数据源","link":"#_2-3、配置数据源","children":[]},{"level":3,"title":"2.4、实体类","slug":"_2-4、实体类","link":"#_2-4、实体类","children":[]},{"level":3,"title":"2.5、Mapper","slug":"_2-5、mapper","link":"#_2-5、mapper","children":[]},{"level":3,"title":"2.6、Service","slug":"_2-6、service","link":"#_2-6、service","children":[]},{"level":3,"title":"2.7、Controller","slug":"_2-7、controller","link":"#_2-7、controller","children":[]}]},{"level":2,"title":"3、基于数据库的用户认证","slug":"_3、基于数据库的用户认证","link":"#_3、基于数据库的用户认证","children":[{"level":3,"title":"3.1、基于数据库的用户认证流程","slug":"_3-1、基于数据库的用户认证流程","link":"#_3-1、基于数据库的用户认证流程","children":[]},{"level":3,"title":"3.2、定义DBUserDetailsManager","slug":"_3-2、定义dbuserdetailsmanager","link":"#_3-2、定义dbuserdetailsmanager","children":[]},{"level":3,"title":"3.3、初始化UserDetailsService","slug":"_3-3、初始化userdetailsservice","link":"#_3-3、初始化userdetailsservice","children":[]}]},{"level":2,"title":"4、SpringSecurity的默认配置","slug":"_4、springsecurity的默认配置","link":"#_4、springsecurity的默认配置","children":[]},{"level":2,"title":"5、添加用户功能","slug":"_5、添加用户功能","link":"#_5、添加用户功能","children":[{"level":3,"title":"5.1、Controller","slug":"_5-1、controller","link":"#_5-1、controller","children":[]},{"level":3,"title":"5.2、Service","slug":"_5-2、service","link":"#_5-2、service","children":[]},{"level":3,"title":"5.3、修改配置","slug":"_5-3、修改配置","link":"#_5-3、修改配置","children":[]},{"level":3,"title":"5.4、使用Swagger测试","slug":"_5-4、使用swagger测试","link":"#_5-4、使用swagger测试","children":[]},{"level":3,"title":"5.5、关闭csrf攻击防御","slug":"_5-5、关闭csrf攻击防御","link":"#_5-5、关闭csrf攻击防御","children":[]}]},{"level":2,"title":"6、密码加密算法","slug":"_6、密码加密算法","link":"#_6、密码加密算法","children":[{"level":3,"title":"6.1、密码加密方式","slug":"_6-1、密码加密方式","link":"#_6-1、密码加密方式","children":[]},{"level":3,"title":"6.2、PasswordEncoder","slug":"_6-2、passwordencoder","link":"#_6-2、passwordencoder","children":[]},{"level":3,"title":"6.3、密码加密测试","slug":"_6-3、密码加密测试","link":"#_6-3、密码加密测试","children":[]},{"level":3,"title":"6.4、DelegatingPasswordEncoder","slug":"_6-4、delegatingpasswordencoder","link":"#_6-4、delegatingpasswordencoder","children":[]}]},{"level":2,"title":"7、自定义登录页面","slug":"_7、自定义登录页面","link":"#_7、自定义登录页面","children":[{"level":3,"title":"7.1、创建登录Controller","slug":"_7-1、创建登录controller","link":"#_7-1、创建登录controller","children":[]},{"level":3,"title":"7.2、创建登录页面","slug":"_7-2、创建登录页面","link":"#_7-2、创建登录页面","children":[]},{"level":3,"title":"7.3、配置SecurityFilterChain","slug":"_7-3、配置securityfilterchain","link":"#_7-3、配置securityfilterchain","children":[]}]},{"level":2,"title":"1、用户认证流程","slug":"_1、用户认证流程","link":"#_1、用户认证流程","children":[]},{"level":2,"title":"2、引入fastjson","slug":"_2、引入fastjson","link":"#_2、引入fastjson","children":[]},{"level":2,"title":"3、认证成功的响应","slug":"_3、认证成功的响应","link":"#_3、认证成功的响应","children":[{"level":3,"title":"3.1、成功结果处理","slug":"_3-1、成功结果处理","link":"#_3-1、成功结果处理","children":[]},{"level":3,"title":"3.2、SecurityFilterChain配置","slug":"_3-2、securityfilterchain配置","link":"#_3-2、securityfilterchain配置","children":[]}]},{"level":2,"title":"4、认证失败响应","slug":"_4、认证失败响应","link":"#_4、认证失败响应","children":[{"level":3,"title":"4.1、失败结果处理","slug":"_4-1、失败结果处理","link":"#_4-1、失败结果处理","children":[]},{"level":3,"title":"4.2SecurityFilterChain配置","slug":"_4-2securityfilterchain配置","link":"#_4-2securityfilterchain配置","children":[]}]},{"level":2,"title":"5、注销响应","slug":"_5、注销响应","link":"#_5、注销响应","children":[{"level":3,"title":"5.1、注销结果处理","slug":"_5-1、注销结果处理","link":"#_5-1、注销结果处理","children":[]},{"level":3,"title":"5.2、SecurityFilterChain配置","slug":"_5-2、securityfilterchain配置","link":"#_5-2、securityfilterchain配置","children":[]}]},{"level":2,"title":"6、请求未认证的接口","slug":"_6、请求未认证的接口","link":"#_6、请求未认证的接口","children":[{"level":3,"title":"6.1、实现AuthenticationEntryPoint接口","slug":"_6-1、实现authenticationentrypoint接口","link":"#_6-1、实现authenticationentrypoint接口","children":[]},{"level":3,"title":"6.2、SecurityFilterChain配置","slug":"_6-2、securityfilterchain配置","link":"#_6-2、securityfilterchain配置","children":[]}]},{"level":2,"title":"7、跨域","slug":"_7、跨域","link":"#_7、跨域","children":[]},{"level":2,"title":"1、用户认证信息","slug":"_1、用户认证信息","link":"#_1、用户认证信息","children":[{"level":3,"title":"1.1、基本概念","slug":"_1-1、基本概念","link":"#_1-1、基本概念","children":[]},{"level":3,"title":"1.2、在Controller中获取用户信息","slug":"_1-2、在controller中获取用户信息","link":"#_1-2、在controller中获取用户信息","children":[]}]},{"level":2,"title":"2、会话并发处理","slug":"_2、会话并发处理","link":"#_2、会话并发处理","children":[{"level":3,"title":"2.1、实现处理器接口","slug":"_2-1、实现处理器接口","link":"#_2-1、实现处理器接口","children":[]},{"level":3,"title":"2.2、SecurityFilterChain配置","slug":"_2-2、securityfilterchain配置","link":"#_2-2、securityfilterchain配置","children":[]}]},{"level":2,"title":"1、基于request的授权","slug":"_1、基于request的授权","link":"#_1、基于request的授权","children":[{"level":3,"title":"1.1、用户-权限-资源","slug":"_1-1、用户-权限-资源","link":"#_1-1、用户-权限-资源","children":[]},{"level":3,"title":"1.2、用户-角色-资源","slug":"_1-2、用户-角色-资源","link":"#_1-2、用户-角色-资源","children":[]},{"level":3,"title":"1.3、用户-角色-权限-资源","slug":"_1-3、用户-角色-权限-资源","link":"#_1-3、用户-角色-权限-资源","children":[]}]},{"level":2,"title":"2、基于方法的授权","slug":"_2、基于方法的授权","link":"#_2、基于方法的授权","children":[{"level":3,"title":"2.1、开启方法授权","slug":"_2-1、开启方法授权","link":"#_2-1、开启方法授权","children":[]},{"level":3,"title":"2.2、给用户授予角色和权限","slug":"_2-2、给用户授予角色和权限","link":"#_2-2、给用户授予角色和权限","children":[]},{"level":3,"title":"2.2、常用授权注解","slug":"_2-2、常用授权注解","link":"#_2-2、常用授权注解","children":[]}]},{"level":2,"title":"1、OAuth2简介","slug":"_1、oauth2简介","link":"#_1、oauth2简介","children":[{"level":3,"title":"1.1、OAuth2是什么","slug":"_1-1、oauth2是什么","link":"#_1-1、oauth2是什么","children":[]},{"level":3,"title":"1.2、OAuth2的角色","slug":"_1-2、oauth2的角色","link":"#_1-2、oauth2的角色","children":[]},{"level":3,"title":"1.3、OAuth2的使用场景","slug":"_1-3、oauth2的使用场景","link":"#_1-3、oauth2的使用场景","children":[]},{"level":3,"title":"1.4、OAuth2的四种授权模式","slug":"_1-4、oauth2的四种授权模式","link":"#_1-4、oauth2的四种授权模式","children":[]},{"level":3,"title":"1.5、授权类型的选择","slug":"_1-5、授权类型的选择","link":"#_1-5、授权类型的选择","children":[]}]},{"level":2,"title":"2、Spring中的OAuth2","slug":"_2、spring中的oauth2","link":"#_2、spring中的oauth2","children":[{"level":3,"title":"2.1、相关角色","slug":"_2-1、相关角色","link":"#_2-1、相关角色","children":[]},{"level":3,"title":"2.2、Spring中的实现","slug":"_2-2、spring中的实现","link":"#_2-2、spring中的实现","children":[]},{"level":3,"title":"2.3、相关依赖","slug":"_2-3、相关依赖","link":"#_2-3、相关依赖","children":[]},{"level":3,"title":"2.4、授权登录的实现思路","slug":"_2-4、授权登录的实现思路","link":"#_2-4、授权登录的实现思路","children":[]}]},{"level":2,"title":"3、GiuHub社交登录案例","slug":"_3、giuhub社交登录案例","link":"#_3、giuhub社交登录案例","children":[{"level":3,"title":"3.1、创建应用","slug":"_3-1、创建应用","link":"#_3-1、创建应用","children":[]},{"level":3,"title":"3.2、创建测试项目","slug":"_3-2、创建测试项目","link":"#_3-2、创建测试项目","children":[]},{"level":3,"title":"3.3、配置OAuth客户端属性","slug":"_3-3、配置oauth客户端属性","link":"#_3-3、配置oauth客户端属性","children":[]},{"level":3,"title":"3.4、创建Controller","slug":"_3-4、创建controller","link":"#_3-4、创建controller","children":[]},{"level":3,"title":"3.5、创建html页面","slug":"_3-5、创建html页面","link":"#_3-5、创建html页面","children":[]},{"level":3,"title":"3.6、启动应用程序","slug":"_3-6、启动应用程序","link":"#_3-6、启动应用程序","children":[]}]},{"level":2,"title":"4、案例分析","slug":"_4、案例分析","link":"#_4、案例分析","children":[{"level":3,"title":"4.1、登录流程","slug":"_4-1、登录流程","link":"#_4-1、登录流程","children":[]},{"level":3,"title":"4.2、CommonOAuth2Provider","slug":"_4-2、commonoauth2provider","link":"#_4-2、commonoauth2provider","children":[]}]}],"git":{"createdTime":1722847687000,"updatedTime":1722847687000,"contributors":[{"name":"reniunai","email":"2843768@qq.com","commits":1}]},"readingTime":{"minutes":30.43,"words":9128},"filePathRelative":"note/java/SpringSecurity.md","localizedDate":"2024年7月15日","excerpt":"<p>SpringSecurity</p>\\n","autoDesc":true}');export{F as comp,u as data};
