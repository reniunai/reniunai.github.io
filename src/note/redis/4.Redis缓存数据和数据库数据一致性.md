---
# 这是文章的标题
title:  Redis缓存数据和数据库数据一致性
# 你可以自定义封面图片
cover: /assets/images/cover1.jpg
# 这是页面的图标
icon: file
# 这是侧边栏的顺序
order: 3
# 设置作者
author: HotMilk
# 设置写作时间
date: 2024-7-15
# 一个页面可以有多个分类
category:
  - Redis
# 一个页面可以有多个标签
tag:
  - 一致性
  - 缓存数据和数据库数据一致性
# 此页面会在文章列表置顶
# sticky: true
# 此页面会出现在星标文章中
# star: true
# 你可以自定义页脚
# footer: 这是测试显示的页脚
# 你可以自定义版权信息
# copyright: 无版权
---

Redis缓存数据和数据库数据如何保持一致性

对于这种两个库如何保证一致性的问题，可以从两大方式去讨论。

一、同步还是异步，

二、需要强一致性还是最终一致性。

<!-- more -->

# 同步

## 双写模式

当修改了数据库的数据也要同时更新缓存的数据，缓存和数据库的数据要保持一致。

![image-20240717031153944](https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407170311991.png)

## 失效模式

数据库更新后，将缓存中数据删除，等待下次主动查询进行更新

缺点：在删除缓存前，有请求读到缓存，那么读取到的数据就不是最新的

![image-20240717031245889](https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407170312933.png)

### 先删除缓存，后更新数据库

![image-20240717031931497](https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407170319607.png)

### 先更新数据库，后删除缓存

![image-20240717032141396](https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407170321502.png)

无论是先删数据库还是先删缓存，都是会出现问题，包括下面的延时双删也是不能保证100%的一致性，需要强一致性那么要加锁。

![image-20240717040018130](https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407170400166.png)

![image-20240717040036393](https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407170400425.png)

### 延迟双删

读操作：缓存命中，直接返回；缓存未命中查询数据库，写入缓存，设定超时时间
写操作：延迟双删（因为数据有变更，数据在写的过程中，并发读会产生脏数据）

![image-20240717032251588](https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407170322666.png)

若是网络延迟，在箭头处才写入旧数据的缓存，还是会出现问题。

此外，因为删除缓存和更新数据库不是原子操作，还可能会出现问题。这种方案只适合最终一致性，想要强一致性就加锁或者直接去掉Rredis直接去MySQL查。或者去掉MySQL，直接全部数据放Redis再持久化，这样就不用考虑一致性问题。

## 加锁（强一致性）

采用Redisson提供的读写锁

①共享锁：读锁readLock，加锁之后，其他线程可以共享读操作   

②排他锁：独占锁writeLock也叫，加锁之后，阻塞其他线程读写操作

# 异步-最终一致性

基于MQ

![image-20240717000827587](https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407170008642.png)

基于Canal

![image-20240717073627838](https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407170736886.png)

![image-20240717073638153](https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407170736198.png)

# 缓存数据一致性解决方案

- 无论是双写模式还是失效模式，都会导致缓存的不一致问题。即多个实例同时更新会出事。怎么办？

  - 1、如果是用户纬度数据（订单数据、用户数据），这种并发几率非常小，不用考虑这个问题，缓存数据加上过期时间，每隔一段时间触发读的主动更新即可
  -  2、如果是菜单，商品介绍等基础数据，也可以去使用canal订阅binlog的方式。
  -  3、缓存数据+过期时间也足够解决大部分业务对于缓存的要求。
  -  4、通过加锁保证并发读写，写写的时候按顺序排好队。读读无所谓。所以适合使用读写锁。（业务不关心脏数据，允许临时脏数据可忽略）；

- 总结：
  - 我们能放入缓存的数据本就不应该是实时性、一致性要求超高的。所以缓存数据的时候加上过期时间，保证每天拿到当前最新数据即可。
  - 我们不应该过度设计，增加系统的复杂性
  - 遇到实时性、一致性要求高的数据，就应该查数据库，即使慢点。

![image-20240717031606230](https://hotmilk-pic.oss-cn-shenzhen.aliyuncs.com/assets/202407170316281.png)